<!DOCTYPE html>
<html lang="pt-br">
<head>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta charset="UTF-8">
  <title>Aluforce: MRP - Estrutura de Produto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Mobile Enterprise Design System -->
    <link rel="stylesheet" href="/css/design-system-mobile.css?v=20260202">
    <link rel="stylesheet" href="/css/responsive-global.css?v=20260202">
    <link rel="stylesheet" href="/css/mobile-master-2026.css?v=20260202">
    <link rel="stylesheet" href="/css/mobile-enterprise-enhancements.css?v=20260202">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <!-- Mobile Enhancement CSS -->
  <link rel="stylesheet" href="/css/design-system-mobile.css?v=20260201">
  <link rel="stylesheet" href="/css/mobile-enterprise-enhancements.css?v=20260201">
  <link rel="stylesheet" href="/css/mrp-mobile.css?v=20260201">
    <script src="/js/modal-title.js?v=20260210"></script>
    <!-- Chat Widget BOB AI --><!-- Chat Widget REMOVIDO --><!-- 
    <link rel="stylesheet" href="/chat/widget.css?v=20260218"> -->
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">Cadastro de Estrutura de Produto (BOM)</h1>
    <form id="bomForm" class="card p-4 mb-4">
      <div class="mb-3">
        <label for="codigoProduto" class="form-label">Código do Produto</label>
        <input type="text" class="form-control" id="codigoProduto" required>
      </div>
      <div class="mb-3">
        <label for="descricao" class="form-label">Descrição do Produto</label>
        <input type="text" class="form-control" id="descricao">
      </div>
      <div class="mb-3">
        <label class="form-label">Componentes</label>
        <div id="componentesList"></div>
        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="adicionarComponente()">Adicionar Componente</button>
      </div>
      <button type="submit" class="btn btn-primary">Salvar BOM</button>
    </form>
    <div id="alerta"></div>
    <h2 class="mb-3">Consultar BOM</h2>
    <form id="consultaForm" class="card p-4 mb-4">
      <div class="mb-3">
        <label for="consultaCodigo" class="form-label">Código do Produto</label>
        <input type="text" class="form-control" id="consultaCodigo" required>
      </div>
      <button type="submit" class="btn btn-info">Buscar BOM</button>
    </form>
    <div id="resultadoConsulta"></div>
  </div>
  <script>
    let componentes = [];
    function adicionarComponente() {
      const idx = componentes.length;
      componentes.push({});
      const div = document.createElement('div');
      div.className = 'row g-2 mb-2 align-items-end';
      div.innerHTML = `
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Código" onchange="componentes[${idx}].codigoComponente = this.value">
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Descrição" onchange="componentes[${idx}].descricao = this.value">
        </div>
        <div class="col-md-2">
          <input type="number" class="form-control" placeholder="Qtd" min="0.01" step="0.01" onchange="componentes[${idx}].quantidade = parseFloat(this.value)">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Unidade" onchange="componentes[${idx}].unidade = this.value">
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-danger btn-sm" onclick="removerComponente(${idx}, this)">Remover</button>
        </div>
      `;
      document.getElementById('componentesList').appendChild(div);
    }
    function removerComponente(idx, btn) {
      componentes[idx] = null;
      btn.closest('.row').remove();
    }
    document.getElementById('bomForm').onsubmit = async function(e) {
      e.preventDefault();
      const codigoProduto = document.getElementById('codigoProduto').value.trim();
      const descricao = document.getElementById('descricao').value.trim();
      const comps = componentes.filter(c => c && c.codigoComponente && c.quantidade);
      if (!codigoProduto || comps.length === 0) {
        mostrarAlerta('Preencha o código do produto e ao menos um componente válido.', 'danger');
        return;
      }
      const resp = await fetch('/api/pcp/mrp/bom', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codigoProduto, descricao, componentes: comps })
      });
      const data = await resp.json();
      if (data.success) {
        mostrarAlerta('BOM cadastrada com sucesso!', 'success');
        document.getElementById('bomForm').reset();
        componentes = [];
        document.getElementById('componentesList').innerHTML = '';
      } else {
        mostrarAlerta(data.message || 'Erro ao cadastrar BOM', 'danger');
      }
    };
    document.getElementById('consultaForm').onsubmit = async function(e) {
      e.preventDefault();
      const codigo = document.getElementById('consultaCodigo').value.trim();
      if (!codigo) return;
      const resp = await fetch(`/api/pcp/mrp/bom/${codigo}`);
      const data = await resp.json();
      if (data.success) {
        let html = `<h4>BOM de ${data.bom.codigoProduto} - ${data.bom.descricao || ''}</h4><ul class="list-group">`;
        for (const c of data.bom.componentes) {
          html += `<li class="list-group-item">${c.codigo_componente} - ${c.descricao_componente || ''} | Qtd: ${c.quantidade} ${c.unidade}</li>`;
        }
        html += '</ul>';
        document.getElementById('resultadoConsulta').innerHTML = html;
      } else {
        document.getElementById('resultadoConsulta').innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
      }
    };
    function mostrarAlerta(msg, tipo) {
      document.getElementById('alerta').innerHTML = `<div class="alert alert-${tipo} mt-2">${msg}</div>`;
      setTimeout(() => { document.getElementById('alerta').innerHTML = ''; }, 4000);
    }
  </script>

    <script src="/js/auth-unified.js?v=20260131c"></script>
    <script src="/js/mobile-auto-enhance.js?v=20260202" defer></script>
    <!-- Chat Widget BOB AI --><!-- Chat Widget REMOVIDO --><!-- 
    <script src="/chat/widget.js?v=20260218" defer></script> -->
</body>
</html>
