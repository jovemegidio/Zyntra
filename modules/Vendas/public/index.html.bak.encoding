<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a2744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ALUFORCE">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ALUFORCE">
    <meta name="msapplication-TileColor" content="#1a2744">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ALUFORCE - Vendas e NF-e</title>
    
    <!-- Favicon e Ícones PWA -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSP Fix -->
    <script src="/js/csp-fix.js"></script>
    
    <!-- Socket.IO para notificações em tempo real -->
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        :root {
            --sidebar-width: 56px;
            --header-height: 48px;
            --tab-height: 0px;
            --primary-orange: #225cfa;
            --primary-dark: #1a1a2e;
            --bg-gray: #f5f5f5;
            --border-color: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --success-green: #22c55e;
            --warning-yellow: #eab308;
            --danger-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gray);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* ========================================
           LAYOUT PRINCIPAL
           ======================================== */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ========================================
           SIDEBAR LATERAL (Estilo Omie)
           ======================================== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            z-index: 100;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: var(--primary-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .sidebar-logo i {
            color: white;
            font-size: 18px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .sidebar-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        .sidebar-btn .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger-red);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 600;
        }

        .sidebar-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* ========================================
           MAIN CONTENT AREA
           ======================================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ========================================
           HEADER SUPERIOR
           ======================================== */
        .header {
            height: var(--header-height);
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .header-brand img {
            height: 24px;
        }

        .header-brand span {
            font-size: 14px;
            font-weight: 600;
            color: #8b8b9a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #8b8b9a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar img.visible {
            display: block;
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 16px;
            color: #8b8b9a;
            font-size: 13px;
        }

        .user-greeting strong {
            color: white;
        }

        /* ========================================
           SISTEMA DE NOTIFICAÇÕES
           ======================================== */
        .notification-container {
            position: relative;
        }

        .notification-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
            animation: pulse-badge 2s infinite;
        }

        .notification-badge.hidden {
            display: none;
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-panel {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 380px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 99999;
            display: none;
            overflow: hidden;
            animation: slideDown 0.2s ease;
        }

        .notification-panel.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-tabs {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f8f8;
        }

        .notif-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .notif-tab:hover {
            color: #f97316;
        }

        .notif-tab.active {
            color: #f97316;
            border-bottom-color: #f97316;
            font-weight: 600;
        }

        .notification-list {
            max-height: 340px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            background: #f8f8f8;
        }

        .notification-item.unread {
            background: #fff7ed;
            border-left: 3px solid #f97316;
        }

        .notification-item.important {
            border-left: 3px solid #ef4444;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.success { background: #dcfce7; color: #22c55e; }
        .notification-icon.warning { background: #fef3c7; color: #f59e0b; }
        .notification-icon.error { background: #fee2e2; color: #ef4444; }
        .notification-icon.info { background: #dbeafe; color: #3b82f6; }
        .notification-icon.order { background: #f3e8ff; color: #8b5cf6; }
        .notification-icon.payment { background: #d1fae5; color: #10b981; }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-title .badge-new {
            background: #f97316;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .notification-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .notification-time {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .notification-empty i {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .notification-footer {
            padding: 12px 20px;
            background: #f8f8f8;
            text-align: center;
            border-top: 1px solid #e5e5e5;
        }

        .notification-footer a {
            color: #f97316;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .notification-footer a:hover {
            text-decoration: underline;
        }

        /* ========================================
           TABS (removido - kanban ocupa todo espaço)
           ======================================== */
        .tabs-bar {
            display: none;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #e5e5e5;
        }

        .tab.active {
            background: var(--primary-orange);
            color: white;
        }

        .tab .close-tab {
            margin-left: 4px;
            opacity: 0.7;
            font-size: 12px;
        }

        .tab .close-tab:hover {
            opacity: 1;
        }

        .tabs-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-action-btn:hover {
            background: #f5f5f5;
        }

        /* ========================================
           FILTROS BAR
           ======================================== */
        .filters-bar {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 0 12px;
            width: 300px;
        }

        .search-box i {
            color: #999;
            font-size: 14px;
        }

        .search-box input {
            border: none;
            background: transparent;
            padding: 10px 12px;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .filter-link {
            color: var(--primary-orange);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
        }

        .filter-link:hover {
            text-decoration: underline;
        }

        /* ========================================
           KANBAN BOARD
           ======================================== */
        .kanban-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 12px;
            background: var(--bg-gray);
            height: calc(100vh - var(--header-height) - 60px);
        }

        .kanban-board {
            display: flex;
            gap: 12px;
            height: 100%;
            width: 100%;
        }

        .kanban-column {
            flex: 1;
            min-width: 200px;
            max-width: none;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kanban-column-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .column-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .column-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .column-indicator.orcamento { background: #94a3b8; }
        .column-indicator.analise { background: #f59e0b; }
        .column-indicator.aprovado { background: #10b981; }
        .column-indicator.faturar { background: #f97316; }
        .column-indicator.faturado { background: #22c55e; }
        .column-indicator.recibo { background: #06b6d4; }

        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .kanban-column-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-new-card {
            width: 100%;
            padding: 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-new-card:hover {
            background: #ea580c;
        }

        .btn-action-card {
            width: 100%;
            padding: 10px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-action-card:hover {
            background: #16a34a;
        }

        .btn-action-card.teal {
            background: #06b6d4;
        }

        .btn-action-card.teal:hover {
            background: #0891b2;
        }

        /* ========================================
           KANBAN CARDS
           ======================================== */
        .kanban-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        .kanban-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        /* Cards bloqueados (faturado/recibo) - néo podem ser arrastados */
        .kanban-card.card-bloqueado {
            cursor: not-allowed;
            opacity: 0.9;
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .kanban-card.card-bloqueado:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card-badge.locked {
            background: #059669;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .card-badge.locked i {
            font-size: 9px;
        }
        
        /* Estilo da coluna quando card está sendo arrastado sobre ela */
        .kanban-column-content.drag-over {
            background: #e0f2fe;
            border: 2px dashed #0ea5e9;
            border-radius: 8px;
        }
        
        /* Placeholder visual para onde o card vai */
        .kanban-column-content.drag-over::after {
            content: 'Solte aqui';
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 8px;
            color: #0ea5e9;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-number {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .card-menu {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #999;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-menu:hover {
            background: #f5f5f5;
            color: var(--text-primary);
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* === Produtos no Card === */
        .card-produtos {
            margin: 8px 0;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        .card-produto-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px dashed #e5e5e5;
            font-size: 11px;
        }

        .card-produto-item:last-child {
            border-bottom: none;
        }

        .produto-codigo {
            font-weight: 600;
            color: #f97316;
            font-size: 10px;
            background: #fff7ed;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .produto-desc {
            flex: 1;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .produto-qtd {
            font-weight: 500;
            color: #555;
            font-size: 10px;
            flex-shrink: 0;
        }

        .card-produtos-mais {
            text-align: center;
            font-size: 10px;
            color: #888;
            padding-top: 6px;
            margin-top: 4px;
            border-top: 1px dashed #e5e5e5;
        }

        .card-produto-vazio {
            text-align: center;
            color: #999;
            font-size: 11px;
            padding: 8px;
        }

        .card-produto-vazio i {
            margin-right: 6px;
            color: #ccc;
        }

        .card-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .card-status.atrasado {
            background: #fef2f2;
            color: #dc2626;
        }

        .card-status.faturado {
            background: #f0fdf4;
            color: #16a34a;
        }

        .card-status.em-dia {
            background: #eff6ff;
            color: #2563eb;
        }

        .card-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .card-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .card-origin {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #22c55e;
            margin-top: 8px;
        }

        .card-origin i {
            font-size: 10px;
        }

        .card-transport {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #f0f0f0;
        }

        .card-badge {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .card-badge.nf {
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .card-message {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 8px;
            padding: 8px;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 11px;
            color: #92400e;
        }

        .card-message i {
            margin-top: 2px;
        }

        /* Empty State */
        .empty-column {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-column i {
            font-size: 32px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .empty-column p {
            font-size: 13px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* ========================================
           MODAL EDITAR PEDIDO - ESTILO OMIE PROFISSIONAL
           ======================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        /* Modal Grande Estilo Omie */
        .modal-content-omie {
            background: #f8f8f8;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            height: auto;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ===== MODAL NOVO ITEM - ESTILO OMIE ===== */
        .modal-header-item-omie {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-header-item-omie h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        /* Botéo Fechar Moderno */
        .close-btn-modern {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }
        
        .close-btn-modern:hover {
            background: #ef4444;
            color: white;
            transform: rotate(90deg);
        }
        
        .close-btn-modern:active {
            transform: scale(0.95) rotate(90deg);
        }

        .modal-body-item-omie {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f8f9fa;
        }

        .produto-section-omie {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 20px;
        }

        .barcode-icon {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
        }

        .produto-fields-omie {
            flex: 1;
        }

        .produto-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-group label {
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }

        .field-group input,
        .field-group select,
        .field-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }

        .field-group input:focus,
        .field-group select:focus,
        .field-group textarea:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .input-autocomplete-container {
            position: relative;
        }

        .input-autocomplete-container input {
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: background 0.15s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #fff7ed;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item-code {
            font-size: 12px;
            font-weight: 600;
            color: #f97316;
        }

        .autocomplete-item-desc {
            font-size: 13px;
            color: #333;
        }

        .autocomplete-item-info {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 12px;
        }

        .autocomplete-no-results {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        .btn-pesquisar-produto {
            padding: 10px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-pesquisar-produto:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .input-with-search {
            position: relative;
            display: flex;
        }

        .input-with-search input {
            flex: 1;
            border-radius: 6px 0 0 6px;
        }

        .input-with-search .btn-input-search {
            padding: 10px 14px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            color: #666;
        }

        .input-with-search .btn-input-search:hover {
            background: #e5e5e5;
        }

        .section-omie {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 16px;
        }

        .section-title-omie {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin: 0 0 16px 0;
        }

        .section-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .section-row-split {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-number {
            text-align: right;
        }

        .checkbox-field {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }

        .toggle-label input {
            display: none;
        }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-label input:checked + .toggle-switch {
            background: #f97316;
        }

        .toggle-label input:checked + .toggle-switch::after {
            transform: translateX(16px);
        }

        .valores-calculados-table {
            display: flex;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .valor-calc-item {
            flex: 1;
            padding: 16px;
            text-align: center;
            border-right: 1px solid #e5e5e5;
        }

        .valor-calc-item:last-child {
            border-right: none;
        }

        .valor-calc-item.destaque {
            background: #fff7ed;
        }

        .valor-calc-label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }

        .valor-calc-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #f97316;
        }

        .valor-calc-item.destaque .valor-calc-value {
            font-size: 16px;
            color: #ea580c;
        }

        .observacoes-link {
            margin-bottom: 16px;
        }

        .btn-link-obs {
            background: none;
            border: none;
            color: #555;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .btn-link-obs:hover {
            color: #f97316;
        }

        .observacoes-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
            margin-bottom: 16px;
        }

        .modal-footer-item-omie {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 24px;
            padding: 16px 24px;
            background: white;
            border-top: 1px solid #e5e5e5;
        }

        .footer-toggle {
            margin-right: auto;
        }

        .btn-incluir-item {
            padding: 12px 32px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-incluir-item:hover {
            background: linear-gradient(135deg, #ea580c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        @media (max-width: 900px) {
            .produto-row {
                flex-direction: column;
                align-items: stretch;
            }
            .section-row-split {
                flex-direction: column;
            }
            .valores-calculados-table {
                flex-wrap: wrap;
            }
            .valor-calc-item {
                flex: 1 1 30%;
                border-bottom: 1px solid #e5e5e5;
            }
        }

        /* Header Omie */
        .modal-header-omie {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }

        .modal-header-omie h2 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header-omie .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-header-omie .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-header-omie .close-btn i {
            font-size: 12px;
        }

        /* Container Principal com Sidebar */
        .modal-container-omie {
            display: flex;
            flex: 1;
            overflow: hidden;
            max-height: calc(90vh - 60px);
        }

        /* área de Conteúdo Principal */
        .modal-main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
            background: white;
            border-right: 1px solid #e5e5e5;
        }

        /* Sidebar de Ações - Estilo Omie */
        .modal-sidebar-actions {
            width: 160px;
            background: white;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
        }

        .sidebar-action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            color: #444;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }

        .sidebar-action-btn:hover {
            background: #f5f5f5;
            color: #222;
        }

        .sidebar-action-btn i {
            width: 16px;
            text-align: center;
            color: var(--primary-orange);
            font-size: 13px;
        }

        .sidebar-action-btn.primary {
            background: var(--primary-orange);
            color: white;
            font-weight: 500;
        }

        .sidebar-action-btn.primary:hover {
            background: #0011ac;
        }

        .sidebar-action-btn.primary i {
            color: white;
        }

        .sidebar-action-btn.danger {
            color: #666;
        }

        .sidebar-action-btn.danger i {
            color: #999;
        }

        .sidebar-action-btn.danger:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .sidebar-action-btn.danger:hover i {
            color: #dc2626;
        }

        .sidebar-action-btn.outline-primary {
            border: 1px solid var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 500;
            background: white;
        }

        .sidebar-action-btn.outline-primary:hover {
            background: #fff7ed;
        }

        /* Botéo Faturar Agora - Destaque especial */
        .sidebar-action-btn.btn-faturar {
            background: linear-gradient(135deg, #023197 0%, #0b58ff 100%);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-action-btn.btn-faturar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .sidebar-action-btn.btn-faturar:hover {
            background: linear-gradient(135deg, #0c86ea 0%, #063b80 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
        }
        
        .sidebar-action-btn.btn-faturar:hover::before {
            left: 100%;
        }
        
        .sidebar-action-btn.btn-faturar i {
            color: white;
        }

        /* Modal Histórico de Alterações - Profissional */
        .modal-historico-content {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 95vw;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-historico-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-historico-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-historico-header .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-historico-header .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-historico-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .historico-timeline-pro {
            position: relative;
            padding-left: 30px;
        }
        
        .historico-timeline-pro::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #e0e7ff 100%);
        }
        
        .historico-item-pro {
            position: relative;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 16px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
        }
        
        .historico-item-pro:hover {
            background: #f1f5f9;
            transform: translateX(4px);
        }
        
        .historico-item-pro::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .historico-item-pro.tipo-faturamento { border-left-color: #10b981; }
        .historico-item-pro.tipo-faturamento::before { background: #10b981; }
        
        .historico-item-pro.tipo-status { border-left-color: #8b5cf6; }
        .historico-item-pro.tipo-status::before { background: #8b5cf6; }
        
        .historico-item-pro.tipo-edicao { border-left-color: #f97316; }
        .historico-item-pro.tipo-edicao::before { background: #f97316; }
        
        .historico-item-pro.tipo-criacao { border-left-color: #06b6d4; }
        .historico-item-pro.tipo-criacao::before { background: #06b6d4; }
        
        .historico-item-pro.tipo-item { border-left-color: #ec4899; }
        .historico-item-pro.tipo-item::before { background: #ec4899; }
        
        .historico-header-pro {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .historico-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .historico-badge.badge-faturamento {
            background: #d1fae5;
            color: #059669;
        }
        
        .historico-badge.badge-status {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .historico-badge.badge-edicao {
            background: #ffedd5;
            color: #c2410c;
        }
        
        .historico-badge.badge-criacao {
            background: #cffafe;
            color: #0891b2;
        }
        
        .historico-badge.badge-item {
            background: #fce7f3;
            color: #be185d;
        }
        
        .historico-data-pro {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .historico-descricao-pro {
            font-size: 14px;
            color: #334155;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .historico-usuario-pro {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .historico-usuario-pro i {
            font-size: 10px;
        }
        
        .historico-empty {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .historico-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .historico-empty p {
            margin: 0;
            font-size: 14px;
        }

        .sidebar-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }

        /* Seçéo do Cliente - Melhorado */
        .cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .cliente-avatar {
            width: 44px;
            height: 44px;
            background: var(--primary-orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .cliente-info {
            flex: 1;
        }

        .cliente-info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }

        .cliente-nome-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: white;
        }

        .cliente-nome-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .btn-consulta-credito {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-consulta-credito:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .previsao-faturamento {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .previsao-label {
            font-size: 11px;
            color: #666;
        }

        .previsao-input {
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 130px;
        }

        .previsao-badge {
            width: 16px;
            height: 16px;
            background: var(--primary-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
        }

        /* Grid de Valores - Melhorado */
        .valores-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .valor-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .valor-item:last-child {
            min-width: 120px;
        }

        .valor-label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
            text-transform: capitalize;
            white-space: nowrap;
        }

        .valor-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background: #fafafa;
            color: #333;
            min-width: 0;
            width: 100%;
        }

        .valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .valor-input.highlight {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Linha de Vendedor, Parcelas, Cenário - Melhorado */
        .info-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-field label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-field input,
        .info-field select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .info-field input:focus,
        .info-field select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .btn-atualizar-impostos {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 10px;
            background: none;
            border: none;
            color: #0891b2;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-atualizar-impostos:hover {
            color: #0e7490;
            text-decoration: underline;
        }

        /* Tabs do Modal - Estilo Omie */
        .modal-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -24px;
            margin-right: -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .modal-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 12px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .modal-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .modal-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Botões de Açéo da Tabela - Estilo Omie */
        .table-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .btn-table-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-table-action.success {
            background: #22c55e;
            color: white;
        }

        .btn-table-action.success:hover {
            background: #16a34a;
        }

        .btn-table-action.warning {
            background: #f59e0b;
            color: white;
        }

        .btn-table-action.warning:hover {
            background: #d97706;
        }

        .btn-table-action.danger {
            background: #ef4444;
            color: white;
        }

        .btn-table-action.danger:hover {
            background: #dc2626;
        }

        /* Tabela de Itens - Estilo Omie */
        .items-table-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            background: white;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .items-table th {
            background: #fafafa;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            font-size: 11px;
        }

        .items-table th .filter-icon {
            color: #bbb;
            font-size: 9px;
            margin-left: 4px;
            cursor: pointer;
        }

        .items-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 12px;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        .items-table tbody tr {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .items-table tr:hover {
            background: #f9f9f9;
        }

        .items-table tr.selected {
            background: #fff7ed;
        }

        .items-table .produto-code {
            font-weight: 600;
            color: #333;
        }

        .items-table .produto-desc {
            color: #555;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Paginaçéo - Estilo Omie */
        .table-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 11px;
            color: #777;
        }

        .pagination-info {
            color: #555;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pagination-btn:hover {
            background: #f5f5f5;
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 11px;
        }

        /* Alerta de Status - Estilo Omie */
        .status-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 16px;
        }

        .status-alert.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.success {
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert.info {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            border: none;
            border-radius: 6px;
        }

        .status-alert i {
            font-size: 14px;
        }

        /* ========================== */
        /* ESTILOS MODAL NOVO ORÇAMENTO */
        /* ========================== */
        
        /* Cliente Section */
        .orcamento-cliente-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .orcamento-cliente-avatar {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 22px;
            flex-shrink: 0;
        }

        .orcamento-cliente-info {
            flex: 1;
        }

        .orcamento-cliente-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .orcamento-field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-field-group label {
            font-size: 11px;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            min-width: 180px;
            background: white;
        }

        .orcamento-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .input-with-btn .orcamento-input {
            border-radius: 4px 0 0 4px;
            border-right: none;
        }

        .input-with-btn .btn-input-action {
            padding: 8px 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            color: #666;
            transition: all 0.15s;
        }

        .input-with-btn .btn-input-action:hover {
            background: #e5e5e5;
            color: #333;
        }

        .input-with-btn .btn-input-action:last-child {
            border-radius: 0 4px 4px 0;
        }

        .input-with-btn .btn-input-action:not(:last-child) {
            border-radius: 0;
            border-right: none;
        }

        /* Dropdown de Sugestões (Autocomplete) */
        .dropdown-sugestoes {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: -1px;
        }

        .dropdown-sugestoes .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }

        .dropdown-sugestoes .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-sugestoes .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-sugestoes .dropdown-item.selected {
            background: #fff7ed;
            border-left: 3px solid #f97316;
        }

        .dropdown-sugestoes .dropdown-item .empresa-nome {
            font-weight: 500;
            color: #333;
        }

        .dropdown-sugestoes .dropdown-item .empresa-cnpj {
            font-size: 11px;
            color: #888;
        }

        /* Valores Row */
        .orcamento-valores-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .orcamento-valor-box {
            flex: 1;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .orcamento-valor-box label {
            font-size: 10px;
            color: #777;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .orcamento-valor-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            background: #fafafa;
            color: #333;
        }

        .orcamento-valor-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            background: white;
        }

        .orcamento-valor-box.destaque .orcamento-valor-input,
        .orcamento-valor-input.destaque {
            background: #fff7ed;
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 700;
        }

        /* Info Row */
        .orcamento-info-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }

        .orcamento-info-row .orcamento-field-group {
            flex: 1;
            min-width: 200px;
        }

        /* Tabs */
        .orcamento-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
            background: #fafafa;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .orcamento-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .orcamento-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.03);
        }

        .orcamento-tab.active {
            color: var(--primary-orange);
            font-weight: 600;
            background: white;
        }

        .orcamento-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-orange);
        }

        /* Tab Content */
        .orcamento-tab-content {
            display: none;
        }

        .orcamento-tab-content.active {
            display: block;
        }

        .orcamento-tab-placeholder {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .orcamento-tab-placeholder i {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        /* ===========================================
           ESTILOS PARA ABA DE IMPOSTOS
           =========================================== */
        
        .imposto-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.15s;
        }

        .imposto-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .imposto-input.valor {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .imposto-input.valor.destaque {
            font-weight: 600;
        }

        .imposto-input:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .imposto-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .imposto-field label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        /* Toggle Mini para checkboxes de impostos */
        .toggle-mini {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-mini input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-mini {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider-mini:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-mini input:checked + .toggle-slider-mini {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .toggle-mini input:checked + .toggle-slider-mini:before {
            transform: translateX(16px);
        }

        /* Impostos Grid responsivo */
        .impostos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .impostos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .impostos-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card de Imposto com animaçéo */
        .imposto-card {
            transition: all 0.2s ease;
        }

        .imposto-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Resumo de Impostos */
        .impostos-resumo .resumo-item {
            text-align: center;
        }

        .impostos-resumo .resumo-item span {
            display: block;
        }

        /* Itens Actions */
        .orcamento-itens-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .btn-orcamento-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            color: white;
            transition: all 0.15s;
        }

        .btn-orcamento-action.verde {
            background: #22c55e;
        }

        .btn-orcamento-action.verde:hover {
            background: #16a34a;
        }

        .btn-orcamento-action.laranja {
            background: #f59e0b;
        }

        .btn-orcamento-action.laranja:hover {
            background: #d97706;
        }

        .btn-orcamento-action.vermelho {
            background: #ef4444;
        }

        .btn-orcamento-action.vermelho:hover {
            background: #dc2626;
        }

        /* Tabela de Orçamento */
        .orcamento-tabela-container {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            background: white;
            margin-bottom: 12px;
        }

        .orcamento-tabela {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .orcamento-tabela thead th {
            background: #fafafa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            text-transform: uppercase;
        }

        .orcamento-tabela thead th i {
            color: #bbb;
            margin-left: 4px;
            font-size: 8px;
        }

        .orcamento-tabela thead tr.filter-row th {
            background: #f5f5f5;
            padding: 6px 8px;
        }

        .orcamento-tabela .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            background: white;
        }

        .orcamento-tabela tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        .orcamento-tabela tbody tr:hover {
            background: #f9f9f9;
        }

        .orcamento-tabela tbody tr.selected {
            background: #fff7ed;
        }

        .orcamento-tabela-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .orcamento-tabela-empty i {
            font-size: 28px;
            color: #ddd;
        }

        /* Paginaçéo */
        .orcamento-paginacao {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: #777;
        }

        .paginacao-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pag-btn {
            padding: 5px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            color: #555;
            cursor: pointer;
        }

        .pag-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pag-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pag-current {
            background: var(--primary-orange);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: 600;
        }

        .pag-text {
            color: #999;
            font-size: 10px;
        }

        /* Textarea */
        .orcamento-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        /* Frete Section */
        .orcamento-frete-section {
            padding: 10px 0;
        }

        /* Seçéo de Formulário Orçamento */
        .orcamento-section-form {
            padding: 10px 0;
        }

        .orcamento-form-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .orcamento-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }

        .orcamento-textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
        }

        .field-hint {
            display: block;
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #555;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-orange);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pendente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.pago {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.vencido {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Estilos originais mantidos para compatibilidade */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-dark);
            border-radius: 16px 16px 0 0;
        }

        .modal-header h2 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            color: var(--primary-orange);
        }

        .modal-close {
            background: none;
            border: none;
            color: #8b8b9a;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* Botéo inline de cadastro rápido */
        .btn-add-inline {
            background: linear-gradient(135deg, var(--primary-orange), #e85d04);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 6px;
            vertical-align: middle;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-inline:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(232, 93, 4, 0.3);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: #f9f9f9;
            border-radius: 0 0 16px 16px;
        }

        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-modal-cancel {
            background: #e5e5e5;
            color: var(--text-primary);
        }

        .btn-modal-cancel:hover {
            background: #d5d5d5;
        }

        .btn-modal-save {
            background: var(--primary-orange);
            color: white;
        }

        .btn-modal-save:hover {
            background: #ea580c;
        }

        .btn-modal-delete {
            background: var(--danger-red);
            color: white;
            margin-right: auto;
        }

        .btn-modal-delete:hover {
            background: #dc2626;
        }

        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f0f9ff;
            color: #0369a1;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           ESTILOS DOS MODAIS AUXILIARES
           ======================================== */
        
        /* área de Upload de Anexos */
        .anexos-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
        }

        .anexos-upload-area:hover,
        .anexos-upload-area.dragover {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .btn-upload-anexo {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .btn-upload-anexo:hover {
            background: #4f46e5;
        }

        .anexo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .anexo-item i {
            font-size: 24px;
            color: #6366f1;
        }

        .anexo-info {
            flex: 1;
        }

        .anexo-nome {
            font-weight: 500;
            color: #333;
        }

        .anexo-tamanho {
            font-size: 12px;
            color: #888;
        }

        .anexo-actions button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }

        .anexo-actions button:hover {
            color: #333;
        }

        .anexo-actions button.delete:hover {
            color: #ef4444;
        }

        /* Timeline do Histórico */
        .historico-timeline {
            position: relative;
            padding-left: 30px;
        }

        .historico-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .historico-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #8b5cf6;
        }

        .historico-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 10px;
            height: 10px;
            background: #8b5cf6;
            border-radius: 50%;
            border: 2px solid white;
        }

        .historico-data {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .historico-usuario {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .historico-descricao {
            font-size: 13px;
            color: #555;
        }

        /* Lista de Emails */
        .email-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .email-item:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .email-destinatario {
            font-weight: 600;
            color: #333;
        }

        .email-data {
            font-size: 12px;
            color: #888;
        }

        .email-assunto {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .email-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .email-status.enviado {
            background: #dcfce7;
            color: #166534;
        }

        .email-status.lido {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-enviar-email {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-enviar-email:hover {
            background: #0284c7;
        }

        /* Lista de Tarefas */
        .nova-tarefa-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-tarefa {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-tarefa:focus {
            outline: none;
            border-color: #10b981;
        }

        .btn-add-tarefa {
            background: #10b981;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-tarefa:hover {
            background: #059669;
        }

        .tarefa-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .tarefa-item:hover {
            border-color: #10b981;
        }

        .tarefa-item.concluida {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .tarefa-item.concluida .tarefa-texto {
            text-decoration: line-through;
            color: #888;
        }

        .tarefa-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .tarefa-texto {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .tarefa-delete {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
        }

        .tarefa-delete:hover {
            color: #ef4444;
        }

        /* Opções de Impresséo */
        .opcoes-impressao {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opcao-impressao {
            cursor: pointer;
        }

        .opcao-impressao input {
            display: none;
        }

        .opcao-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .opcao-content i {
            font-size: 32px;
            color: #64748b;
        }

        .opcao-content span {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .opcao-impressao input:checked + .opcao-content {
            border-color: #f97316;
            background: #fff7ed;
        }

        .opcao-impressao input:checked + .opcao-content i {
            color: #f97316;
        }

        /* Itens Pedido Parcial */
        .item-parcial {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-parcial-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #f97316;
        }

        .item-parcial-info {
            flex: 1;
        }

        .item-parcial-nome {
            font-weight: 500;
            color: #333;
        }

        .item-parcial-qtd-original {
            font-size: 12px;
            color: #888;
        }

        .item-parcial-qtd-input {
            width: 100px;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            text-align: center;
        }

        /* Botões gerais */
        .btn-primary {
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #ea580c;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* Empty State para tabela */
        .empty-table-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-table-state i {
            font-size: 48px;
            margin-bottom: 12px;
            color: #ddd;
        }

        .empty-table-state p {
            font-size: 14px;
        }

        /* ========================================
           RESPONSIVO
           ======================================== */
        @media (max-width: 768px) {
            .sidebar {
                width: 48px;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .kanban-column {
                width: 260px;
                min-width: 260px;
            }

            .search-box {
                width: 200px;
            }
        }

        /* ========================================
           ESTILOS MOBILE COMPLETOS - VENDAS
           ======================================== */
        @media (max-width: 768px) {
            /* Sidebar mobile */
            .sidebar {
                position: fixed !important;
                left: -100% !important;
                height: 100vh !important;
                width: 280px !important;
                z-index: 2000 !important;
                transition: left 0.3s ease !important;
                background: var(--primary-dark, #1e1e2d) !important;
            }

            .sidebar.open {
                left: 0 !important;
            }

            /* Mobile overlay - criado pelo mobile-menu.js */
            .mobile-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                z-index: 1999 !important;
                opacity: 0 !important;
                visibility: hidden !important;
                transition: all 0.3s ease !important;
            }

            .mobile-overlay.active {
                opacity: 1 !important;
                visibility: visible !important;
            }

            /* Header mobile */
            .header {
                padding: 0 12px !important;
            }

            .header-brand img {
                height: 20px !important;
            }

            .header-brand span {
                display: none !important;
            }

            .header-search {
                display: none !important;
            }

            .header-right .header-btn span {
                display: none !important;
            }

            /* Menu hambúrguer - ambas classes para compatibilidade */
            .btn-menu-mobile,
            .mobile-menu-btn {
                display: flex !important;
                width: 36px !important;
                height: 36px !important;
                background: rgba(255,255,255,0.1) !important;
                border: none !important;
                border-radius: 8px !important;
                color: white !important;
                font-size: 18px !important;
                cursor: pointer !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* Main area */
            .main-area {
                margin-left: 0 !important;
            }

            /* Kanban wrapper */
            .kanban-wrapper {
                padding: 0 !important;
            }

            .kanban-container {
                padding: 8px !important;
                gap: 8px !important;
            }

            .kanban-column {
                width: 85vw !important;
                min-width: 85vw !important;
                max-width: 85vw !important;
            }

            /* Modal overlay */
            .modal-overlay {
                padding: 0 !important;
                align-items: flex-start !important;
            }

            /* Modal content */
            .modal-content,
            .modal-content-omie {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }

            /* Modal header */
            .modal-header,
            .modal-header-omie {
                padding: 12px 16px !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 10 !important;
            }

            .modal-header h2,
            .modal-header-omie h2 {
                font-size: 15px !important;
            }

            .close-btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }

            .close-btn span {
                display: none !important;
            }

            /* Modal body */
            .modal-body,
            .modal-body-omie {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                padding: 12px !important;
                padding-bottom: 100px !important;
            }

            /* Tabs do orçamento */
            .orcamento-tabs {
                display: flex !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                gap: 4px !important;
                padding: 8px 0 !important;
                scrollbar-width: none !important;
            }

            .orcamento-tabs::-webkit-scrollbar {
                display: none !important;
            }

            .orcamento-tab {
                flex: 0 0 auto !important;
                padding: 8px 12px !important;
                font-size: 11px !important;
                white-space: nowrap !important;
            }

            .orcamento-tab i {
                margin-right: 4px !important;
                font-size: 10px !important;
            }

            /* Seções do formulário */
            .orcamento-section-form {
                padding: 12px !important;
            }

            .orcamento-field-group {
                margin-bottom: 12px !important;
            }

            .orcamento-field-group label {
                font-size: 11px !important;
            }

            .orcamento-input,
            .orcamento-select {
                padding: 10px 12px !important;
                font-size: 14px !important;
            }

            /* Grid de campos */
            .orcamento-row,
            .form-row,
            .form-row-3 {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }

            .orcamento-row > *,
            .form-row > *,
            .form-row-3 > * {
                width: 100% !important;
                flex: none !important;
            }

            /* Tabela de itens */
            .tabela-itens-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                margin: 0 -12px !important;
                padding: 0 12px !important;
            }

            .tabela-itens {
                min-width: 600px !important;
                font-size: 12px !important;
            }

            .tabela-itens th,
            .tabela-itens td {
                padding: 8px 6px !important;
            }

            /* Botões de açéo */
            .btn-adicionar-item {
                width: 100% !important;
                padding: 12px !important;
            }

            /* Footer do modal */
            .modal-footer-omie,
            .orcamento-footer {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                padding: 12px !important;
                background: white !important;
                border-top: 1px solid #e5e5e5 !important;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1) !important;
                z-index: 100 !important;
                display: flex !important;
                gap: 8px !important;
                flex-wrap: wrap !important;
            }

            .modal-footer-omie button,
            .orcamento-footer button {
                flex: 1 !important;
                min-width: calc(50% - 4px) !important;
                padding: 12px !important;
                font-size: 12px !important;
            }

            /* Modal Editar Pedido */
            .modal-editar-content {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                border-radius: 0 !important;
            }

            .modal-editar-header {
                padding: 12px 16px !important;
            }

            .modal-editar-body {
                padding: 12px !important;
                padding-bottom: 100px !important;
            }

            /* Modal Filtros */
            .modal-filtros-content {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
            }

            .filtros-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Modal Adicionar Item */
            .modal-item-content {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                border-radius: 0 !important;
            }

            .item-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }

            /* Modal Cliente */
            .modal-cliente-container {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                border-radius: 0 !important;
            }

            /* Autocomplete mobile */
            .dropdown-sugestoes,
            .autocomplete-dropdown {
                max-height: 200px !important;
            }

            .dropdown-item {
                padding: 12px !important;
            }

            /* Sidebar overlay */
            .sidebar-overlay-mobile {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0,0,0,0.5) !important;
                z-index: 1999 !important;
                opacity: 0 !important;
                visibility: hidden !important;
                transition: all 0.3s !important;
            }

            .sidebar-overlay-mobile.show {
                opacity: 1 !important;
                visibility: visible !important;
            }
        }

        /* Telas muito pequenas */
        @media (max-width: 480px) {
            .kanban-column {
                width: 95vw !important;
                min-width: 95vw !important;
                max-width: 95vw !important;
            }

            .orcamento-tab {
                padding: 6px 10px !important;
            }

            .orcamento-tab i {
                display: none !important;
            }

            .modal-footer-omie button,
            .orcamento-footer button {
                flex: 1 1 100% !important;
            }
        }

        /* ========================================
           MODAL FILTROS KANBAN (Estilo Omie)
           ======================================== */
        .modal-filtros-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.2s ease;
        }

        .modal-filtros-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
        }

        .modal-filtros-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-filtros-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-filtros-header .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-filtros-header .close-btn i {
            font-size: 12px;
        }

        .modal-filtros-body {
            padding: 24px;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filtro-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .filtro-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filtro-select:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .filtros-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .filtro-input-search {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filtro-input-search input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filtro-input-search input:focus {
            outline: none;
            border-color: #f97316;
        }

        .filtro-input-search button {
            width: 40px;
            height: 40px;
            border: none;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }

        .filtro-input-search button:hover {
            background: #f97316;
            color: white;
        }

        .filtros-toggles {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #f97316;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 13px;
            color: #555;
        }

        .filtros-info-box {
            background: #fff9e6;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .filtros-info-box p {
            font-size: 13px;
            color: #7a5a00;
            line-height: 1.5;
        }

        .filtros-info-box strong {
            color: #b38600;
        }

        .modal-filtros-footer {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 20px 24px;
            border-top: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .btn-desfazer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-desfazer:hover {
            background: #ea580c;
        }

        .btn-atualizar-filtro {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-atualizar-filtro:hover {
            background: #059669;
        }

        /* Modal Selecionar Vendedor */
        .modal-vendedor-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .vendedor-search-bar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
            gap: 12px;
        }

        .vendedor-search-bar .filter-icon {
            width: 40px;
            height: 40px;
            background: #f97316;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .vendedor-search-bar input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #f97316;
        }

        .vendedor-search-bar input::placeholder {
            color: #f97316;
        }

        .vendedor-search-bar .search-btn {
            width: 40px;
            height: 40px;
            background: #f97316;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .vendedor-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .vendedor-item {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #333;
        }

        .vendedor-item:hover {
            background: #f5f5f5;
        }

        .vendedor-item.selected {
            background: #fff7ed;
            color: #f97316;
            font-weight: 500;
        }

        .vendedor-item:nth-child(odd) {
            background: #fafafa;
        }

        .vendedor-item:nth-child(odd):hover {
            background: #f0f0f0;
        }

        /* ========================================
           MODAL CONFIRMAÇéO ALTERAÇÕES
           ======================================== */
        .modal-confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        .modal-confirm-overlay.active {
            display: flex;
        }

        .modal-confirm-content {
            background: white;
            border-radius: 12px;
            padding: 32px 48px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.2s ease;
            max-width: 400px;
            width: 90%;
            position: relative;
            z-index: 100000;
        }

        .modal-confirm-content h3 {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
        }

        .modal-confirm-content .link-alteracoes {
            color: #14b8a6;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            display: block;
            margin-bottom: 24px;
        }

        .modal-confirm-content .link-alteracoes:hover {
            text-decoration: underline;
        }

        .modal-confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 100001;
        }

        .btn-confirm-sim {
            padding: 10px 32px;
            background: #e5e7eb;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-sim:hover {
            background: #d1d5db;
        }

        .btn-confirm-nao {
            padding: 10px 32px;
            background: white;
            color: #14b8a6;
            border: 2px solid #14b8a6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
        }

        .btn-confirm-nao:hover {
            background: #f0fdfa;
        }

        /* Lista de alterações */
        .alteracoes-lista {
            display: none;
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .alteracoes-lista.show {
            display: block;
        }

        .alteracoes-lista ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .alteracoes-lista li {
            font-size: 13px;
            color: #555;
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .alteracoes-lista li:last-child {
            border-bottom: none;
        }

        .alteracoes-lista li i {
            color: #f97316;
            margin-right: 8px;
        }

        /* ========================================
           MODAL CONFIGURAÇÃO ETAPAS KANBAN
           ======================================== */
        .btn-config-etapas {
            border: none !important;
            border-radius: 4px !important;
            margin-right: 8px;
        }

        .btn-config-etapas:hover {
            background: rgba(255,255,255,0.15) !important;
        }

        .modal-etapas-content {
            background: white;
            border-radius: 12px;
            width: 98%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.25s ease;
        }

        .modal-etapas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 28px;
            border-bottom: 2px solid #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
        }

        .modal-etapas-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #3b82f6;
            display: flex;
            align-items: center;
        }

        .modal-etapas-header .close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-etapas-header .close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .modal-etapas-header .close-btn i {
            font-size: 12px;
        }

        .modal-etapas-body {
            padding: 28px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-etapas-body > p {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px dashed #e5e5e5;
        }

        /* Container de etapas dinâmico */
        .etapas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #e5e5e5;
            min-height: 100px;
        }

        .etapa-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            min-width: 150px;
            max-width: 180px;
            flex: 1 1 150px;
            position: relative;
            transition: all 0.2s ease;
            cursor: grab;
        }

        .etapa-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59,130,246,0.15);
            transform: translateY(-2px);
        }

        .etapa-item.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .etapa-item.drag-over {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .etapa-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .etapa-item-number {
            font-size: 11px;
            font-weight: 600;
            color: #3b82f6;
            background: #eff6ff;
            padding: 2px 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .etapa-item-number i {
            font-size: 10px;
            cursor: grab;
        }

        .etapa-item-actions {
            display: flex;
            gap: 4px;
        }

        .etapa-item-actions button {
            width: 22px;
            height: 22px;
            border: none;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            transition: all 0.15s;
        }

        .etapa-item-actions button:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .etapa-item-actions button.btn-mover:hover {
            background: #dbeafe;
            color: #2563eb;
        }

        .etapa-item input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: #fafafa;
            transition: all 0.2s;
        }

        .etapa-item input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .etapa-item.etapa-destaque {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #60a5fa;
        }

        .etapa-item.etapa-destaque input {
            background: white;
            border-color: #60a5fa;
        }

        /* Ações de etapas */
        .etapas-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .btn-adicionar-etapa {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-adicionar-etapa:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        .btn-adicionar-etapa i {
            font-size: 16px;
        }

        .etapas-counter {
            font-size: 13px;
            color: #888;
            font-style: italic;
        }

        .etapas-info-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #86efac;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .etapas-info-box i {
            color: #22c55e;
            font-size: 18px;
            margin-top: 1px;
        }

        .etapas-info-box p {
            font-size: 13px;
            color: #166534;
            line-height: 1.6;
            margin: 0;
        }

        .modal-etapas-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 28px;
            border-top: 1px solid #e5e5e5;
            background: #f8fafc;
        }

        .alterar-numeracao {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #555;
        }

        .alterar-numeracao .checkbox-container {
            position: relative;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .alterar-numeracao .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .alterar-numeracao .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .alterar-numeracao .checkbox-container:hover input ~ .checkmark {
            border-color: #f97316;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark {
            background-color: #f97316;
            border-color: #f97316;
        }

        .alterar-numeracao .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .alterar-numeracao .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .alterar-numeracao .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .alterar-numeracao i {
            color: #3b82f6;
        }

        .alterar-numeracao strong {
            color: #3b82f6;
        }

        .modal-etapas-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-cancelar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancelar-etapas:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .btn-confirmar-etapas {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        .btn-confirmar-etapas:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,197,94,0.4);
        }

        @media (max-width: 768px) {
            .etapas-container {
                flex-direction: column;
            }
            
            .etapa-item {
                max-width: 100%;
            }
            
            .modal-etapas-footer {
                flex-direction: column;
                gap: 16px;
            }
            
            .alterar-numeracao {
                text-align: center;
            }
        }
        
        /* TABLET RESPONSIVO - Portrait e Landscape */
        @media (min-width: 768px) and (max-width: 1024px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .main-grid { grid-template-columns: 1fr; }
            .sidebar { width: 56px; }
            .main-area { margin-left: 56px; }
            .kanban-grid { grid-template-columns: repeat(2, 1fr); }
            .kpi-card { padding: 16px; }
            .kpi-value { font-size: 1.5rem; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .main-area { margin-left: 56px; }
            .sidebar { width: 56px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .kanban-grid { grid-template-columns: 1fr; }
        }
        
        @media (min-width: 768px) and (max-width: 1280px) and (orientation: landscape) {
            .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .kpi-value { font-size: 1.3rem; }
            .kanban-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
    <script>
        // Funções stub para evitar erros antes do carregamento completo
        // Seréo sobrescritas pelas funções reais no script principal
        function toggleNotificacoes() {
            const panel = document.getElementById('notification-panel');
            if (panel) panel.classList.toggle('active');
        }
        function abrirModalEtapas() { console.log('Carregando...'); }
        function marcarTodasLidas() { console.log('Carregando...'); }
    </script>
    <script src="/js/anti-copy-protection.js"></script>
    <script src="js/vendas-admin-check.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Lateral -->
        <aside class="sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>
            
            <nav class="sidebar-nav">
                <button class="sidebar-btn active" title="Kanban" onclick="window.location.href='index.html'">
                    <i class="fas fa-columns"></i>
                </button>
                <button class="sidebar-btn" title="Pedidos" onclick="window.location.href='pedidos.html'">
                    <i class="fas fa-clipboard-list"></i>
                </button>
                <button class="sidebar-btn" title="Clientes" onclick="window.location.href='clientes.html'">
                    <i class="fas fa-users"></i>
                </button>
                <button class="sidebar-btn" title="Prospecções & Leads" onclick="window.location.href='prospeccao.html'">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="sidebar-btn" title="Estoque" onclick="window.location.href='estoque.html'">
                    <i class="fas fa-boxes-stacked"></i>
                </button>
                <button class="sidebar-btn" title="Meu Dashboard" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-chart-pie"></i>
                </button>
                <button class="sidebar-btn" title="Gestéo de Vendas" onclick="window.location.href='dashboard-admin.html'">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="sidebar-btn" title="Relatórios" onclick="window.location.href='relatorios.html'">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="sidebar-btn" title="Comissões" onclick="window.location.href='comissoes.html'">
                    <i class="fas fa-percentage"></i>
                </button>
            </nav>

            <div class="sidebar-bottom">
                <button class="sidebar-btn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <div class="header-brand">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE">
                        <span>|</span>
                        <span>Vendas</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn btn-config-etapas" title="Configurar Etapas do Kanban" onclick="abrirModalEtapas()">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="notification-container">
                        <button class="header-btn notification-btn" title="Notificações" onclick="toggleNotificacoes()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count">3</span>
                        </button>
                        <div class="notification-panel" id="notification-panel">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell"></i> Notificações</h3>
                                <div class="notification-actions">
                                    <button onclick="marcarTodasLidas()" title="Marcar todas como lidas">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                    <button onclick="limparNotificacoes()" title="Limpar todas">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="notification-tabs">
                                <button class="notif-tab active" onclick="filtrarNotificacoes('todas', this)">Todas</button>
                                <button class="notif-tab" onclick="filtrarNotificacoes('nao-lidas', this)">Néo lidas</button>
                                <button class="notif-tab" onclick="filtrarNotificacoes('importantes', this)">Importantes</button>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <!-- Notificações seréo inseridas via JavaScript -->
                            </div>
                            <div class="notification-footer">
                                <a href="#" onclick="verTodasNotificacoes(); return false;">Ver histórico completo</a>
                            </div>
                        </div>
                    </div>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img src="" alt="Foto do usuário" id="user-photo">
                            <span id="user-initial">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs removidas conforme solicitaçéo -->

            <!-- Barra de Ações Rápidas -->
            <div class="quick-actions-bar" style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <button class="btn-action-primary" onclick="abrirModalNovoPedido()" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;">
                    <i class="fas fa-plus"></i>
                    <span>Novo Pedido</span>
                </button>
                <button class="btn-action-secondary" onclick="abrirModalNovoCliente()" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-user-plus"></i>
                    <span>Novo Cliente</span>
                </button>
                <div style="flex: 1;"></div>
                <button class="btn-action-icon" onclick="abrirModalExportar()" title="Exportar Dados" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: white; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-download"></i>
                </button>
            </div>

            <!-- Filtros -->
            <div class="filters-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Digite o que deseja pesquisar" id="search-input">
                </div>
                <a class="filter-link" id="filter-toggle">Exibindo tudo</a>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-container">
                <div class="kanban-board" id="kanban-board">
                    
                    <!-- Coluna: Orçamento -->
                    <div class="kanban-column" data-status="orcamento">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Orçamento</div>
                                <div class="column-count" id="count-orcamento">Carregando...</div>
                            </div>
                            <div class="column-indicator orcamento"></div>
                        </div>
                        <div class="kanban-column-content" id="col-orcamento">
                            <!-- Cards seréo inseridos aqui -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-new-card" onclick="novoOrcamento()">
                                <i class="fas fa-plus"></i> Novo Orçamento
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Análise de Crédito -->
                    <div class="kanban-column" data-status="analise">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Análise de Crédito</div>
                                <div class="column-count" id="count-analise">12 registros</div>
                            </div>
                            <div class="column-indicator analise"></div>
                        </div>
                        <div class="kanban-column-content" id="col-analise">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Pedido Aprovado -->
                    <div class="kanban-column" data-status="aprovado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Pedido Aprovado</div>
                                <div class="column-count" id="count-aprovado">5 registros</div>
                            </div>
                            <div class="column-indicator aprovado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-aprovado">
                            <!-- Cards -->
                        </div>
                    </div>

                    <!-- Coluna: Faturar -->
                    <div class="kanban-column" data-status="faturar">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturar</div>
                                <div class="column-count" id="count-faturar">23 registros</div>
                            </div>
                            <div class="column-indicator faturar"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturar">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card" id="btn-faturar-todos" onclick="faturarTodos()" style="display: none;">
                                <i class="fas fa-bolt"></i> Faturar Todos
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Faturado -->
                    <div class="kanban-column" data-status="faturado">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Faturado</div>
                                <div class="column-count" id="count-faturado">52 registros</div>
                            </div>
                            <div class="column-indicator faturado"></div>
                        </div>
                        <div class="kanban-column-content" id="col-faturado">
                            <!-- Cards -->
                        </div>
                        <div class="kanban-column-footer">
                            <button class="btn-action-card teal" id="btn-comunicar-sefaz" onclick="comunicarSefaz()" style="display: none;">
                                <i class="fas fa-sync"></i> Comunicar com a SEFAZ
                            </button>
                        </div>
                    </div>

                    <!-- Coluna: Recibo -->
                    <div class="kanban-column" data-status="recibo">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">Recibo</div>
                                <div class="column-count" id="count-recibo">Nenhum registro</div>
                            </div>
                            <div class="column-indicator recibo"></div>
                        </div>
                        <div class="kanban-column-content" id="col-recibo">
                            <div class="empty-column">
                                <i class="fas fa-receipt"></i>
                                <p>Nenhum recibo pendente</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal Editar Pedido -->
    <!-- Modal Editar Pedido - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-editar-pedido">
        <div class="modal-content-omie">
            <!-- Header -->
            <div class="modal-header-omie">
                <h2 id="modal-titulo-pedido">Orçamento Nº 233</h2>
                <button class="close-btn" onclick="fecharModalEditar()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- área de Conteúdo Principal -->
                <div class="modal-main-content">
                    <!-- Seçéo do Cliente -->
                    <div class="cliente-section">
                        <div class="cliente-avatar" id="modal-cliente-avatar">IE</div>
                        <div class="cliente-info">
                            <div class="cliente-info-header">
                                <label style="font-size: 11px; color: #888; margin-bottom: 0;">Cliente <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></label>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; position: relative;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" class="cliente-nome-input" id="edit-cliente" placeholder="Digite para buscar cliente..." style="width: 100%;" autocomplete="off">
                                    <input type="hidden" id="edit-cliente-id">
                                    <div id="dropdown-edit-clientes" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 9999;"></div>
                                </div>
                                <button type="button" class="btn-consulta-credito" onclick="consultarCreditoEdit()">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="previsao-faturamento">
                                    <span class="previsao-label">Previséo de Faturamento</span>
                                    <div class="previsao-badge"><i class="fas fa-exclamation" style="font-size: 8px;"></i></div>
                                    <input type="date" class="previsao-input" id="edit-previsao-faturamento">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Valores -->
                    <div class="valores-grid">
                        <div class="valor-item">
                            <label class="valor-label">Total de Mercadorias</label>
                            <input type="text" class="valor-input" id="edit-total-mercadorias" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor do Desconto</label>
                            <input type="text" class="valor-input" id="edit-desconto" value="0,00" placeholder="0,00">
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de IPI</label>
                            <input type="text" class="valor-input" id="edit-ipi" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Total de ICMS ST</label>
                            <input type="text" class="valor-input" id="edit-icms-st" value="0,00" readonly>
                        </div>
                        <div class="valor-item">
                            <label class="valor-label">Valor</label>
                            <input type="text" class="valor-input highlight" id="edit-valor-total" value="R$ 0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha de Vendedor, Parcelas, Cenário -->
                    <div class="info-row">
                        <div class="info-field">
                            <label>Vendedor</label>
                            <select id="edit-vendedor">
                                <option value="">Selecione o vendedor...</option>
                                <option value="Augusto Ladeira dos Santos">Augusto Ladeira</option>
                                <option value="Renata Maria Batista do Nascimento">Renata Nascimento</option>
                                <option value="Marcia Oliveira do Nascimento Scarcella">Marcia Scarcella</option>
                                <option value="Fabiano Marques de Oliveira">Fabiano Marques</option>
                                <option value="Andreia">Andreia</option>
                                <option value="Fabiola de Souza Santos">Fabiola Souza</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <label>Número de Parcelas</label>
                            <input type="text" id="edit-parcelas" placeholder="Ex: 28/35/42/49">
                        </div>
                        <div class="info-field">
                            <label>Cenário Fiscal</label>
                            <select id="edit-cenario-fiscal">
                                <option value="Padréo">Padréo</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                            </select>
                        </div>
                        <button type="button" class="btn-atualizar-impostos">
                            <i class="fas fa-sync-alt"></i> Atualizar os impostos dos itens
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div class="modal-tabs">
                        <button class="modal-tab active" data-tab="itens" onclick="switchModalTab('itens')">Itens da Venda</button>
                        <button class="modal-tab" data-tab="departamentos" onclick="switchModalTab('departamentos')">Departamentos</button>
                        <button class="modal-tab" data-tab="frete" onclick="switchModalTab('frete')">Frete e Outras Despesas</button>
                        <button class="modal-tab" data-tab="informacoes" onclick="switchModalTab('informacoes')">Informações Adicionais</button>
                        <button class="modal-tab" data-tab="parcelas" onclick="switchModalTab('parcelas')">Parcelas</button>
                        <button class="modal-tab" data-tab="observacoes" onclick="switchModalTab('observacoes')">Observações</button>
                        <button class="modal-tab" data-tab="email" onclick="switchModalTab('email')">E-mail para o Cliente</button>
                    </div>

                    <!-- Tab Content: Itens da Venda -->
                    <div class="tab-content active" id="tab-itens">
                        <!-- Botões de Açéo -->
                        <div class="table-actions">
                            <button type="button" class="btn-table-action success" onclick="adicionarItem()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-table-action warning" onclick="editarItemSelecionado()">
                                <i class="fas fa-pen"></i> Editar Item
                            </button>
                            <button type="button" class="btn-table-action danger" onclick="excluirItemSelecionado()">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Produto <i class="fas fa-sort filter-icon"></i></th>
                                        <th>Descriçéo do Produto</th>
                                        <th>Quantidade</th>
                                        <th>Quantidade (Parcial)</th>
                                        <th>Local de Estoque</th>
                                        <th>Preço Unitário</th>
                                    </tr>
                                </thead>
                                <tbody id="itens-pedido-tbody">
                                    <tr>
                                        <td class="produto-code">ITEM001</td>
                                        <td class="produto-desc">AL CONESUL VALVULAS INDUST...</td>
                                        <td>1.000 M</td>
                                        <td>0 M</td>
                                        <td>PADRAO - Local de Estoque Padréo</td>
                                        <td>R$ 11.540,00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginaçéo -->
                        <div class="table-pagination">
                            <span class="pagination-info" id="pagination-info">1 - 1 de 1 registros</span>
                            <div class="pagination-controls">
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-left"></i> anterior</button>
                                <span class="pagination-current">1</span>
                                <button class="pagination-btn" disabled>próximo <i class="fas fa-angle-right"></i></button>
                                <button class="pagination-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Departamentos -->
                    <div class="tab-content" id="tab-departamentos">
                        <div class="empty-table-state">
                            <i class="fas fa-building"></i>
                            <p>Nenhum departamento configurado</p>
                        </div>
                    </div>

                    <!-- Tab Content: Frete e Transporte -->
                    <div class="tab-content" id="tab-frete">
                        <!-- Linha 1: Transportadora, Tipo Frete, Placa, UF, RNTRC -->
                        <div class="form-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 0.5fr 1fr; gap: 12px;">
                            <div class="form-group" style="position: relative;">
                                <label><i class="fas fa-truck" style="color: #f97316;"></i> Transportadora</label>
                                <input type="text" id="edit-transportadora" placeholder="Digite para buscar transportadora..." autocomplete="off">
                                <input type="hidden" id="edit-transportadora-id">
                                <div id="dropdown-edit-transportadoras" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 9999;"></div>
                            </div>
                            <div class="form-group">
                                <label>Tipo do Frete</label>
                                <select id="edit-tipo-frete">
                                    <option value="">Selecione...</option>
                                    <option value="0">0 - Contrataçéo do Frete por conta do Remetente (CIF)</option>
                                    <option value="1">1 - Contrataçéo do Frete por conta do Destinatário (FOB)</option>
                                    <option value="2">2 - Contrataçéo do Frete por conta de Terceiros</option>
                                    <option value="3">3 - Transporte Próprio por conta do Remetente</option>
                                    <option value="4">4 - Transporte Próprio por conta do Destinatário</option>
                                    <option value="9">9 - Sem Ocorrência de Transporte</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Placa do Veículo</label>
                                <input type="text" id="edit-placa-veiculo" placeholder="ABC-1234" maxlength="8" style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label>UF</label>
                                <select id="edit-veiculo-uf" style="min-width: 70px;">
                                    <option value=""></option>
                                    <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                    <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                    <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                    <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                    <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                    <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                    <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                    <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                    <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>RNTRC (ANTT)</label>
                                <input type="text" id="edit-rntrc" placeholder="Registro ANTT" maxlength="20">
                            </div>
                        </div>

                        <!-- Linha 2: Volumes -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Quantidade de Volumes</label>
                                <input type="number" id="edit-qtd-volumes" min="0" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Espécie dos Volumes</label>
                                <input type="text" id="edit-especie-volumes" placeholder="Ex: Caixa, Bobina...">
                            </div>
                            <div class="form-group">
                                <label>Marca dos Volumes</label>
                                <input type="text" id="edit-marca-volumes" placeholder="Marca">
                            </div>
                            <div class="form-group">
                                <label>Numeraçéo dos Volumes</label>
                                <input type="text" id="edit-numeracao-volumes" placeholder="Ex: 1/10">
                            </div>
                        </div>

                        <!-- Linha 3: Pesos e Valores -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Peso Líquido (Kg)</label>
                                <input type="number" id="edit-peso-liquido" step="0.001" min="0" placeholder="0,000">
                            </div>
                            <div class="form-group">
                                <label>Peso Bruto (Kg)</label>
                                <input type="number" id="edit-peso-bruto" step="0.001" min="0" placeholder="0,000">
                            </div>
                            <div class="form-group">
                                <label>Valor do Frete</label>
                                <input type="number" id="edit-valor-frete" step="0.01" min="0" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Valor do Seguro</label>
                                <input type="number" id="edit-valor-seguro" step="0.01" min="0" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Entrega</label>
                                <select id="edit-tipo-entrega">
                                    <option value="">Selecione...</option>
                                    <option value="normal">Normal</option>
                                    <option value="expressa">Expressa</option>
                                    <option value="agendada">Agendada</option>
                                    <option value="retira">Retira no Local</option>
                                </select>
                            </div>
                        </div>

                        <!-- Linha 4: Lacre, Despesas, Previséo, Rastreio -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Número do Lacre</label>
                                <input type="text" id="edit-numero-lacre" placeholder="Lacre">
                            </div>
                            <div class="form-group">
                                <label>Outras Despesas Acessórias</label>
                                <input type="number" id="edit-outras-despesas" step="0.01" min="0" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Previséo de Entrega</label>
                                <input type="date" id="edit-previsao-entrega">
                            </div>
                            <div class="form-group">
                                <label>Código de Rastreio</label>
                                <input type="text" id="edit-codigo-rastreio" placeholder="Código de rastreamento">
                            </div>
                        </div>

                        <!-- Linha 5: Checkbox veículo próprio e link ICMS -->
                        <div class="form-row" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="edit-veiculo-proprio" style="width: 18px; height: 18px; cursor: pointer;">
                                O transporte será realizado com veículo próprio
                            </label>
                            <a href="#" onclick="abrirModalICMSTransporte(); return false;" style="color: #f97316; font-size: 13px; text-decoration: none;">
                                <i class="fas fa-info-circle"></i> Informar os valores para o ICMS Retido do Serviço de Transporte
                            </a>
                        </div>
                    </div>

                    <!-- Tab Content: Informações Adicionais -->
                    <div class="tab-content" id="tab-informacoes">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nota Fiscal</label>
                                <input type="text" id="edit-nf" placeholder="Número da NF">
                            </div>
                            <div class="form-group">
                                <label>Origem</label>
                                <select id="edit-origem">
                                    <option value="Omie">Omie</option>
                                    <option value="Sistema">Sistema</option>
                                    <option value="Manual">Manual</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Informações Complementares</label>
                            <textarea id="edit-info-complementar" placeholder="Informações adicionais para a nota fiscal..." style="min-height: 100px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: Parcelas -->
                    <div class="tab-content" id="tab-parcelas">
                        <div class="form-group">
                            <label>Condiçéo de Pagamento <button type="button" onclick="abrirModalNovaCondicao()" class="btn-add-inline" title="Cadastrar condiçéo"><i class="fas fa-plus"></i></button></label>
                            <select id="edit-condicao-pagamento">
                                <option value="a vista">À Vista</option>
                                <option value="28/35/42/49">28/35/42/49 dias</option>
                                <option value="30/60">30/60 dias</option>
                                <option value="30/60/90">30/60/90 dias</option>
                                <option value="30/60/90/120">30/60/90/120 dias</option>
                            </select>
                        </div>
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Forma de Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody id="parcelas-tbody">
                                    <tr>
                                        <td>1/4</td>
                                        <td>14/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>2/4</td>
                                        <td>21/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>3/4</td>
                                        <td>28/01/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                    <tr>
                                        <td>4/4</td>
                                        <td>04/02/2026</td>
                                        <td>R$ 20.195,00</td>
                                        <td>Boleto</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Content: Observações -->
                    <div class="tab-content" id="tab-observacoes">
                        <div class="form-group">
                            <label>Observações Internas</label>
                            <textarea id="edit-observacoes" placeholder="Observações internas (néo aparecem na NF)..." style="min-height: 120px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Observações para o Cliente</label>
                            <textarea id="edit-observacoes-cliente" placeholder="Observações que apareceréo para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                    </div>

                    <!-- Tab Content: E-mail -->
                    <div class="tab-content" id="tab-email">
                        <div class="form-group">
                            <label>E-mail do Cliente</label>
                            <input type="email" id="edit-email-cliente" placeholder="email@cliente.com.br">
                        </div>
                        <div class="form-group">
                            <label>Assunto</label>
                            <input type="text" id="edit-email-assunto" placeholder="Orçamento Nº 233 - ALUFORCE">
                        </div>
                        <div class="form-group">
                            <label>Mensagem</label>
                            <textarea id="edit-email-mensagem" placeholder="Mensagem personalizada para o cliente..." style="min-height: 120px;"></textarea>
                        </div>
                        <button type="button" class="btn-table-action success" style="margin-top: 12px;">
                            <i class="fas fa-paper-plane"></i> Enviar E-mail
                        </button>
                    </div>

                    <!-- Alerta de Status -->
                    <div class="status-alert warning" id="status-alert">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="status-alert-text">Faturamento atrasado</span>
                    </div>

                    <!-- Campo oculto para ID -->
                    <input type="hidden" id="edit-pedido-id">
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions">
                    <button class="sidebar-action-btn primary" onclick="salvarPedido()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button class="sidebar-action-btn" onclick="incluirPedido()">
                        <i class="fas fa-plus-circle"></i> Incluir
                    </button>
                    <button class="sidebar-action-btn" onclick="imprimirPedido()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="sidebar-action-btn" onclick="duplicarPedido()">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    <button class="sidebar-action-btn" onclick="conferirPedido()">
                        <i class="fas fa-check-circle"></i> Conferir
                    </button>
                    <button class="sidebar-action-btn btn-faturar" onclick="faturarPedido()">
                        <i class="fas fa-file-invoice-dollar"></i> Faturar Agora
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn" onclick="verAnexos()">
                        <i class="fas fa-paperclip"></i> Anexos
                    </button>
                    <button class="sidebar-action-btn" onclick="verEmailsEnviados()">
                        <i class="fas fa-envelope"></i> Emails Enviados
                    </button>
                    <button class="sidebar-action-btn" onclick="verHistorico()">
                        <i class="fas fa-history"></i> Histórico de Alterações
                    </button>
                    <button class="sidebar-action-btn" onclick="verTarefas()">
                        <i class="fas fa-tasks"></i> Tarefas
                    </button>
                    
                    <button class="sidebar-action-btn outline-primary" onclick="pedidoParcial()">
                        <i class="fas fa-random"></i> Pedido Parcial
                    </button>
                    
                    <div class="sidebar-divider"></div>
                    
                    <button class="sidebar-action-btn danger" onclick="excluirPedido()">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button class="sidebar-action-btn danger" onclick="cancelarPedido()">
                        <i class="fas fa-ban"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Anexos -->
    <div class="modal-overlay" id="modal-anexos">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                <h2><i class="fas fa-paperclip"></i> Anexos do Pedido</h2>
                <button class="modal-close" onclick="fecharModalAnexos()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="anexos-upload-area" id="anexos-upload-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6366f1; margin-bottom: 10px;"></i>
                    <p style="color: #666;">Arraste arquivos aqui ou clique para selecionar</p>
                    <input type="file" id="input-anexo" multiple style="display: none;" onchange="processarAnexos(this.files)">
                    <button type="button" class="btn-upload-anexo" onclick="document.getElementById('input-anexo').click()">
                        <i class="fas fa-folder-open"></i> Selecionar Arquivos
                    </button>
                </div>
                <div class="anexos-lista" id="anexos-lista">
                    <h4 style="margin: 15px 0 10px; color: #333;">Arquivos Anexados</h4>
                    <div id="lista-anexos-container">
                        <p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico de Alterações - Profissional -->
    <div class="modal-overlay" id="modal-historico">
        <div class="modal-historico-content">
            <div class="modal-historico-header">
                <h2><i class="fas fa-history"></i> Histórico de Alterações</h2>
                <button class="close-btn" onclick="fecharModalHistorico()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-historico-body">
                <div class="historico-timeline-pro" id="historico-timeline">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Emails Enviados -->
    <div class="modal-overlay" id="modal-emails">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                <h2><i class="fas fa-envelope"></i> Emails Enviados</h2>
                <button class="modal-close" onclick="fecharModalEmails()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="emails-lista" id="emails-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" class="btn-enviar-email" onclick="abrirEnviarEmail()">
                        <i class="fas fa-paper-plane"></i> Enviar Novo Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarefas -->
    <div class="modal-overlay" id="modal-tarefas">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h2><i class="fas fa-tasks"></i> Tarefas do Pedido</h2>
                <button class="modal-close" onclick="fecharModalTarefas()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="nova-tarefa-form">
                    <input type="text" id="input-nova-tarefa" placeholder="Adicionar nova tarefa..." class="input-tarefa">
                    <button type="button" class="btn-add-tarefa" onclick="adicionarTarefa()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tarefas-lista" id="tarefas-lista">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Imprimir - SaaS Enterprise Style -->
    <div class="modal-overlay" id="modal-imprimir">
        <div class="modal-content" style="max-width: 480px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header com estilo institucional -->
            <div class="modal-header" style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0c4a6e 100%); padding: 24px 28px; border: none;">
                <div style="display: flex; align-items: center; gap: 14px;">
                    <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        <i class="fas fa-file-pdf" style="font-size: 20px; color: #fff;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #fff;">Exportar Documento</h2>
                        <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.7); font-weight: 400;">Gerar arquivo PDF profissional</p>
                    </div>
                </div>
                <button class="modal-close" onclick="fecharModalImprimir()" style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 10px; color: #fff; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body com informações do documento -->
            <div class="modal-body" style="padding: 0; background: #f8fafc;">
                <!-- Card do documento -->
                <div style="padding: 24px 28px; background: #fff; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-file-pdf" style="font-size: 26px; color: #fff;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <p style="font-size: 16px; color: #0f172a; margin: 0 0 4px 0; font-weight: 600;" id="pdf-numero-orcamento">Orçamento Nº 000000</p>
                            <p style="font-size: 13px; color: #64748b; margin: 0 0 8px 0;" id="pdf-cliente-nome">Cliente néo identificado</p>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: #0369a1; background: #e0f2fe; padding: 4px 10px; border-radius: 6px; font-weight: 500;">
                                    <i class="fas fa-file-alt"></i> Documento Fiscal
                                </span>
                                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: #047857; background: #d1fae5; padding: 4px 10px; border-radius: 6px; font-weight: 500;">
                                    <i class="fas fa-check-circle"></i> Completo
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Informações do PDF -->
                <div style="padding: 20px 28px;">
                    <p style="font-size: 12px; color: #64748b; margin: 0 0 12px 0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-info-circle" style="margin-right: 6px;"></i>Conteúdo do documento
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <i class="fas fa-user" style="color: #6366f1; font-size: 14px;"></i>
                            <span style="font-size: 13px; color: #475569;">Dados do Cliente</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <i class="fas fa-boxes" style="color: #8b5cf6; font-size: 14px;"></i>
                            <span style="font-size: 13px; color: #475569;">Itens do Pedido</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <i class="fas fa-calculator" style="color: #10b981; font-size: 14px;"></i>
                            <span style="font-size: 13px; color: #475569;">Valores e Totais</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <i class="fas fa-sticky-note" style="color: #f59e0b; font-size: 14px;"></i>
                            <span style="font-size: 13px; color: #475569;">Observações</span>
                        </div>
                    </div>
                </div>
                
                <!-- Footer com botões -->
                <div style="padding: 20px 28px; background: #fff; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="fecharModalImprimir()" style="padding: 12px 24px; border-radius: 10px; border: 1px solid #e2e8f0; background: #fff; color: #475569; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" onclick="executarImpressaoCompleta()" style="padding: 12px 28px; border-radius: 10px; border: none; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 14px rgba(15, 23, 42, 0.25);">
                        <i class="fas fa-download"></i> Gerar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Critários de Seleçéo (Filtros do Kanban) -->
    <div class="modal-overlay" id="modal-filtros-kanban">
        <div class="modal-filtros-content">
            <div class="modal-filtros-header">
                <h2>Critários de Seleçéo</h2>
                <button class="close-btn" onclick="fecharModalFiltros()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-filtros-body">
                <div class="filtros-grid">
                    <div class="filtro-group">
                        <label>Considerar Data de Incluséo</label>
                        <select class="filtro-select" id="filtro-data-inclusao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">últimos 3 dias</option>
                            <option value="ultimos-7">últimos 7 dias</option>
                            <option value="ultimos-15">últimos 15 dias</option>
                            <option value="ultimos-30">últimos 30 dias</option>
                            <option value="ultimos-90">últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Previséo</label>
                        <select class="filtro-select" id="filtro-data-previsao">
                            <option value="tudo">Tudo</option>
                            <option value="hoje">Hoje</option>
                            <option value="amanha">Amanhá</option>
                            <option value="proximos-3">Próximos 3 dias</option>
                            <option value="proximos-7">Próximos 7 dias</option>
                            <option value="proximos-15">Próximos 15 dias</option>
                            <option value="proximos-30">Próximos 30 dias</option>
                            <option value="proximos-90">Próximos 90 dias</option>
                            <option value="ontem">Ontem</option>
                            <option value="ultimos-3">últimos 3 dias</option>
                            <option value="ultimos-7">últimos 7 dias</option>
                            <option value="ultimos-15">últimos 15 dias</option>
                            <option value="ultimos-30">últimos 30 dias</option>
                            <option value="ultimos-60">últimos 60 dias</option>
                            <option value="ultimos-90">últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label>Considerar Data de Faturamento</label>
                        <select class="filtro-select" id="filtro-data-faturamento">
                            <option value="ultimos-30" selected>últimos 30 dias</option>
                            <option value="ultimos-60">últimos 60 dias</option>
                            <option value="ultimos-90">últimos 90 dias</option>
                            <option value="ultimos-120">últimos 120 dias</option>
                            <option value="ultimo-ano">último 1 ano</option>
                        </select>
                    </div>
                </div>

                <div class="filtros-row-2">
                    <div class="filtro-group">
                        <label>Exibir Vendedor</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-vendedor" placeholder="Todos os Vendedores" readonly>
                            <button type="button" onclick="abrirModalVendedor()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="filtro-group">
                        <label>Exibir Projeto</label>
                        <div class="filtro-input-search">
                            <input type="text" id="filtro-projeto" placeholder="Todos os Projetos" readonly>
                            <button type="button" onclick="abrirModalProjeto()"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>

                <div class="filtros-toggles">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-cancelados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Cancelados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-denegados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Denegados</span>
                    </div>
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-encerrados">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Exibir Encerrados</span>
                    </div>
                </div>

                <div class="filtros-info-box">
                    <p>Para localizar pedidos de venda faturados antes desse período utilize a opçéo <strong>"Exibir Todos"</strong> em <strong>"Venda de Produto"</strong> no menu.</p>
                </div>
            </div>
            <div class="modal-filtros-footer">
                <button type="button" class="btn-desfazer" onclick="desfazerFiltros()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn-atualizar-filtro" onclick="aplicarFiltros()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Vendedor -->
    <div class="modal-overlay" id="modal-selecionar-vendedor">
        <div class="modal-vendedor-content">
            <div class="modal-filtros-header">
                <h2 style="color: #f97316;">Exibir Vendedor</h2>
                <button class="close-btn" onclick="fecharModalVendedor()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="vendedor-search-bar">
                <div class="filter-icon"><i class="fas fa-filter"></i></div>
                <input type="text" id="busca-vendedor" placeholder="Pesquisar por Nome">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="vendedor-list" id="vendedor-list">
                <div class="vendedor-item selected" data-id="todos">Todos os Vendedores</div>
                <div class="vendedor-item" data-id="1">Andreia Trovéo</div>
                <div class="vendedor-item" data-id="2">Ariel Silva</div>
                <div class="vendedor-item" data-id="3">Augusto Santos</div>
                <div class="vendedor-item" data-id="4">Elaine Freitas</div>
                <div class="vendedor-item" data-id="5">Fabiano Marques</div>
                <div class="vendedor-item" data-id="6">Fabíola Souza</div>
                <div class="vendedor-item" data-id="7">Lais da Silva</div>
                <div class="vendedor-item" data-id="8">Lorena Silva</div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaçéo de Alterações Néo Salvas -->
    <div class="modal-confirm-overlay" id="modal-confirmar-alteracoes">
        <div class="modal-confirm-content">
            <h3>Desprezar as alterações realizadas?</h3>
            <a class="link-alteracoes" onclick="toggleListaAlteracoes()">quais alterações?</a>
            <div class="alteracoes-lista" id="lista-alteracoes">
                <ul id="alteracoes-itens">
                    <!-- Será preenchido dinamicamente -->
                </ul>
            </div>
            <div class="modal-confirm-buttons">
                <button type="button" class="btn-confirm-sim" id="btn-confirmar-sim">Sim</button>
                <button type="button" class="btn-confirm-nao" id="btn-confirmar-nao">Néo</button>
            </div>
        </div>
    </div>

    <!-- Modal Configurar Etapas do Kanban -->
    <div class="modal-overlay" id="modal-etapas-kanban">
        <div class="modal-etapas-content">
            <div class="modal-etapas-header">
                <h2><i class="fas fa-tasks" style="margin-right: 10px;"></i>Alterar as Etapas deste Processo</h2>
                <button class="close-btn" onclick="fecharModalEtapas()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-etapas-body">
                <p>Aqui você pode modificar o nome de cada etapa do seu processo de venda</p>
                
                <div class="etapas-container" id="etapas-container">
                    <!-- Etapas seréo carregadas dinamicamente -->
                </div>

                <div class="etapas-actions">
                    <button type="button" class="btn-adicionar-etapa" onclick="adicionarNovaEtapa()">
                        <i class="fas fa-plus-circle"></i> Adicionar Nova Etapa
                    </button>
                    <span class="etapas-counter" id="etapas-counter">6 etapas configuradas</span>
                </div>

                <div class="etapas-info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>As etapas podem deixar de ser usadas somente quando néo houver mais Orçamentos nela. Arraste as etapas para reordenar.</p>
                </div>
            </div>
            <div class="modal-etapas-footer">
                <div class="alterar-numeracao">
                    <label class="checkbox-container">
                        <input type="checkbox" id="checkbox-alterar-numeracao">
                        <span class="checkmark"></span>
                    </label>
                    <i class="fas fa-edit"></i>
                    <span>Alterar o <strong>número dos próximos</strong> Pedidos de Venda e Remessas de Produto</span>
                </div>
                <div class="modal-etapas-buttons">
                    <button type="button" class="btn-cancelar-etapas" onclick="fecharModalEtapas()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn-confirmar-etapas" onclick="confirmarEtapas()">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Orçamento - Estilo Omie Profissional -->
    <div class="modal-overlay" id="modal-novo-orcamento">
        <div class="modal-content-omie" style="max-width: 1100px; height: 95vh; display: flex; flex-direction: column; position: relative;">
            <!-- Header -->
            <div class="modal-header-omie" style="flex-shrink: 0;">
                <h2><i class="fas fa-file-invoice" style="color: #f97316;"></i> Incluir Orçamento</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="close-btn" onclick="fecharModalNovoOrcamento()">
                        Fechar <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Container Principal -->
            <div class="modal-container-omie">
                <!-- área Principal -->
                <div class="modal-main-content" style="padding: 20px;">
                    <!-- Seçéo Cliente -->
                    <div class="orcamento-cliente-section">
                        <div class="orcamento-cliente-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="orcamento-cliente-info">
                            <div class="orcamento-cliente-row">
                                <div class="orcamento-field-group" style="flex: 1; position: relative;">
                                    <label>Cliente <i class="fas fa-link" style="color: #999; font-size: 10px;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-cliente" placeholder="Digite o nome ou código do cliente" class="orcamento-input" autocomplete="off">
                                        <input type="hidden" id="novo-cliente-id">
                                        <button type="button" class="btn-input-action" onclick="buscarClientes()"><i class="fas fa-search"></i></button>
                                    </div>
                                    <!-- Dropdown de sugestões -->
                                    <div id="dropdown-clientes" class="dropdown-sugestoes" style="display: none; position: absolute; top: 100%; left: 0; right: 40px; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                                </div>
                                <button type="button" class="btn-consulta-credito" onclick="consultarCredito()">
                                    <i class="fas fa-search"></i> Consulta de Crédito
                                </button>
                                <div class="orcamento-field-group">
                                    <label>Previséo de Faturamento</label>
                                    <div class="input-with-btn">
                                        <input type="date" id="novo-previsao-faturamento" class="orcamento-input" value="">
                                        <button type="button" class="btn-input-action"><i class="fas fa-calendar"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha de Valores -->
                    <div class="orcamento-valores-row">
                        <div class="orcamento-valor-box">
                            <label>Total de Mercadorias</label>
                            <input type="text" id="novo-total-mercadorias" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Valor do Desconto</label>
                            <input type="text" id="novo-desconto" class="orcamento-valor-input" value="0,00" placeholder="0,00">
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de IPI</label>
                            <input type="text" id="novo-total-ipi" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box">
                            <label>Total de ICMS ST</label>
                            <input type="text" id="novo-total-icms" class="orcamento-valor-input" value="0,00" readonly>
                        </div>
                        <div class="orcamento-valor-box destaque">
                            <label>Valor Total do Pedido</label>
                            <input type="text" id="novo-valor-total" class="orcamento-valor-input destaque" value="0,00" readonly>
                        </div>
                    </div>

                    <!-- Linha Vendedor e Parcelas -->
                    <div class="orcamento-info-row">
                        <div class="orcamento-field-group" style="position: relative;">
                            <label>Vendedor</label>
                            <div class="input-with-btn">
                                <input type="text" id="novo-vendedor" placeholder="Selecione o vendedor" class="orcamento-input" readonly style="cursor: pointer;" onclick="toggleDropdownVendedores()">
                                <input type="hidden" id="novo-vendedor-id">
                                <button type="button" class="btn-input-action" onclick="toggleDropdownVendedores()"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <!-- Dropdown de vendedores -->
                            <div id="dropdown-vendedores" class="dropdown-sugestoes" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Número de Parcelas</label>
                            <div class="input-with-btn">
                                <select id="novo-parcelas" class="orcamento-input" onchange="sincronizarParcelasAba()">
                                    <option value="a_vista">A Vista</option>
                                    <option value="30">30 dias</option>
                                    <option value="30_60">30/60 dias</option>
                                    <option value="30_60_90">30/60/90 dias</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                                <button type="button" class="btn-input-action" onclick="ativarAbaOrcamento('parcelas')"><i class="fas fa-cog"></i></button>
                            </div>
                        </div>
                        <div class="orcamento-field-group">
                            <label>Cenário Fiscal</label>
                            <select id="novo-cenario-fiscal" class="orcamento-input" onchange="aplicarCenarioFiscal()">
                                <option value="">Selecione o cenário na lista</option>
                                <option value="venda_normal">Venda Normal (Dentro do Estado)</option>
                                <option value="venda_fora_estado">Venda Fora do Estado</option>
                                <option value="venda_zona_franca">Venda Zona Franca</option>
                                <option value="exportacao">Exportaçéo</option>
                                <option value="simples_nacional">Simples Nacional</option>
                            </select>
                        </div>
                    </div>

                    <!-- Abas -->
                    <div class="orcamento-tabs">
                        <button class="orcamento-tab active" data-tab="itens">Itens da Venda</button>
                        <button class="orcamento-tab" data-tab="impostos">Impostos</button>
                        <button class="orcamento-tab" data-tab="departamentos">Departamentos</button>
                        <button class="orcamento-tab" data-tab="frete">Frete e Outras Despesas</button>
                        <button class="orcamento-tab" data-tab="info">Informações Adicionais</button>
                        <button class="orcamento-tab" data-tab="parcelas">Parcelas</button>
                        <button class="orcamento-tab" data-tab="obs">Observações</button>
                        <button class="orcamento-tab" data-tab="email">E-mail para o Cliente</button>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div class="orcamento-tab-content active" id="tab-itens">
                        <!-- Botões de Açéo -->
                        <div class="orcamento-itens-actions">
                            <button type="button" class="btn-orcamento-action verde" onclick="adicionarItemOrcamento()">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button type="button" class="btn-orcamento-action laranja">
                                <i class="fas fa-edit"></i> Editar Item
                            </button>
                            <button type="button" class="btn-orcamento-action vermelho">
                                <i class="fas fa-trash"></i> Excluir Item
                            </button>
                        </div>

                        <!-- Tabela de Itens -->
                        <div class="orcamento-tabela-container">
                            <table class="orcamento-tabela">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Produto <i class="fas fa-sort"></i></th>
                                        <th>Descriçéo do Produto <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Quantidade <i class="fas fa-sort"></i></th>
                                        <th style="width: 100px;">Qtd. Pendente <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Local de Estoque <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Preço Unitário <i class="fas fa-sort"></i></th>
                                        <th style="width: 120px;">Valor Total <i class="fas fa-sort"></i></th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                        <th><input type="text" placeholder="??" class="filter-input"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-itens-orcamento">
                                    <!-- Itens seréo adicionados aqui -->
                                </tbody>
                            </table>
                            <div class="orcamento-tabela-empty" id="empty-itens">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhum registro encontrado</p>
                            </div>
                        </div>

                        <!-- Paginaçéo -->
                        <div class="orcamento-paginacao">
                            <span class="paginacao-info">Nenhum registro encontrado</span>
                            <div class="paginacao-controls">
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-left"></i></button>
                                <span class="pag-text">anterior</span>
                                <span class="pag-current">1</span>
                                <span class="pag-text">próximo</span>
                                <button class="pag-btn" disabled><i class="fas fa-angle-right"></i></button>
                                <button class="pag-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Impostos -->
                    <div class="orcamento-tab-content" id="tab-impostos">
                        <div class="orcamento-section-form">
                            <!-- Indicador de Config do Sistema -->
                            <div id="impostos-config-sistema-badge" style="display: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 8px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-cog fa-spin"></i>
                                <span><strong>Alíquotas sincronizadas</strong> com as Configurações do Sistema (Menu Configurações → Impostos)</span>
                            </div>
                            
                            <!-- Cabeçalho: Cenário Fiscal e Botéo Calcular -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div class="orcamento-field-group" style="margin: 0; width: 350px;">
                                        <label style="font-weight: 600;">Cenário Fiscal</label>
                                        <select id="impostos-cenario-fiscal" class="orcamento-input" onchange="carregarCenarioFiscal()">
                                            <option value="">Selecione o cenário fiscal</option>
                                            <option value="venda_normal">Venda Normal (Dentro do Estado)</option>
                                            <option value="venda_fora_estado">Venda Fora do Estado</option>
                                            <option value="venda_zona_franca">Venda Zona Franca</option>
                                            <option value="exportacao">Exportaçéo</option>
                                            <option value="simples_nacional">Simples Nacional</option>
                                            <option value="industrializacao">Industrializaçéo (com IPI)</option>
                                            <option value="revenda">Revenda de Mercadorias</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn-orcamento-action laranja" onclick="calcularImpostos()" style="padding: 10px 20px; margin-top: 18px;">
                                        <i class="fas fa-calculator"></i> Calcular Impostos
                                    </button>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="impostos-destacar-nf" checked>
                                        <span style="font-size: 13px; color: #333;">Destacar Impostos na NF</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Grid de Impostos -->
                            <div class="impostos-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
                                
                                <!-- Card ICMS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-percentage" style="color: #3b82f6; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #1e40af; font-weight: 600;">ICMS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST</label>
                                            <select id="impostos-icms-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="00">00 - Tributada Integralmente</option>
                                                <option value="10">10 - Tributada com ICMS ST</option>
                                                <option value="20">20 - Com Reduçéo de Base</option>
                                                <option value="30">30 - Isenta com ICMS ST</option>
                                                <option value="40">40 - Isenta</option>
                                                <option value="41">41 - Néo Tributada</option>
                                                <option value="50">50 - Suspenséo</option>
                                                <option value="51">51 - Diferimento</option>
                                                <option value="60">60 - ICMS Cobrado Anteriormente</option>
                                                <option value="70">70 - Reduçéo + ICMS ST</option>
                                                <option value="90">90 - Outras</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-icms-aliquota" class="imposto-input" value="18,00" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Red. Base (%)</label>
                                                <input type="text" id="impostos-icms-reducao" class="imposto-input" value="0,00" onchange="atualizarImpostos()">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-icms-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ICMS</label>
                                                <input type="text" id="impostos-icms-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #dbeafe; color: #1e40af; font-weight: 600;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card ICMS ST -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-truck" style="color: #7c3aed; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #5b21b6; font-weight: 600;">ICMS ST</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-icms-st-ativo" onchange="toggleICMSST()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-icms-st-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">MVA (%)</label>
                                                <input type="text" id="impostos-icms-st-mva" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base ST</label>
                                                <input type="text" id="impostos-icms-st-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ICMS ST</label>
                                                <input type="text" id="impostos-icms-st-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #ede9fe; color: #5b21b6; font-weight: 600;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card IPI -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-industry" style="color: #059669; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #047857; font-weight: 600;">IPI</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-ipi-ativo" onchange="toggleIPI()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST IPI</label>
                                            <select id="impostos-ipi-cst" class="imposto-input" disabled onchange="atualizarImpostos()">
                                                <option value="50">50 - Saída Tributada</option>
                                                <option value="51">51 - Saída Tributada com Alíquota Zero</option>
                                                <option value="52">52 - Saída Isenta</option>
                                                <option value="53">53 - Saída Néo Tributada</option>
                                                <option value="54">54 - Saída Imune</option>
                                                <option value="55">55 - Saída com Suspenséo</option>
                                                <option value="99">99 - Outras Saídas</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-ipi-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-ipi-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor IPI</label>
                                            <input type="text" id="impostos-ipi-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #d1fae5; color: #047857; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card PIS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-hand-holding-usd" style="color: #dc2626; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #b91c1c; font-weight: 600;">PIS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST PIS</label>
                                            <select id="impostos-pis-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="01">01 - Operaçéo Tributável (BC = Valor da Operaçéo)</option>
                                                <option value="02">02 - Operaçéo Tributável (BC = Valor da Operaçéo - Alíquota Diferenciada)</option>
                                                <option value="04">04 - Operaçéo Tributável (Monofásica - Revenda a Alíquota Zero)</option>
                                                <option value="06">06 - Operaçéo Tributável (Alíquota Zero)</option>
                                                <option value="07">07 - Operaçéo Isenta da Contribuiçéo</option>
                                                <option value="08">08 - Operaçéo sem Incidência da Contribuiçéo</option>
                                                <option value="09">09 - Operaçéo com Suspenséo da Contribuiçéo</option>
                                                <option value="49">49 - Outras Operações de Saída</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-pis-aliquota" class="imposto-input" value="1,65" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-pis-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor PIS</label>
                                            <input type="text" id="impostos-pis-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #fee2e2; color: #b91c1c; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card COFINS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-coins" style="color: #ea580c; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #c2410c; font-weight: 600;">COFINS</h4>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b;">CST COFINS</label>
                                            <select id="impostos-cofins-cst" class="imposto-input" onchange="atualizarImpostos()">
                                                <option value="01">01 - Operaçéo Tributável (BC = Valor da Operaçéo)</option>
                                                <option value="02">02 - Operaçéo Tributável (BC = Valor da Operaçéo - Alíquota Diferenciada)</option>
                                                <option value="04">04 - Operaçéo Tributável (Monofásica - Revenda a Alíquota Zero)</option>
                                                <option value="06">06 - Operaçéo Tributável (Alíquota Zero)</option>
                                                <option value="07">07 - Operaçéo Isenta da Contribuiçéo</option>
                                                <option value="08">08 - Operaçéo sem Incidência da Contribuiçéo</option>
                                                <option value="09">09 - Operaçéo com Suspenséo da Contribuiçéo</option>
                                                <option value="49">49 - Outras Operações de Saída</option>
                                            </select>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-cofins-aliquota" class="imposto-input" value="7,60" onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-cofins-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor COFINS</label>
                                            <input type="text" id="impostos-cofins-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #ffedd5; color: #c2410c; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Card ISS -->
                                <div class="imposto-card" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <i class="fas fa-building" style="color: #0284c7; font-size: 18px;"></i>
                                        <h4 style="margin: 0; color: #0369a1; font-weight: 600;">ISS</h4>
                                        <label class="toggle-mini" style="margin-left: auto;">
                                            <input type="checkbox" id="impostos-iss-ativo" onchange="toggleISS()">
                                            <span class="toggle-slider-mini"></span>
                                        </label>
                                    </div>
                                    <div class="imposto-campos" style="display: grid; gap: 10px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Alíquota (%)</label>
                                                <input type="text" id="impostos-iss-aliquota" class="imposto-input" value="0,00" disabled onchange="atualizarImpostos()">
                                            </div>
                                            <div class="imposto-field">
                                                <label style="font-size: 11px; color: #64748b;">Base Cálculo</label>
                                                <input type="text" id="impostos-iss-base" class="imposto-input valor" value="0,00" readonly style="background: #f1f5f9;">
                                            </div>
                                        </div>
                                        <div class="imposto-field">
                                            <label style="font-size: 11px; color: #64748b; font-weight: 600;">Valor ISS</label>
                                            <input type="text" id="impostos-iss-valor" class="imposto-input valor destaque" value="0,00" readonly style="background: #e0f2fe; color: #0369a1; font-weight: 600;">
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Resumo de Valores -->
                            <div class="impostos-resumo" style="background: linear-gradient(135deg, #1e3a5f, #2d4a6f); border-radius: 12px; padding: 20px; color: white;">
                                <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-receipt"></i> Resumo dos Valores
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Total de Produtos</span>
                                        <strong id="impostos-total-produtos" style="font-size: 16px; display: block;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Total de Impostos</span>
                                        <strong id="impostos-total-impostos" style="font-size: 16px; display: block; color: #fbbf24;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item">
                                        <span style="font-size: 11px; opacity: 0.8;">Frete + Outras Despesas</span>
                                        <strong id="impostos-total-frete" style="font-size: 16px; display: block;">R$ 0,00</strong>
                                    </div>
                                    <div class="resumo-item" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                                        <span style="font-size: 11px; opacity: 0.8;">Total da Nota Fiscal</span>
                                        <strong id="impostos-total-nf" style="font-size: 20px; display: block; color: #4ade80;">R$ 0,00</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações Complementares -->
                            <div style="margin-top: 20px;">
                                <div class="orcamento-field-group">
                                    <label style="color: #3b82f6; font-size: 13px;">
                                        <i class="fas fa-info-circle"></i> Informações Complementares para a NF-e
                                    </label>
                                    <textarea id="impostos-info-complementares" class="orcamento-textarea" style="min-height: 80px; margin-top: 8px;" placeholder="Informações adicionais de interesse do fisco que seréo impressas na NF-e..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Departamentos -->
                    <div class="orcamento-tab-content" id="tab-departamentos">
                        <div class="orcamento-empty-state" style="padding: 60px 20px; text-align: center;">
                            <div style="font-size: 48px; color: #ccc; margin-bottom: 16px;">=(</div>
                            <p style="color: #666; font-size: 14px;">Ainda néo foi informada nenhuma distribuiçéo por departamentos para esta venda.</p>
                        </div>
                    </div>

                    <!-- Aba Frete -->
                    <div class="orcamento-tab-content" id="tab-frete">
                        <div class="orcamento-frete-section">
                            <!-- Linha 1: Transportadora, Tipo do Frete, Placa, UF, RNTRC -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 80px 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Transportadora <i class="fas fa-link" style="color: #999; font-size: 10px;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-transportadora" placeholder="" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Tipo do Frete</label>
                                    <select id="novo-tipo-frete" class="orcamento-input">
                                        <option value="9">9 - Sem Ocorrência de Transporte</option>
                                        <option value="0">0 - Contrataçéo por conta do Remetente (CIF)</option>
                                        <option value="1">1 - Contrataçéo por conta do Destinatário (FOB)</option>
                                        <option value="2">2 - Contrataçéo por conta de Terceiros</option>
                                        <option value="3">3 - Transporte Próprio por conta do Remetente</option>
                                        <option value="4">4 - Transporte Próprio por conta do Destinatário</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Placa do Veículo</label>
                                    <input type="text" id="novo-placa-veiculo" class="orcamento-input" placeholder="" maxlength="8">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>UF</label>
                                    <select id="novo-placa-uf" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                        <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                        <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                        <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                        <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                        <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                        <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                        <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                        <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>RNTRC (ANTT)</label>
                                    <input type="text" id="novo-rntrc" class="orcamento-input" placeholder="">
                                </div>
                            </div>

                            <!-- Linha 2: Volumes -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Quantidade de Volumes</label>
                                    <input type="number" id="novo-qtd-volumes" class="orcamento-input" value="0" min="0">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Espécie dos Volumes</label>
                                    <input type="text" id="novo-especie-volumes" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Marca dos Volumes</label>
                                    <input type="text" id="novo-marca-volumes" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Numeraçéo dos Volumes</label>
                                    <input type="text" id="novo-numeracao-volumes" class="orcamento-input" placeholder="">
                                </div>
                            </div>

                            <!-- Linha 3: Pesos e Valores + Link ICMS -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px; align-items: end;">
                                <div class="orcamento-field-group">
                                    <label>Peso Líquido (Kg)</label>
                                    <input type="text" id="novo-peso-liquido" class="orcamento-input" value="0,000" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Peso Bruto (Kg)</label>
                                    <input type="text" id="novo-peso-bruto" class="orcamento-input" value="0,000" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Valor do Frete</label>
                                    <input type="text" id="novo-frete" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Valor do Seguro</label>
                                    <input type="text" id="novo-seguro" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                                <div style="text-align: right; padding-bottom: 8px;">
                                    <a href="#" onclick="abrirModalICMSTransporte(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Informar os valores para o<br><strong>ICMS Retido do Serviço<br>de Transporte</strong></a>
                                </div>
                            </div>

                            <!-- Linha 4: Lacre e Outras Despesas -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Número do Lacre</label>
                                    <input type="text" id="novo-numero-lacre" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Outras Despesas Acessórias</label>
                                    <input type="text" id="novo-outras-despesas" class="orcamento-input" value="0,00" style="text-align: right;">
                                </div>
                            </div>

                            <!-- Linha 5: Previséo de Entrega e Rastreio -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px; align-items: end;">
                                <div class="orcamento-field-group">
                                    <label>Previséo de Entrega</label>
                                    <div class="input-with-btn">
                                        <input type="date" id="novo-previsao-entrega" class="orcamento-input">
                                        <button type="button" class="btn-input-action"><i class="fas fa-calendar"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Código de Rastreio</label>
                                    <input type="text" id="novo-codigo-rastreio" class="orcamento-input" placeholder="">
                                </div>
                                <div style="padding-bottom: 8px;">
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="novo-veiculo-proprio">
                                        <span style="font-size: 13px; color: #333;">O transporte será realizado com veículo próprio</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Informações Adicionais -->
                    <div class="orcamento-tab-content" id="tab-info">
                        <div class="orcamento-section-form">
                            <!-- Linha 1: Categoria, Conta Corrente, Etapa -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Categoria</label>
                                    <select id="novo-categoria" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="venda_mercadoria">Venda de Mercadoria</option>
                                        <option value="venda_servico">Venda de Serviço</option>
                                        <option value="revenda">Revenda</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Conta Corrente</label>
                                    <select id="novo-conta-corrente" class="orcamento-input">
                                        <option value=""></option>
                                        <option value="principal">Conta Principal</option>
                                        <option value="secundaria">Conta Secundária</option>
                                        <option value="caixa">Caixa</option>
                                    </select>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Etapa</label>
                                    <select id="novo-etapa" class="orcamento-input">
                                        <option value="orcamento">Orçamento</option>
                                        <option value="analise">Em Análise</option>
                                        <option value="aprovado">Aprovado</option>
                                        <option value="faturar">Faturar</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Linha 2: Nº Pedido Cliente, Nº Contrato, Contato, Projeto, Origem -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Nº do Pedido do Cliente</label>
                                    <input type="text" id="novo-pedido-cliente" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Nº do Contrato de Venda</label>
                                    <input type="text" id="novo-contrato-venda" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Contato</label>
                                    <input type="text" id="novo-contato" class="orcamento-input" placeholder="">
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Projeto <i class="fas fa-plus" style="color: #f97316; font-size: 10px; cursor: pointer;"></i></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="novo-projeto" class="orcamento-input" placeholder="">
                                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                                <div class="orcamento-field-group">
                                    <label>Origem do Pedido</label>
                                    <select id="novo-origem-pedido" class="orcamento-input">
                                        <option value="omie">Omie</option>
                                        <option value="site">Site</option>
                                        <option value="telefone">Telefone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="presencial">Presencial</option>
                                        <option value="marketplace">Marketplace</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Dados Adicionais NF e Links -->
                            <div class="orcamento-form-row" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; margin-bottom: 16px;">
                                <div class="orcamento-field-group">
                                    <label>Dados Adicionais para a Nota Fiscal</label>
                                    <textarea id="novo-dados-adicionais-nf" class="orcamento-textarea" style="min-height: 100px;" placeholder=""></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 12px; padding-top: 20px;">
                                    <a href="#" onclick="abrirModalNFsRelacionadas(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Clique aqui para <strong>Incluir<br>notas fiscais relacionadas</strong></a>
                                    <a href="#" onclick="abrirModalInfoFisco(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Clique aqui para <strong>Alterar</strong> as<br>informações adicionais de <strong>interesse do fisco</strong></a>
                                </div>
                            </div>

                            <!-- Checkbox e Links inferiores -->
                            <div style="display: flex; align-items: flex-start; gap: 24px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="novo-consumo-final">
                                    <span style="font-size: 13px; color: #333;">Nota Fiscal para Consumo Final</span>
                                </label>
                                <a href="#" onclick="abrirModalCamposObsNFe(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Incluir os <strong>campos adicionais de observaçéo</strong><br>para a NF-e</a>
                                <a href="#" onclick="abrirModalEnderecoEntrega(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Alterar o <strong>endereço de entrega</strong><br>e outros detalhes da NF-e</a>
                                <a href="#" onclick="abrirModalAgropecuaria(); return false;" style="color: #3b82f6; font-size: 12px; text-decoration: none;">Dados de produtos da <strong>Agricultura,<br>Pecuária e Produçéo Florestal</strong></a>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Parcelas -->
                    <div class="orcamento-tab-content" id="tab-parcelas">
                        <div class="orcamento-section-form">
                            <!-- Cabeçalho: Contas a Receber e Valor Total -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div>
                                    <span style="font-size: 13px; color: #333;">Contas a Receber</span>
                                    <span style="font-size: 11px; color: #999; margin-left: 8px;">(clique duas vezes para modificar a parcela)</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="orcamento-valor-box destaque" style="margin: 0;">
                                        <label style="font-size: 11px;">Valor Total a Receber</label>
                                        <input type="text" id="novo-valor-total-receber" class="orcamento-valor-input destaque" value="0,00" readonly style="width: 120px;">
                                    </div>
                                    <button type="button" class="btn-orcamento-action laranja" onclick="refazerParcelas()" style="padding: 8px 16px;">
                                        <i class="fas fa-sync-alt"></i> Refazer Parcelas
                                    </button>
                                </div>
                            </div>

                            <!-- Tabela de Parcelas estilo Omie -->
                            <div class="orcamento-tabela-container">
                                <table class="orcamento-tabela">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">Situaçéo <span style="color: #999;">É</span></th>
                                            <th style="width: 80px;">Parcela <span style="color: #999;">É</span></th>
                                            <th style="width: 120px;">Vencimento <span style="color: #999;">É</span></th>
                                            <th style="width: 120px;">Valor a Receber <span style="color: #999;">É</span></th>
                                            <th style="width: 100px;">Percentual <span style="color: #999;">É</span></th>
                                            <th style="width: 140px;">Tipo de Documento <span style="color: #999;">É</span></th>
                                            <th style="width: 140px;">Meio de Pagamento <span style="color: #999;">É</span></th>
                                            <th style="width: 100px;">Gerar Boleto <span style="color: #999;">É</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-parcelas">
                                        <!-- Parcelas seréo geradas dinamicamente -->
                                    </tbody>
                                </table>
                                <div class="orcamento-tabela-empty" id="empty-parcelas">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum registro encontrado</p>
                                </div>
                            </div>

                            <!-- Paginaçéo -->
                            <div class="orcamento-paginacao">
                                <span class="paginacao-info">Nenhum registro encontrado</span>
                                <div class="paginacao-controls">
                                    <button class="pag-btn" disabled><i class="fas fa-angle-double-left"></i></button>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-left"></i></button>
                                    <span class="pag-text">anterior</span>
                                    <span class="pag-current">1</span>
                                    <span class="pag-text">próximo</span>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-right"></i></button>
                                    <button class="pag-btn" disabled><i class="fas fa-angle-double-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Observações -->
                    <div class="orcamento-tab-content" id="tab-obs">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label style="color: #3b82f6; font-size: 13px;">Preencha aqui as observações desta venda (elas néo seréo exibidas na Nota Fiscal)</label>
                                <textarea id="novo-observacoes" class="orcamento-textarea" style="min-height: 200px; margin-top: 8px;" placeholder=""></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Aba E-mail -->
                    <div class="orcamento-tab-content" id="tab-email">
                        <div class="orcamento-section-form">
                            <div class="orcamento-field-group">
                                <label style="color: #3b82f6; font-size: 13px;">Utilizar os seguintes endereços de e-mail</label>
                                <textarea id="novo-email-cliente" class="orcamento-textarea" style="min-height: 80px; margin-top: 8px;" placeholder="Digite os e-mails separados por vírgula ou ponto e vírgula"></textarea>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                                <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 8px;">
                                    <input type="checkbox" id="novo-email-boleto" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #333;">Enviar e-mail com o boleto de cobrança (juntamente com o DANFE e o XML da NF-e)</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: flex-start; gap: 8px;">
                                    <input type="checkbox" id="novo-email-pix" style="margin-top: 2px;">
                                    <span style="font-size: 13px; color: #333;">Enviar e-mail com o pix de cobrança (juntamente com o DANFE e o XML da NF-e)</span>
                                </label>
                            </div>

                            <!-- Aviso de Conta Corrente -->
                            <div id="aviso-conta-corrente" style="margin-top: 20px; padding: 12px 16px; background: #fef3c7; border-radius: 6px; display: none;">
                                <span style="color: #92400e; font-size: 13px;">A "Conta Corrente" precisa ser informada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar de Ações -->
                <div class="modal-sidebar-actions" style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <button class="sidebar-action-btn primary" onclick="salvarNovoOrcamento()" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-cloud-upload-alt"></i> Salvar
                        </button>
                    </div>
                    
                    <!-- Botéo de navegaçéo circular -->
                    <div style="display: flex; justify-content: center; margin-top: auto; padding-top: 20px;">
                        <button type="button" class="btn-nav-circular" onclick="navegarProximoOrcamento()" title="Próximo registro" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #f97316; background: white; color: #f97316; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Barra de informaçéo inferior (estilo Omie) -->
            <div id="orcamento-info-bar" style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px 24px; border-top: 1px solid #f59e0b; display: none;">
                <span id="orcamento-info-text" style="color: #92400e; font-size: 13px;"></span>
            </div>
            
            <!-- Botéo WhatsApp flutuante -->
            <div style="position: fixed; bottom: 24px; right: 24px; z-index: 10001;">
                <button onclick="abrirWhatsAppOrcamento()" style="width: 56px; height: 56px; background: #25d366; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;">
                    <i class="fab fa-whatsapp" style="font-size: 28px; color: white;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Item do Pedido - Estilo Omie -->
    <div class="modal-overlay" id="modal-item-pedido">
        <div class="modal-content-omie" style="max-width: 1100px; height: auto; max-height: 95vh;">
            <!-- Header -->
            <div class="modal-header-item-omie">
                <h2 id="modal-item-titulo">Novo Item de Pedido de Venda</h2>
                <button class="close-btn-modern" onclick="fecharModalItemPedido()" title="Fechar (ESC)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-item-omie">
                <input type="hidden" id="item-pedido-id">
                
                <!-- Seçéo Produto com Barcode -->
                <div class="produto-section-omie">
                    <div class="barcode-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5">
                            <path d="M3 5v14M7 5v14M11 5v14M15 5v14M19 5v14M5 5v14M9 5v14M13 5v14M17 5v14M21 5v14"/>
                        </svg>
                    </div>
                    <div class="produto-fields-omie">
                        <div class="produto-row">
                            <div class="field-group" style="flex: 2;">
                                <label>Produto <i class="fas fa-link" style="font-size: 10px; color: #999;"></i></label>
                                <div class="input-autocomplete-container">
                                    <input type="text" id="item-pedido-produto" placeholder="Preencha aqui a Descriçéo, Código ou EAN do produto" autocomplete="off">
                                    <div class="autocomplete-dropdown" id="produto-autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="field-group" style="flex: 0 0 auto;">
                                <label>&nbsp;</label>
                                <button type="button" class="btn-pesquisar-produto" onclick="abrirPesquisaProduto()">
                                    <i class="fas fa-search"></i> Pesquisar Produto
                                </button>
                            </div>
                            <div class="field-group" style="flex: 1;">
                                <label>CFOP</label>
                                <div class="input-with-search">
                                    <input type="text" id="item-pedido-cfop" placeholder="Preencha aqui a CFOP de Venda">
                                    <button type="button" class="btn-input-search"><i class="fas fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seçéo Movimentaçéo de Estoque -->
                <div class="section-omie">
                    <h3 class="section-title-omie">Movimentaçéo de Estoque</h3>
                    <div class="section-row">
                        <div class="field-group" style="flex: 0 0 100px;">
                            <label>Quantidade</label>
                            <input type="number" id="item-pedido-quantidade" value="1.0000" step="0.0001" min="0.0001" class="input-number">
                        </div>
                        <div class="field-group" style="flex: 1;">
                            <label>Local de Estoque</label>
                            <select id="item-pedido-estoque">
                                <option value="PADRAO - Local de Estoque Padréo">PADRAO - Local de Estoque Padréo</option>
                                <option value="SECUNDARIO - Estoque Secundário">SECUNDARIO - Estoque Secundário</option>
                                <option value="EXPEDICAO - Expediçéo">EXPEDICAO - Expediçéo</option>
                            </select>
                        </div>
                        <div class="field-group checkbox-field">
                            <label class="toggle-label">
                                <input type="checkbox" id="item-nao-gerar-saida">
                                <span class="toggle-switch"></span>
                                Néo gerar a saída de estoque ao emitir a NF-e
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Seçéo Valores e Descontos -->
                <div class="section-omie">
                    <h3 class="section-title-omie">Valores e Descontos</h3>
                    <div class="section-row">
                        <div class="field-group" style="flex: 0 0 120px;">
                            <label>Preço Unitário de Venda</label>
                            <input type="text" id="item-pedido-preco" value="0,000000" class="input-number">
                        </div>
                        <div class="field-group" style="flex: 1;">
                            <label>Tabela de Preço</label>
                            <div class="input-with-search">
                                <input type="text" id="item-pedido-tabela-preco" placeholder="">
                                <button type="button" class="btn-input-search"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="field-group" style="flex: 0 0 150px;">
                            <label>% do Desconto <i class="fas fa-exchange-alt" style="font-size: 10px; color: #999;"></i></label>
                            <input type="text" id="item-pedido-desconto-pct" value="0,0000000000" class="input-number">
                        </div>
                        <div class="field-group checkbox-field">
                            <label class="toggle-label">
                                <input type="checkbox" id="item-nao-gerar-conta">
                                <span class="toggle-switch"></span>
                                Néo gerar conta a receber para este item
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Seçéo Impostos e Informações da NF-e -->
                <div class="section-row-split">
                    <div class="section-omie" style="flex: 1;">
                        <h3 class="section-title-omie">Impostos</h3>
                        <div class="field-group">
                            <label>Cenário Fiscal</label>
                            <div class="input-with-clear">
                                <select id="item-pedido-cenario">
                                    <option value="Padréo">Padréo</option>
                                    <option value="Simples Nacional">Simples Nacional</option>
                                    <option value="Lucro Presumido">Lucro Presumido</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="section-omie" style="flex: 1;">
                        <h3 class="section-title-omie">Informações da NF-e</h3>
                        <div class="section-row">
                            <div class="field-group">
                                <label>Número do Pedido de Compra</label>
                                <input type="text" id="item-pedido-npc">
                            </div>
                            <div class="field-group" style="flex: 0 0 80px;">
                                <label>Item do Pedido de Compra</label>
                                <input type="number" id="item-pedido-item-npc" value="0" class="input-number">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Valores Calculados -->
                <div class="valores-calculados-table">
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Valor da Mercadoria</span>
                        <span class="valor-calc-value" id="calc-valor-mercadoria">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Valor do Desconto</span>
                        <span class="valor-calc-value" id="calc-valor-desconto">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">IPI</span>
                        <span class="valor-calc-value" id="calc-ipi">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">ICMS ST+FCP ST</span>
                        <span class="valor-calc-value" id="calc-icms-st">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item">
                        <span class="valor-calc-label">Total do Item</span>
                        <span class="valor-calc-value" id="calc-total-item">R$ 0,00</span>
                    </div>
                    <div class="valor-calc-item destaque">
                        <span class="valor-calc-label">Total do Pedido</span>
                        <span class="valor-calc-value" id="calc-total-pedido">R$ 0,00</span>
                    </div>
                </div>

                <!-- Link Observações -->
                <div class="observacoes-link">
                    <button type="button" class="btn-link-obs" onclick="toggleObservacoesItem()">
                        <i class="fas fa-pen"></i> Clique aqui para alterar as observações e informações adicionais da NF-e
                    </button>
                </div>

                <!-- Observações (oculto inicialmente) -->
                <div class="observacoes-container" id="item-observacoes-container" style="display: none;">
                    <div class="field-group">
                        <label>Observações do Item</label>
                        <textarea id="item-pedido-observacoes" rows="3" placeholder="Observações adicionais para este item..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer-item-omie">
                <div class="footer-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="item-continuar-incluindo">
                        <span class="toggle-switch"></span>
                        Continuar incluindo mais itens
                    </label>
                </div>
                <button type="button" class="btn-incluir-item" onclick="salvarItemPedido()">
                    Incluir Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Item ao Orçamento -->
    <div class="modal-overlay" id="modal-adicionar-item">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <h2><i class="fas fa-plus-circle"></i> Adicionar Item</h2>
                <button class="modal-close" onclick="fecharModalAdicionarItem()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Produto *</label>
                    <div class="input-with-btn">
                        <input type="text" id="item-produto" placeholder="Código ou nome do produto" class="orcamento-input">
                        <button type="button" class="btn-input-action"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantidade *</label>
                        <input type="number" id="item-quantidade" value="1" min="1" class="orcamento-input">
                    </div>
                    <div class="form-group">
                        <label>Preço Unitário (R$) *</label>
                        <input type="text" id="item-preco" placeholder="0,00" class="orcamento-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Local de Estoque</label>
                    <select id="item-estoque" class="orcamento-input">
                        <option value="principal">Estoque Principal</option>
                        <option value="secundario">Estoque Secundário</option>
                        <option value="expediçéo">Expediçéo</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalAdicionarItem()">
                    Cancelar
                </button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #22c55e;" onclick="confirmarAdicionarItem()">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Faturar Todos - Design Premium -->
    <div class="modal-overlay" id="modal-faturar-todos">
        <div class="modal-content" style="max-width: 520px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header Premium -->
            <div class="modal-header" style="background: linear-gradient(135deg, #059669, #10b981); padding: 20px 24px; border: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-bolt" style="font-size: 20px;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Faturar Pedidos</h2>
                        <span style="font-size: 12px; opacity: 0.9;">Geraçéo de notas fiscais em lote</span>
                    </div>
                </div>
                <button class="modal-close" onclick="fecharModalFaturar()" style="background: rgba(255,255,255,0.15); border: none; width: 36px; height: 36px; border-radius: 10px; color: white; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body Premium -->
            <div class="modal-body" style="padding: 0;">
                <!-- Info Card -->
                <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px 24px; border-bottom: 1px solid #a7f3d0;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 26px; color: #059669;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #065f46; font-weight: 600;">Confirmar Faturamento</h3>
                            <p id="faturar-info" style="margin: 0; color: #047857; font-size: 14px;">Você está prestes a faturar X pedidos.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Pedidos -->
                <div style="padding: 20px 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 13px; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.5px;">Pedidos Selecionados</span>
                        <span id="faturar-total" style="font-size: 13px; color: #059669; font-weight: 600;"></span>
                    </div>
                    <div id="faturar-lista" style="max-height: 220px; overflow-y: auto; border-radius: 12px; border: 1px solid #e5e7eb; background: #fafafa;"></div>
                </div>
                
                <!-- Alerta Info -->
                <div style="padding: 0 24px 20px 24px;">
                    <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 10px; padding: 12px 16px; display: flex; align-items: flex-start; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: #d97706; font-size: 16px; margin-top: 2px;"></i>
                        <div>
                            <span style="font-size: 13px; color: #92400e; font-weight: 500;">Atençéo:</span>
                            <span style="font-size: 13px; color: #a16207;"> Esta açéo irá gerar as notas fiscais para todos os pedidos listados acima.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Premium -->
            <div class="modal-footer" style="background: #f9fafb; padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <button type="button" onclick="fecharModalFaturar()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" onclick="confirmarFaturarTodos()" style="padding: 10px 24px; border: none; background: linear-gradient(135deg, #059669, #10b981); color: white; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-check-circle"></i> Confirmar Faturamento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Pedido Parcial - Design SaaS Empresarial -->
    <div class="modal-overlay" id="modal-pedido-parcial">
        <div class="modal-content" style="max-width: 560px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header Premium Laranja -->
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316, #ea580c); padding: 20px 24px; border: none;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-boxes" style="font-size: 20px; color: white;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: white;">Pedido Parcial</h2>
                    </div>
                </div>
                <button class="modal-close" onclick="fecharModalPedidoParcial()" style="background: rgba(255,255,255,0.15); border: none; width: 36px; height: 36px; border-radius: 10px; color: white; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body -->
            <div class="modal-body" style="padding: 24px;">
                <p style="margin: 0 0 20px 0; color: #4b5563; font-size: 14px;">Selecione os itens que deseja faturar parcialmente:</p>
                
                <!-- Lista de Itens -->
                <div id="pedido-parcial-lista" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Itens seréo inseridos via JavaScript -->
                </div>
            </div>
            
            <!-- Footer -->
            <div class="modal-footer" style="background: #f9fafb; padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; align-items: center; gap: 12px;">
                <button type="button" onclick="fecharModalPedidoParcial()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    Cancelar
                </button>
                <button type="button" onclick="confirmarPedidoParcial()" style="padding: 10px 24px; border: none; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                    <i class="fas fa-check"></i> Gerar Pedido Parcial
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Comunicar SEFAZ -->
    <div class="modal-overlay" id="modal-sefaz">
        <div class="modal-content" style="max-width: 480px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4); padding: 20px 24px; position: relative;">
                <h2 style="font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-building" style="font-size: 20px;"></i> Comunicar com a SEFAZ
                </h2>
                <button class="modal-close" onclick="fecharModalSefaz()" style="position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times" style="font-size: 14px;"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px 28px 24px;">
                <div id="sefaz-loading" style="display: none;">
                    <div style="width: 72px; height: 72px; margin: 0 auto 24px; background: linear-gradient(135deg, #e0f2fe, #cffafe); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #0ea5e9;"></i>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Comunicando com a SEFAZ...</h3>
                    <p style="color: #64748b; font-size: 14px;">Aguarde enquanto enviamos os dados.</p>
                </div>
                <div id="sefaz-inicial">
                    <div style="width: 72px; height: 72px; margin: 0 auto 24px; background: linear-gradient(135deg, #e0f2fe, #cffafe); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-building" style="font-size: 32px; color: #0ea5e9;"></i>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Transmitir Notas Fiscais</h3>
                    <p id="sefaz-info" style="color: #64748b; font-size: 14px; margin-bottom: 20px;">X notas fiscais prontas para transmisséo.</p>
                    <div id="sefaz-lista" style="text-align: left; max-height: 180px; overflow-y: auto; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 16px; margin-bottom: 8px; border: 1px solid #e2e8f0;"></div>
                </div>
                <div id="sefaz-resultado" style="display: none;">
                    <div style="width: 72px; height: 72px; margin: 0 auto 24px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check" style="font-size: 32px; color: #22c55e;"></i>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Transmisséo Concluída!</h3>
                    <p id="sefaz-resultado-info" style="color: #64748b; font-size: 14px;"></p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 12px; padding: 20px 28px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                <button type="button" onclick="fecharModalSefaz()" style="padding: 12px 28px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; color: #475569; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                    Fechar
                </button>
                <button type="button" id="btn-transmitir-sefaz" onclick="transmitirSefaz()" style="padding: 12px 28px; border: none; border-radius: 10px; background: linear-gradient(135deg, #0ea5e9, #06b6d4); color: white; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 14px rgba(6,182,212,0.4);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(6,182,212,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(6,182,212,0.4)'">
                    <i class="fas fa-paper-plane"></i> Transmitir para SEFAZ
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaçéo Profissional -->
    <div class="modal-overlay" id="modal-confirmacao-custom" style="z-index: 999999;">
        <div class="modal-content" style="max-width: 400px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalSlideIn 0.25s ease;">
            <div class="modal-body" style="padding: 32px 28px; text-align: center;">
                <div id="confirm-icon-container" style="width: 64px; height: 64px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #fef3c7, #fde68a);">
                    <i id="confirm-icon" class="fas fa-exclamation-triangle" style="font-size: 28px; color: #f59e0b;"></i>
                </div>
                <h3 id="confirm-titulo" style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Confirmar Açéo</h3>
                <p id="confirm-mensagem" style="font-size: 14px; color: #64748b; line-height: 1.5; margin: 0;">Deseja realmente realizar esta açéo?</p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; padding: 20px 28px; background: #f8fafc; border-top: 1px solid #e2e8f0; justify-content: center;">
                <button type="button" id="btn-confirm-cancelar" style="padding: 12px 32px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; color: #64748b; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; min-width: 120px;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                    Cancelar
                </button>
                <button type="button" id="btn-confirm-ok" style="padding: 12px 32px; border: none; border-radius: 10px; background: linear-gradient(135deg, #f97316, #ea580c); color: white; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; min-width: 120px; box-shadow: 0 4px 14px rgba(249,115,22,0.4);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(249,115,22,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(249,115,22,0.4)'">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Button -->

    <!-- ========================================
         MODAIS SECUNDÁRIOS DO ORÇAMENTO
         ======================================== -->
    
    <!-- Modal NFs Relacionadas -->
    <div class="modal-overlay" id="modal-nfs-relacionadas">
        <div class="modal-content-omie" style="max-width: 700px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <h2><i class="fas fa-file-alt"></i> Notas Fiscais Relacionadas</h2>
                <button class="close-btn" onclick="fecharModalNFsRelacionadas()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #666; margin-bottom: 16px;">Vincule notas fiscais de compra ou outras NF-e relacionadas a este orçamento.</p>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="nf-relacionada-numero" placeholder="Número da NF" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="nf-relacionada-serie" placeholder="Série" style="width: 80px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="nf-relacionada-chave" placeholder="Chave de Acesso (44 dígitos)" style="flex: 2; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    <button onclick="adicionarNFRelacionada()" style="background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Número</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Série</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569;">Chave de Acesso</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="nfs-relacionadas-lista">
                        <tr>
                            <td colspan="4" style="padding: 30px; text-align: center; color: #999;">
                                <i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <p style="margin: 0;">Nenhuma NF relacionada</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalNFsRelacionadas()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarNFsRelacionadas()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Info Fisco -->
    <div class="modal-overlay" id="modal-info-fisco">
        <div class="modal-content-omie" style="max-width: 600px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #059669, #047857);">
                <h2><i class="fas fa-university"></i> Informações do Fisco</h2>
                <button class="close-btn" onclick="fecharModalInfoFisco()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #666; margin-bottom: 16px;">Informações adicionais para o fisco que seréo incluídas na NF-e.</p>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;">Informações ao Fisco</label>
                    <textarea id="info-fisco-texto" rows="4" placeholder="Informe dados relevantes para a fiscalizaçéo..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
                    <span style="font-size: 11px; color: #999;">Ex: Operaçéo beneficiada por incentivo fiscal, isençéo de ICMS conforme convênio X...</span>
                </div>
                
                <div style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-top: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #92400e;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        Estas informações apareceréo no campo de Informações Complementares da NF-e e seréo validadas pela SEFAZ.
                    </p>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalInfoFisco()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarInfoFisco()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Campos Obs NF-e -->
    <div class="modal-overlay" id="modal-campos-obs-nfe">
        <div class="modal-content-omie" style="max-width: 650px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #7c3aed, #6d28d9);">
                <h2><i class="fas fa-sticky-note"></i> Campos de Observaçéo NF-e</h2>
                <button class="close-btn" onclick="fecharModalCamposObsNFe()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;">Campo do Contribuinte</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="obs-campo" placeholder="Nome do campo" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <input type="text" id="obs-valor" placeholder="Valor" style="flex: 2; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        <button onclick="adicionarCampoObs()" style="background: #7c3aed; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="campos-obs-lista" style="max-height: 200px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #999; background: #f8fafc; border-radius: 8px;">
                        <i class="fas fa-list" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 13px;">Nenhum campo adicional</p>
                    </div>
                </div>
                
                <div style="background: #dbeafe; padding: 12px 16px; border-radius: 8px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 12px; color: #1e40af;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        Estes campos seréo incluídos na tag obsCont da NF-e.
                    </p>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalCamposObsNFe()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarCamposObsNFe()" style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Endereço de Entrega -->
    <div class="modal-overlay" id="modal-endereco-entrega">
        <div class="modal-content-omie" style="max-width: 700px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                <h2><i class="fas fa-truck"></i> Endereço de Entrega</h2>
                <button class="close-btn" onclick="fecharModalEnderecoEntrega()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="usar-endereco-cliente" checked onchange="toggleEnderecoEntrega()">
                        <span style="font-size: 14px; color: #475569;">Usar mesmo endereço do cliente</span>
                    </label>
                </div>
                
                <div id="form-endereco-entrega" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CEP</label>
                            <input type="text" id="entrega-cep" placeholder="00000-000" onblur="buscarCepEntrega()" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Logradouro</label>
                            <input type="text" id="entrega-logradouro" placeholder="Rua, Av..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 100px 1fr 150px; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Número</label>
                            <input type="text" id="entrega-numero" placeholder="Nº" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Complemento</label>
                            <input type="text" id="entrega-complemento" placeholder="Apto, Sala..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Bairro</label>
                            <input type="text" id="entrega-bairro" placeholder="Bairro" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 80px; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Cidade</label>
                            <input type="text" id="entrega-cidade" placeholder="Cidade" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">UF</label>
                            <input type="text" id="entrega-uf" placeholder="UF" maxlength="2" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalEnderecoEntrega()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarEnderecoEntrega()" style="background: #f97316; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal ICMS Retido Transporte -->
    <div class="modal-overlay" id="modal-icms-transporte">
        <div class="modal-content-omie" style="max-width: 550px; border-radius: 12px;">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #0891b2, #0e7490);">
                <h2><i class="fas fa-percentage"></i> ICMS Retido no Transporte</h2>
                <button class="close-btn" onclick="fecharModalICMSTransporte()">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Valor Serviço (R$)</label>
                        <input type="text" id="icms-valor-servico" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Base de Cálculo (R$)</label>
                        <input type="text" id="icms-base-calculo" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Alíquota ICMS (%)</label>
                        <input type="text" id="icms-aliquota" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Valor ICMS Retido (R$)</label>
                        <input type="text" id="icms-valor-retido" placeholder="0,00" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CFOP</label>
                        <input type="text" id="icms-cfop" placeholder="0000" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Código Município</label>
                        <input type="text" id="icms-cod-municipio" placeholder="0000000" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                </div>
            </div>
            <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="fecharModalICMSTransporte()" style="background: white; color: #475569; border: 1px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="salvarICMSTransporte()" style="background: #0891b2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salvar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL INCLUIR CLIENTE - ESTILO PROFISSIONAL
         ======================================== -->
    <div class="modal-overlay" id="modal-novo-cliente">
        <div class="modal-content-omie" style="max-width: 720px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="modal-header-omie" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 24px 28px; position: relative;">
                <div>
                    <h2 style="color: white; font-size: 24px; font-weight: 600; margin: 0 0 4px 0;"><i class="fas fa-user-plus" style="margin-right: 10px;"></i>Incluir Cliente</h2>
                    <p style="font-size: 13px; color: rgba(255,255,255,0.85); margin: 0;">Utilize uma das opções de pesquisa abaixo para cadastrar rapidamente</p>
                </div>
                <button class="close-btn" onclick="verificarAlteracoesCliente()" style="color: white; background: rgba(255,255,255,0.15); border: none; font-size: 13px; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    Fechar <i class="fas fa-times" style="margin-left: 6px;"></i>
                </button>
            </div>
            
            <div class="modal-body-cliente" style="padding: 24px 28px; max-height: calc(90vh - 140px); overflow-y: auto; background: #f8fafc;">
                <!-- Pesquisa Atômica -->
                <div class="cliente-opcao-pesquisa" style="margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-bolt" style="font-size: 18px;"></i>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Pesquisa Inteligente</h3>
                        </div>
                        <div style="text-align: right; font-size: 11px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px;">
                            <span><i class="fas fa-infinity" style="margin-right: 4px;"></i> Pesquisas ilimitadas</span>
                        </div>
                    </div>
                    <div style="background: #fff; border: 1px solid #e2e8f0; border-top: none; padding: 20px;">
                        <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Digite aqui o que deseja pesquisar</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="pesquisa-atomica" placeholder="CNPJ, CPF, Nome, Razéo Social, Telefone ou E-mail" style="flex: 1; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                            <button onclick="pesquisarAtomico()" style="padding: 14px 20px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pesquisa por CNPJ/CPF -->
                <div class="cliente-opcao-pesquisa" onclick="expandirPesquisaCNPJ()" style="cursor: pointer; margin-bottom: 12px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(20,184,166,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-id-card"></i> Pesquisa por CNPJ / CPF</h3>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">Consulta automática na Receita Federal</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px;">
                        <i class="fas fa-search" style="font-size: 16px;"></i>
                        <span style="font-size: 18px; font-weight: 700;">CNPJ</span>
                    </div>
                </div>
                
                <!-- Campo CNPJ expandido -->
                <div id="pesquisa-cnpj-expandido" style="display: none; background: #fff; border: 2px solid #14b8a6; border-radius: 12px; padding: 20px; margin-bottom: 12px; margin-top: -8px; box-shadow: 0 4px 12px rgba(20,184,166,0.15);">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">CNPJ ou CPF</label>
                            <input type="text" id="cliente-cnpj" placeholder="00.000.000/0000-00" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" oninput="formatarCNPJ(this)" onfocus="this.style.borderColor='#14b8a6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <button onclick="consultarCNPJ()" style="padding: 14px 24px; background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-search" style="margin-right: 6px;"></i> Consultar
                        </button>
                    </div>
                    <div id="cnpj-loading" style="display: none; padding: 12px; background: #eff6ff; border-radius: 8px; margin-top: 12px;">
                        <i class="fas fa-spinner fa-spin" style="color: #3b82f6;"></i>
                        <span style="margin-left: 8px; color: #1e40af;">Consultando na Receita Federal...</span>
                    </div>
                    <div id="cnpj-resultado" style="display: none; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; margin-top: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-check-circle" style="color: #22c55e;"></i>
                            <span style="font-weight: 600; color: #166534;">CNPJ encontrado!</span>
                        </div>
                        <p id="cnpj-info" style="font-size: 13px; color: #166534; margin: 0;"></p>
                    </div>
                </div>

                <!-- Pesquisa no Google -->
                <div class="cliente-opcao-pesquisa" onclick="expandirPesquisaGoogle()" style="cursor: pointer; margin-bottom: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); color: #334155; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-globe" style="color: #4285f4;"></i> Pesquisa no Google</h3>
                        <p style="margin: 0; font-size: 12px; color: #64748b;">Busque por nome, razéo social ou endereço</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; background: white; padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <span style="font-size: 11px; color: #94a3b8;">by</span>
                        <svg viewBox="0 0 272 92" width="60" height="20">
                            <path fill="#4285F4" d="M115.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18C71.25 34.32 81.24 25 93.5 25s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44S80.99 39.2 80.99 47.18c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/>
                            <path fill="#EA4335" d="M163.75 47.18c0 12.77-9.99 22.18-22.25 22.18s-22.25-9.41-22.25-22.18c0-12.85 9.99-22.18 22.25-22.18s22.25 9.32 22.25 22.18zm-9.74 0c0-7.98-5.79-13.44-12.51-13.44s-12.51 5.46-12.51 13.44c0 7.9 5.79 13.44 12.51 13.44s12.51-5.55 12.51-13.44z"/>
                            <path fill="#FBBC05" d="M209.75 26.34v39.82c0 16.38-9.66 23.07-21.08 23.07-10.75 0-17.22-7.19-19.66-13.07l8.48-3.53c1.51 3.61 5.21 7.87 11.17 7.87 7.31 0 11.84-4.51 11.84-13v-3.19h-.34c-2.18 2.69-6.38 5.04-11.68 5.04-11.09 0-21.25-9.66-21.25-22.09 0-12.52 10.16-22.26 21.25-22.26 5.29 0 9.49 2.35 11.68 4.96h.34v-3.61h9.25zm-8.56 20.92c0-7.81-5.21-13.52-11.84-13.52-6.72 0-12.35 5.71-12.35 13.52 0 7.73 5.63 13.36 12.35 13.36 6.63 0 11.84-5.63 11.84-13.36z"/>
                            <path fill="#4285F4" d="M225 3v65h-9.5V3h9.5z"/>
                            <path fill="#34A853" d="M262.02 54.48l7.56 5.04c-2.44 3.61-8.32 9.83-18.48 9.83-12.6 0-22.01-9.74-22.01-22.18 0-13.19 9.49-22.18 20.92-22.18 11.51 0 17.14 9.16 18.98 14.11l1.01 2.52-29.65 12.28c2.27 4.45 5.8 6.72 10.75 6.72 4.96 0 8.4-2.44 10.92-6.14zm-23.27-7.98l19.82-8.23c-1.09-2.77-4.37-4.7-8.23-4.7-4.95 0-11.84 4.37-11.59 12.93z"/>
                            <path fill="#EA4335" d="M35.29 41.41V32H67c.31 1.64.47 3.58.47 5.68 0 7.06-1.93 15.79-8.15 22.01-6.05 6.3-13.78 9.66-24.02 9.66C16.32 69.35.36 53.89.36 34.91.36 15.93 16.32.47 35.3.47c10.5 0 17.98 4.12 23.6 9.49l-6.64 6.64c-4.03-3.78-9.49-6.72-16.97-6.72-13.86 0-24.7 11.17-24.7 25.03 0 13.86 10.84 25.03 24.7 25.03 8.99 0 14.11-3.61 17.39-6.89 2.66-2.66 4.41-6.46 5.1-11.65l-22.49.01z"/>
                        </svg>
                    </div>
                </div>

                <!-- Campo Google expandido -->
                <div id="pesquisa-google-expandido" style="display: none; background: #fff; border: 2px solid #4285f4; border-radius: 12px; padding: 20px; margin-bottom: 12px; margin-top: -8px; box-shadow: 0 4px 12px rgba(66,133,244,0.15);">
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Pesquisar no Google</label>
                            <input type="text" id="pesquisa-google" placeholder="Nome da empresa, endereço, telefone..." style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" onfocus="this.style.borderColor='#4285f4'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <button onclick="pesquisarGoogle()" style="padding: 14px 24px; background: #4285f4; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#3367d6'" onmouseout="this.style.background='#4285f4'">
                            <i class="fas fa-search"></i> Pesquisar
                        </button>
                    </div>
                </div>

                <!-- Inseráéo Manual -->
                <div class="cliente-opcao-pesquisa" onclick="expandirInsercaoManual()" style="cursor: pointer; background: linear-gradient(135deg, #475569 0%, #64748b 100%); color: white; padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(71,85,105,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i class="fas fa-edit"></i> Inseráéo Manual</h3>
                        <p style="margin: 0; font-size: 12px; opacity: 0.9;">Cadastre os dados manualmente ou pesquise pelo CEP</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px;">
                        <i class="fas fa-keyboard" style="font-size: 24px;"></i>
                    </div>
                </div>

                <!-- Formulário Manual Expandido -->
                <div id="insercao-manual-expandido" style="display: none; background: #fff; border: 2px solid #64748b; border-radius: 12px; padding: 24px; margin-top: 8px; box-shadow: 0 4px 12px rgba(71,85,105,0.15);">
                    <h4 style="font-size: 15px; color: #1e293b; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-building" style="color: #3b82f6;"></i> Dados do Cliente
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">CNPJ/CPF</label>
                            <input type="text" id="manual-cnpj" placeholder="00.000.000/0000-00" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Tipo de Pessoa</label>
                            <select id="manual-tipo-pessoa" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <option value="PJ">Pessoa Jurídica</option>
                                <option value="PF">Pessoa Física</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Razéo Social / Nome <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="manual-razao-social" placeholder="Nome completo da empresa ou pessoa" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Nome Fantasia</label>
                            <input type="text" id="manual-fantasia" placeholder="Nome fantasia" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Inscriçéo Estadual</label>
                            <input type="text" id="manual-ie" placeholder="Isento ou nº IE" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <h4 style="font-size: 15px; color: #1e293b; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i> Endereço
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">CEP</label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" id="manual-cep" placeholder="00000-000" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; transition: all 0.2s;" oninput="formatarCEP(this)" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <button onclick="consultarCEPManual()" style="padding: 12px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Logradouro</label>
                            <input type="text" id="manual-logradouro" placeholder="Rua, Avenida, etc." style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Número</label>
                            <input type="text" id="manual-numero" placeholder="Nº" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 90px; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Complemento</label>
                            <input type="text" id="manual-complemento" placeholder="Sala, Bloco" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Bairro</label>
                            <input type="text" id="manual-bairro" placeholder="Bairro" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Cidade</label>
                            <input type="text" id="manual-cidade" placeholder="Cidade" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">UF</label>
                            <select id="manual-uf" style="width: 100%; padding: 12px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                                <option value="">UF</option>
                                <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="font-size: 15px; color: #1e293b; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
                        <i class="fas fa-phone-alt" style="color: #3b82f6;"></i> Contato
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Telefone</label>
                            <input type="text" id="manual-telefone" placeholder="(00) 0000-0000" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">Celular/WhatsApp</label>
                            <input type="text" id="manual-celular" placeholder="(00) 00000-0000" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500;">E-mail</label>
                            <input type="email" id="manual-email" placeholder="email@empresa.com.br" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <button onclick="fecharModalNovoCliente()" style="padding: 12px 28px; background: #f8fafc; color: #64748b; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                            <i class="fas fa-times" style="margin-right: 6px;"></i> Cancelar
                        </button>
                        <button onclick="salvarClienteManual()" style="padding: 12px 28px; background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59,130,246,0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.3)'">
                            <i class="fas fa-check" style="margin-right: 6px;"></i> Salvar Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL INCLUIR PRODUTO - ESTILO OMIE
         ======================================== -->
    <div class="modal-overlay" id="modal-novo-produto">
        <div class="modal-content-omie" style="max-width: 1200px; border-radius: 0; height: 95vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #e5e5e5; background: white; flex-shrink: 0;">
                <h2 style="color: #333; font-size: 20px; font-weight: 400; margin: 0;">Incluir Produto</h2>
                <button class="close-btn" onclick="verificarAlteracoesProduto()" style="color: #666; background: none; border: none; font-size: 14px; cursor: pointer;">
                    Fechar <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Container Principal -->
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- área Principal -->
                <div style="flex: 1; padding: 24px; overflow-y: auto; background: #fafafa;">
                    <!-- Seçéo Superior: Imagem + Dados Básicos -->
                    <div style="display: flex; gap: 24px; margin-bottom: 24px;">
                        <!-- Upload de Imagem -->
                        <div style="flex-shrink: 0;">
                            <div id="produto-imagem-container" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f8f8; cursor: pointer; position: relative;" onclick="document.getElementById('produto-imagem-input').click()">
                                <img id="produto-imagem-preview" src="" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                                <i class="fas fa-image" id="produto-imagem-icon" style="font-size: 32px; color: #ccc;"></i>
                            </div>
                            <input type="file" id="produto-imagem-input" accept="image/*" style="display: none;" onchange="previewImagemProduto(this)">
                            <a href="#" onclick="document.getElementById('produto-imagem-input').click(); return false;" style="display: block; text-align: center; margin-top: 8px; font-size: 12px; color: #f97316;">
                                <i class="fas fa-pencil-alt"></i> Alterar
                            </a>
                            <p style="text-align: center; font-size: 11px; color: #999; margin-top: 4px;">Nenhuma<br>imagem</p>
                        </div>
                        
                        <!-- Dados Básicos -->
                        <div style="flex: 1;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Descriçéo do Produto</label>
                                <input type="text" id="produto-descricao" placeholder="Preencha aqui a Descriçéo do Produto" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código do Produto</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-codigo" value="PRD00048" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f8f8f8;">
                                        <i class="fas fa-info-circle" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; cursor: help;" title="Código único do produto"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código EAN (GTIN)</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-ean" placeholder="Opcional" style="width: 100%; padding: 12px; padding-right: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-globe" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Unidade</label>
                                    <select id="produto-unidade" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; color: #999;">
                                        <option value="">Preencha aqui a Unidade</option>
                                        <option value="UN">UN - Unidade</option>
                                        <option value="M">M - Metro</option>
                                        <option value="M2">M² - Metro Quadrado</option>
                                        <option value="KG">KG - Quilograma</option>
                                        <option value="CX">CX - Caixa</option>
                                        <option value="PC">PC - Peça</option>
                                        <option value="RL">RL - Rolo</option>
                                        <option value="LT">LT - Litro</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Preço Unitário de Venda</label>
                                    <input type="text" id="produto-preco-venda" value="0,000000" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-align: right;" oninput="formatarMoedaProduto(this)">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Código NCM</label>
                                    <div style="position: relative;">
                                        <input type="text" id="produto-ncm" placeholder="Selecione aqui o NCM" style="width: 100%; padding: 12px; padding-left: 36px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #f97316; margin-bottom: 4px;">Família de Produto</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select id="produto-familia" style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; color: #999;">
                                            <option value="">Opcional (mas importante para os seus ?</option>
                                        </select>
                                        <button style="padding: 12px; background: none; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #f97316;">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Definiçéo do Produto -->
                        <div style="flex-shrink: 0; width: 180px;">
                            <h4 style="font-size: 13px; color: #333; margin: 0 0 16px 0; font-weight: 500;">Definiçéo do Produto</h4>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" data-active="true" onclick="toggleDefinicaoProduto(this, 'simples')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Simples</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" onclick="toggleDefinicaoProduto(this, 'kit')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Kit</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                                
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <div class="toggle-switch-produto" onclick="toggleDefinicaoProduto(this, 'variacoes')">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span style="font-size: 13px; color: #333;">Com Variações</span>
                                    <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Abas -->
                    <div style="border-bottom: 1px solid #e5e5e5; margin-bottom: 20px;">
                        <div style="display: flex; gap: 0;">
                            <button class="produto-tab active" onclick="mudarAbaProduto('estoque', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid #f97316; color: #f97316; font-size: 13px; font-weight: 500; cursor: pointer;">Estoque</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('custo', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Custo do Estoque</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('fornecedores', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Fornecedores</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('historico', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Histórico de Compras</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('adicionais', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Informações Adicionais</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('caracteristicas', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Características</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('fiscais', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Recomendações Fiscais</button>
                            <button class="produto-tab" onclick="mudarAbaProduto('observacoes', this)" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; color: #666; font-size: 13px; cursor: pointer;">Observações</button>
                        </div>
                    </div>
                    
                    <!-- Conteúdo das Abas -->
                    <div id="produto-tab-content">
                        <!-- Aba Estoque (Default) -->
                        <div id="tab-estoque" class="produto-tab-panel">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 8px 0; font-weight: 600;">Estoque Mínimo</h4>
                            <p style="font-size: 12px; color: #3b82f6; margin: 0 0 4px 0;">Clique diretamente em qualquer célula desta coluna para atualizar o estoque mínimo de cada local de estoque</p>
                            <p style="font-size: 12px; color: #666; margin: 0 0 16px 0;">Abaixo um resumo das informações de estoque deste produto.</p>
                            
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer;">
                                <div class="toggle-switch-produto" onclick="toggleControleLote(this)">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span style="font-size: 13px; color: #333;">Este produto possui controle de lote</span>
                                <i class="fas fa-info-circle" style="color: #999; font-size: 12px;"></i>
                            </label>
                            
                            <!-- Tabela de Estoque -->
                            <div style="background: white; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f8f8;">
                                            <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Local de Estoque <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Estoque Disponível <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                CMC Unitário <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                CMC Total <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: right; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Estoque Mínimo <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: center; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Previséo de Entrada <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                            <th style="padding: 12px 16px; text-align: center; font-weight: 500; color: #333; border-bottom: 1px solid #e5e5e5;">
                                                Previséo de Saída <span style="color: #999;">É</span>
                                                <i class="fas fa-filter" style="color: #ccc; margin-left: 4px; font-size: 10px;"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-estoque-body">
                                        <tr>
                                            <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                                <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 8px; display: block;"></i>
                                                Nenhum registro de estoque
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Outras abas (escondidas por padréo) -->
                        <div id="tab-custo" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Custo do Estoque</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Preço de Custo (R$)</label>
                                    <input type="text" id="produto-preco-custo" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CMC Médio (R$)</label>
                                    <input type="text" id="produto-cmc" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Margem (%)</label>
                                    <input type="text" id="produto-margem" value="0,00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-fornecedores" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Fornecedores</h4>
                            <p style="color: #666; font-size: 13px;">Nenhum fornecedor vinculado a este produto.</p>
                            <button style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-plus"></i> Adicionar Fornecedor
                            </button>
                        </div>
                        
                        <div id="tab-historico" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Histórico de Compras</h4>
                            <p style="color: #666; font-size: 13px;">Nenhuma compra registrada para este produto.</p>
                        </div>
                        
                        <div id="tab-adicionais" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Informações Adicionais</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Bruto (kg)</label>
                                    <input type="number" id="produto-peso-bruto" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Peso Líquido (kg)</label>
                                    <input type="number" id="produto-peso-liquido" placeholder="0.00" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Altura (cm)</label>
                                    <input type="number" id="produto-altura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Largura (cm)</label>
                                    <input type="number" id="produto-largura" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Comprimento (cm)</label>
                                    <input type="number" id="produto-comprimento" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-caracteristicas" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Características do Produto</h4>
                            <p style="color: #666; font-size: 13px;">Nenhuma característica definida.</p>
                            <button style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-plus"></i> Adicionar Caracteràstica
                            </button>
                        </div>
                        
                        <div id="tab-fiscais" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Recomendações Fiscais</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">CFOP Padréo</label>
                                    <input type="text" id="produto-cfop" placeholder="5102" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Origem</label>
                                    <select id="produto-origem" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="0">0 - Nacional</option>
                                        <option value="1">1 - Estrangeira - Importaçéo direta</option>
                                        <option value="2">2 - Estrangeira - Adquirida no mercado interno</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tab-observacoes" class="produto-tab-panel" style="display: none;">
                            <h4 style="font-size: 14px; color: #333; margin: 0 0 16px 0;">Observações</h4>
                            <textarea id="produto-observacoes" placeholder="Observações sobre o produto..." style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Direita - Ações -->
                <div style="width: 140px; background: #f8f8f8; border-left: 1px solid #e5e5e5; padding: 20px 16px; display: flex; flex-direction: column; flex-shrink: 0;">
                    <button onclick="salvarNovoProduto()" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; font-size: 13px; color: #333; margin-bottom: 12px;">
                        <i class="fas fa-save" style="color: #f97316;"></i> Salvar
                    </button>
                    
                    <!-- Navegaçéo entre produtos -->
                    <div style="margin-top: auto; display: flex; justify-content: center;">
                        <button style="width: 36px; height: 36px; background: white; border: 1px solid #e5e5e5; border-radius: 50%; cursor: pointer; color: #f97316;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Button -->
            <div style="position: fixed; bottom: 24px; right: 24px; z-index: 1000;">
                <button style="width: 56px; height: 56px; background: #25d366; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <i class="fab fa-whatsapp" style="font-size: 28px; color: white;"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Estilos do Toggle Switch para Produto -->
    <style>
        .toggle-switch-produto {
            width: 44px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch-produto[data-active="true"] {
            background: #f97316;
        }
        .toggle-switch-produto .toggle-slider {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch-produto[data-active="true"] .toggle-slider {
            left: 22px;
        }
        .produto-tab.active {
            color: #f97316 !important;
            border-bottom-color: #f97316 !important;
        }
    </style>

    <!-- ========================================
         MODAL GERAR RELATÓRIO PDF
         ======================================== -->
    <div class="modal-overlay" id="modal-exportar">
        <div class="modal-content" style="max-width: 520px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
            <!-- Header Empresarial -->
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 24px 28px; position: relative;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249,115,22,0.4);">
                        <i class="fas fa-file-pdf" style="font-size: 24px; color: white;"></i>
                    </div>
                    <div>
                        <h2 style="color: white; font-size: 20px; font-weight: 600; margin: 0;">Gerar Relatório</h2>
                        <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 4px 0 0 0;">Exporte seus dados em PDF profissional</p>
                    </div>
                </div>
                <button onclick="fecharModalExportar()" style="position: absolute; top: 16px; right: 16px; width: 36px; height: 36px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 28px; background: #fff;">
                <!-- Tipo de Relatório -->
                <div style="margin-bottom: 24px;">
                    <label style="font-size: 13px; font-weight: 600; color: #374151; display: block; margin-bottom: 12px;">
                        <i class="fas fa-list-alt" style="color: #f97316; margin-right: 8px;"></i>Tipo de Relatório
                    </label>
                    <select id="export-tipo-relatorio" style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; color: #374151; background: #fff; cursor: pointer; transition: all 0.2s;" onchange="atualizarPreviewRelatorio()">
                        <option value="pedidos">📦 Relatório de Pedidos/Orçamentos</option>
                        <option value="clientes">👥 Relatório de Clientes</option>
                        <option value="vendas">📊 Resumo de Vendas</option>
                        <option value="faturamento">💰 Relatório de Faturamento</option>
                    </select>
                </div>
                
                <!-- Período -->
                <div style="margin-bottom: 24px;">
                    <label style="font-size: 13px; font-weight: 600; color: #374151; display: block; margin-bottom: 12px;">
                        <i class="fas fa-calendar-alt" style="color: #f97316; margin-right: 8px;"></i>Período do Relatório
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 6px;">Data Inicial</label>
                            <input type="date" id="export-data-inicio" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; color: #374151;">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 6px;">Data Final</label>
                            <input type="date" id="export-data-fim" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; color: #374151;">
                        </div>
                    </div>
                </div>
                
                <!-- Opções Adicionais -->
                <div style="background: linear-gradient(135deg, #fef3c7, #fef9c3); border: 1px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <i class="fas fa-cog" style="color: #d97706;"></i>
                        <span style="font-size: 13px; font-weight: 600; color: #92400e;">Opções do Relatório</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; color: #78350f;">
                            <input type="checkbox" id="export-incluir-logo" checked style="width: 18px; height: 18px; accent-color: #f97316;">
                            Incluir logo da empresa
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; color: #78350f;">
                            <input type="checkbox" id="export-incluir-totais" checked style="width: 18px; height: 18px; accent-color: #f97316;">
                            Incluir totalizadores
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; color: #78350f;">
                            <input type="checkbox" id="export-agrupar-status" style="width: 18px; height: 18px; accent-color: #f97316;">
                            Agrupar por status/etapa
                        </label>
                    </div>
                </div>
                
                <!-- Preview Info -->
                <div id="export-preview-info" style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: #dcfce7; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-pdf" style="color: #16a34a; font-size: 18px;"></i>
                    </div>
                    <div>
                        <p style="font-size: 13px; font-weight: 600; color: #166534; margin: 0;">Relatório pronto para gerar</p>
                        <p style="font-size: 12px; color: #15803d; margin: 2px 0 0 0;">Formato: PDF • Template: Orçamento ALUFORCE</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="background: #f8fafc; border-top: 1px solid #e5e7eb; padding: 20px 28px; display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" onclick="fecharModalExportar()" style="padding: 12px 24px; border-radius: 10px; border: 2px solid #e5e7eb; background: #fff; color: #64748b; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" onclick="gerarRelatorioPDF()" style="padding: 12px 28px; border-radius: 10px; border: none; background: linear-gradient(135deg, #f97316, #ea580c); color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(249,115,22,0.35);">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden inputs para manter compatibilidade -->
    <input type="hidden" id="export-pedidos" value="true">
    <input type="hidden" id="export-clientes" value="false">
    <input type="hidden" id="export-produtos" value="false">

    <!-- ========================================
         MODAIS DE CADASTRO RÁPIDO
         ======================================== -->
    
    <!-- Modal Cadastro Rápido - Condiçéo de Pagamento -->
    <div class="modal-overlay" id="modal-nova-condicao">
        <div class="modal-content" style="max-width: 450px; border-radius: 12px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <h2><i class="fas fa-credit-card"></i> Nova Condiçéo de Pagamento</h2>
                <button class="modal-close" onclick="fecharModalNovaCondicao()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Nome da Condiçéo *</label>
                    <input type="text" id="nova-condicao-nome" placeholder="Ex: 30/60/90 dias" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Dias para Vencimento (separados por /)</label>
                    <input type="text" id="nova-condicao-dias" placeholder="Ex: 30/60/90" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Descriçéo</label>
                    <textarea id="nova-condicao-descricao" placeholder="Descriçéo opcional..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalNovaCondicao()">Cancelar</button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #8b5cf6;" onclick="salvarNovaCondicao()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro Rápido - Tipo de Frete -->
    <div class="modal-overlay" id="modal-novo-tipo-frete">
        <div class="modal-content" style="max-width: 450px; border-radius: 12px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <h2><i class="fas fa-truck"></i> Novo Tipo de Frete</h2>
                <button class="modal-close" onclick="fecharModalNovoTipoFrete()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Código do Frete *</label>
                    <input type="text" id="novo-tipo-frete-codigo" placeholder="Ex: CIF, FOB" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Descriçéo *</label>
                    <input type="text" id="novo-tipo-frete-descricao" placeholder="Ex: Por conta do remetente" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalNovoTipoFrete()">Cancelar</button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #f59e0b;" onclick="salvarNovoTipoFrete()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro Rápido - Regiéo -->
    <div class="modal-overlay" id="modal-nova-regiao">
        <div class="modal-content" style="max-width: 450px; border-radius: 12px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <h2><i class="fas fa-map-marker-alt"></i> Nova Regiéo</h2>
                <button class="modal-close" onclick="fecharModalNovaRegiao()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Nome da Regiéo *</label>
                    <input type="text" id="nova-regiao-nome" placeholder="Ex: Sudeste, Interior SP" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Estados (UFs)</label>
                    <input type="text" id="nova-regiao-estados" placeholder="Ex: SP, RJ, MG" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Descriçéo</label>
                    <textarea id="nova-regiao-descricao" placeholder="Descriçéo opcional..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalNovaRegiao()">Cancelar</button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #06b6d4;" onclick="salvarNovaRegiao()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro Rápido - Cargo/Funçéo -->
    <div class="modal-overlay" id="modal-novo-cargo">
        <div class="modal-content" style="max-width: 450px; border-radius: 12px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                <h2><i class="fas fa-user-tie"></i> Novo Cargo</h2>
                <button class="modal-close" onclick="fecharModalNovoCargo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Nome do Cargo *</label>
                    <input type="text" id="novo-cargo-nome" placeholder="Ex: Vendedor, Gerente Comercial" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Departamento</label>
                    <select id="novo-cargo-departamento" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                        <option value="">Selecione...</option>
                        <option value="vendas">Vendas</option>
                        <option value="compras">Compras</option>
                        <option value="financeiro">Financeiro</option>
                        <option value="rh">RH</option>
                        <option value="producao">Produçéo</option>
                        <option value="ti">TI</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Descriçéo</label>
                    <textarea id="novo-cargo-descricao" placeholder="Descriçéo das responsabilidades..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalNovoCargo()">Cancelar</button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #ec4899;" onclick="salvarNovoCargo()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro Rápido - Vendedor -->
    <div class="modal-overlay" id="modal-novo-vendedor">
        <div class="modal-content" style="max-width: 500px; border-radius: 12px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <h2><i class="fas fa-user-plus"></i> Novo Vendedor</h2>
                <button class="modal-close" onclick="fecharModalNovoVendedor()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Nome Completo *</label>
                        <input type="text" id="novo-vendedor-nome" placeholder="Nome do vendedor" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">E-mail</label>
                        <input type="email" id="novo-vendedor-email" placeholder="email@empresa.com" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Telefone</label>
                        <input type="text" id="novo-vendedor-telefone" placeholder="(00) 00000-0000" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Regiéo</label>
                        <select id="novo-vendedor-regiao" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            <option value="">Selecione...</option>
                            <option value="sudeste">Sudeste</option>
                            <option value="sul">Sul</option>
                            <option value="nordeste">Nordeste</option>
                            <option value="norte">Norte</option>
                            <option value="centro-oeste">Centro-Oeste</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151; display: block; margin-bottom: 6px;">Comisséo (%)</label>
                        <input type="number" id="novo-vendedor-comissao" placeholder="5" step="0.5" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn-modal btn-modal-cancel" onclick="fecharModalNovoVendedor()">Cancelar</button>
                <button type="button" class="btn-modal btn-modal-save" style="background: #3b82f6;" onclick="salvarNovoVendedor()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // UTILITÁRIOS GLOBAIS
        // ========================================
        function showToast(message, type = 'info') {
            // Remover toast existente
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            // Criar toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Estilos inline para o toast
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 14px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: toastSlideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover após 3 segundos
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Adicionar animações do toast
        if (!document.getElementById('toast-animations')) {
            const style = document.createElement('style');
            style.id = 'toast-animations';
            style.textContent = `
                @keyframes toastSlideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes toastSlideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ========================================
        // DADOS DO KANBAN (Carregados da API)
        // ========================================
        // Dados iniciais vazios - seréo carregados da API
        const dadosFallback = {
            orcamento: [],
            analise: [],
            aprovado: [],
            faturar: [],
            faturado: [],
            recibo: []
        };
        
        // Dados dinâmicos carregados da API
        let dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
        
        // Mapeamento de status da API para colunas do Kanban
        const statusParaColuna = {
            'orcamento': 'orcamento',
            'orçamento': 'orcamento',
            'analise-credito': 'analise',
            'analise': 'analise',
            'pedido-aprovado': 'aprovado',
            'aprovado': 'aprovado',
            'faturar': 'faturar',
            'faturado': 'faturado',
            'entregue': 'recibo',
            'recibo': 'recibo'
        };
        
        // Mapeamento de coluna para status da API
        const colunaParaStatus = {
            'orcamento': 'orcamento',
            'analise': 'analise-credito',
            'aprovado': 'pedido-aprovado',
            'faturar': 'faturar',
            'faturado': 'faturado',
            'recibo': 'recibo'
        };
        
        // Carregar dados da API com filtros
        async function carregarDadosKanban(filtros = null) {
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                // Construir query string com filtros
                let url = '/api/vendas/kanban/pedidos';
                if (filtros) {
                    const params = new URLSearchParams();
                    if (filtros.dataInclusao && filtros.dataInclusao !== 'tudo') {
                        params.append('dataInclusao', filtros.dataInclusao);
                    }
                    if (filtros.dataPrevisao && filtros.dataPrevisao !== 'tudo') {
                        params.append('dataPrevisao', filtros.dataPrevisao);
                    }
                    if (filtros.dataFaturamento && filtros.dataFaturamento !== 'tudo') {
                        params.append('dataFaturamento', filtros.dataFaturamento);
                    }
                    if (filtros.vendedor && filtros.vendedor !== 'todos') {
                        params.append('vendedor', filtros.vendedor);
                    }
                    if (filtros.projeto && filtros.projeto !== 'todos') {
                        params.append('projeto', filtros.projeto);
                    }
                    params.append('exibirCancelados', filtros.exibirCancelados ? 'true' : 'false');
                    params.append('exibirDenegados', filtros.exibirDenegados ? 'true' : 'false');
                    params.append('exibirEncerrados', filtros.exibirEncerrados ? 'true' : 'false');
                    
                    const queryString = params.toString();
                    if (queryString) url += '?' + queryString;
                }
                
                console.log('?? Carregando Kanban:', url);
                
                const resp = await fetch(url, {
                    credentials: 'include',
                    headers: headers
                });
                
                if (!resp.ok) throw new Error(`Erro ${resp.status}`);
                
                const dados = await resp.json();
                console.log('?? Resposta da API:', dados);
                console.log('?? é array?', Array.isArray(dados), '| Length:', dados?.length);
                
                // Resetar dados
                dadosVendas = {
                    orcamento: [],
                    analise: [],
                    aprovado: [],
                    faturar: [],
                    faturado: [],
                    recibo: []
                };
                
                // Organizar por coluna
                if (Array.isArray(dados) && dados.length > 0) {
                    console.log('?? Organizando', dados.length, 'pedidos...');
                    dados.forEach((pedido, index) => {
                        const colunaDestino = statusParaColuna[pedido.status] || 'orcamento';
                        if (index < 3) {
                            console.log(`   Pedido ${index + 1}: ID=${pedido.id}, Status="${pedido.status}" -> Coluna "${colunaDestino}"`);
                        }
                        const item = {
                            id: pedido.id,
                            cliente: pedido.cliente || pedido.cliente_nome || 'Cliente néo informado',
                            status: pedido.faturamento || pedido.observacoes || 'Aguardando',
                            valor: pedido.valor || pedido.valor_total || 0,
                            parcelas: pedido.tipo || pedido.condicao_pagamento || 'a vista',
                            origem: pedido.origem || 'Omie',
                            vendedor: pedido.vendedor_nome || pedido.vendedor || '',
                            vendedor_id: pedido.vendedor_id,
                            transportadora: pedido.transportadora || null,
                            nf: pedido.notaFiscal || pedido.nf_numero || null,
                            mensagem: pedido.manifestacao || null,
                            itens: pedido.itens || [],
                            _statusOriginal: pedido.status
                        };
                        dadosVendas[colunaDestino].push(item);
                    });
                    console.log('? Dados organizados:', {
                        orcamento: dadosVendas.orcamento.length,
                        analise: dadosVendas.analise.length,
                        aprovado: dadosVendas.aprovado.length,
                        faturar: dadosVendas.faturar.length,
                        faturado: dadosVendas.faturado.length,
                        recibo: dadosVendas.recibo.length
                    });
                } else {
                    console.log('?? API retornou vazio, usando dados de fallback');
                    dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                }
                
                console.log('?? Renderizando Kanban...');
                renderKanban();
                
            } catch (err) {
                console.error('? Erro ao carregar dados do Kanban:', err);
                showNotification('Néo foi possível carregar dados do servidor. Exibindo dados locais.', 'error');
                dadosVendas = JSON.parse(JSON.stringify(dadosFallback));
                renderKanban();
            }
        }
        
        // Salvar status do pedido na API
        async function salvarStatusPedido(pedidoId, novoStatus) {
            try {
                const statusAPI = colunaParaStatus[novoStatus] || novoStatus;
                // Buscar token de múltiplas fontes possóveis
                const token = localStorage.getItem('authToken') || localStorage.getItem('token') || sessionStorage.getItem('authToken');
                
                const headers = { 'Content-Type': 'application/json' };
                // SÉ adicionar Authorization se tiver token válido
                if (token && token !== 'null' && token !== 'undefined') {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const resp = await fetch(`/api/vendas/pedidos/${pedidoId}/status`, {
                    method: 'PUT',
                    credentials: 'include', // Envia cookies automaticamente
                    headers: headers,
                    body: JSON.stringify({ status: statusAPI })
                });
                
                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Erro ao salvar status');
                }
                console.log('? Status do pedido', pedidoId, 'atualizado para:', statusAPI);
                return true;
            } catch (err) {
                console.error('? Erro ao salvar status:', err);
                return false;
            }
        };

        // ========================================
        // RENDER CARDS
        // ========================================
        // Mapeamento de prefixos dinâmicos por coluna
        const prefixosPorColuna = {
            'orcamento': 'Orçamento',
            'analise': 'Análise',
            'aprovado': 'Pedido',
            'faturar': 'Faturar',
            'faturado': 'Faturado',
            'recibo': 'Recibo'
        };
        
        function renderCard(item, coluna = 'orcamento') {
            const statusClass = item.status === 'Faturado' ? 'faturado' : 'atrasado';
            const prefixo = prefixosPorColuna[coluna] || 'Pedido';
            
            // Verifica se o card deve ser bloqueado (faturado ou recibo néo podem ser arrastados)
            const isBloqueado = coluna === 'faturado' || coluna === 'recibo';
            const draggableAttr = isBloqueado ? 'false' : 'true';
            const cardBloqueadoClass = isBloqueado ? 'card-bloqueado' : '';
            
            let lockBadge = '';
            if (isBloqueado) {
                lockBadge = `<span class="card-badge locked"><i class="fas fa-lock"></i> Bloqueado</span>`;
            }
            
            let nfBadge = '';
            if (item.nf) {
                nfBadge = `<span class="card-badge nf">Nota Fiscal: ${item.nf}</span>`;
            }

            let transportadora = '';
            if (item.transportadora) {
                transportadora = `<div class="card-transport">Transportadora: ${item.transportadora}</div>`;
            }

            let mensagem = '';
            if (item.mensagem) {
                mensagem = `
                    <div class="card-message">
                        <i class="fas fa-comment"></i>
                        <span>${item.mensagem}</span>
                    </div>
                `;
            }

            const parcelas = item.parcelas || item.tipo || 'a vista';
            const valorFormatado = (item.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            const origem = item.origem || 'Omie';
            
            return `
                <div class="kanban-card ${cardBloqueadoClass}" draggable="${draggableAttr}" data-id="${item.id}" data-vendedor-id="${item.vendedor_id || ''}" data-coluna="${coluna}" ondblclick="abrirModalEditar(${item.id})">
                    ${lockBadge}
                    ${nfBadge}
                    <div class="card-header">
                        <span class="card-number">${prefixo} Nº ${item.id}</span>
                        <button class="card-menu" onclick="event.stopPropagation(); abrirModalEditar(${item.id})" title="Editar pedido">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="card-title">${item.cliente || 'Cliente néo informado'}</div>
                    <span class="card-status ${statusClass}">${item.status || 'Aguardando'}</span>
                    <div class="card-value">R$ ${valorFormatado} ${parcelas}</div>
                    <div class="card-origin">
                        <i class="fas fa-check-circle"></i>
                        Origem: ${origem}
                    </div>
                    ${transportadora}
                    ${mensagem}
                </div>
            `;
        }

        function renderKanban() {
            console.log('?? renderKanban() chamado');
            console.log('?? dadosVendas:', dadosVendas);
            
            // Orçamento
            const colOrcamento = document.getElementById('col-orcamento');
            if (!colOrcamento) {
                console.error('? Elemento col-orcamento néo encontrado!');
                return;
            }
            console.log('?? Orçamento:', dadosVendas.orcamento?.length || 0, 'itens');
            colOrcamento.innerHTML = dadosVendas.orcamento.map(item => renderCard(item, 'orcamento')).join('');

            // Análise
            const colAnalise = document.getElementById('col-analise');
            if (colAnalise) {
                console.log('?? Análise:', dadosVendas.analise?.length || 0, 'itens');
                colAnalise.innerHTML = dadosVendas.analise.map(item => renderCard(item, 'analise')).join('');
            }

            // Aprovado
            const colAprovado = document.getElementById('col-aprovado');
            if (colAprovado) {
                console.log('?? Aprovado:', dadosVendas.aprovado?.length || 0, 'itens');
                colAprovado.innerHTML = dadosVendas.aprovado.map(item => renderCard(item, 'aprovado')).join('');
            }

            // Faturar
            const colFaturar = document.getElementById('col-faturar');
            if (colFaturar) {
                console.log('?? Faturar:', dadosVendas.faturar?.length || 0, 'itens');
                colFaturar.innerHTML = dadosVendas.faturar.map(item => renderCard(item, 'faturar')).join('');
            }

            // Faturado
            const colFaturado = document.getElementById('col-faturado');
            if (colFaturado) {
                console.log('?? Faturado:', dadosVendas.faturado?.length || 0, 'itens');
                colFaturado.innerHTML = dadosVendas.faturado.map(item => renderCard(item, 'faturado')).join('');
            }

            // Recibo
            const colRecibo = document.getElementById('col-recibo');
            if (colRecibo) {
                console.log('?? Recibo:', dadosVendas.recibo?.length || 0, 'itens');
                if (dadosVendas.recibo && dadosVendas.recibo.length > 0) {
                    colRecibo.innerHTML = dadosVendas.recibo.map(item => renderCard(item, 'recibo')).join('');
                } else {
                    colRecibo.innerHTML = '<div class="empty-column"><i class="fas fa-receipt"></i><p>Nenhum recibo pendente</p></div>';
                }
            }

            console.log('? renderKanban() concluído');
            
            // Adicionar eventos de drag
            initDragAndDrop();
            
            // Atualizar contadores
            updateCounters();
        }

        // ========================================
        // DRAG AND DROP
        // ========================================
        function initDragAndDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column-content');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedCard) {
                // Capturar informações para histórico
                const pedidoId = draggedCard.getAttribute('data-id');
                const vendedorId = draggedCard.getAttribute('data-vendedor-id');
                const colunaOrigemEl = draggedCard.parentElement;
                const colunaOrigemId = colunaOrigemEl?.id?.replace('col-', '') || '';
                const colunaDestinoId = this.id;
                const colunaDestino = colunaDestinoId.replace('col-', '');
                
                // ========================================
                // VERIFICAÇéO DE PERMISSÕES
                // ========================================
                // Etapas em ordem: orcamento -> analise -> aprovado -> faturar -> faturado -> recibo
                const etapasOrdem = ['orcamento', 'analise', 'aprovado', 'faturar', 'faturado', 'recibo'];
                const etapaOrigemIdx = etapasOrdem.indexOf(colunaOrigemId);
                const etapaDestinoIdx = etapasOrdem.indexOf(colunaDestino);
                
                // ========================================
                // BLOQUEIO TOTAL PARA STATUS "FATURADO"
                // ========================================
                // Pedidos que estéo em "Faturado" NéO podem ser movidos para nenhuma outra coluna
                if (colunaOrigemId === 'faturado') {
                    showToast('⚠️ Pedidos FATURADOS néo podem ser movidos.\n\nA DANFE já foi emitida e o pedido está finalizado.', 'error');
                    return;
                }
                
                // Também bloquear recibo (etapa final)
                if (colunaOrigemId === 'recibo') {
                    showToast('⚠️ Pedidos com RECIBO néo podem ser movidos.\n\nEste pedido já foi concluído.', 'error');
                    return;
                }
                
                // Verificar se pode mover pedidos além de "Análise" (admin, supervisor ou diretor)
                const canMoveAll = usuarioLogado.canMoveAllKanban || usuarioLogado.isAdmin;
                
                // Se NéO pode mover todos (É apenas vendedor)
                if (!canMoveAll) {
                    // Verificar se é o dono do pedido
                    const isProprioPedido = vendedorId && usuarioLogado.id && vendedorId == usuarioLogado.id;
                    
                    if (!isProprioPedido) {
                        showToast('Você só pode mover seus próprios pedidos.', 'error');
                        return;
                    }
                    
                    // Vendedor só pode mover até "analise" (índice 1)
                    // Se destino for após "analise", bloquear
                    if (etapaDestinoIdx > 1) {
                        showToast('Apenas supervisores, diretores ou administradores podem mover pedidos após "Análise de Crédito".', 'warning');
                        return;
                    }
                    
                    // Também néo pode voltar de etapas avançadas
                    if (etapaOrigemIdx > 1) {
                        showToast('Este pedido já passou da Análise de Crédito. Contate um supervisor ou administrador.', 'warning');
                        return;
                    }
                }
                
                // Mapear IDs para nomes
                const colunaNomes = {
                    'col-orcamento': 'Orçamento',
                    'col-analise': 'Em análise',
                    'col-aprovado': 'Aprovado',
                    'col-faturar': 'Faturar',
                    'col-faturado': 'Faturado',
                    'col-recibo': 'Recibo Enviado'
                };
                
                const etapaOrigem = colunaNomes[colunaOrigemEl?.id] || 'Desconhecido';
                const etapaDestino = colunaNomes[colunaDestinoId] || 'Desconhecido';
                
                // Néo fazer nada se mesma coluna
                if (colunaOrigemId === colunaDestino) return;
                
                // Remove empty state se existir
                const emptyState = this.querySelector('.empty-column');
                if (emptyState) {
                    emptyState.remove();
                }
                
                this.appendChild(draggedCard);
                
                // ========================================
                // ATUALIZAR LABEL DO CARD EM TEMPO REAL
                // ========================================
                const cardNumberEl = draggedCard.querySelector('.card-number');
                if (cardNumberEl) {
                    const novoPrefixo = prefixosPorColuna[colunaDestino] || 'Pedido';
                    cardNumberEl.textContent = `${novoPrefixo} Nº ${pedidoId}`;
                }
                
                // Atualizar o data-coluna do card
                draggedCard.setAttribute('data-coluna', colunaDestino);
                
                // Atualizar dados locais - mover pedido entre arrays
                const pedidoIdx = dadosVendas[colunaOrigemId]?.findIndex(p => p.id == pedidoId);
                if (pedidoIdx !== undefined && pedidoIdx !== -1) {
                    const [pedido] = dadosVendas[colunaOrigemId].splice(pedidoIdx, 1);
                    if (!dadosVendas[colunaDestino]) dadosVendas[colunaDestino] = [];
                    pedido._statusOriginal = colunaParaStatus[colunaDestino] || colunaDestino;
                    dadosVendas[colunaDestino].push(pedido);
                }
                
                // Atualizar contadores
                updateCounters();
                
                // Salvar status na API
                const salvoComSucesso = await salvarStatusPedido(pedidoId, colunaDestino);
                
                // ========================================
                // EMISSéO AUTOMÁTICA DE DANFE AO FATURAR
                // ========================================
                if (colunaDestino === 'faturado') {
                    // Buscar dados do pedido para validaçéo
                    const pedidoParaFaturar = dadosVendas.faturado.find(p => p.id == pedidoId);
                    
                    // ========================================
                    // VALIDAÇéO DO PEDIDO ANTES DE EMITIR DANFE
                    // ========================================
                    let errosPedido = [];
                    
                    if (!pedidoParaFaturar) {
                        errosPedido.push('Dados do pedido néo encontrados');
                    } else {
                        // Validar cliente
                        if (!pedidoParaFaturar.cliente || pedidoParaFaturar.cliente.trim() === '' || pedidoParaFaturar.cliente === 'Cliente néo informado') {
                            errosPedido.push('Cliente néo informado');
                        }
                        
                        // Validar valor
                        if (!pedidoParaFaturar.valor || pedidoParaFaturar.valor <= 0) {
                            errosPedido.push('Valor do pedido inválido ou zerado');
                        }
                        
                        // Validar se tem itens (verificar via API se necessário)
                        if (pedidoParaFaturar.itens_count !== undefined && pedidoParaFaturar.itens_count === 0) {
                            errosPedido.push('Pedido néo possui itens');
                        }
                        
                        // Validar CNPJ/CPF do cliente se disponível
                        if (pedidoParaFaturar.cliente_cpf_cnpj) {
                            const docLimpo = pedidoParaFaturar.cliente_cpf_cnpj.replace(/\D/g, '');
                            if (docLimpo.length !== 11 && docLimpo.length !== 14) {
                                errosPedido.push('CPF/CNPJ do cliente inválido');
                            }
                        }
                    }
                    
                    // SE HOUVER ERROS, NéO EMITIR DANFE
                    if (errosPedido.length > 0) {
                        const listaErros = errosPedido.map(e => `• ${e}`).join('\n');
                        showNotification(`❌ DANFE néo pode ser emitida:\n${listaErros}`, 'error');
                        
                        // Mostrar modal de erro detalhado
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro ao Emitir DANFE',
                            html: `
                                <p>O pedido <strong>#${pedidoId}</strong> possui erros que impedem a emisséo da DANFE:</p>
                                <ul style="text-align: left; margin-top: 15px;">
                                    ${errosPedido.map(e => `<li style="color: #dc2626; margin: 5px 0;">⚠️ ${e}</li>`).join('')}
                                </ul>
                                <p style="margin-top: 15px; color: #666;">Corrija os dados do pedido e tente novamente.</p>
                            `,
                            confirmButtonText: 'Editar Pedido',
                            showCancelButton: true,
                            cancelButtonText: 'Fechar',
                            confirmButtonColor: '#3085d6',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                abrirModalEditar(pedidoId);
                            }
                        });
                        
                        // NéO emitir DANFE, mas pedido permanece em faturado para correçéo
                        return;
                    }
                    
                    // PEDIDO VÁLIDO - PROSSEGUIR COM EMISSéO
                    showNotification('⏳ Gerando DANFE automaticamente...', 'info');
                    
                    try {
                        // Gerar número de NF
                        const nfNumero = String(Math.floor(Math.random() * 900000) + 100000).padStart(8, '0');
                        if (pedidoParaFaturar) {
                            pedidoParaFaturar.nf = nfNumero;
                            pedidoParaFaturar.status = 'Faturado';
                        }
                        
                        // Tentar emitir NF-e via API
                        const token = localStorage.getItem('token');
                        const responseEmissao = await fetch('/api/nfe/emitir', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                pedido_id: pedidoId,
                                tipo: 'saida',
                                natureza_operacao: 'Venda de Mercadoria'
                            })
                        });
                        
                        if (responseEmissao.ok) {
                            const resultadoEmissao = await responseEmissao.json();
                            
                            if (resultadoEmissao.sucesso || resultadoEmissao.nfe_id) {
                                // Atualizar dados do pedido com informações da NF-e
                                if (pedidoParaFaturar) {
                                    pedidoParaFaturar.nfe_id = resultadoEmissao.nfe_id;
                                    pedidoParaFaturar.nf = resultadoEmissao.numero || nfNumero;
                                    pedidoParaFaturar.chave_acesso = resultadoEmissao.chave_acesso;
                                }
                                
                                showNotification(`✅ DANFE Nº ${resultadoEmissao.numero || nfNumero} emitida com sucesso!`, 'success');
                                
                                // Abrir DANFE em nova aba se disponível
                                if (resultadoEmissao.url_danfe) {
                                    window.open(resultadoEmissao.url_danfe, '_blank');
                                }
                            } else if (resultadoEmissao.erro || resultadoEmissao.mensagem) {
                                // Erro retornado pela API de emisséo
                                showNotification(`❌ Erro SEFAZ: ${resultadoEmissao.mensagem || resultadoEmissao.erro}`, 'error');
                            } else {
                                showNotification(`⚠️ NF-e gerada (Nº ${nfNumero}), aguardando autorizaçéo SEFAZ`, 'warning');
                            }
                        } else {
                            // Erro HTTP na emisséo
                            const erroBody = await responseEmissao.json().catch(() => ({}));
                            showNotification(`❌ Erro ao emitir: ${erroBody.erro || erroBody.message || 'Falha na comunicaçéo'}`, 'error');
                        }
                        
                        // Re-renderizar para mostrar o número da NF no card
                        renderKanban();
                        
                    } catch (errorEmissao) {
                        console.error('Erro ao emitir DANFE:', errorEmissao);
                        showNotification('⚠️ Pedido faturado, mas erro ao gerar DANFE. Tente manualmente.', 'warning');
                    }
                }
                
                // Registrar mudança de etapa no histórico
                if (pedidoId && etapaOrigem !== etapaDestino) {
                    try {
                        const token = localStorage.getItem('token');
                        await fetch(`/api/vendas/pedidos/${pedidoId}/historico`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                tipo: 'status',
                                descricao: `Etapa alterada de "${etapaOrigem}" para "${etapaDestino}"`,
                                usuario: 'Administrador'
                            })
                        });
                    } catch (err) {
                        console.log('Erro ao registrar histórico:', err);
                    }
                }
                
                // Notificar mudança
                if (salvoComSucesso) {
                    showNotification(`Pedido movido para ${etapaDestino}!`, 'success');
                } else {
                    showNotification(`Pedido movido para ${etapaDestino} (offline - sincronizar depois)`, 'warning');
                }
            }
        }

        function updateCounters() {
            const columns = {
                'col-orcamento': 'count-orcamento',
                'col-analise': 'count-analise',
                'col-aprovado': 'count-aprovado',
                'col-faturar': 'count-faturar',
                'col-faturado': 'count-faturado',
                'col-recibo': 'count-recibo'
            };

            Object.entries(columns).forEach(([colId, countId]) => {
                const col = document.getElementById(colId);
                const counter = document.getElementById(countId);
                if (col && counter) {
                    const count = col.querySelectorAll('.kanban-card').length;
                    counter.textContent = count === 0 ? 'Nenhum registro' : `${count} registro${count > 1 ? 's' : ''}`;
                }
            });
        }

        // ========================================
        // MODAL EDITAR PEDIDO
        // ========================================
        let pedidoAtual = null;
        
        function encontrarPedido(id) {
            // Busca em todas as colunas
            for (const coluna of Object.keys(dadosVendas)) {
                const pedido = dadosVendas[coluna].find(p => p.id == id);
                if (pedido) {
                    pedido._coluna = coluna;
                    return pedido;
                }
            }
            return null;
        }
        
        function abrirModalEditar(id) {
            const pedido = encontrarPedido(id);
            if (!pedido) {
                showNotification('Pedido néo encontrado', 'error');
                return;
            }
            
            pedidoAtual = pedido;
            
            // Atualizar título do modal
            document.getElementById('modal-titulo-pedido').textContent = `Orçamento Nº ${pedido.id}`;
            
            // Atualizar avatar do cliente (primeiras 2 letras)
            const clienteNome = pedido.cliente || 'Cliente';
            const iniciais = clienteNome.split(' ').map(n => n.charAt(0).toUpperCase()).slice(0, 2).join('');
            document.getElementById('modal-cliente-avatar').textContent = iniciais;
            
            // Preencher campos principais
            document.getElementById('edit-pedido-id').value = pedido.id;
            document.getElementById('edit-cliente').value = pedido.cliente || '';
            document.getElementById('edit-cliente-id').value = pedido.cliente_id || '';
            document.getElementById('edit-valor-total').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-total-mercadorias').value = formatarMoeda(pedido.valor || 0);
            document.getElementById('edit-vendedor').value = pedido.vendedor || '';
            document.getElementById('edit-parcelas').value = pedido.parcelas || '28/35/42/49';
            document.getElementById('edit-observacoes').value = pedido.mensagem || '';
            
            // Campos de frete
            if (document.getElementById('edit-transportadora')) {
                document.getElementById('edit-transportadora').value = pedido.transportadora || '';
            }
            if (document.getElementById('edit-nf')) {
                document.getElementById('edit-nf').value = pedido.nf || '';
            }
            if (document.getElementById('edit-origem')) {
                document.getElementById('edit-origem').value = pedido.origem || 'Omie';
            }
            
            // Atualizar alerta de status
            const statusAlert = document.getElementById('status-alert');
            const statusAlertText = document.getElementById('status-alert-text');
            if (pedido.status) {
                statusAlertText.textContent = pedido.status;
                statusAlert.className = 'status-alert';
                if (pedido.status.toLowerCase().includes('atrasado')) {
                    statusAlert.classList.add('warning');
                } else if (pedido.status.toLowerCase().includes('faturado') || pedido.status.toLowerCase().includes('aprovado')) {
                    statusAlert.classList.add('success');
                } else {
                    statusAlert.classList.add('info');
                }
            }
            
            // Limpar seleçéo de item
            itemSelecionado = null;
            itemSelecionadoIdx = null;
            
            // Carregar itens do pedido da API
            carregarItensPedido(pedido.id);
            
            // Resetar tabs para primeira aba
            switchModalTab('itens');
            
            // Limpar alterações anteriores e preparar rastreamento
            limparAlteracoes();
            
            // Mostrar modal
            document.getElementById('modal-editar-pedido').classList.add('active');
            
            // Rastrear alterações após um pequeno delay para garantir que os campos estáo preenchidos
            setTimeout(() => {
                const form = document.getElementById('modal-editar-pedido');
                const inputs = form.querySelectorAll('input, select, textarea');
                formOriginalData['modal-editar-pedido'] = {};
                inputs.forEach(input => {
                    const name = input.name || input.id;
                    if (name) {
                        formOriginalData['modal-editar-pedido'][name] = input.type === 'checkbox' ? input.checked : input.value;
                        input.addEventListener('change', () => marcarAlteracao('modal-editar-pedido', input));
                        input.addEventListener('input', () => marcarAlteracao('modal-editar-pedido', input));
                    }
                });
            }, 100);
        }
        
        function switchModalTab(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Ocultar todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Ativar tab e conteúdo selecionados
            document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        function formatarMoeda(valor) {
            return 'R$ ' + parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function fecharModalEditar() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-editar-pedido').classList.remove('active');
                    pedidoAtual = null;
                });
            } else {
                document.getElementById('modal-editar-pedido').classList.remove('active');
                pedidoAtual = null;
            }
        }
        
        async function salvarPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            // Capturar alterações para histórico
            const alteracoes = [];
            
            const novoCliente = document.getElementById('edit-cliente').value;
            if (novoCliente !== pedidoAtual.cliente) {
                alteracoes.push(`Cliente alterado de "${pedidoAtual.cliente}" para "${novoCliente}"`);
            }
            
            const novasParcelas = document.getElementById('edit-parcelas').value;
            if (novasParcelas !== pedidoAtual.parcelas) {
                alteracoes.push(`Parcelas alteradas para "${novasParcelas}"`);
            }
            
            const novoVendedor = document.getElementById('edit-vendedor').value;
            if (novoVendedor !== pedidoAtual.vendedor) {
                alteracoes.push(`Vendedor alterado para "${novoVendedor}"`);
            }
            
            let novaTransp = '';
            if (document.getElementById('edit-transportadora')) {
                novaTransp = document.getElementById('edit-transportadora').value;
                if (novaTransp !== pedidoAtual.transportadora) {
                    alteracoes.push(`Transportadora alterada para "${novaTransp}"`);
                }
            }
            
            let novaNF = '';
            if (document.getElementById('edit-nf')) {
                novaNF = document.getElementById('edit-nf').value;
            }
            
            let novaOrigem = '';
            if (document.getElementById('edit-origem')) {
                novaOrigem = document.getElementById('edit-origem').value;
            }
            
            let novaObs = '';
            if (document.getElementById('edit-observacoes')) {
                novaObs = document.getElementById('edit-observacoes').value;
                if (novaObs !== pedidoAtual.mensagem) {
                    alteracoes.push('Observações atualizadas');
                }
            }
            
            // Preparar dados para enviar à API
            const dadosAtualizacao = {
                cliente: novoCliente,
                cliente_id: document.getElementById('edit-cliente-id')?.value || null,
                vendedor_nome: novoVendedor,
                parcelas: novasParcelas,
                observacao: novaObs,
                transportadora: novaTransp,
                nf: novaNF
            };
            
            console.log('📝 Enviando atualizaçéo para API:', dadosAtualizacao);
            
            try {
                // Obter token de autenticaçéo
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                
                // Salvar no backend via API
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(dadosAtualizacao)
                });
                
                if (!response.ok) {
                    // Verificar se a resposta É JSON antes de parsear
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao salvar pedido');
                    } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText || 'Erro ao salvar pedido'}`);
                    }
                }
                
                const result = await response.json();
                console.log('? Pedido salvo na API:', result);
                
                // Atualizar dados locais do pedido
                pedidoAtual.cliente = novoCliente;
                pedidoAtual.parcelas = novasParcelas;
                pedidoAtual.vendedor = novoVendedor;
                pedidoAtual.vendedor_nome = novoVendedor;
                pedidoAtual.transportadora = novaTransp;
                pedidoAtual.nf = novaNF;
                pedidoAtual.mensagem = novaObs;
                if (novaOrigem) pedidoAtual.origem = novaOrigem;
                
                // Registrar histórico se houve alterações
                if (alteracoes.length > 0) {
                    await registrarHistoricoLocal('edicao', alteracoes.join('; '));
                }
                
                // Limpar alterações após salvar
                limparAlteracoes();
                
                // Recarregar dados do Kanban da API para garantir sincronizaçéo
                await carregarDadosKanban();
                
                // Fechar modal e notificar
                fecharModalEditar();
                showNotification('Pedido atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error('? Erro ao salvar pedido:', error);
                showNotification(error.message || 'Erro ao salvar pedido', 'error');
            }
        }
        
        // Funções adicionais da sidebar de ações
        function duplicarPedido() {
            if (!pedidoAtual) return;
            
            // Criar cópia do pedido
            const novoPedido = {
                ...pedidoAtual,
                id: Math.floor(Math.random() * 9000) + 1000,
                status: 'Novo',
                nf: null
            };
            
            // Adicionar É coluna de negociaçéo
            dadosVendas.negociacao.push(novoPedido);
            
            // Re-renderizar kanban
            renderKanban();
            
            showNotification(`Pedido duplicado! Novo Orçamento Nº ${novoPedido.id}`, 'success');
        }
        
        function imprimirPedido() {
            if (!pedidoAtual) return;
            // Atualizar número do orçamento no modal
            const numOrc = document.getElementById('pdf-numero-orcamento');
            if (numOrc) {
                numOrc.textContent = `Orçamento Nº ${String(pedidoAtual.id).padStart(6, '0')}`;
            }
            // Atualizar nome do cliente no modal
            const clienteNome = document.getElementById('pdf-cliente-nome');
            if (clienteNome) {
                clienteNome.textContent = pedidoAtual.cliente || 'Cliente néo identificado';
            }
            // Abrir modal de opções de impresséo
            document.getElementById('modal-imprimir').classList.add('active');
        }

        function fecharModalImprimir() {
            document.getElementById('modal-imprimir').classList.remove('active');
        }

        // Funçéo simplificada - apenas PDF completo com fallback
        async function executarImpressaoCompleta() {
            fecharModalImprimir();
            showNotification(`Gerando PDF...`, 'info');
            
            try {
                let token = localStorage.getItem('token');
                if (!token) {
                    const cookies = document.cookie.split('; ');
                    for (const cookie of cookies) {
                        if (cookie.startsWith('authToken=') || cookie.startsWith('token=')) {
                            token = decodeURIComponent(cookie.split('=')[1]);
                            break;
                        }
                    }
                }
                
                const pdfUrl = `/api/vendas/pedidos/${pedidoAtual.id}/pdf`;
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                // Tentar gerar via API com timeout de 15 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(pdfUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    let errorMessage = 'Erro ao gerar PDF';
                    try { errorMessage = (await response.json()).error || errorMessage; } catch(e) {}
                    throw new Error(errorMessage);
                }
                
                const pdfBlob = await response.blob();
                if (pdfBlob.size === 0) throw new Error('PDF gerado está vazio');
                
                const blobUrl = URL.createObjectURL(pdfBlob);
                const pdfWindow = window.open(blobUrl, '_blank');
                
                if (!pdfWindow) {
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = `orcamento_${pedidoAtual.id}.pdf`;
                    link.click();
                }
                showNotification('PDF gerado com sucesso!', 'success');
                setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                
            } catch (error) {
                console.error('Erro ao gerar PDF via API:', error);
                // Usar fallback HTML quando a API falhar
                showNotification('Usando modo alternativo...', 'warning');
                setTimeout(() => gerarImpressaoHTML(), 500);
            }
        }

        async function executarImpressao() {
            // Redireciona para a funçéo simplificada
            executarImpressaoCompleta();
        }
        
        // Funçéo auxiliar para gerar nome do documento baseado no status
        function gerarNomeDocumento(pedido, formato = 'titulo') {
            const status = (pedido.status || 'Orçamento').toUpperCase();
            const numero = String(pedido.id).padStart(5, '0');
            const empresa = 'ALUFORCE';
            
            // Mapear status para nome do documento
            const mapaStatus = {
                'NEGOCIAÇéO': 'ORÇAMENTO',
                'NEGOCIACAO': 'ORÇAMENTO',
                'EM PRODUÇéO': 'PEDIDO DE VENDA',
                'EM PRODUCAO': 'PEDIDO DE VENDA',
                'PRONTO': 'PEDIDO DE VENDA',
                'AGUARDANDO': 'PEDIDO DE VENDA',
                'FATURADO': 'PEDIDO FATURADO',
                'FINALIZADO': 'PEDIDO FINALIZADO',
                'CANCELADO': 'PEDIDO CANCELADO',
                'NOVO': 'ORÇAMENTO',
                'ORÇAMENTO': 'ORÇAMENTO'
            };
            
            const tipoDoc = mapaStatus[status] || 'ORÇAMENTO';
            
            if (formato === 'arquivo') {
                // Para nome de arquivo: ORCAMENTO - 00009 - ALUFORCE
                return `${tipoDoc.replace(/Ç/g, 'C').replace(/é/g, 'A')} - ${numero} - ${empresa}`;
            } else {
                // Para título do documento
                return tipoDoc;
            }
        }
        
        // Fallback para impresséo HTML
        function gerarImpressaoHTML() {
            const printWindow = window.open('', '_blank');
            
            // Verificar se o popup foi bloqueado
            if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
                showNotification('Popup bloqueado! Permitir popups para este site.', 'warning');
                // Alternativa: usar iframe oculto para impresséo
                gerarImpressaoIframe();
                return;
            }
            
            const tipoDocumento = gerarNomeDocumento(pedidoAtual);
            const nomeArquivo = gerarNomeDocumento(pedidoAtual, 'arquivo');
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const dataInclusao = pedidoAtual.data_criacao ? new Date(pedidoAtual.data_criacao).toLocaleString('pt-BR') : `${dataAtual} ${horaAtual}`;
            
            // Calcular totais
            let subtotal = 0;
            let totalICMS = 0;
            const itensHTMLPopup = itensPedidoAtual.length > 0 ? itensPedidoAtual.map((item, idx) => {
                const qtd = parseFloat(item.quantidade || 0);
                const precoUnit = parseFloat(item.preco_unitario || 0);
                const total = parseFloat(item.preco_total) || (qtd * precoUnit);
                const icms = parseFloat(item.icms_value || 0);
                subtotal += total;
                totalICMS += icms;
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f7fafc';
                return `<tr style="background: ${bgColor};">
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; color: #1a365d; font-weight: 600;">${item.codigo || '-'}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; color: #2d3748;">${(item.descricao || '-').substring(0, 50)}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: center; color: #2d3748;">${qtd.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: center; color: #2d3748;">${item.unidade || 'M'}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #2d3748;">${precoUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #1a365d; font-weight: 600;">${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #718096;">${icms.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="7" style="text-align: center; color: #718096; padding: 20px; font-size: 10px;">Nenhum item adicionado</td></tr>';
            
            // Usar valor do pedido se néo tiver itens
            if (subtotal === 0) subtotal = parseFloat(pedidoAtual.valor) || 0;
            const frete = parseFloat(pedidoAtual.frete) || 0;
            const ipi = parseFloat(pedidoAtual.total_ipi) || 0;
            const icmsST = parseFloat(pedidoAtual.total_icms_st) || 0;
            const totalGeral = subtotal + frete + ipi + icmsST;
            
            // Calcular vencimentos baseado na condiçéo de pagamento
            const condicao = pedidoAtual.parcelas || '30';
            let diasParcelas = condicao.split('/').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
            if (diasParcelas.length === 0) diasParcelas = [30];
            const numParcelas = diasParcelas.length;
            const valorParcela = totalGeral / numParcelas;
            const dataBase = pedidoAtual.data_criacao ? new Date(pedidoAtual.data_criacao) : new Date();
            
            let vencimentosHTML = '';
            for (let i = 0; i < numParcelas; i++) {
                const dataVenc = new Date(dataBase);
                dataVenc.setDate(dataVenc.getDate() + diasParcelas[i]);
                vencimentosHTML += `
                    <td style="text-align: center; padding: 4px;">${i + 1}</td>
                    <td style="text-align: center; padding: 4px;">${dataVenc.toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: center; padding: 4px; font-weight: 600; color: #1a365d;">R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                `;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                    <title>${nomeArquivo}</title>
                    <style>
                        @page { margin: 10mm; size: A4; }
                        @media print {
                            @page { margin: 10mm; }
                            html, body { margin: 0; padding: 0; }
                            /* Remover cabeçalho e rodapé do navegador */
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, Helvetica, sans-serif; color: #2d3748; background: #fff; font-size: 10px; }
                        .container { padding: 15px; max-width: 100%; }
                        
                        /* Header */
                        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 8px; border-bottom: 2.5px solid #1a365d; }
                        .header-line { height: 0.5px; background: #2c5282; margin-top: 3px; }
                        .logo-area img { height: 40px; }
                        .empresa-info { text-align: right; font-size: 7px; color: #718096; line-height: 1.4; }
                        .empresa-info .razao { font-size: 8px; font-weight: 700; color: #1a365d; margin-bottom: 1px; }
                        
                        /* Título */
                        .doc-title { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #fff; padding: 8px 15px; margin-top: 8px; text-align: center; }
                        .doc-title h1 { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; margin: 0; }
                        .doc-title .numero { font-size: 10px; color: #90cdf4; margin-top: 2px; }
                        
                        /* Seções */
                        .section { margin-top: 10px; }
                        .section-header { background: #2c5282; color: #fff; padding: 5px 10px; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
                        .section-content { border: 1px solid #e2e8f0; border-top: none; padding: 10px; background: #fff; }
                        
                        /* Cliente */
                        .cliente-nome { font-size: 10px; font-weight: 700; color: #1a365d; text-transform: uppercase; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px; }
                        .cliente-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px 15px; font-size: 8px; }
                        .cliente-item { display: flex; gap: 5px; }
                        .cliente-item label { color: #718096; font-weight: 700; min-width: 55px; }
                        .cliente-item span { color: #2d3748; }
                        
                        /* Tabela Itens */
                        .items-table { width: 100%; border-collapse: collapse; }
                        .items-table th { background: #1a365d; color: #fff; padding: 6px 8px; font-size: 7px; font-weight: 700; text-transform: uppercase; text-align: left; }
                        .items-table th:nth-child(3), .items-table th:nth-child(4) { text-align: center; }
                        .items-table th:nth-child(5), .items-table th:nth-child(6), .items-table th:nth-child(7) { text-align: right; }
                        
                        /* Totais Box */
                        .totais-wrapper { display: flex; justify-content: flex-end; margin-top: 10px; }
                        .totais-box { background: #f0f9ff; border: 1px solid #2c5282; padding: 10px 15px; min-width: 180px; box-shadow: 2px 2px 0 #e2e8f0; }
                        .totais-row { display: flex; justify-content: space-between; font-size: 8px; padding: 3px 0; }
                        .totais-row.total { border-top: 1px solid #2c5282; padding-top: 8px; margin-top: 5px; }
                        .totais-row.total label { font-size: 10px; font-weight: 700; color: #1a365d; }
                        .totais-row.total span { font-size: 11px; font-weight: 700; color: #38a169; }
                        
                        /* Vencimentos */
                        .venc-table { width: 100%; border-collapse: collapse; background: #fffff0; border: 1px solid #d69e2e; font-size: 8px; }
                        .venc-table th { background: transparent; color: #b7791f; font-weight: 700; padding: 6px; border-bottom: 1px solid #faf089; }
                        .venc-table td { padding: 6px; color: #2d3748; }
                        
                        /* Outras Info */
                        .info-box { background: #fff; border: 1px solid #e2e8f0; padding: 8px 10px; font-size: 8px; }
                        .info-row { margin: 3px 0; }
                        .info-row strong { color: #718096; }
                        
                        /* Observações */
                        .obs-box { background: #fff; border: 1px solid #e2e8f0; padding: 8px 10px; font-size: 8px; color: #4a5568; line-height: 1.4; }
                        
                        /* Footer */
                        .footer { margin-top: 15px; padding-top: 8px; border-top: 1px solid #1a365d; font-size: 7px; color: #718096; text-align: center; }
                        
                        @media print { 
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                    </style>
                    <scr` + `ipt src="/js/anti-copy-protection.js"></scr` + `ipt>
                </head>
                <body>
                    <div class="container">
                        <!-- HEADER -->
                        <div class="header">
                            <div class="logo-area">
                                <img src="/images/Logo Monocromatico - Azul - Aluforce.png" alt="ALUFORCE" onerror="this.outerHTML='<div style=font-size:20px;font-weight:700;color:#1a365d>ALUFORCE</div>'">
                            </div>
                            <div class="empresa-info">
                                <div class="razao">I. M. DOS REIS - ALUFORCE INDÚSTRIA E COMÉRCIO DE CONDUTORES</div>
                                <div>CNPJ: 08.192.479/0001-60 | IE: 103.385.861-110</div>
                                <div>RUA ERNESTINA, 270 - VILA SéO JOéO</div>
                                <div>Ferraz de Vasconcelos - SP | CEP: 08527-400</div>
                                <div>Tel: (11) 94723-8729</div>
                            </div>
                        </div>
                        <div class="header-line"></div>
                        
                        <!-- TÍTULO -->
                        <div class="doc-title">
                            <h1>${tipoDocumento}</h1>
                            <div class="numero">Nº ${String(pedidoAtual.id).padStart(5, '0')}</div>
                        </div>
                        
                        <!-- INFORMAÇÕES DO CLIENTE -->
                        <div class="section">
                            <div class="section-header">Informações do Cliente</div>
                            <div class="section-content">
                                <div class="cliente-nome">${pedidoAtual.cliente || 'Cliente néo informado'}</div>
                                <div class="cliente-grid">
                                    <div class="cliente-item"><label>Contato:</label><span>${pedidoAtual.cliente_contato || '-'}</span></div>
                                    <div class="cliente-item"><label>Endereço:</label><span>${pedidoAtual.cliente_endereco || '-'}</span></div>
                                    <div class="cliente-item"><label>CNPJ:</label><span>${pedidoAtual.cliente_cnpj || '-'}</span></div>
                                    <div class="cliente-item"><label>Bairro:</label><span>${pedidoAtual.cliente_bairro || '-'}</span></div>
                                    <div class="cliente-item"><label>IE:</label><span>${pedidoAtual.cliente_ie || 'Isento'}</span></div>
                                    <div class="cliente-item"><label>CEP:</label><span>${pedidoAtual.cliente_cep || '-'}</span></div>
                                    <div class="cliente-item"><label>Telefone:</label><span>${pedidoAtual.cliente_telefone || '-'}</span></div>
                                    <div class="cliente-item"><label>Email:</label><span>${pedidoAtual.cliente_email || '-'}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ITENS DO PEDIDO -->
                        <div class="section">
                            <div class="section-header">Itens do ${tipoDocumento}</div>
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 70px;">CÓDIGO</th>
                                        <th>DESCRIÇéO</th>
                                        <th style="width: 50px;">QTD</th>
                                        <th style="width: 35px;">UN</th>
                                        <th style="width: 70px;">UNITÁRIO</th>
                                        <th style="width: 70px;">TOTAL</th>
                                        <th style="width: 50px;">ICMS</th>
                                    </tr>
                                </thead>
                                <tbody>${itensHTMLPopup}</tbody>
                            </table>
                        </div>
                        
                        <!-- TOTAIS -->
                        <div class="totais-wrapper">
                            <div class="totais-box">
                                <div class="totais-row"><label>Subtotal:</label><span>R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row"><label>IPI:</label><span>R$ ${ipi.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row"><label>ICMS ST:</label><span>R$ ${icmsST.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row total"><label>TOTAL:</label><span>R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                            </div>
                        </div>
                        
                        <!-- VENCIMENTOS -->
                        <div class="section">
                            <div class="section-header">Vencimentos</div>
                            <table class="venc-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>${vencimentosHTML}</tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- OUTRAS INFORMAÇÕES -->
                        <div class="section">
                            <div class="section-header">Outras Informações</div>
                            <div class="info-box">
                                <div class="info-row"><strong>Pedido incluído em:</strong> ${dataInclusao}</div>
                                <div class="info-row"><strong>Previséo de Faturamento:</strong> ${pedidoAtual.data_prevista ? new Date(pedidoAtual.data_prevista).toLocaleDateString('pt-BR') : 'A combinar'}</div>
                                <div class="info-row"><strong>Vendedor:</strong> ${pedidoAtual.vendedor || '-'}</div>
                            </div>
                        </div>
                        
                        ${pedidoAtual.observacoes ? `
                        <!-- OBSERVAÇÕES -->
                        <div class="section">
                            <div class="section-header">Observações</div>
                            <div class="obs-box">${pedidoAtual.observacoes}</div>
                        </div>` : ''}
                        
                        <!-- FOOTER -->
                        <div class="footer">
                            <div>Documento gerado em ${dataAtual} às ${horaAtual}</div>
                            <div style="margin-top: 2px;">ALUFORCE - Sistema de Gestéo Empresarial | Este documento tem validade de 7 dias a partir da data de emisséo.</div>
                        </div>
                    </div>
                    
                    <scr` + `ipt>
                        setTimeout(function() { window.print(); }, 500);
                    <\/scr` + `ipt>
                </body>
                </html>
            `);
            printWindow.document.close();
            showNotification('Documento gerado com sucesso!', 'success');
        }
        
        // Alternativa usando iframe quando popup é bloqueado
        function gerarImpressaoIframe() {
            const tipoDocumento = gerarNomeDocumento(pedidoAtual);
            const nomeArquivo = gerarNomeDocumento(pedidoAtual, 'arquivo');
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const dataInclusao = pedidoAtual.data_criacao ? new Date(pedidoAtual.data_criacao).toLocaleString('pt-BR') : `${dataAtual} ${horaAtual}`;
            
            // Remover iframe anterior se existir
            const oldIframe = document.getElementById('print-iframe');
            if (oldIframe) oldIframe.remove();
            
            // Criar iframe oculto
            const iframe = document.createElement('iframe');
            iframe.id = 'print-iframe';
            iframe.style.cssText = 'position: fixed; right: 0; bottom: 0; width: 0; height: 0; border: 0;';
            document.body.appendChild(iframe);
            
            // Calcular totais
            let subtotal = 0;
            let totalICMS = 0;
            const itensHTML = itensPedidoAtual.length > 0 ? itensPedidoAtual.map((item, idx) => {
                const qtd = parseFloat(item.quantidade || 0);
                const precoUnit = parseFloat(item.preco_unitario || 0);
                const total = parseFloat(item.preco_total) || (qtd * precoUnit);
                const icms = parseFloat(item.icms_value || 0);
                subtotal += total;
                totalICMS += icms;
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f7fafc';
                return `<tr style="background: ${bgColor};">
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; color: #1a365d; font-weight: 600;">${item.codigo || '-'}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; color: #2d3748;">${(item.descricao || '-').substring(0, 50)}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: center; color: #2d3748;">${qtd.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: center; color: #2d3748;">${item.unidade || 'M'}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #2d3748;">${precoUnit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #1a365d; font-weight: 600;">${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; text-align: right; color: #718096;">${icms.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="7" style="text-align: center; color: #718096; padding: 20px; font-size: 10px;">Nenhum item adicionado</td></tr>';
            
            // Usar valor do pedido se néo tiver itens
            if (subtotal === 0) subtotal = parseFloat(pedidoAtual.valor) || 0;
            const frete = parseFloat(pedidoAtual.frete) || 0;
            const ipi = parseFloat(pedidoAtual.total_ipi) || 0;
            const icmsST = parseFloat(pedidoAtual.total_icms_st) || 0;
            const totalGeral = subtotal + frete + ipi + icmsST;
            
            // Calcular vencimentos baseado na condiçéo de pagamento
            const condicao = pedidoAtual.parcelas || '30';
            let diasParcelas = condicao.split('/').map(d => parseInt(d.trim())).filter(d => !isNaN(d));
            if (diasParcelas.length === 0) diasParcelas = [30];
            const numParcelas = diasParcelas.length;
            const valorParcela = totalGeral / numParcelas;
            const dataBase = pedidoAtual.data_criacao ? new Date(pedidoAtual.data_criacao) : new Date();
            
            let vencimentosHTML = '';
            for (let i = 0; i < numParcelas; i++) {
                const dataVenc = new Date(dataBase);
                dataVenc.setDate(dataVenc.getDate() + diasParcelas[i]);
                vencimentosHTML += `
                    <td style="text-align: center; padding: 4px;">${i + 1}</td>
                    <td style="text-align: center; padding: 4px;">${dataVenc.toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: center; padding: 4px; font-weight: 600; color: #1a365d;">R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                `;
            }
            
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${nomeArquivo}</title>
                    <style>
                        @page { margin: 10mm; size: A4; }
                        @media print {
                            @page { margin: 10mm; }
                            html, body { margin: 0; padding: 0; }
                            /* Remover cabeçalho e rodapé do navegador */
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, Helvetica, sans-serif; color: #2d3748; background: #fff; font-size: 10px; }
                        .container { padding: 15px; max-width: 100%; }
                        
                        /* Header */
                        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 8px; border-bottom: 2.5px solid #1a365d; }
                        .header-line { height: 0.5px; background: #2c5282; margin-top: 3px; }
                        .logo-area img { height: 40px; }
                        .empresa-info { text-align: right; font-size: 7px; color: #718096; line-height: 1.4; }
                        .empresa-info .razao { font-size: 8px; font-weight: 700; color: #1a365d; margin-bottom: 1px; }
                        
                        /* Título */
                        .doc-title { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #fff; padding: 8px 15px; margin-top: 8px; text-align: center; }
                        .doc-title h1 { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; margin: 0; }
                        .doc-title .numero { font-size: 10px; color: #90cdf4; margin-top: 2px; }
                        
                        /* Seções */
                        .section { margin-top: 10px; }
                        .section-header { background: #2c5282; color: #fff; padding: 5px 10px; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
                        .section-content { border: 1px solid #e2e8f0; border-top: none; padding: 10px; background: #fff; }
                        
                        /* Cliente */
                        .cliente-nome { font-size: 10px; font-weight: 700; color: #1a365d; text-transform: uppercase; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px; }
                        .cliente-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px 15px; font-size: 8px; }
                        .cliente-item { display: flex; gap: 5px; }
                        .cliente-item label { color: #718096; font-weight: 700; min-width: 55px; }
                        .cliente-item span { color: #2d3748; }
                        
                        /* Tabela Itens */
                        .items-table { width: 100%; border-collapse: collapse; }
                        .items-table th { background: #1a365d; color: #fff; padding: 6px 8px; font-size: 7px; font-weight: 700; text-transform: uppercase; text-align: left; }
                        .items-table th:nth-child(3), .items-table th:nth-child(4) { text-align: center; }
                        .items-table th:nth-child(5), .items-table th:nth-child(6), .items-table th:nth-child(7) { text-align: right; }
                        
                        /* Totais Box */
                        .totais-wrapper { display: flex; justify-content: flex-end; margin-top: 10px; }
                        .totais-box { background: #f0f9ff; border: 1px solid #2c5282; padding: 10px 15px; min-width: 180px; box-shadow: 2px 2px 0 #e2e8f0; }
                        .totais-row { display: flex; justify-content: space-between; font-size: 8px; padding: 3px 0; }
                        .totais-row.total { border-top: 1px solid #2c5282; padding-top: 8px; margin-top: 5px; }
                        .totais-row.total label { font-size: 10px; font-weight: 700; color: #1a365d; }
                        .totais-row.total span { font-size: 11px; font-weight: 700; color: #38a169; }
                        
                        /* Vencimentos */
                        .venc-table { width: 100%; border-collapse: collapse; background: #fffff0; border: 1px solid #d69e2e; font-size: 8px; }
                        .venc-table th { background: transparent; color: #b7791f; font-weight: 700; padding: 6px; border-bottom: 1px solid #faf089; }
                        .venc-table td { padding: 6px; color: #2d3748; }
                        
                        /* Outras Info */
                        .info-box { background: #fff; border: 1px solid #e2e8f0; padding: 8px 10px; font-size: 8px; }
                        .info-row { margin: 3px 0; }
                        .info-row strong { color: #718096; }
                        
                        /* Observações */
                        .obs-box { background: #fff; border: 1px solid #e2e8f0; padding: 8px 10px; font-size: 8px; color: #4a5568; line-height: 1.4; }
                        
                        /* Footer */
                        .footer { margin-top: 15px; padding-top: 8px; border-top: 1px solid #1a365d; font-size: 7px; color: #718096; text-align: center; }
                        
                        @media print { 
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <!-- HEADER -->
                        <div class="header">
                            <div class="logo-area">
                                <img src="/images/Logo Monocromatico - Azul - Aluforce.png" alt="ALUFORCE" onerror="this.outerHTML='<div style=font-size:20px;font-weight:700;color:#1a365d>ALUFORCE</div>'">
                            </div>
                            <div class="empresa-info">
                                <div class="razao">I. M. DOS REIS - ALUFORCE INDÚSTRIA E COMÉRCIO DE CONDUTORES</div>
                                <div>CNPJ: 08.192.479/0001-60 | IE: 103.385.861-110</div>
                                <div>RUA ERNESTINA, 270 - VILA SéO JOéO</div>
                                <div>Ferraz de Vasconcelos - SP | CEP: 08527-400</div>
                                <div>Tel: (11) 94723-8729</div>
                            </div>
                        </div>
                        <div class="header-line"></div>
                        
                        <!-- TÍTULO -->
                        <div class="doc-title">
                            <h1>${tipoDocumento}</h1>
                            <div class="numero">Nº ${String(pedidoAtual.id).padStart(5, '0')}</div>
                        </div>
                        
                        <!-- INFORMAÇÕES DO CLIENTE -->
                        <div class="section">
                            <div class="section-header">Informações do Cliente</div>
                            <div class="section-content">
                                <div class="cliente-nome">${pedidoAtual.cliente || 'Cliente néo informado'}</div>
                                <div class="cliente-grid">
                                    <div class="cliente-item"><label>Contato:</label><span>${pedidoAtual.cliente_contato || '-'}</span></div>
                                    <div class="cliente-item"><label>Endereço:</label><span>${pedidoAtual.cliente_endereco || '-'}</span></div>
                                    <div class="cliente-item"><label>CNPJ:</label><span>${pedidoAtual.cliente_cnpj || '-'}</span></div>
                                    <div class="cliente-item"><label>Bairro:</label><span>${pedidoAtual.cliente_bairro || '-'}</span></div>
                                    <div class="cliente-item"><label>IE:</label><span>${pedidoAtual.cliente_ie || 'Isento'}</span></div>
                                    <div class="cliente-item"><label>CEP:</label><span>${pedidoAtual.cliente_cep || '-'}</span></div>
                                    <div class="cliente-item"><label>Telefone:</label><span>${pedidoAtual.cliente_telefone || '-'}</span></div>
                                    <div class="cliente-item"><label>Email:</label><span>${pedidoAtual.cliente_email || '-'}</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ITENS DO PEDIDO -->
                        <div class="section">
                            <div class="section-header">Itens do ${tipoDocumento}</div>
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th style="width: 70px;">CÓDIGO</th>
                                        <th>DESCRIÇéO</th>
                                        <th style="width: 50px;">QTD</th>
                                        <th style="width: 35px;">UN</th>
                                        <th style="width: 70px;">UNITÁRIO</th>
                                        <th style="width: 70px;">TOTAL</th>
                                        <th style="width: 50px;">ICMS</th>
                                    </tr>
                                </thead>
                                <tbody>${itensHTML}</tbody>
                            </table>
                        </div>
                        
                        <!-- TOTAIS -->
                        <div class="totais-wrapper">
                            <div class="totais-box">
                                <div class="totais-row"><label>Subtotal:</label><span>R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row"><label>IPI:</label><span>R$ ${ipi.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row"><label>ICMS ST:</label><span>R$ ${icmsST.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                                <div class="totais-row total"><label>TOTAL:</label><span>R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
                            </div>
                        </div>
                        
                        <!-- VENCIMENTOS -->
                        <div class="section">
                            <div class="section-header">Vencimentos</div>
                            <table class="venc-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>${vencimentosHTML}</tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- OUTRAS INFORMAÇÕES -->
                        <div class="section">
                            <div class="section-header">Outras Informações</div>
                            <div class="info-box">
                                <div class="info-row"><strong>Pedido incluído em:</strong> ${dataInclusao}</div>
                                <div class="info-row"><strong>Previséo de Faturamento:</strong> ${pedidoAtual.data_prevista ? new Date(pedidoAtual.data_prevista).toLocaleDateString('pt-BR') : 'A combinar'}</div>
                                <div class="info-row"><strong>Vendedor:</strong> ${pedidoAtual.vendedor || '-'}</div>
                            </div>
                        </div>
                        
                        ${pedidoAtual.observacoes ? `
                        <!-- OBSERVAÇÕES -->
                        <div class="section">
                            <div class="section-header">Observações</div>
                            <div class="obs-box">${pedidoAtual.observacoes}</div>
                        </div>` : ''}
                        
                        <!-- FOOTER -->
                        <div class="footer">
                            <div>Documento gerado em ${dataAtual} às ${horaAtual}</div>
                            <div style="margin-top: 2px;">ALUFORCE - Sistema de Gestéo Empresarial | Este documento tem validade de 7 dias a partir da data de emisséo.</div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            doc.close();
            
            // Aguardar carregamento e imprimir
            setTimeout(() => {
                try {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                    showNotification('Documento enviado para impresséo!', 'success');
                } catch (e) {
                    console.error('Erro ao imprimir:', e);
                    showNotification('Erro ao imprimir. Tente novamente.', 'error');
                }
                // Remover iframe após impresséo
                setTimeout(() => iframe.remove(), 1000);
            }, 500);
        }
        
        function conferirPedido() {
            if (!pedidoAtual) return;
            
            // Simular conferência - verificar campos obrigatórios
            const erros = [];
            if (!pedidoAtual.cliente) erros.push('Cliente néo informado');
            if (!pedidoAtual.valor || pedidoAtual.valor <= 0) erros.push('Valor inválido');
            
            if (erros.length > 0) {
                showNotification('Problemas encontrados: ' + erros.join(', '), 'error');
            } else {
                showNotification('Pedido conferido! Todos os dados estáo corretos.', 'success');
            }
        }
        
        async function faturarPedido() {
            if (!pedidoAtual) return;
            
            // Modal de confirmaçéo profissional para faturamento
            const valorFormatado = formatarMoeda(pedidoAtual.valor);
            const gerarNFe = await showConfirmDialog({
                title: 'Faturar Orçamento',
                message: `Deseja faturar o <strong>Orçamento Nº ${pedidoAtual.id}</strong>?<br><br>📦 <strong>Valor:</strong> ${valorFormatado}<br>👤 <strong>Cliente:</strong> ${pedidoAtual.cliente}<br><br>📋 NFe será gerada automaticamente no módulo fiscal`,
                type: 'info',
                confirmText: 'Faturar',
                confirmIcon: 'fa-file-invoice-dollar'
            });
            if (!gerarNFe) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/faturar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ gerarNFe: true })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Atualizar status localmente
                    const colunaAtual = pedidoAtual._coluna;
                    const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                    
                    if (idx !== undefined && idx !== -1) {
                        dadosVendas[colunaAtual].splice(idx, 1);
                    }
                    
                    pedidoAtual.status = 'Faturado';
                    pedidoAtual.nf = result.nf_numero;
                    pedidoAtual.nfe_chave = result.nfe_data?.chave;
                    pedidoAtual.nfe_protocolo = result.nfe_data?.protocolo;
                    pedidoAtual._coluna = 'faturado';
                    
                    if (!dadosVendas.faturado) dadosVendas.faturado = [];
                    dadosVendas.faturado.push(pedidoAtual);
                    
                    // Re-renderizar kanban
                    renderKanban();
                    
                    // Fechar modal
                    fecharModalEditar();
                    
                    // Mensagem de sucesso diferenciada
                    if (result.nfe_gerada) {
                        showNotification(`? Pedido faturado com sucesso!?? NFe ${result.nf_numero} gerada automaticamente?? Chave: ${result.nfe_data?.chave?.substring(0, 20)}...`, 'success');
                        
                        // Opçéo para visualizar NFe
                        setTimeout(async () => {
                            const visualizar = await showConfirmDialog({
                                title: 'NFe Gerada',
                                message: 'Deseja visualizar a NFe no módulo fiscal?',
                                type: 'success',
                                confirmText: 'Visualizar NFe',
                                confirmIcon: 'fa-external-link-alt'
                            });
                            if (visualizar) {
                                window.open(`/modules/NFe?nfe=${result.nf_numero}`, '_blank');
                            }
                        }, 1500);
                    } else {
                        showNotification(`Pedido faturado! NF: ${result.nf_numero}?? NFe néo foi gerada automaticamente - verifique o módulo fiscal`, 'warning');
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao faturar pedido', 'error');
                }
            } catch (error) {
                console.error('Erro ao faturar:', error);
                
                // Fallback: faturar localmente
                const colunaAtual = pedidoAtual._coluna;
                const idx = dadosVendas[colunaAtual]?.findIndex(p => p.id === pedidoAtual.id);
                
                if (idx !== undefined && idx !== -1) {
                    dadosVendas[colunaAtual].splice(idx, 1);
                }
                
                pedidoAtual.status = 'Faturado';
                pedidoAtual.nf = '0000' + Math.floor(Math.random() * 9000 + 1000);
                pedidoAtual._coluna = 'faturado';
                
                if (!dadosVendas.faturado) dadosVendas.faturado = [];
                dadosVendas.faturado.push(pedidoAtual);
                
                renderKanban();
                fecharModalEditar();
                
                showNotification(`Pedido faturado! NF: ${pedidoAtual.nf}?? Erro na conexéo - NFe néo foi gerada`, 'warning');
            }
        }
        
        // ========================================
        // FUNÇéO: CRIAR NOVO PEDIDO
        // ========================================
        async function abrirModalNovoPedido() {
            try {
                // Criar pedido no banco de dados primeiro
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vendas/pedidos/novo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        status: 'orcamento',
                        valor: 0,
                        descricao: 'Novo Orçamento'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao criar pedido');
                }
                
                const data = await response.json();
                const novoId = data.id;
                
                // Limpar array de itens do pedido atual
                itensPedidoAtual = [];
                
                // Criar objeto de novo pedido
                pedidoAtual = {
                    id: novoId,
                    cliente: '',
                    valor: 0,
                    vendedor: '',
                    parcelas: '',
                    origem: 'Interno',
                    status: 'Novo',
                    nf: null,
                    transportadora: '',
                    mensagem: '',
                    _coluna: 'negociacao',
                    itens: []
                };
                
                // Atualizar título do modal
                document.getElementById('modal-titulo-pedido').textContent = `Novo Orçamento Nº ${novoId}`;
                
                // Limpar avatar do cliente
                document.getElementById('modal-cliente-avatar').textContent = 'NC';
                
                // Limpar campos principais
                document.getElementById('edit-pedido-id').value = novoId;
                document.getElementById('edit-cliente').value = '';
                document.getElementById('edit-valor-total').value = 'R$ 0,00';
                document.getElementById('edit-total-mercadorias').value = 'R$ 0,00';
                document.getElementById('edit-vendedor').value = '';
                document.getElementById('edit-parcelas').value = '';
            
            // Limpar campos de desconto e impostos
            if (document.getElementById('edit-desconto')) {
                document.getElementById('edit-desconto').value = '0,00';
            }
            if (document.getElementById('edit-ipi')) {
                document.getElementById('edit-ipi').value = '0,00';
            }
            if (document.getElementById('edit-icms-st')) {
                document.getElementById('edit-icms-st').value = '0,00';
            }
            
            // Limpar observações
            if (document.getElementById('edit-observacoes')) {
                document.getElementById('edit-observacoes').value = '';
            }
            if (document.getElementById('edit-observacoes-cliente')) {
                document.getElementById('edit-observacoes-cliente').value = '';
            }
            
            // Campos de frete
            if (document.getElementById('edit-transportadora')) {
                document.getElementById('edit-transportadora').value = '';
            }
            if (document.getElementById('edit-nf')) {
                document.getElementById('edit-nf').value = '';
            }
            if (document.getElementById('edit-origem')) {
                document.getElementById('edit-origem').value = 'Interno';
            }
            if (document.getElementById('edit-valor-frete')) {
                document.getElementById('edit-valor-frete').value = '';
            }
            if (document.getElementById('edit-outras-despesas')) {
                document.getElementById('edit-outras-despesas').value = '';
            }
            
            // Atualizar alerta de status para novo
            const statusAlert = document.getElementById('status-alert');
            const statusAlertText = document.getElementById('status-alert-text');
            if (statusAlert && statusAlertText) {
                statusAlertText.textContent = 'Novo Pedido';
                statusAlert.className = 'status-alert info';
            }
            
            // Limpar tabela de itens - ID CORRETO
            const tabelaItens = document.getElementById('itens-pedido-tbody');
            if (tabelaItens) {
                tabelaItens.innerHTML = '';
            }
            
            // Atualizar paginaçéo
            const paginationInfo = document.getElementById('pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = '0 - 0 de 0 registros';
            }
            
            // Limpar seleçéo de item
            itemSelecionado = null;
            itemSelecionadoIdx = null;
            
            // Resetar tabs para primeira aba
            switchModalTab('itens');
            
            // Limpar alterações
            limparAlteracoes();
            
            // Mostrar modal
            document.getElementById('modal-editar-pedido').classList.add('active');
            
            // Focar no campo cliente
            setTimeout(() => {
                document.getElementById('edit-cliente').focus();
            }, 100);
            
            showNotification('Novo pedido iniciado! Preencha os dados.', 'info');
            } catch (error) {
                console.error('Erro ao criar novo pedido:', error);
                showNotification('Erro ao criar novo pedido: ' + error.message, 'error');
            }
        }
        
        async function salvarNovoPedido() {
            if (!pedidoAtual || !pedidoAtual._coluna) return;
            
            const cliente = document.getElementById('edit-cliente').value;
            if (!cliente) {
                showNotification('Por favor, informe o cliente', 'error');
                return;
            }
            
            // Atualizar dados do pedido
            pedidoAtual.cliente = cliente;
            pedidoAtual.vendedor = document.getElementById('edit-vendedor').value;
            pedidoAtual.parcelas = document.getElementById('edit-parcelas').value;
            pedidoAtual.mensagem = document.getElementById('edit-observacoes').value;
            if (document.getElementById('edit-origem')) {
                pedidoAtual.origem = document.getElementById('edit-origem').value;
            }
            if (document.getElementById('edit-transportadora')) {
                pedidoAtual.transportadora = document.getElementById('edit-transportadora').value;
            }
            
            // Calcular valor total dos itens
            let valorTotal = 0;
            const linhasItens = document.querySelectorAll('#tabela-itens-modal tbody tr');
            linhasItens.forEach(linha => {
                const totalCell = linha.querySelector('.item-total');
                if (totalCell) {
                    const valor = parseFloat(totalCell.textContent.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
                    valorTotal += valor;
                }
            });
            pedidoAtual.valor = valorTotal;
            
            // Adicionar É coluna de negociaçéo
            if (!dadosVendas.negociacao) {
                dadosVendas.negociacao = [];
            }
            dadosVendas.negociacao.push(pedidoAtual);
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal
            fecharModalEditar();
            
            showNotification(`Pedido Nº ${pedidoAtual.id} criado com sucesso!`, 'success');
            
            // TODO: Salvar no backend
            // await criarPedidoAPI(pedidoAtual);
        }
        
        // ========================================
        // MODAL ANEXOS
        // ========================================
        let anexosPedido = {};

        function verAnexos() {
            if (!pedidoAtual) return;
            
            // Carregar anexos do pedido
            const anexos = anexosPedido[pedidoAtual.id] || [];
            renderizarAnexos(anexos);
            
            document.getElementById('modal-anexos').classList.add('active');
        }

        function fecharModalAnexos() {
            document.getElementById('modal-anexos').classList.remove('active');
        }

        function renderizarAnexos(anexos) {
            const container = document.getElementById('lista-anexos-container');
            
            if (anexos.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px;">Nenhum anexo encontrado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = anexos.map((anexo, idx) => `
                <div class="anexo-item">
                    <i class="fas ${getIconeArquivo(anexo.tipo)}"></i>
                    <div class="anexo-info">
                        <div class="anexo-nome">${anexo.nome}</div>
                        <div class="anexo-tamanho">${anexo.tamanho}</div>
                    </div>
                    <div class="anexo-actions">
                        <button onclick="downloadAnexo(${idx})" title="Baixar"><i class="fas fa-download"></i></button>
                        <button class="delete" onclick="excluirAnexo(${idx})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function getIconeArquivo(tipo) {
            const icones = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'default': 'fa-file'
            };
            return icones[tipo] || icones['default'];
        }

        function processarAnexos(files) {
            if (!pedidoAtual) return;
            
            if (!anexosPedido[pedidoAtual.id]) {
                anexosPedido[pedidoAtual.id] = [];
            }
            
            Array.from(files).forEach(file => {
                const extensao = file.name.split('.').pop().toLowerCase();
                anexosPedido[pedidoAtual.id].push({
                    nome: file.name,
                    tipo: extensao,
                    tamanho: formatarTamanhoArquivo(file.size),
                    data: new Date().toLocaleString('pt-BR')
                });
            });
            
            renderizarAnexos(anexosPedido[pedidoAtual.id]);
            showNotification(`${files.length} arquivo(s) anexado(s)!`, 'success');
        }

        function formatarTamanhoArquivo(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadAnexo(idx) {
            showNotification('Iniciando download...', 'info');
        }

        async function excluirAnexo(idx) {
            if (!pedidoAtual) return;
            const confirmar = await confirmDelete('este anexo', 'Anexo');
            if (confirmar) {
                anexosPedido[pedidoAtual.id].splice(idx, 1);
                renderizarAnexos(anexosPedido[pedidoAtual.id]);
                showNotification('Anexo excluído!', 'success');
            }
        }

        // Drag and drop para anexos
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('anexos-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    processarAnexos(e.dataTransfer.files);
                });
            }
        });
        
        // ========================================
        // MODAL CONFIRMAÇéO ALTERAÇÕES NéO SALVAS
        // ========================================
        
        // Funçéo showToast para compatibilidade
        function showToast(message, type = 'info') {
            if (typeof showNotification === 'function') {
                showNotification(message, type);
            } else {
                console.log(`[${type}] ${message}`);
            }
        }
        
        let alteracoesNaoSalvas = [];
        let onConfirmCallback = null;
        let onCancelCallback = null;
        let formOriginalData = {};

        // Rastrear alterações em formulários
        function rastrearAlteracoes(formId) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            // Salvar estado original
            const inputs = form.querySelectorAll('input, select, textarea');
            formOriginalData[formId] = {};
            inputs.forEach(input => {
                const name = input.name || input.id;
                if (name) {
                    formOriginalData[formId][name] = input.type === 'checkbox' ? input.checked : input.value;
                }
            });
            
            // Adicionar listeners para detectar mudanças
            inputs.forEach(input => {
                input.addEventListener('change', () => marcarAlteracao(formId, input));
                input.addEventListener('input', () => marcarAlteracao(formId, input));
            });
        }

        function marcarAlteracao(formId, input) {
            const name = input.name || input.id;
            const label = input.closest('.form-group')?.querySelector('label')?.textContent || name;
            const valorOriginal = formOriginalData[formId]?.[name];
            const valorAtual = input.type === 'checkbox' ? input.checked : input.value;
            
            // Verificar se o valor mudou
            if (valorOriginal !== valorAtual) {
                // Adicionar É lista se néo existir
                const existe = alteracoesNaoSalvas.find(a => a.campo === name);
                if (!existe) {
                    alteracoesNaoSalvas.push({
                        campo: name,
                        label: label,
                        de: valorOriginal,
                        para: valorAtual
                    });
                } else {
                    existe.para = valorAtual;
                }
            } else {
                // Remover da lista se voltou ao original
                alteracoesNaoSalvas = alteracoesNaoSalvas.filter(a => a.campo !== name);
            }
        }

        function temAlteracoesNaoSalvas() {
            return alteracoesNaoSalvas.length > 0;
        }

        function limparAlteracoes() {
            alteracoesNaoSalvas = [];
        }

        // Mostrar modal de confirmaçéo
        function mostrarConfirmacaoAlteracoes(onConfirm, onCancel) {
            if (!temAlteracoesNaoSalvas()) {
                if (onConfirm) onConfirm();
                return;
            }
            
            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;
            
            // Preencher lista de alterações
            const lista = document.getElementById('alteracoes-itens');
            lista.innerHTML = alteracoesNaoSalvas.map(alt => `
                <li><i class="fas fa-edit"></i> ${alt.label}</li>
            `).join('');
            
            // Esconder lista inicialmente
            document.getElementById('lista-alteracoes').classList.remove('show');
            
            document.getElementById('modal-confirmar-alteracoes').classList.add('active');
        }

        function toggleListaAlteracoes() {
            document.getElementById('lista-alteracoes').classList.toggle('show');
        }

        function confirmarDesprezarAlteracoes() {
            // Fechar o modal de confirmaçéo
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            limparAlteracoes();
            
            // Fechar todos os modais abertos (modal principal de ediçéo/orçamento)
            document.querySelectorAll('.modal-overlay.active, .modal-overlay[style*="display: flex"], .modal-overlay[style*="display: block"]').forEach(modal => {
                modal.classList.remove('active');
                modal.style.display = 'none';
            });
            
            // Executar callback de confirmaçéo
            if (onConfirmCallback) onConfirmCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
            
            // Restaurar scroll do body
            document.body.style.overflow = '';
        }

        function cancelarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            if (onCancelCallback) onCancelCallback();
            onConfirmCallback = null;
            onCancelCallback = null;
        }

        // Interceptar fechamento de modais
        function fecharModalComVerificacao(modalId, fecharFn) {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    fecharFn();
                });
            } else {
                fecharFn();
            }
        }

        // Interceptar navegaçéo
        window.addEventListener('beforeunload', function(e) {
            if (temAlteracoesNaoSalvas()) {
                e.preventDefault();
                e.returnValue = 'Você tem alterações néo salvas. Deseja sair?';
                return e.returnValue;
            }
        });

        // Fechar modal de confirmaçéo ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalConfirm = document.getElementById('modal-confirmar-alteracoes');
            if (modalConfirm) {
                modalConfirm.addEventListener('click', function(e) {
                    if (e.target === this) {
                        cancelarDesprezarAlteracoes();
                    }
                });
            }
            
            // Event listeners para os botões do modal de confirmaçéo
            const btnSim = document.getElementById('btn-confirmar-sim');
            const btnNao = document.getElementById('btn-confirmar-nao');
            
            if (btnSim) {
                btnSim.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botéo SIM clicado');
                    confirmarDesprezarAlteracoes();
                });
            }
            
            if (btnNao) {
                btnNao.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Botéo NéO clicado');
                    cancelarDesprezarAlteracoes();
                });
            }
        });
        
        // ========================================
        // MODAL CONFIGURAÇéO ETAPAS KANBAN
        // ========================================
        // CONFIGURAÇéO DE ETAPAS DO KANBAN
        // ========================================
        let etapasKanban = [
            { id: 'orcamento', nome: 'Orçamento', status: 'orcamento' },
            { id: 'analise', nome: 'Análise de Crédito', status: 'analise' },
            { id: 'aprovado', nome: 'Pedido Aprovado', status: 'aprovado' },
            { id: 'faturar', nome: 'Faturar', status: 'faturar' },
            { id: 'faturado', nome: 'Faturado', status: 'faturado', destaque: true },
            { id: 'recibo', nome: 'Recibo', status: 'recibo' }
        ];

        let etapasTemp = []; // Cópia temporária para ediçéo
        let draggedEtapa = null;

        function abrirModalEtapas() {
            // Criar cópia para ediçéo
            etapasTemp = JSON.parse(JSON.stringify(etapasKanban));
            renderizarEtapas();
            document.getElementById('modal-etapas-kanban').classList.add('active');
        }

        function renderizarEtapas() {
            const container = document.getElementById('etapas-container');
            const ordinais = ['Primeira', 'Segunda', 'Terceira', 'Quarta', 'Quinta', 'Sexta', 'Sétima', 'Oitava', 'Nona', 'Décima'];
            
            container.innerHTML = etapasTemp.map((etapa, index) => `
                <div class="etapa-item ${etapa.destaque ? 'etapa-destaque' : ''}" 
                     data-index="${index}" 
                     draggable="true"
                     ondragstart="handleEtapaDragStart(event)"
                     ondragend="handleEtapaDragEnd(event)"
                     ondragover="handleEtapaDragOver(event)"
                     ondrop="handleEtapaDrop(event)">
                    <div class="etapa-item-header">
                        <span class="etapa-item-number">
                            <i class="fas fa-grip-vertical"></i>
                            ${ordinais[index] || (index + 1) + 'É'} Etapa
                        </span>
                        <div class="etapa-item-actions">
                            ${etapasTemp.length > 2 ? `
                                <button type="button" class="btn-remover" onclick="removerEtapa(${index})" title="Remover etapa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <input type="text" 
                           value="${etapa.nome}" 
                           placeholder="Nome da etapa"
                           onchange="atualizarNomeEtapa(${index}, this.value)"
                           data-etapa-index="${index}">
                </div>
            `).join('');
            
            atualizarContadorEtapas();
        }

        function atualizarContadorEtapas() {
            const counter = document.getElementById('etapas-counter');
            const total = etapasTemp.length;
            counter.textContent = `${total} etapa${total !== 1 ? 's' : ''} configurada${total !== 1 ? 's' : ''}`;
        }

        function atualizarNomeEtapa(index, novoNome) {
            if (etapasTemp[index]) {
                etapasTemp[index].nome = novoNome.trim() || etapasTemp[index].nome;
            }
        }

        function adicionarNovaEtapa() {
            if (etapasTemp.length >= 10) {
                showNotification('M²ximo de 10 etapas permitidas!', 'warning');
                return;
            }
            
            const novoId = 'etapa_' + Date.now();
            const novaEtapa = {
                id: novoId,
                nome: 'Nova Etapa',
                status: novoId,
                destaque: false
            };
            
            etapasTemp.push(novaEtapa);
            renderizarEtapas();
            
            // Focar no novo input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.etapa-item input');
                const ultimoInput = inputs[inputs.length - 1];
                if (ultimoInput) {
                    ultimoInput.focus();
                    ultimoInput.select();
                }
            }, 100);
            
            showNotification('Nova etapa adicionada!', 'success');
        }

        async function removerEtapa(index) {
            if (etapasTemp.length <= 2) {
                showNotification('É necessário ter pelo menos 2 etapas!', 'warning');
                return;
            }
            
            const etapa = etapasTemp[index];
            
            // Confirmar remoçéo com modal profissional
            const confirmar = await confirmDelete(etapa.nome, 'Etapa');
            if (confirmar) {
                etapasTemp.splice(index, 1);
                renderizarEtapas();
                showNotification('Etapa removida!', 'info');
            }
        }

        // Drag and Drop para reordenar etapas (funções específicas para néo conflitar com Kanban)
        function handleEtapaDragStart(e) {
            draggedEtapa = e.target.closest('.etapa-item');
            if (draggedEtapa) {
                draggedEtapa.classList.add('dragging');
            }
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleEtapaDragEnd(e) {
            if (draggedEtapa) {
                draggedEtapa.classList.remove('dragging');
            }
            document.querySelectorAll('.etapa-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedEtapa = null;
        }

        function handleEtapaDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            if (target && target !== draggedEtapa) {
                target.classList.add('drag-over');
            }
        }

        function handleEtapaDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.etapa-item');
            
            if (target && draggedEtapa && target !== draggedEtapa) {
                const fromIndex = parseInt(draggedEtapa.dataset.index);
                const toIndex = parseInt(target.dataset.index);
                
                // Reordenar array
                const [movedItem] = etapasTemp.splice(fromIndex, 1);
                etapasTemp.splice(toIndex, 0, movedItem);
                
                renderizarEtapas();
            }
            
            target?.classList.remove('drag-over');
        }

        function fecharModalEtapas() {
            document.getElementById('modal-etapas-kanban').classList.remove('active');
        }

        function confirmarEtapas() {
            // Atualizar valores dos inputs antes de salvar
            document.querySelectorAll('.etapa-item input').forEach((input, index) => {
                if (etapasTemp[index]) {
                    etapasTemp[index].nome = input.value.trim() || etapasTemp[index].nome;
                }
            });
            
            // Validar que todas as etapas têm nome
            const etapaSemNome = etapasTemp.find(e => !e.nome || e.nome.trim() === '');
            if (etapaSemNome) {
                showNotification('Todas as etapas precisam ter um nome!', 'warning');
                return;
            }
            
            // Salvar etapas
            etapasKanban = JSON.parse(JSON.stringify(etapasTemp));
            
            // Reconstruir o Kanban Board completamente
            reconstruirKanbanBoard();
            
            // Fechar modal
            fecharModalEtapas();
            
            // Notificaçéo de sucesso
            showNotification('Etapas do processo atualizadas com sucesso!', 'success');
            
            // Salvar no localStorage para persistência
            localStorage.setItem('etapasKanban', JSON.stringify(etapasKanban));
        }

        // Cores para as colunas do Kanban (rotativas)
        const coresKanban = [
            '#94a3b8', // cinza
            '#f59e0b', // amarelo
            '#10b981', // verde claro
            '#f97316', // laranja
            '#22c55e', // verde
            '#06b6d4', // ciano
            '#8b5cf6', // roxo
            '#ec4899', // rosa
            '#ef4444', // vermelho
            '#14b8a6'  // teal
        ];

        function reconstruirKanbanBoard() {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;
            
            // Guardar os cards existentes por status antes de reconstruir
            const cardsExistentes = {};
            document.querySelectorAll('.kanban-column').forEach(coluna => {
                const status = coluna.dataset.status;
                const content = coluna.querySelector('.kanban-column-content');
                if (content) {
                    cardsExistentes[status] = content.innerHTML;
                }
            });
            
            // Limpar o board
            kanbanBoard.innerHTML = '';
            
            // Reconstruir colunas baseado nas etapas
            etapasKanban.forEach((etapa, index) => {
                const cor = coresKanban[index % coresKanban.length];
                const isFirstColumn = index === 0;
                const hasFooter = etapa.footer || isFirstColumn;
                
                // Recuperar cards existentes ou usar vazio
                const cardsHtml = cardsExistentes[etapa.status] || '';
                const hasCards = cardsHtml && cardsHtml.trim() !== '' && !cardsHtml.includes('empty-column');
                
                const colunaHtml = `
                    <div class="kanban-column" data-status="${etapa.status}">
                        <div class="kanban-column-header">
                            <div>
                                <div class="column-title">${etapa.nome}</div>
                                <div class="column-count" id="count-${etapa.status}">${hasCards ? 'Carregando...' : 'Nenhum registro'}</div>
                            </div>
                            <div class="column-indicator" style="background: ${cor};"></div>
                        </div>
                        <div class="kanban-column-content" id="col-${etapa.status}">
                            ${cardsHtml || `
                                <div class="empty-column">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum registro</p>
                                </div>
                            `}
                        </div>
                        ${isFirstColumn ? `
                            <div class="kanban-column-footer">
                                <button class="btn-new-card" onclick="novoOrcamento()">
                                    <i class="fas fa-plus"></i> Novo Orçamento
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                kanbanBoard.insertAdjacentHTML('beforeend', colunaHtml);
            });
            
            // Reinicializar drag and drop para cards
            inicializarDragDropCards();
            
            // Atualizar contadores
            atualizarContadoresKanban();
        }

        function atualizarTitulosKanban() {
            // Atualizar cada coluna baseado nas etapas ou reconstruir se necessário
            const colunasAtuais = document.querySelectorAll('.kanban-column').length;
            
            if (colunasAtuais !== etapasKanban.length) {
                // Número de colunas diferente, reconstruir
                reconstruirKanbanBoard();
            } else {
                // Apenas atualizar títulos e reordenar se necessário
                const kanbanBoard = document.getElementById('kanban-board');
                const colunasEl = Array.from(document.querySelectorAll('.kanban-column'));
                
                // Verificar se precisa reordenar
                let precisaReordenar = false;
                etapasKanban.forEach((etapa, index) => {
                    if (colunasEl[index]?.dataset.status !== etapa.status) {
                        precisaReordenar = true;
                    }
                });
                
                if (precisaReordenar) {
                    reconstruirKanbanBoard();
                } else {
                    // Apenas atualizar títulos
                    etapasKanban.forEach((etapa, index) => {
                        const coluna = document.querySelector(`.kanban-column[data-status="${etapa.status}"]`);
                        if (coluna) {
                            const titulo = coluna.querySelector('.column-title');
                            if (titulo) {
                                titulo.textContent = etapa.nome;
                            }
                            // Atualizar cor do indicador
                            const indicator = coluna.querySelector('.column-indicator');
                            if (indicator) {
                                indicator.style.background = coresKanban[index % coresKanban.length];
                            }
                        }
                    });
                }
            }
        }

        function inicializarDragDropCards() {
            // Reinicializar eventos de drag/drop para os cards do kanban
            document.querySelectorAll('.kanban-column-content').forEach(content => {
                content.addEventListener('dragover', handleCardDragOver);
                content.addEventListener('dragleave', handleCardDragLeave);
                content.addEventListener('drop', handleCardDrop);
            });
            
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleCardDragStart);
                card.addEventListener('dragend', handleCardDragEnd);
            });
        }

        function atualizarContadoresKanban() {
            // Atualizar contagem de cards em cada coluna
            etapasKanban.forEach(etapa => {
                const content = document.getElementById(`col-${etapa.status}`);
                const counter = document.getElementById(`count-${etapa.status}`);
                if (content && counter) {
                    const cards = content.querySelectorAll('.kanban-card');
                    const total = cards.length;
                    if (total === 0) {
                        counter.textContent = 'Nenhum registro';
                    } else if (total === 1) {
                        counter.textContent = '1 registro';
                    } else {
                        counter.textContent = `${total} registros`;
                    }
                }
            });
        }

        // Funções de Drag/Drop para cards (se néo existirem)
        function handleCardDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleCardDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleCardDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            // Implementar lógica de mover card entre colunas
        }

        function handleCardDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }

        function handleCardDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        // Funçéo para compatibilidade com código legado
        function getEtapaByStatus(status) {
            return etapasKanban.find(e => e.status === status) || null;
        }

        // Carregar etapas salvas ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const etapasSalvas = localStorage.getItem('etapasKanban');
            if (etapasSalvas) {
                try {
                    const parsed = JSON.parse(etapasSalvas);
                    // Verificar se é o formato novo (array) ou antigo (objeto)
                    if (Array.isArray(parsed)) {
                        etapasKanban = parsed;
                    } else {
                        // Converter formato antigo para novo
                        etapasKanban = [
                            { id: 'orcamento', nome: parsed.orcamento || 'Orçamento', status: 'orcamento' },
                            { id: 'analise', nome: parsed.analise || 'Análise de Crédito', status: 'analise' },
                            { id: 'aprovado', nome: parsed.aprovado || 'Pedido Aprovado', status: 'aprovado' },
                            { id: 'faturar', nome: parsed.faturar || 'Faturar', status: 'faturar' },
                            { id: 'faturado', nome: parsed.faturado || 'Faturado', status: 'faturado', destaque: true },
                            { id: 'recibo', nome: parsed.recibo || 'Recibo', status: 'recibo' }
                        ];
                    }
                    // Reconstruir o kanban com as etapas salvas
                    reconstruirKanbanBoard();
                } catch (e) {
                    console.error('Erro ao carregar etapas salvas:', e);
                }
            }
            
            // Fechar modal ao clicar fora
            document.getElementById('modal-etapas-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalEtapas();
            });
            
            // Inicializar drag/drop para cards existentes
            inicializarDragDropCards();
        });
        
        // ========================================
        // MODAL FILTROS KANBAN
        // ========================================
        const filtrosState = {
            dataInclusao: 'tudo',
            dataPrevisao: 'tudo',
            dataFaturamento: 'ultimos-30',
            vendedor: 'todos',
            vendedorNome: 'Todos os Vendedores',
            projeto: 'todos',
            projetoNome: 'Todos os Projetos',
            exibirCancelados: false,
            exibirDenegados: false,
            exibirEncerrados: false
        };

        // Abrir modal de filtros
        function abrirModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.add('active');
        }

        // Fechar modal de filtros
        function fecharModalFiltros() {
            document.getElementById('modal-filtros-kanban').classList.remove('active');
        }

        // Desfazer filtros (restaurar padrões)
        function desfazerFiltros() {
            document.getElementById('filtro-data-inclusao').value = 'tudo';
            document.getElementById('filtro-data-previsao').value = 'tudo';
            document.getElementById('filtro-data-faturamento').value = 'ultimos-30';
            document.getElementById('filtro-vendedor').value = '';
            document.getElementById('filtro-vendedor').placeholder = 'Todos os Vendedores';
            document.getElementById('filtro-projeto').value = '';
            document.getElementById('filtro-projeto').placeholder = 'Todos os Projetos';
            document.getElementById('toggle-cancelados').checked = false;
            document.getElementById('toggle-denegados').checked = false;
            document.getElementById('toggle-encerrados').checked = false;
            
            // Atualizar estado
            filtrosState.dataInclusao = 'tudo';
            filtrosState.dataPrevisao = 'tudo';
            filtrosState.dataFaturamento = 'ultimos-30';
            filtrosState.vendedor = 'todos';
            filtrosState.vendedorNome = 'Todos os Vendedores';
            filtrosState.projeto = 'todos';
            filtrosState.projetoNome = 'Todos os Projetos';
            filtrosState.exibirCancelados = false;
            filtrosState.exibirDenegados = false;
            filtrosState.exibirEncerrados = false;
            
            // Atualizar link de filtro
            const filterLink = document.getElementById('filter-toggle');
            if (filterLink) {
                filterLink.textContent = 'Exibindo tudo';
                filterLink.style.color = '';
            }
            
            showToast('Filtros restaurados', 'info');
            
            // Recarregar Kanban sem filtros
            carregarDadosKanban(filtrosState);
        }

        // Aplicar filtros
        function aplicarFiltros() {
            filtrosState.dataInclusao = document.getElementById('filtro-data-inclusao').value;
            filtrosState.dataPrevisao = document.getElementById('filtro-data-previsao').value;
            filtrosState.dataFaturamento = document.getElementById('filtro-data-faturamento').value;
            filtrosState.exibirCancelados = document.getElementById('toggle-cancelados').checked;
            filtrosState.exibirDenegados = document.getElementById('toggle-denegados').checked;
            filtrosState.exibirEncerrados = document.getElementById('toggle-encerrados').checked;
            
            // Atualizar texto do link de filtro
            const filterLink = document.getElementById('filter-toggle');
            if (filterLink) {
                const filtrosAtivos = [];
                if (filtrosState.dataInclusao !== 'tudo') filtrosAtivos.push('Data Incluséo');
                if (filtrosState.dataPrevisao !== 'tudo') filtrosAtivos.push('Data Previséo');
                if (filtrosState.vendedor !== 'todos') filtrosAtivos.push(filtrosState.vendedorNome);
                if (filtrosState.projeto !== 'todos') filtrosAtivos.push('Projeto');
                if (filtrosState.exibirCancelados) filtrosAtivos.push('Cancelados');
                if (filtrosState.exibirDenegados) filtrosAtivos.push('Denegados');
                if (filtrosState.exibirEncerrados) filtrosAtivos.push('Encerrados');
                
                if (filtrosAtivos.length > 0) {
                    filterLink.textContent = `Filtrado: ${filtrosAtivos.join(', ')}`;
                    filterLink.style.color = '#f97316';
                } else {
                    filterLink.textContent = 'Exibindo tudo';
                    filterLink.style.color = '';
                }
            }
            
            fecharModalFiltros();
            showToast('Aplicando filtros...', 'info');
            
            // Recarregar o Kanban com os filtros aplicados
            carregarDadosKanban(filtrosState);
        }

        // Modal Selecionar Vendedor
        async function abrirModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.add('active');
            
            // Carregar vendedores da API
            try {
                const resp = await fetch('/api/vendas/vendedores', { credentials: 'include' });
                if (resp.ok) {
                    const vendedores = await resp.json();
                    const lista = document.getElementById('vendedor-list');
                    if (lista && vendedores.length > 0) {
                        lista.innerHTML = `
                            <div class="vendedor-item ${filtrosState.vendedor === 'todos' ? 'selected' : ''}" data-id="todos">Todos os Vendedores</div>
                            ${vendedores.map(v => `
                                <div class="vendedor-item ${filtrosState.vendedor == v.id ? 'selected' : ''}" data-id="${v.id}">${v.nome}</div>
                            `).join('')}
                        `;
                        
                        // Adicionar eventos de click
                        lista.querySelectorAll('.vendedor-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selecionarVendedor(this);
                            });
                        });
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar vendedores:', err);
            }
        }

        function fecharModalVendedor() {
            document.getElementById('modal-selecionar-vendedor').classList.remove('active');
        }

        // Selecionar vendedor da lista
        function selecionarVendedor(item) {
            const vendedorId = item.dataset.id;
            const vendedorNome = item.textContent.trim();
            
            // Atualizar estado
            filtrosState.vendedor = vendedorId;
            filtrosState.vendedorNome = vendedorNome;
            
            // Atualizar input
            const inputVendedor = document.getElementById('filtro-vendedor');
            if (vendedorId === 'todos') {
                inputVendedor.value = '';
                inputVendedor.placeholder = 'Todos os Vendedores';
            } else {
                inputVendedor.value = vendedorNome;
            }
            
            // Marcar como selecionado
            document.querySelectorAll('.vendedor-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            
            fecharModalVendedor();
        }

        // Modal Selecionar Projeto
        function abrirModalProjeto() {
            // Criar modal de seleçéo de projetos se néo existir
            let modal = document.getElementById('modal-selecionar-projeto');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-selecionar-projeto';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-vendedor-content" style="max-width: 500px;">
                        <div class="modal-vendedor-header">
                            <h3><i class="fas fa-folder-open"></i> Selecionar Projeto</h3>
                            <button type="button" class="btn-fechar" onclick="fecharModalProjeto()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-vendedor-body">
                            <div class="vendedor-search">
                                <input type="text" id="busca-projeto" placeholder="Buscar projeto...">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="vendedor-list" id="lista-projetos">
                                <div class="vendedor-item selected" onclick="selecionarProjeto(this, 'todos', 'Todos os Projetos')">
                                    <span class="vendedor-nome">Todos os Projetos</span>
                                </div>
                                <div class="vendedor-item" onclick="selecionarProjeto(this, 'industrial', 'Projeto Industrial')">
                                    <span class="vendedor-nome">Projeto Industrial</span>
                                </div>
                                <div class="vendedor-item" onclick="selecionarProjeto(this, 'residencial', 'Projeto Residencial')">
                                    <span class="vendedor-nome">Projeto Residencial</span>
                                </div>
                                <div class="vendedor-item" onclick="selecionarProjeto(this, 'comercial', 'Projeto Comercial')">
                                    <span class="vendedor-nome">Projeto Comercial</span>
                                </div>
                                <div class="vendedor-item" onclick="selecionarProjeto(this, 'manutencao', 'Manutençéo')">
                                    <span class="vendedor-nome">Manutençéo</span>
                                </div>
                                <div class="vendedor-item" onclick="selecionarProjeto(this, 'reforma', 'Reforma')">
                                    <span class="vendedor-nome">Reforma</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Busca de projeto
                modal.querySelector('#busca-projeto').addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    modal.querySelectorAll('.vendedor-item').forEach(item => {
                        const nome = item.textContent.toLowerCase();
                        item.style.display = nome.includes(termo) ? 'block' : 'none';
                    });
                });
                
                // Fechar ao clicar fora
                modal.addEventListener('click', function(e) {
                    if (e.target === this) fecharModalProjeto();
                });
            }
            
            modal.classList.add('active');
        }
        
        function fecharModalProjeto() {
            const modal = document.getElementById('modal-selecionar-projeto');
            if (modal) modal.classList.remove('active');
        }
        
        function selecionarProjeto(item, projetoId, projetoNome) {
            filtrosState.projeto = projetoId;
            filtrosState.projetoNome = projetoNome;
            
            const inputProjeto = document.getElementById('filtro-projeto');
            if (projetoId === 'todos') {
                inputProjeto.value = '';
                inputProjeto.placeholder = 'Todos os Projetos';
            } else {
                inputProjeto.value = projetoNome;
            }
            
            // Marcar como selecionado
            document.querySelectorAll('#modal-selecionar-projeto .vendedor-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            
            fecharModalProjeto();
        }

        // Inicializar eventos do modal de filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Click no link "Exibindo tudo" para abrir modal
            const filterToggle = document.getElementById('filter-toggle');
            if (filterToggle) {
                filterToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    abrirModalFiltros();
                });
            }
            
            // Busca de vendedor
            const buscaVendedor = document.getElementById('busca-vendedor');
            if (buscaVendedor) {
                buscaVendedor.addEventListener('input', function() {
                    const termo = this.value.toLowerCase();
                    document.querySelectorAll('.vendedor-item').forEach(item => {
                        const nome = item.textContent.toLowerCase();
                        item.style.display = nome.includes(termo) ? 'block' : 'none';
                    });
                });
            }
            
            // Fechar modais ao clicar fora
            document.getElementById('modal-filtros-kanban').addEventListener('click', function(e) {
                if (e.target === this) fecharModalFiltros();
            });
            
            document.getElementById('modal-selecionar-vendedor').addEventListener('click', function(e) {
                if (e.target === this) fecharModalVendedor();
            });
        });
        
        // ========================================
        // MODAL EMAILS ENVIADOS
        // ========================================
        let emailsPedido = {};

        function verEmailsEnviados() {
            if (!pedidoAtual) return;
            
            // Carregar emails do pedido (simular dados)
            if (!emailsPedido[pedidoAtual.id]) {
                emailsPedido[pedidoAtual.id] = [
                    {
                        destinatario: 'cliente@empresa.com',
                        assunto: `Orçamento Nº ${pedidoAtual.id} - Aluforce`,
                        data: '15/12/2025 14:30',
                        status: 'lido'
                    }
                ];
            }
            
            renderizarEmails(emailsPedido[pedidoAtual.id]);
            document.getElementById('modal-emails').classList.add('active');
        }

        function fecharModalEmails() {
            document.getElementById('modal-emails').classList.remove('active');
        }

        function renderizarEmails(emails) {
            const container = document.getElementById('emails-lista');
            
            if (emails.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhum email enviado para este pedido.</p>';
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-header">
                        <span class="email-destinatario"><i class="fas fa-user"></i> ${email.destinatario}</span>
                        <span class="email-data">${email.data}</span>
                    </div>
                    <div class="email-assunto">${email.assunto}</div>
                    <span class="email-status ${email.status}">
                        <i class="fas ${email.status === 'lido' ? 'fa-check-double' : 'fa-check'}"></i>
                        ${email.status === 'lido' ? 'Lido' : 'Enviado'}
                    </span>
                </div>
            `).join('');
        }

        function abrirEnviarEmail() {
            fecharModalEmails();
            // Ir para a aba de email no modal principal
            switchModalTab('email');
        }
        
        // ========================================
        // MODAL HISTÓRICO
        // ========================================
        // MODAL HISTÓRICO - PROFISSIONAL
        // ========================================
        async function verHistorico() {
            if (!pedidoAtual) return;
            
            const container = document.getElementById('historico-timeline');
            container.innerHTML = '<div class="historico-empty"><i class="fas fa-spinner fa-spin"></i><p>Carregando histórico...</p></div>';
            document.getElementById('modal-historico').classList.add('active');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const historico = await response.json();
                    renderizarHistoricoPro(historico);
                } else {
                    // Se néo tiver histórico na API, mostrar histórico simulado
                    renderizarHistoricoSimulado();
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                renderizarHistoricoSimulado();
            }
        }

        function fecharModalHistorico() {
            document.getElementById('modal-historico').classList.remove('active');
        }

        function renderizarHistoricoPro(historico) {
            const container = document.getElementById('historico-timeline');
            
            if (!historico || historico.length === 0) {
                container.innerHTML = `
                    <div class="historico-empty">
                        <i class="fas fa-clock"></i>
                        <p>Nenhum histórico registrado para este pedido.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            const historicoOrdenado = [...historico].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            container.innerHTML = historicoOrdenado.map(item => {
                const data = new Date(item.created_at);
                const dataFormatada = data.toLocaleDateString('pt-BR') + ' às ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const tipoClasse = getTipoClasse(item.action);
                const badge = getBadgeHtml(item.action);
                
                return `
                    <div class="historico-item-pro tipo-${tipoClasse}">
                        <div class="historico-header-pro">
                            ${badge}
                            <span class="historico-data-pro">${dataFormatada}</span>
                        </div>
                        <div class="historico-descricao-pro">${item.descricao || item.action}</div>
                        <div class="historico-usuario-pro">
                            <i class="fas fa-user-circle"></i>
                            ${item.user_name || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderizarHistoricoSimulado() {
            const historico = [
                {
                    created_at: new Date().toISOString(),
                    user_name: localStorage.getItem('userName') || 'Usuário',
                    action: 'criacao',
                    descricao: 'Pedido criado no sistema'
                }
            ];
            
            // Adicionar evento de status se existir
            if (pedidoAtual.status) {
                historico.push({
                    created_at: new Date(Date.now() - 3600000).toISOString(),
                    user_name: 'Sistema',
                    action: 'status',
                    descricao: `Status atual: ${pedidoAtual.status}`
                });
            }
            
            renderizarHistoricoPro(historico);
        }

        function getTipoClasse(action) {
            const tipos = {
                'faturamento': 'faturamento',
                'faturar': 'faturamento',
                'status': 'status',
                'status_alterado': 'status',
                'edicao': 'edicao',
                'item_added': 'edicao',
                'item_updated': 'edicao',
                'item_deleted': 'edicao',
                'criacao': 'criacao',
                'pedido_criado': 'criacao'
            };
            return tipos[action] || 'edicao';
        }

        function getBadgeHtml(action) {
            const badges = {
                'faturamento': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'faturar': '<span class="historico-badge badge-faturamento"><i class="fas fa-check-circle"></i> Faturamento</span>',
                'status': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'status_alterado': '<span class="historico-badge badge-status"><i class="fas fa-exchange-alt"></i> Etapa</span>',
                'edicao': '<span class="historico-badge badge-edicao"><i class="fas fa-edit"></i> Ediçéo</span>',
                'item_added': '<span class="historico-badge badge-item"><i class="fas fa-plus"></i> Item</span>',
                'item_updated': '<span class="historico-badge badge-item"><i class="fas fa-edit"></i> Item</span>',
                'item_deleted': '<span class="historico-badge badge-item"><i class="fas fa-trash"></i> Item</span>',
                'criacao': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criaçéo</span>',
                'pedido_criado': '<span class="historico-badge badge-criacao"><i class="fas fa-file-alt"></i> Criaçéo</span>'
            };
            return badges[action] || '<span class="historico-badge badge-edicao"><i class="fas fa-info"></i> Alteraçéo</span>';
        }

        // Registrar histórico localmente (quando API néo disponível)
        async function registrarHistoricoLocal(action, descricao) {
            if (!pedidoAtual) return;
            
            try {
                const token = localStorage.getItem('token');
                await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/historico`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ action, descricao })
                });
            } catch (error) {
                console.warn('Erro ao registrar histórico:', error);
            }
        }
        
        // ========================================
        // MODAL TAREFAS
        // ========================================
        let tarefasPedido = {};

        function verTarefas() {
            if (!pedidoAtual) return;
            
            // Carregar tarefas do pedido
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [
                    { id: 1, texto: 'Confirmar pagamento com cliente', concluida: true },
                    { id: 2, texto: 'Aguardar aprovaçéo de crédito', concluida: false },
                    { id: 3, texto: 'Enviar documentaçéo fiscal', concluida: false }
                ];
            }
            
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            document.getElementById('modal-tarefas').classList.add('active');
        }

        function fecharModalTarefas() {
            document.getElementById('modal-tarefas').classList.remove('active');
        }

        function renderizarTarefas(tarefas) {
            const container = document.getElementById('tarefas-lista');
            
            if (tarefas.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px;">Nenhuma tarefa cadastrada.</p>';
                return;
            }
            
            container.innerHTML = tarefas.map((tarefa, idx) => `
                <div class="tarefa-item ${tarefa.concluida ? 'concluida' : ''}">
                    <input type="checkbox" class="tarefa-checkbox" ${tarefa.concluida ? 'checked' : ''} onchange="toggleTarefa(${idx})">
                    <span class="tarefa-texto">${tarefa.texto}</span>
                    <button class="tarefa-delete" onclick="excluirTarefa(${idx})"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function adicionarTarefa() {
            if (!pedidoAtual) return;
            
            const input = document.getElementById('input-nova-tarefa');
            const texto = input.value.trim();
            
            if (!texto) {
                showNotification('Digite a descriçéo da tarefa', 'warning');
                return;
            }
            
            if (!tarefasPedido[pedidoAtual.id]) {
                tarefasPedido[pedidoAtual.id] = [];
            }
            
            tarefasPedido[pedidoAtual.id].push({
                id: Date.now(),
                texto: texto,
                concluida: false
            });
            
            input.value = '';
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa adicionada!', 'success');
        }

        function toggleTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id][idx].concluida = !tarefasPedido[pedidoAtual.id][idx].concluida;
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
        }

        function excluirTarefa(idx) {
            if (!pedidoAtual) return;
            tarefasPedido[pedidoAtual.id].splice(idx, 1);
            renderizarTarefas(tarefasPedido[pedidoAtual.id]);
            showNotification('Tarefa removida!', 'success');
        }
        
        // ========================================
        // MODAL PEDIDO PARCIAL
        // ========================================
        function pedidoParcial() {
            if (!pedidoAtual) return;
            
            // Mostrar itens do pedido para seleçéo parcial
            const container = document.getElementById('pedido-parcial-lista');
            
            // Simular itens do pedido
            const itens = [
                { codigo: 'ITEM001', nome: pedidoAtual.cliente + ' - Produto 1', qtd: 5, qtdDisp: 5 },
                { codigo: 'ITEM002', nome: pedidoAtual.cliente + ' - Produto 2', qtd: 3, qtdDisp: 3 }
            ];
            
            container.innerHTML = itens.map((item, idx) => `
                <div class="item-parcial">
                    <input type="checkbox" class="item-parcial-checkbox" id="item-parcial-${idx}" checked>
                    <div class="item-parcial-info">
                        <div class="item-parcial-nome">${item.codigo} - ${item.nome}</div>
                        <div class="item-parcial-qtd-original">Qtd Original: ${item.qtd} | Disponível: ${item.qtdDisp}</div>
                    </div>
                    <input type="number" class="item-parcial-qtd-input" value="${item.qtdDisp}" min="0" max="${item.qtdDisp}">
                </div>
            `).join('');
            
            document.getElementById('modal-pedido-parcial').classList.add('active');
        }

        function fecharModalPedidoParcial() {
            document.getElementById('modal-pedido-parcial').classList.remove('active');
        }

        function gerarPedidoParcial() {
            showNotification('Pedido parcial gerado com sucesso!', 'success');
            fecharModalPedidoParcial();
        }
        
        async function cancelarPedido() {
            if (!pedidoAtual || !pedidoAtual.id) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            const pedidoId = pedidoAtual.id;
            
            const confirmar = await showConfirmDialog({
                title: 'Cancelar Orçamento',
                message: `Tem certeza que deseja cancelar o <strong>Orçamento Nº ${pedidoId}</strong>?<br><br>O pedido será marcado como cancelado.`,
                type: 'warning',
                confirmText: 'Sim, Cancelar',
                confirmIcon: 'fa-ban',
                danger: true
            });
            if (!confirmar) return;
            
            try {
                // Chamar API para cancelar o pedido
                const response = await fetch(`/api/vendas/pedidos/${pedidoId}/status`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Cancelado' })
                });
                
                if (response.ok) {
                    // Atualizar status local
                    if (pedidoAtual) {
                        pedidoAtual.status = 'Cancelado';
                    }
                    
                    // Re-renderizar kanban
                    renderKanban();
                    
                    // Fechar modal
                    fecharModalEditar();
                    showNotification(`Orçamento Nº ${pedidoId} cancelado!`, 'success');
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Erro ao cancelar pedido', 'error');
                }
            } catch (error) {
                console.error('Erro ao cancelar pedido:', error);
                showNotification('Erro de conexéo ao cancelar pedido', 'error');
            }
        }

        // Funçéo Incluir (Criar novo pedido a partir do modal)
        function incluirPedido() {
            // Abrir modal de novo orçamento
            novoOrcamento();
        }
        
        function adicionarItem() {
            // Abre modal para adicionar novo item ao pedido
            novoItemPedido();
        }
        
        // ========================================
        // AUTOCOMPLETE DE PRODUTOS - API REAL
        // ========================================
        let produtoSelecionadoAutoComplete = null;
        let autocompleteTimeout = null;
        let autocompleteSelectedIndex = -1;

        // Inicializar autocomplete
        function initProdutoAutocomplete() {
            const input = document.getElementById('item-pedido-produto');
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            if (!input || !dropdown) return;

            // Evento de digitaçéo
            input.addEventListener('input', function(e) {
                const termo = e.target.value.trim();
                
                // Limpar timeout anterior
                if (autocompleteTimeout) clearTimeout(autocompleteTimeout);
                
                // Resetar seleçéo
                autocompleteSelectedIndex = -1;
                
                if (termo.length < 2) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                // Debounce de 300ms
                autocompleteTimeout = setTimeout(() => {
                    buscarProdutosAutocomplete(termo);
                }, 300);
            });

            // Navegaçéo com teclado
            input.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, items.length - 1);
                    atualizarSelecaoAutocomplete(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, 0);
                    atualizarSelecaoAutocomplete(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (autocompleteSelectedIndex >= 0 && items[autocompleteSelectedIndex]) {
                        items[autocompleteSelectedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                }
            });

            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // Atualizar item selecionado visualmente
        function atualizarSelecaoAutocomplete(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === autocompleteSelectedIndex);
            });
            if (items[autocompleteSelectedIndex]) {
                items[autocompleteSelectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        // Buscar produtos via API
        async function buscarProdutosAutocomplete(termo) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            try {
                // Tentar obter token de várias fontes (múltiplas tentativas)
                let token = localStorage.getItem('authToken') || 
                            localStorage.getItem('token') || 
                            sessionStorage.getItem('authToken') ||
                            sessionStorage.getItem('token');
                
                // Também tenta buscar do cookie
                if (!token) {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        const [name, value] = cookie.trim().split('=');
                        if (name === 'authToken' || name === 'token') {
                            token = decodeURIComponent(value);
                            break;
                        }
                    }
                }
                
                // Verificar se existe usuário logado
                const userData = localStorage.getItem('user') || localStorage.getItem('userData');
                const isUserLogged = !!userData;
                
                // Fazer requisiçéo mesmo sem token (servidor verifica cookie)
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`/api/vendas/produtos/autocomplete/${encodeURIComponent(termo)}`, {
                    headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const produtos = await response.json();
                    renderizarAutocomplete(produtos);
                } else if (response.status === 401) {
                    showNotification('Sesséo expirada. Faça login novamente.', 'error');
                    dropdown.innerHTML = '<div class="autocomplete-no-results">Sesséo expirada</div>';
                    dropdown.classList.add('active');
                } else {
                    dropdown.innerHTML = '<div class="autocomplete-no-results">Erro ao buscar produtos</div>';
                    dropdown.classList.add('active');
                }
            } catch (error) {
                console.error('Erro no autocomplete:', error);
                dropdown.innerHTML = '<div class="autocomplete-no-results">Erro de conexéo</div>';
                dropdown.classList.add('active');
            }
        }

        // Renderizar lista de autocomplete
        function renderizarAutocomplete(produtos) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            
            if (produtos.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results"><i class="fas fa-search"></i> Nenhum produto encontrado</div>';
                dropdown.classList.add('active');
                return;
            }
            
            dropdown.innerHTML = produtos.map((p, idx) => `
                <div class="autocomplete-item" data-idx="${idx}" onclick="selecionarProdutoAutocomplete(${idx})">
                    <span class="autocomplete-item-code">${p.codigo || ''}</span>
                    <span class="autocomplete-item-desc">${p.descricao || ''}</span>
                    <span class="autocomplete-item-info">
                        <span><i class="fas fa-box"></i> Estoque: ${formatarQuantidade(p.estoque_atual || 0)} ${p.unidade || 'M'}</span>
                        <span><i class="fas fa-tag"></i> ${formatarMoeda(p.preco_venda || 0)}</span>
                        <span><i class="fas fa-warehouse"></i> ${p.local_estoque || 'PADRAO'}</span>
                    </span>
                </div>
            `).join('');
            
            // Guardar produtos no DOM para seleçéo
            dropdown.produtosData = produtos;
            dropdown.classList.add('active');
        }

        // Selecionar produto do autocomplete
        function selecionarProdutoAutocomplete(idx) {
            const dropdown = document.getElementById('produto-autocomplete-dropdown');
            const input = document.getElementById('item-pedido-produto');
            const produto = dropdown.produtosData[idx];
            
            if (!produto) return;
            
            // Preencher dados do produto selecionado
            produtoSelecionadoAutoComplete = produto;
            input.value = `${produto.codigo} - ${produto.descricao}`;
            
            // Preencher preço
            const precoInput = document.getElementById('item-pedido-preco');
            if (precoInput) {
                precoInput.value = formatarDecimal(produto.preco_venda || 0);
            }
            
            // Atualizar cálculos
            atualizarCalculosItem();
            
            // Fechar dropdown
            dropdown.classList.remove('active');
            
            // Focus no campo quantidade
            const qtdInput = document.getElementById('item-pedido-quantidade');
            if (qtdInput) qtdInput.focus();
        }

        // Atualizar valores calculados
        function atualizarCalculosItem() {
            const quantidade = parseFloat(document.getElementById('item-pedido-quantidade')?.value) || 0;
            const preco = parseDecimal(document.getElementById('item-pedido-preco')?.value);
            const descontoPct = parseFloat(document.getElementById('item-pedido-desconto-pct')?.value?.replace(',', '.')) || 0;
            
            const valorMercadoria = quantidade * preco;
            const valorDesconto = valorMercadoria * (descontoPct / 100);
            const totalItem = valorMercadoria - valorDesconto;
            
            // Atualizar exibiçéo
            document.getElementById('calc-valor-mercadoria').textContent = formatarMoeda(valorMercadoria);
            document.getElementById('calc-valor-desconto').textContent = formatarMoeda(valorDesconto);
            document.getElementById('calc-total-item').textContent = formatarMoeda(totalItem);
            
            // Calcular total do pedido (itens existentes + este item)
            const totalExistente = itensPedidoAtual.reduce((sum, item) => {
                const qtd = parseFloat(item.quantidade) || 0;
                const prc = parseFloat(item.preco_unitario) || 0;
                const desc = parseFloat(item.desconto) || 0;
                return sum + (qtd * prc - desc);
            }, 0);
            
            document.getElementById('calc-total-pedido').textContent = formatarMoeda(totalExistente + totalItem);
        }

        // Toggle observações
        function toggleObservacoesItem() {
            const container = document.getElementById('item-observacoes-container');
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Pesquisar produto (abre modal de pesquisa avançada)
        function abrirPesquisaProduto() {
            // Criar modal de pesquisa se néo existir
            let modal = document.getElementById('modal-pesquisa-produto');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-pesquisa-produto';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <h3><i class="fas fa-search"></i> Pesquisa Avançada de Produtos</h3>
                            <button onclick="fecharPesquisaProduto()" class="btn-fechar"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="font-size: 12px; color: #666;">Código/Referência</label>
                                    <input type="text" id="pesq-codigo" class="form-control" placeholder="Código...">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666;">Descriçéo</label>
                                    <input type="text" id="pesq-descricao" class="form-control" placeholder="Descriçéo...">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666;">Categoria</label>
                                    <select id="pesq-categoria" class="form-control">
                                        <option value="">Todas</option>
                                        <option value="aluminio">Alumínio</option>
                                        <option value="vidro">Vidro</option>
                                        <option value="acessorio">Acessórios</option>
                                        <option value="ferragem">Ferragens</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="executarPesquisaProduto()" class="btn-primary" style="margin-bottom: 20px;">
                                <i class="fas fa-search"></i> Pesquisar
                            </button>
                            <div id="resultado-pesquisa-produto" style="max-height: 400px; overflow-y: auto;">
                                <p style="text-align: center; color: #999;">Digite os critérios e clique em Pesquisar</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', e => { if (e.target === modal) fecharPesquisaProduto(); });
            }
            modal.classList.add('active');
        }
        
        function fecharPesquisaProduto() {
            const modal = document.getElementById('modal-pesquisa-produto');
            if (modal) modal.classList.remove('active');
        }
        
        async function executarPesquisaProduto() {
            const codigo = document.getElementById('pesq-codigo').value;
            const descricao = document.getElementById('pesq-descricao').value;
            const categoria = document.getElementById('pesq-categoria').value;
            const container = document.getElementById('resultado-pesquisa-produto');
            
            container.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';
            
            try {
                let url = '/api/pcp/materiais?limit=50';
                if (codigo) url += `&codigo=${encodeURIComponent(codigo)}`;
                if (descricao) url += `&descricao=${encodeURIComponent(descricao)}`;
                if (categoria) url += `&categoria=${encodeURIComponent(categoria)}`;
                
                const resp = await fetch(url, { credentials: 'include' });
                const produtos = await resp.json();
                
                if (produtos.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">Nenhum produto encontrado</p>';
                    return;
                }
                
                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead><tr style="background: #f3f4f6;">
                            <th style="padding: 10px; text-align: left;">Código</th>
                            <th style="padding: 10px; text-align: left;">Descriçéo</th>
                            <th style="padding: 10px; text-align: right;">Preço</th>
                            <th style="padding: 10px; text-align: center;">Estoque</th>
                            <th style="padding: 10px;"></th>
                        </tr></thead>
                        <tbody>${produtos.map(p => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px;">${p.codigo || p.id}</td>
                                <td style="padding: 10px;">${p.descricao || p.nome}</td>
                                <td style="padding: 10px; text-align: right;">R$ ${(p.preco_venda || p.preco || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td style="padding: 10px; text-align: center;">${p.estoque_atual || p.quantidade || 0}</td>
                                <td style="padding: 10px; text-align: center;">
                                    <button onclick="selecionarProdutoPesquisa(${JSON.stringify(p).replace(/"/g, '&quot;')})" class="btn-sm btn-primary">Selecionar</button>
                                </td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = '<p style="text-align: center; color: #ef4444;">Erro ao buscar produtos</p>';
            }
        }
        
        function selecionarProdutoPesquisa(produto) {
            document.getElementById('item-pedido-produto').value = produto.descricao || produto.nome;
            document.getElementById('item-pedido-preco').value = (produto.preco_venda || produto.preco || 0).toFixed(2);
            fecharPesquisaProduto();
            atualizarCalculosItem();
        }

        // Inicializar eventos ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            initProdutoAutocomplete();
            
            // Eventos de cálculo ao alterar valores
            ['item-pedido-quantidade', 'item-pedido-preco', 'item-pedido-desconto-pct'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', atualizarCalculosItem);
                    el.addEventListener('change', atualizarCalculosItem);
                }
            });
        });
        
        // ========================================
        // CRUD ITENS DO PEDIDO
        // ========================================
        let itensPedidoAtual = [];
        let itemSelecionado = null;
        let itemSelecionadoIdx = null;
        let modoEdicaoItem = false;

        // Carregar itens do pedido da API
        async function carregarItensPedido(pedidoId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vendas/pedidos/${pedidoId}/itens`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                if (response.ok) {
                    itensPedidoAtual = await response.json();
                } else {
                    itensPedidoAtual = [];
                }
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                itensPedidoAtual = [];
            }
            renderizarTabelaItens();
            
            // Atualizar totais do modal após carregar os itens
            atualizarTotalModalEditar();
        }

        // Renderizar tabela de itens
        function renderizarTabelaItens() {
            const tbody = document.getElementById('itens-pedido-tbody');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (!tbody) return;
            
            if (itensPedidoAtual.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #888; padding: 40px;">
                            <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            Nenhum item adicionado. Clique em "Novo Item" para adicionar.
                        </td>
                    </tr>
                `;
                paginationInfo.textContent = '0 registros';
                return;
            }
            
            tbody.innerHTML = itensPedidoAtual.map((item, idx) => `
                <tr data-index="${idx}" data-id="${item.id}" onclick="selecionarItemTabela(${idx})" ondblclick="editarItemPorIndice(${idx})">
                    <td class="produto-code">${item.codigo || ''}</td>
                    <td class="produto-desc">${item.descricao || ''}</td>
                    <td>${formatarQuantidade(item.quantidade)} ${item.unidade || 'M'}</td>
                    <td>${formatarQuantidade(item.quantidade_parcial)} ${item.unidade || 'M'}</td>
                    <td>${item.local_estoque || 'PADRAO'}</td>
                    <td>${formatarMoeda(item.preco_unitario)}</td>
                </tr>
            `).join('');
            
            paginationInfo.textContent = `1 - ${itensPedidoAtual.length} de ${itensPedidoAtual.length} registros`;
        }

        function formatarQuantidade(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
        }

        // Selecionar item na tabela
        function selecionarItemTabela(idx) {
            // Remover seleçéo anterior
            document.querySelectorAll('#itens-pedido-tbody tr').forEach(tr => tr.classList.remove('selected'));
            
            // Adicionar seleçéo
            const tr = document.querySelector(`#itens-pedido-tbody tr[data-index="${idx}"]`);
            if (tr) {
                tr.classList.add('selected');
                itemSelecionadoIdx = idx;
                itemSelecionado = itensPedidoAtual[idx];
            }
        }

        // Adicionar novo item
        function adicionarItem() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            modoEdicaoItem = false;
            itemSelecionado = null;
            produtoSelecionadoAutoComplete = null;
            
            // Limpar campos do novo modal
            document.getElementById('item-pedido-id').value = '';
            document.getElementById('item-pedido-produto').value = '';
            document.getElementById('item-pedido-cfop').value = '';
            document.getElementById('item-pedido-quantidade').value = '1';
            document.getElementById('item-pedido-preco').value = '0,00';
            document.getElementById('item-pedido-tabela-preco').value = '';
            document.getElementById('item-pedido-desconto-pct').value = '0';
            document.getElementById('item-pedido-estoque').value = 'PADRAO - Local de Estoque Padréo';
            document.getElementById('item-pedido-cenario').value = 'Padréo';
            document.getElementById('item-pedido-npc').value = '';
            document.getElementById('item-pedido-item-npc').value = '0';
            document.getElementById('item-pedido-observacoes').value = '';
            
            // Limpar checkboxes
            document.getElementById('item-nao-gerar-saida').checked = false;
            document.getElementById('item-nao-gerar-conta').checked = false;
            document.getElementById('item-continuar-incluindo').checked = false; // Padréo: fechar modal após adicionar item
            
            // Esconder observações
            document.getElementById('item-observacoes-container').style.display = 'none';
            
            // Resetar cálculos
            document.getElementById('calc-valor-mercadoria').textContent = 'R$ 0,00';
            document.getElementById('calc-valor-desconto').textContent = 'R$ 0,00';
            document.getElementById('calc-ipi').textContent = 'R$ 0,00';
            document.getElementById('calc-icms-st').textContent = 'R$ 0,00';
            document.getElementById('calc-total-item').textContent = 'R$ 0,00';
            
            // Atualizar total do pedido existente
            const totalExistente = itensPedidoAtual.reduce((sum, item) => {
                const qtd = parseFloat(item.quantidade) || 0;
                const prc = parseFloat(item.preco_unitario) || 0;
                const desc = parseFloat(item.desconto) || 0;
                return sum + (qtd * prc - desc);
            }, 0);
            document.getElementById('calc-total-pedido').textContent = formatarMoeda(totalExistente);
            
            document.getElementById('modal-item-titulo').textContent = 'Novo Item de Pedido de Venda';
            document.getElementById('modal-item-pedido').classList.add('active');
            
            // Focar no campo produto
            setTimeout(() => {
                document.getElementById('item-pedido-produto').focus();
            }, 100);
        }

        // Editar item selecionado
        function editarItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para editar', 'info');
                return;
            }
            editarItemPorIndice(itemSelecionadoIdx);
        }

        // Editar item por índice (duplo clique)
        function editarItemPorIndice(idx) {
            const item = itensPedidoAtual[idx];
            if (!item) return;
            
            modoEdicaoItem = true;
            itemSelecionado = item;
            produtoSelecionadoAutoComplete = {
                id: item.produto_id,
                codigo: item.codigo,
                descricao: item.descricao,
                preco_venda: item.preco_unitario,
                unidade: item.unidade
            };
            
            // Preencher campos do novo modal
            document.getElementById('item-pedido-id').value = item.id;
            document.getElementById('item-pedido-produto').value = `${item.codigo || ''} - ${item.descricao || ''}`;
            document.getElementById('item-pedido-cfop').value = item.cfop || '';
            document.getElementById('item-pedido-quantidade').value = item.quantidade || 1;
            document.getElementById('item-pedido-preco').value = formatarDecimal(item.preco_unitario);
            document.getElementById('item-pedido-tabela-preco').value = item.tabela_preco || '';
            document.getElementById('item-pedido-desconto-pct').value = item.desconto_pct || '0';
            document.getElementById('item-pedido-estoque').value = item.local_estoque || 'PADRAO - Local de Estoque Padréo';
            document.getElementById('item-pedido-cenario').value = item.cenario_fiscal || 'Padréo';
            document.getElementById('item-pedido-npc').value = item.numero_pedido_compra || '';
            document.getElementById('item-pedido-item-npc').value = item.item_pedido_compra || '0';
            document.getElementById('item-pedido-observacoes').value = item.observacoes || '';
            
            // Atualizar cálculos
            atualizarCalculosItem();
            
            document.getElementById('modal-item-titulo').textContent = 'Editar Item de Pedido de Venda';
            document.getElementById('modal-item-pedido').classList.add('active');
        }

        function formatarDecimal(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function parseDecimal(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Fechar modal de item
        function fecharModalItemPedido() {
            document.getElementById('modal-item-pedido').classList.remove('active');
            document.getElementById('produto-autocomplete-dropdown').classList.remove('active');
        }

        // Salvar item (criar ou atualizar)
        async function salvarItemPedido() {
            // Obter dados do produto selecionado
            const produtoInput = document.getElementById('item-pedido-produto').value.trim();
            
            // Extrair código e descriçéo do input
            let codigo = '';
            let descricao = '';
            
            if (produtoSelecionadoAutoComplete) {
                codigo = produtoSelecionadoAutoComplete.codigo;
                descricao = produtoSelecionadoAutoComplete.descricao;
            } else if (produtoInput.includes(' - ')) {
                const parts = produtoInput.split(' - ');
                codigo = parts[0].trim();
                descricao = parts.slice(1).join(' - ').trim();
            } else {
                codigo = produtoInput;
                descricao = produtoInput;
            }
            
            const quantidade = parseFloat(document.getElementById('item-pedido-quantidade').value) || 1;
            const precoUnitario = parseDecimal(document.getElementById('item-pedido-preco').value);
            const descontoPct = parseFloat(document.getElementById('item-pedido-desconto-pct')?.value?.replace(',', '.')) || 0;
            const desconto = (quantidade * precoUnitario) * (descontoPct / 100); // Calcular valor do desconto
            const localEstoque = document.getElementById('item-pedido-estoque').value;
            const cfop = document.getElementById('item-pedido-cfop').value;
            const cenarioFiscal = document.getElementById('item-pedido-cenario').value;
            const observacoes = document.getElementById('item-pedido-observacoes').value;
            const unidade = produtoSelecionadoAutoComplete?.unidade || 'M';
            
            if (!codigo && !produtoInput) {
                showNotification('Selecione um produto', 'warning');
                document.getElementById('item-pedido-produto').focus();
                return;
            }
            
            const token = localStorage.getItem('token');
            const itemData = {
                codigo,
                descricao,
                quantidade,
                quantidade_parcial: 0,
                preco_unitario: precoUnitario,
                desconto,
                desconto_pct: descontoPct,
                unidade,
                local_estoque: localEstoque,
                cfop,
                cenario_fiscal: cenarioFiscal,
                observacoes,
                produto_id: produtoSelecionadoAutoComplete?.id || null
            };
            
            try {
                let response;
                if (modoEdicaoItem && itemSelecionado) {
                    // Atualizar item existente
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(itemData)
                    });
                } else {
                    // Criar novo item
                    response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(itemData)
                    });
                }
                
                if (response.ok) {
                    showNotification(modoEdicaoItem ? 'Item atualizado com sucesso!' : 'Item adicionado com sucesso!', 'success');
                    
                    // Verificar se deve continuar incluindo
                    const continuarIncluindo = document.getElementById('item-continuar-incluindo').checked;
                    
                    if (continuarIncluindo && !modoEdicaoItem) {
                        // Limpar formulário e manter modal aberto
                        produtoSelecionadoAutoComplete = null;
                        document.getElementById('item-pedido-produto').value = '';
                        document.getElementById('item-pedido-quantidade').value = '1';
                        document.getElementById('item-pedido-preco').value = '0,00';
                        document.getElementById('item-pedido-desconto-pct').value = '0';
                        document.getElementById('item-pedido-produto').focus();
                        
                        // Recarregar itens para atualizar total
                        await carregarItensPedido(pedidoAtual.id);
                        atualizarCalculosItem();
                    } else {
                        fecharModalItemPedido();
                        // Recarregar itens
                        await carregarItensPedido(pedidoAtual.id);
                    }
                    
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    // Tratar erros de autenticaçéo
                    if (response.status === 401 || response.status === 403) {
                        const errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            showNotification(errorJson.message || 'Erro de autenticaçéo. Faça login novamente.', 'error');
                        } catch {
                            showNotification('Sesséo expirada. Faça login novamente.', 'error');
                        }
                        // Redirecionar para login se token inválido/expirado
                        if (response.status === 401) {
                            setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                        }
                        return;
                    }
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao salvar item', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showNotification('Erro de conexéo ao salvar item', 'error');
            }
        }

        // Excluir item selecionado
        async function excluirItemSelecionado() {
            if (itemSelecionadoIdx === null || !itemSelecionado) {
                showNotification('Selecione um item na tabela para excluir', 'warning');
                return;
            }
            
            const confirmar = await confirmDelete(`${itemSelecionado.codigo}`, 'Item');
            if (!confirmar) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/vendas/pedidos/${pedidoAtual.id}/itens/${itemSelecionado.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Item excluído com sucesso!', 'success');
                    itemSelecionado = null;
                    itemSelecionadoIdx = null;
                    // Recarregar itens
                    await carregarItensPedido(pedidoAtual.id);
                    // Atualizar total no modal
                    atualizarTotalModalEditar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Erro ao excluir item', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir item:', error);
                showNotification('Erro de conexéo ao excluir item', 'error');
            }
        }

        // Atualizar totais no modal de editar
        function atualizarTotalModalEditar() {
            // Calcular total de mercadorias (quantidade * preço unitário)
            const totalMercadorias = itensPedidoAtual.reduce((sum, item) => {
                const quantidade = parseFloat(item.quantidade) || 0;
                const preco = parseFloat(item.preco_unitario) || parseFloat(item.valor_unitario) || 0;
                return sum + (quantidade * preco);
            }, 0);
            
            // Calcular total de descontos
            const totalDesconto = itensPedidoAtual.reduce((sum, item) => {
                return sum + (parseFloat(item.desconto) || 0);
            }, 0);
            
            // Calcular impostos (se existirem)
            const totalIPI = itensPedidoAtual.reduce((sum, item) => {
                return sum + (parseFloat(item.valor_ipi) || 0);
            }, 0);
            
            const totalICMSST = itensPedidoAtual.reduce((sum, item) => {
                return sum + (parseFloat(item.valor_icms_st) || 0);
            }, 0);
            
            // Valor final
            const valorTotal = totalMercadorias - totalDesconto + totalIPI + totalICMSST;
            
            // Atualizar campos do modal
            const totalMercadoriasInput = document.getElementById('edit-total-mercadorias');
            const descontoInput = document.getElementById('edit-desconto');
            const ipiInput = document.getElementById('edit-ipi');
            const icmsStInput = document.getElementById('edit-icms-st');
            const valorTotalInput = document.getElementById('edit-valor-total');
            
            if (totalMercadoriasInput) totalMercadoriasInput.value = formatarMoeda(totalMercadorias);
            if (descontoInput && totalDesconto > 0) descontoInput.value = formatarMoeda(totalDesconto);
            if (ipiInput) ipiInput.value = formatarMoeda(totalIPI);
            if (icmsStInput) icmsStInput.value = formatarMoeda(totalICMSST);
            if (valorTotalInput) valorTotalInput.value = formatarMoeda(valorTotal);
            
            // Atualizar o valor no pedidoAtual
            if (pedidoAtual) {
                pedidoAtual.valor = valorTotal;
                pedidoAtual.total_mercadorias = totalMercadorias;
            }
            
            console.log('[Vendas] Totais atualizados:', { 
                itens: itensPedidoAtual.length,
                totalMercadorias, 
                totalDesconto, 
                totalIPI, 
                totalICMSST, 
                valorTotal 
            });
        }

        // Fechar modal de item ao clicar fora
        document.addEventListener('DOMContentLoaded', function() {
            const modalItemPedido = document.getElementById('modal-item-pedido');
            if (modalItemPedido) {
                modalItemPedido.addEventListener('click', function(e) {
                    if (e.target === this) fecharModalItemPedido();
                });
            }
        });
        
        async function excluirPedido() {
            if (!pedidoAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            // Salvar dados do pedido ANTES do confirm (pois pode ser alterado)
            const pedidoId = pedidoAtual.id;
            const pedidoColuna = pedidoAtual._coluna || statusParaColuna[pedidoAtual._statusOriginal] || 'orcamento';
            
            // Usar modal de confirmaçéo profissional
            const confirmar = await confirmDelete(`Pedido Nº ${pedidoId}`, 'Pedido');
            if (!confirmar) return;
            
            // Mostrar loading
            showNotification('Excluindo pedido...', 'info');
            
            // Excluir no backend via API PRIMEIRO
            try {
                const resp = await fetch(`/api/vendas/pedidos/${pedidoId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await resp.json().catch(() => ({}));
                
                if (!resp.ok) {
                    throw new Error(result.error || result.message || 'Erro ao excluir pedido');
                }
                
                // Sucesso: Remover da lista local
                const idx = dadosVendas[pedidoColuna]?.findIndex(p => p.id === pedidoId);
                if (idx !== -1 && dadosVendas[pedidoColuna]) {
                    dadosVendas[pedidoColuna].splice(idx, 1);
                }
                
                // Também buscar em todas as colunas caso néo encontre
                Object.keys(dadosVendas).forEach(col => {
                    const index = dadosVendas[col].findIndex(p => p.id === pedidoId);
                    if (index !== -1) {
                        dadosVendas[col].splice(index, 1);
                    }
                });
                
                // Re-renderizar kanban
                renderKanban();
                
                // Fechar modal e notificar
                fecharModalEditar();
                showNotification('Pedido excluído com sucesso!', 'success');
                
                console.log('✅ Pedido', pedidoId, 'excluído com sucesso');
                
            } catch (e) {
                console.error('❌ Erro ao excluir pedido:', e);
                showNotification('Erro ao excluir pedido: ' + e.message, 'error');
            }
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('modal-editar-pedido').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalEditar();
            }
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalEditar();
            }
        });

        // ========================================
        // AUTOCOMPLETE PARA CAMPO EDIT-CLIENTE
        // ========================================
        let debounceTimerEditCliente = null;
        let editClienteSelecionadoId = null;
        
        // Usar delegaçéo de eventos para o autocomplete de clientes
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'edit-cliente') {
                const query = e.target.value.trim();
                
                if (debounceTimerEditCliente) clearTimeout(debounceTimerEditCliente);
                
                if (query.length < 2) {
                    const dropdown = document.getElementById('dropdown-edit-clientes');
                    if (dropdown) dropdown.style.display = 'none';
                    return;
                }
                
                debounceTimerEditCliente = setTimeout(() => buscarClientesEditAPI(query), 300);
            }
        });
        
        async function buscarClientesEditAPI(query) {
            try {
                const resp = await fetch(`/api/empresas/buscar?termo=${encodeURIComponent(query)}&limit=15`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Erro na busca');
                
                const empresas = await resp.json();
                const dropdown = document.getElementById('dropdown-edit-clientes');
                
                if (!dropdown) return;
                
                if (!empresas || empresas.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 15px; color: #999; text-align: center; font-size: 13px;"><i class="fas fa-search" style="margin-right: 8px;"></i>Nenhuma empresa encontrada</div>';
                } else {
                    dropdown.innerHTML = empresas.map(emp => `
                        <div class="dropdown-item-edit" onclick="selecionarClienteEdit(${emp.id}, '${(emp.nome_fantasia || emp.razao_social || emp.nome || '').replace(/'/g, "\\'")}', '${emp.cnpj || ''}')" 
                             style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 500; color: #333;">${emp.nome_fantasia || emp.razao_social || emp.nome || 'Sem nome'}</div>
                                    ${emp.razao_social && emp.razao_social !== emp.nome_fantasia ? `<div style="font-size: 11px; color: #888;">${emp.razao_social}</div>` : ''}
                                </div>
                                <span style="font-size: 11px; color: #3b82f6; background: #eff6ff; padding: 3px 8px; border-radius: 4px;">${emp.cnpj || 'CPF/CNPJ néo informado'}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
                
                // Adicionar hover effect
                dropdown.querySelectorAll('.dropdown-item-edit').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.background = '#f8fafc';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.background = '#fff';
                    });
                });
            } catch (err) {
                console.error('Erro ao buscar clientes:', err);
            }
        }
        
        function selecionarClienteEdit(id, nome, cnpj) {
            document.getElementById('edit-cliente').value = nome;
            document.getElementById('edit-cliente-id').value = id;
            editClienteSelecionadoId = id;
            document.getElementById('dropdown-edit-clientes').style.display = 'none';
            
            // Atualizar avatar com iniciais
            const avatar = document.getElementById('modal-cliente-avatar');
            if (avatar && nome) {
                const iniciais = nome.split(' ').slice(0, 2).map(n => n[0]).join('').toUpperCase();
                avatar.textContent = iniciais;
            }
            
            showNotification('Cliente selecionado: ' + nome, 'success');
        }
        
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('dropdown-edit-clientes');
            const input = document.getElementById('edit-cliente');
            if (dropdown && input && !input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
            // Fechar dropdown de transportadoras
            const dropdownTransp = document.getElementById('dropdown-edit-transportadoras');
            const inputTransp = document.getElementById('edit-transportadora');
            if (dropdownTransp && inputTransp && !inputTransp.contains(e.target) && !dropdownTransp.contains(e.target)) {
                dropdownTransp.style.display = 'none';
            }
        });
        
        // ========================================
        // AUTOCOMPLETE PARA CAMPO EDIT-TRANSPORTADORA
        // ========================================
        let debounceTimerEditTransportadora = null;
        let editTransportadoraSelecionadaId = null;
        
        // Usar delegaçéo de eventos para o autocomplete de transportadoras
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'edit-transportadora') {
                const query = e.target.value.trim();
                
                if (debounceTimerEditTransportadora) clearTimeout(debounceTimerEditTransportadora);
                
                if (query.length < 2) {
                    const dropdown = document.getElementById('dropdown-edit-transportadoras');
                    if (dropdown) dropdown.style.display = 'none';
                    return;
                }
                
                debounceTimerEditTransportadora = setTimeout(() => buscarTransportadorasEditAPI(query), 300);
            }
        });
        
        async function buscarTransportadorasEditAPI(query) {
            try {
                const resp = await fetch(`/api/transportadoras?termo=${encodeURIComponent(query)}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Erro na busca');
                
                const transportadoras = await resp.json();
                const dropdown = document.getElementById('dropdown-edit-transportadoras');
                
                if (!dropdown) return;
                
                if (!transportadoras || transportadoras.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 15px; color: #999; text-align: center; font-size: 13px;"><i class="fas fa-truck" style="margin-right: 8px;"></i>Nenhuma transportadora encontrada</div>';
                } else {
                    dropdown.innerHTML = transportadoras.map(transp => `
                        <div class="dropdown-item-transp" onclick="selecionarTransportadoraEdit(${transp.id}, '${(transp.nome || transp.razao_social || '').replace(/'/g, "\\'")}', '${transp.cnpj || ''}')" 
                             style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 500; color: #333;"><i class="fas fa-truck" style="color: #3b82f6; margin-right: 8px;"></i>${transp.nome || transp.razao_social || 'Sem nome'}</div>
                                    ${transp.cidade ? `<div style="font-size: 11px; color: #888;">${transp.cidade}/${transp.estado || ''}</div>` : ''}
                                </div>
                                <span style="font-size: 11px; color: #059669; background: #ecfdf5; padding: 3px 8px; border-radius: 4px;">${transp.cnpj || transp.telefone || ''}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
                
                // Adicionar hover effect
                dropdown.querySelectorAll('.dropdown-item-transp').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.background = '#f8fafc';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.background = '#fff';
                    });
                });
            } catch (err) {
                console.error('Erro ao buscar transportadoras:', err);
                // Se a API falhar, tenta buscar por empresas tipo transportadora
                try {
                    const respFallback = await fetch(`/api/empresas/buscar?termo=${encodeURIComponent(query)}&tipo=transportadora&limit=15`, { credentials: 'include' });
                    if (respFallback.ok) {
                        const empresas = await respFallback.json();
                        const dropdown = document.getElementById('dropdown-edit-transportadoras');
                        if (dropdown && empresas && empresas.length > 0) {
                            dropdown.innerHTML = empresas.map(emp => `
                                <div class="dropdown-item-transp" onclick="selecionarTransportadoraEdit(${emp.id}, '${(emp.nome_fantasia || emp.razao_social || '').replace(/'/g, "\\'")}', '${emp.cnpj || ''}')" 
                                     style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: all 0.2s;">
                                    <div style="font-weight: 500; color: #333;"><i class="fas fa-truck" style="color: #3b82f6; margin-right: 8px;"></i>${emp.nome_fantasia || emp.razao_social || 'Sem nome'}</div>
                                </div>
                            `).join('');
                            dropdown.style.display = 'block';
                        }
                    }
                } catch (e) { /* fallback silencioso */ }
            }
        }
        
        function selecionarTransportadoraEdit(id, nome, cnpj) {
            document.getElementById('edit-transportadora').value = nome;
            document.getElementById('edit-transportadora-id').value = id;
            editTransportadoraSelecionadaId = id;
            document.getElementById('dropdown-edit-transportadoras').style.display = 'none';
            
            showNotification('Transportadora selecionada: ' + nome, 'success');
        }
        
        // Funçéo de consulta de crédito para modal de ediçéo
        function consultarCreditoEdit() {
            const clienteId = editClienteSelecionadoId || document.getElementById('edit-cliente-id')?.value;
            const clienteNome = document.getElementById('edit-cliente')?.value || 'Cliente';
            
            if (!clienteId) {
                showNotification('Selecione um cliente primeiro', 'warning');
                return;
            }
            
            // Criar/mostrar modal de consulta de crédito
            let modal = document.getElementById('modal-consulta-credito-edit');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-consulta-credito-edit';
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
                modal.innerHTML = `
                    <div style="background: white; max-width: 650px; width: 95%; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
                        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 20px; font-weight: 600;"><i class="fas fa-credit-card" style="margin-right: 10px;"></i>Consulta de Crédito</h3>
                                <button onclick="document.getElementById('modal-consulta-credito-edit').style.display='none'" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <p style="margin: 12px 0 0 0; font-size: 15px; opacity: 0.9;" id="credito-edit-cliente-nome"></p>
                        </div>
                        <div style="padding: 28px;" id="credito-edit-conteudo">
                            <div style="text-align: center; padding: 50px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #3b82f6;"></i>
                                <p style="margin-top: 20px; color: #666; font-size: 15px;">Consultando informações de crédito...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === this) this.style.display = 'none';
                });
            }
            
            document.getElementById('credito-edit-cliente-nome').textContent = clienteNome;
            modal.style.display = 'flex';
            
            // Buscar dados de crédito via API
            fetch(`/api/vendas/credito/${clienteId}`, { credentials: 'include' })
            .then(res => res.ok ? res.json() : Promise.reject('API néo encontrada'))
            .then(dados => renderizarCredito(dados))
            .catch(err => {
                // Fallback: buscar dados do cliente
                fetch(`/api/empresas/${clienteId}`, { credentials: 'include' })
                .then(res => res.json())
                .then(cliente => {
                    renderizarCredito({
                        limite_credito: cliente.limite_credito || 50000,
                        credito_utilizado: cliente.credito_utilizado || 0,
                        ultima_compra: cliente.ultima_compra || 'Néo registrada',
                        titulos_vencidos: cliente.titulos_vencidos || 0
                    });
                })
                .catch(() => {
                    // Dados simulados se nenhuma API funcionar
                    renderizarCredito({
                        limite_credito: 50000,
                        credito_utilizado: 12500,
                        ultima_compra: new Date().toLocaleDateString('pt-BR'),
                        titulos_vencidos: 0
                    });
                });
            });
        }
        
        function renderizarCredito(dados) {
            const limiteCredito = dados.limite_credito || 50000;
            const creditoUtilizado = dados.credito_utilizado || dados.total_em_aberto || 0;
            const creditoDisponivel = limiteCredito - creditoUtilizado;
            const percentualUtilizado = limiteCredito > 0 ? (creditoUtilizado / limiteCredito) * 100 : 0;
            const status = creditoDisponivel > 0 ? 'Disponível' : 'Bloqueado';
            const statusColor = creditoDisponivel > 0 ? '#22c55e' : '#ef4444';
            const ultimaCompra = dados.ultima_compra || 'Néo registrada';
            const maiorCompra = dados.maior_compra || 0;
            const titulVencidos = dados.titulos_vencidos || 0;
            
            document.getElementById('credito-edit-conteudo').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 22px; border-radius: 12px; text-align: center; border: 1px solid #86efac;">
                        <div style="font-size: 11px; color: #166534; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Limite de Crédito</div>
                        <div style="font-size: 26px; font-weight: 700; color: #166534;">R$ ${limiteCredito.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef2f2, #fecaca); padding: 22px; border-radius: 12px; text-align: center; border: 1px solid #fca5a5;">
                        <div style="font-size: 11px; color: #991b1b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Crédito Utilizado</div>
                        <div style="font-size: 26px; font-weight: 700; color: #991b1b;">R$ ${creditoUtilizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); padding: 25px; border-radius: 14px; text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Crédito Disponível</div>
                    <div style="font-size: 36px; font-weight: 700; color: white;">R$ ${creditoDisponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    <div style="margin-top: 18px; background: rgba(255,255,255,0.2); border-radius: 10px; height: 10px; overflow: hidden;">
                        <div style="background: ${percentualUtilizado > 80 ? '#fbbf24' : '#22c55e'}; height: 100%; width: ${Math.min(percentualUtilizado, 100)}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 10px;">${percentualUtilizado.toFixed(1)}% do limite utilizado</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8fafc; padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">Status</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                            <i class="fas fa-${creditoDisponivel > 0 ? 'check-circle' : 'times-circle'}" style="margin-right: 5px;"></i>${status}
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">Última Compra</div>
                        <div style="font-size: 14px; font-weight: 600; color: #334155;">${ultimaCompra}</div>
                    </div>
                    <div style="background: #f8fafc; padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">Maior Compra</div>
                        <div style="font-size: 14px; font-weight: 600; color: #334155;">R$ ${maiorCompra.toLocaleString('pt-BR')}</div>
                    </div>
                </div>
                
                ${titulVencidos > 0 ? `
                <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; padding: 18px; border-radius: 10px; display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 24px;"></i>
                    <div>
                        <div style="font-weight: 600; color: #991b1b; font-size: 15px;">Atençéo: Títulos em Atraso</div>
                        <div style="font-size: 13px; color: #b91c1c;">${titulVencidos} título(s) vencido(s) - Verificar situaçéo financeira</div>
                    </div>
                </div>
                ` : `
                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #86efac; padding: 18px; border-radius: 10px; display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-check-circle" style="color: #22c55e; font-size: 24px;"></i>
                    <div>
                        <div style="font-weight: 600; color: #166534; font-size: 15px;">Cliente em Dia</div>
                        <div style="font-size: 13px; color: #15803d;">Nenhum título vencido - Cliente adimplente</div>
                    </div>
                </div>
                `}
            `;
        }

        // ========================================
        // AÇÕES - NOVO ORÇAMENTO (MODAL PROFISSIONAL)
        // ========================================
        
        // Dados temporários dos itens do orçamento
        let itensOrcamento = [];
        let clienteSelecionadoId = null;
        let vendedoresLista = [];
        
        // ========================================
        // AUTOCOMPLETE DE CLIENTES/EMPRESAS
        // ========================================
        let debounceTimerCliente = null;
        
        document.getElementById('novo-cliente').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // Limpar timer anterior
            if (debounceTimerCliente) clearTimeout(debounceTimerCliente);
            
            if (query.length < 1) {
                document.getElementById('dropdown-clientes').style.display = 'none';
                return;
            }
            
            // Aguardar 300ms antes de buscar
            debounceTimerCliente = setTimeout(() => buscarClientesAPI(query), 300);
        });
        
        async function buscarClientesAPI(query) {
            try {
                const resp = await fetch(`/api/vendas/empresas/search?q=${encodeURIComponent(query)}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Erro na busca');
                
                const empresas = await resp.json();
                const dropdown = document.getElementById('dropdown-clientes');
                
                if (empresas.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">Nenhuma empresa encontrada</div>';
                } else {
                    dropdown.innerHTML = empresas.map(emp => `
                        <div class="dropdown-item" onclick="selecionarCliente(${emp.id}, '${emp.nome_fantasia.replace(/'/g, "\\'")}', '${emp.cnpj || ''}')" 
                             style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;"
                             onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
                            <span style="font-weight: 500;">${emp.nome_fantasia}</span>
                            <span style="font-size: 11px; color: #888;">${emp.cnpj || ''}</span>
                        </div>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
            } catch (err) {
                console.error('Erro ao buscar clientes:', err);
            }
        }
        
        function selecionarCliente(id, nome, cnpj) {
            document.getElementById('novo-cliente').value = nome;
            document.getElementById('novo-cliente-id').value = id;
            clienteSelecionadoId = id;
            document.getElementById('dropdown-clientes').style.display = 'none';
            
            // Atualizar avatar com primeira letra
            const avatar = document.querySelector('.orcamento-cliente-avatar i');
            if (avatar) {
                avatar.className = 'fas fa-building';
                avatar.style.color = '#f97316';
            }
        }
        
        function buscarClientes() {
            const query = document.getElementById('novo-cliente').value.trim();
            if (query.length >= 1) {
                buscarClientesAPI(query);
            } else {
                buscarClientesAPI(''); // Buscar todos
            }
        }
        
        function consultarCredito() {
            if (!clienteSelecionadoId) {
                showToast('Selecione um cliente primeiro', 'warning');
                return;
            }
            
            // Buscar dados do cliente selecionado
            const clienteInfo = document.getElementById('novo-cliente').value || 'Cliente';
            
            // Criar modal de consulta de crédito
            let modal = document.getElementById('modal-consulta-credito');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-consulta-credito';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; padding: 0; border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-credit-card"></i> Consulta de Crédito</h3>
                                <button onclick="fecharModalCredito()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;" id="credito-cliente-nome"></p>
                        </div>
                        <div style="padding: 25px;" id="credito-conteudo">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #3b82f6;"></i>
                                <p style="margin-top: 15px; color: #666;">Consultando informações...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', function(e) {
                    if (e.target === this) fecharModalCredito();
                });
            }
            
            document.getElementById('credito-cliente-nome').textContent = clienteInfo;
            modal.classList.add('active');
            
            // Buscar dados de crédito via API
            fetch(`/api/vendas/empresas/${clienteSelecionadoId}/credito`, { credentials: 'include' })
            .then(res => res.json())
            .then(dados => {
                // Usar dados da API ou valores simulados
                const limiteCredito = dados.limite_credito || 50000;
                const creditoUtilizado = dados.credito_utilizado || dados.total_em_aberto || 12500;
                const creditoDisponivel = limiteCredito - creditoUtilizado;
                const percentualUtilizado = (creditoUtilizado / limiteCredito) * 100;
                const status = creditoDisponivel > 0 ? 'Disponível' : 'Bloqueado';
                const statusClass = creditoDisponivel > 0 ? 'green' : 'red';
                const ultimaCompra = dados.ultima_compra || dados.ultimo_pedido || '15/01/2026';
                const maiorCompra = dados.maior_compra || 8500;
                const titulVencidos = dados.titulos_vencidos || 0;
                
                document.getElementById('credito-conteudo').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #22c55e;">
                            <div style="font-size: 12px; color: #166534; margin-bottom: 8px;">LIMITE DE CRÉDITO</div>
                            <div style="font-size: 24px; font-weight: bold; color: #166534;">R$ ${limiteCredito.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="background: #fef2f2; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #ef4444;">
                            <div style="font-size: 12px; color: #991b1b; margin-bottom: 8px;">CRÉDITO UTILIZADO</div>
                            <div style="font-size: 24px; font-weight: bold; color: #991b1b;">R$ ${creditoUtilizado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">CRÉDITO DISPONÍVEL</div>
                        <div style="font-size: 32px; font-weight: bold; color: white;">R$ ${creditoDisponivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <div style="margin-top: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; overflow: hidden;">
                            <div style="background: ${percentualUtilizado > 80 ? '#ef4444' : '#22c55e'}; height: 100%; width: ${Math.min(percentualUtilizado, 100)}%;"></div>
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 8px;">${percentualUtilizado.toFixed(1)}% utilizado</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Status</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${statusClass === 'green' ? '#22c55e' : '#ef4444'};">
                                <i class="fas fa-${statusClass === 'green' ? 'check-circle' : 'times-circle'}"></i> ${status}
                            </div>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Última Compra</div>
                            <div style="font-size: 14px; font-weight: 600; color: #334155;">${ultimaCompra}</div>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Maior Compra</div>
                            <div style="font-size: 14px; font-weight: 600; color: #334155;">R$ ${maiorCompra.toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                    
                    ${titulVencidos > 0 ? `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 20px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #991b1b;">Atençéo: Títulos em Atraso</div>
                            <div style="font-size: 13px; color: #b91c1c;">${titulVencidos} título(s) vencido(s) - Verificar situaçéo financeira</div>
                        </div>
                    </div>
                    ` : `
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-check-circle" style="color: #22c55e; font-size: 20px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #166534;">Cliente em Dia</div>
                            <div style="font-size: 13px; color: #15803d;">Nenhum título vencido - Cliente adimplente</div>
                        </div>
                    </div>
                    `}
                `;
            })
            .catch(error => {
                console.error('Erro ao consultar crédito:', error);
                // Mostrar dados simulados em caso de erro
                document.getElementById('credito-conteudo').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <i class="fas fa-info-circle" style="font-size: 40px; color: #3b82f6; margin-bottom: 15px;"></i>
                        <p style="color: #666; margin-bottom: 20px;">Informações de crédito néo disponíveis para este cliente.</p>
                        <p style="font-size: 13px; color: #999;">Entre em contato com o setor financeiro para mais informações.</p>
                    </div>
                `;
            });
        }
        
        function fecharModalCredito() {
            const modal = document.getElementById('modal-consulta-credito');
            if (modal) modal.classList.remove('active');
        }
        
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('dropdown-clientes');
            const input = document.getElementById('novo-cliente');
            if (!dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
            }
            
            const dropdownVend = document.getElementById('dropdown-vendedores');
            const inputVend = document.getElementById('novo-vendedor');
            if (dropdownVend && !dropdownVend.contains(e.target) && e.target !== inputVend && !e.target.closest('.btn-input-action')) {
                dropdownVend.style.display = 'none';
            }
        });
        
        // ========================================
        // DROPDOWN DE VENDEDORES
        // ========================================
        async function carregarVendedores() {
            try {
                const resp = await fetch('/api/vendas/vendedores', { credentials: 'include' });
                if (resp.ok) {
                    vendedoresLista = await resp.json();
                }
            } catch (err) {
                console.error('Erro ao carregar vendedores:', err);
            }
        }
        
        function toggleDropdownVendedores() {
            const dropdown = document.getElementById('dropdown-vendedores');
            
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                return;
            }
            
            // Renderizar lista
            if (vendedoresLista.length === 0) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">Carregando...</div>';
                carregarVendedores().then(() => renderDropdownVendedores());
            } else {
                renderDropdownVendedores();
            }
            
            dropdown.style.display = 'block';
        }
        
        function renderDropdownVendedores() {
            const dropdown = document.getElementById('dropdown-vendedores');
            const vendedorAtualId = document.getElementById('novo-vendedor-id').value;
            
            dropdown.innerHTML = vendedoresLista.map(v => `
                <div class="dropdown-item ${v.id == vendedorAtualId ? 'selected' : ''}" 
                     onclick="selecionarVendedorOrcamento(${v.id}, '${v.nome.replace(/'/g, "\\'")}')"
                     style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; ${v.id == vendedorAtualId ? 'background: #fff7ed;' : ''}"
                     onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${v.id == vendedorAtualId ? '#fff7ed' : '#fff'}'">
                    <i class="fas fa-user" style="color: #f97316; margin-right: 8px;"></i>
                    ${v.nome}
                </div>
            `).join('');
        }
        
        function selecionarVendedorOrcamento(id, nome) {
            document.getElementById('novo-vendedor').value = nome;
            document.getElementById('novo-vendedor-id').value = id;
            document.getElementById('dropdown-vendedores').style.display = 'none';
        }
        
        // ========================================
        // FUNÇÕES DO CENÁRIO FISCAL E IMPOSTOS
        // ========================================
        
        // Variável para armazenar os dados de impostos calculados
        let impostosCalculados = null;
        
        // Configurações de impostos do sistema (carregadas via API)
        let configImpostosSistema = null;
        
        // Funçéo para carregar configurações de impostos do sistema
        async function carregarConfigImpostosSistema() {
            try {
                const response = await fetch('/api/configuracoes/impostos', { credentials: 'include' });
                if (response.ok) {
                    configImpostosSistema = await response.json();
                    console.log('✅ Configurações de impostos carregadas:', configImpostosSistema);
                    
                    // Atualizar cenários fiscais com valores do sistema
                    if (configImpostosSistema) {
                        atualizarCenariosFiscaisComConfigSistema();
                        
                        // Mostrar badge de sincronizaçéo
                        const badge = document.getElementById('impostos-config-sistema-badge');
                        if (badge) {
                            badge.style.display = 'flex';
                        }
                    }
                    
                    return configImpostosSistema;
                }
            } catch (error) {
                console.error('Erro ao carregar config de impostos:', error);
            }
            return null;
        }
        
        // Atualiza os cenários fiscais com as alíquotas do sistema
        function atualizarCenariosFiscaisComConfigSistema() {
            if (!configImpostosSistema) return;
            
            const icms = parseFloat(configImpostosSistema.icms) || 18;
            const ipi = parseFloat(configImpostosSistema.ipi) || 5;
            const pis = parseFloat(configImpostosSistema.pis) || 1.65;
            const cofins = parseFloat(configImpostosSistema.cofins) || 7.6;
            const iss = parseFloat(configImpostosSistema.iss) || 5;
            
            // Atualizar cenários que usam alíquotas normais
            ['venda_normal', 'industrializacao', 'revenda'].forEach(key => {
                if (cenariosFiscais[key]) {
                    cenariosFiscais[key].icms_aliquota = icms;
                    cenariosFiscais[key].pis_aliquota = pis;
                    cenariosFiscais[key].cofins_aliquota = cofins;
                }
            });
            
            // Atualizar cenário de industrializaçéo com IPI
            if (cenariosFiscais.industrializacao) {
                cenariosFiscais.industrializacao.ipi_aliquota = ipi;
            }
            
            // Atualizar cenário de serviços com ISS
            if (cenariosFiscais.servicos) {
                cenariosFiscais.servicos.iss_aliquota = iss;
            }
            
            // Venda fora do estado usa ICMS interestadual (12% ou 7%)
            if (cenariosFiscais.venda_fora_estado) {
                cenariosFiscais.venda_fora_estado.pis_aliquota = pis;
                cenariosFiscais.venda_fora_estado.cofins_aliquota = cofins;
            }
            
            console.log('✅ Cenários fiscais atualizados com config do sistema');
        }
        
        // Cenários fiscais padréo (fallback)
        const cenariosFiscais = {
            venda_normal: {
                codigo: 'venda_normal',
                nome: 'Venda Normal (Dentro do Estado)',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            venda_fora_estado: {
                codigo: 'venda_fora_estado',
                nome: 'Venda Fora do Estado',
                icms_aliquota: 12.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            venda_zona_franca: {
                codigo: 'venda_zona_franca',
                nome: 'Venda Zona Franca',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '40',
                cst_ipi: '52',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            exportacao: {
                codigo: 'exportacao',
                nome: 'Exportaçéo',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 0,
                cofins_aliquota: 0,
                iss_aliquota: 0,
                cst_icms: '41',
                cst_ipi: '52',
                cst_pis: '08',
                cst_cofins: '08',
                calcula_icms_st: false,
                destaca_impostos: false
            },
            simples_nacional: {
                codigo: 'simples_nacional',
                nome: 'Simples Nacional',
                icms_aliquota: 0,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 0,
                cofins_aliquota: 0,
                iss_aliquota: 0,
                cst_icms: '102',
                cst_ipi: '53',
                cst_pis: '49',
                cst_cofins: '49',
                calcula_icms_st: false,
                destaca_impostos: false
            },
            industrializacao: {
                codigo: 'industrializacao',
                nome: 'Industrializaçéo (com IPI)',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 5.00,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '50',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            },
            revenda: {
                codigo: 'revenda',
                nome: 'Revenda de Mercadorias',
                icms_aliquota: 18.00,
                icms_reducao_base: 0,
                icms_st_aliquota: 0,
                icms_st_mva: 0,
                ipi_aliquota: 0,
                pis_aliquota: 1.65,
                cofins_aliquota: 7.60,
                iss_aliquota: 0,
                cst_icms: '00',
                cst_ipi: '53',
                cst_pis: '01',
                cst_cofins: '01',
                calcula_icms_st: false,
                destaca_impostos: true
            }
        };
        
        function aplicarCenarioFiscal() {
            const cenario = document.getElementById('novo-cenario-fiscal').value;
            
            if (!cenario) return;
            
            // Também atualizar o select na aba de impostos
            const selectImpostos = document.getElementById('impostos-cenario-fiscal');
            if (selectImpostos && selectImpostos.value !== cenario) {
                selectImpostos.value = cenario;
            }
            
            // Carregar configurações do cenário
            carregarCenarioFiscal();
            
            showToast(`Cenário fiscal aplicado: ${cenario.replace(/_/g, ' ')}`, 'info');
            calcularTotaisOrcamento();
        }
        
        // Carregar cenário fiscal e preencher campos de impostos
        async function carregarCenarioFiscal() {
            const cenarioCodigo = document.getElementById('impostos-cenario-fiscal')?.value || 
                                  document.getElementById('novo-cenario-fiscal')?.value;
            
            if (!cenarioCodigo) return;
            
            let cenario = cenariosFiscais[cenarioCodigo];
            
            // Tentar buscar do servidor
            try {
                const response = await fetch(`/api/vendas/impostos/cenarios/${cenarioCodigo}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cenario) {
                        cenario = data.cenario;
                    }
                }
            } catch (error) {
                console.log('Usando cenário fiscal local');
            }
            
            if (!cenario) return;
            
            // Preencher campos de ICMS
            const icmsCst = document.getElementById('impostos-icms-cst');
            const icmsAliquota = document.getElementById('impostos-icms-aliquota');
            const icmsReducao = document.getElementById('impostos-icms-reducao');
            
            if (icmsCst) icmsCst.value = cenario.cst_icms || '00';
            if (icmsAliquota) icmsAliquota.value = formatarNumero(cenario.icms_aliquota || 0);
            if (icmsReducao) icmsReducao.value = formatarNumero(cenario.icms_reducao_base || 0);
            
            // Preencher campos de ICMS ST
            const icmsStAliquota = document.getElementById('impostos-icms-st-aliquota');
            const icmsStMva = document.getElementById('impostos-icms-st-mva');
            const icmsStAtivo = document.getElementById('impostos-icms-st-ativo');
            
            if (icmsStAtivo) {
                icmsStAtivo.checked = cenario.calcula_icms_st || cenario.icms_st_aliquota > 0;
                toggleICMSST();
            }
            if (icmsStAliquota) icmsStAliquota.value = formatarNumero(cenario.icms_st_aliquota || 0);
            if (icmsStMva) icmsStMva.value = formatarNumero(cenario.icms_st_mva || 0);
            
            // Preencher campos de IPI
            const ipiCst = document.getElementById('impostos-ipi-cst');
            const ipiAliquota = document.getElementById('impostos-ipi-aliquota');
            const ipiAtivo = document.getElementById('impostos-ipi-ativo');
            
            if (ipiAtivo) {
                ipiAtivo.checked = cenario.ipi_aliquota > 0;
                toggleIPI();
            }
            if (ipiCst) ipiCst.value = cenario.cst_ipi || '50';
            if (ipiAliquota) ipiAliquota.value = formatarNumero(cenario.ipi_aliquota || 0);
            
            // Preencher campos de PIS
            const pisCst = document.getElementById('impostos-pis-cst');
            const pisAliquota = document.getElementById('impostos-pis-aliquota');
            
            if (pisCst) pisCst.value = cenario.cst_pis || '01';
            if (pisAliquota) pisAliquota.value = formatarNumero(cenario.pis_aliquota || 0);
            
            // Preencher campos de COFINS
            const cofinsCst = document.getElementById('impostos-cofins-cst');
            const cofinsAliquota = document.getElementById('impostos-cofins-aliquota');
            
            if (cofinsCst) cofinsCst.value = cenario.cst_cofins || '01';
            if (cofinsAliquota) cofinsAliquota.value = formatarNumero(cenario.cofins_aliquota || 0);
            
            // Preencher campos de ISS
            const issAliquota = document.getElementById('impostos-iss-aliquota');
            const issAtivo = document.getElementById('impostos-iss-ativo');
            
            if (issAtivo) {
                issAtivo.checked = cenario.iss_aliquota > 0;
                toggleISS();
            }
            if (issAliquota) issAliquota.value = formatarNumero(cenario.iss_aliquota || 0);
            
            // Destacar impostos
            const destacar = document.getElementById('impostos-destacar-nf');
            if (destacar) destacar.checked = cenario.destaca_impostos !== false;
            
            // Sincronizar com o select principal
            const selectPrincipal = document.getElementById('novo-cenario-fiscal');
            if (selectPrincipal && selectPrincipal.value !== cenarioCodigo) {
                selectPrincipal.value = cenarioCodigo;
            }
            
            // Calcular impostos automaticamente
            calcularImpostos();
        }
        
        // Toggle ICMS ST
        function toggleICMSST() {
            const ativo = document.getElementById('impostos-icms-st-ativo')?.checked || false;
            const aliquota = document.getElementById('impostos-icms-st-aliquota');
            const mva = document.getElementById('impostos-icms-st-mva');
            
            if (aliquota) aliquota.disabled = !ativo;
            if (mva) mva.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
                if (mva) mva.value = '0,00';
            }
        }
        
        // Toggle IPI
        function toggleIPI() {
            const ativo = document.getElementById('impostos-ipi-ativo')?.checked || false;
            const cst = document.getElementById('impostos-ipi-cst');
            const aliquota = document.getElementById('impostos-ipi-aliquota');
            
            if (cst) cst.disabled = !ativo;
            if (aliquota) aliquota.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
            }
        }
        
        // Toggle ISS
        function toggleISS() {
            const ativo = document.getElementById('impostos-iss-ativo')?.checked || false;
            const aliquota = document.getElementById('impostos-iss-aliquota');
            
            if (aliquota) aliquota.disabled = !ativo;
            
            if (!ativo) {
                if (aliquota) aliquota.value = '0,00';
            }
        }
        
        // Funçéo utilitária para formatar número
        function formatarNumero(valor, decimais = 2) {
            return parseFloat(valor || 0).toFixed(decimais).replace('.', ',');
        }
        
        // Funçéo utilitária para parsear número brasileiro
        function parsearNumero(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        // Calcular impostos
        async function calcularImpostos() {
            // Obter valores
            const valorProdutos = parsearNumero(document.getElementById('novo-total-mercadorias')?.value || '0');
            const valorDesconto = parsearNumero(document.getElementById('novo-desconto')?.value || '0');
            const valorFrete = parsearNumero(document.getElementById('novo-frete')?.value || '0');
            const valorSeguro = parsearNumero(document.getElementById('novo-seguro')?.value || '0');
            const outrasDespesas = parsearNumero(document.getElementById('novo-outras-despesas')?.value || '0');
            
            // Obter alíquotas dos campos
            const icmsAliquota = parsearNumero(document.getElementById('impostos-icms-aliquota')?.value || '0');
            const icmsReducao = parsearNumero(document.getElementById('impostos-icms-reducao')?.value || '0');
            const icmsStAliquota = parsearNumero(document.getElementById('impostos-icms-st-aliquota')?.value || '0');
            const icmsStMva = parsearNumero(document.getElementById('impostos-icms-st-mva')?.value || '0');
            const ipiAliquota = parsearNumero(document.getElementById('impostos-ipi-aliquota')?.value || '0');
            const pisAliquota = parsearNumero(document.getElementById('impostos-pis-aliquota')?.value || '0');
            const cofinsAliquota = parsearNumero(document.getElementById('impostos-cofins-aliquota')?.value || '0');
            const issAliquota = parsearNumero(document.getElementById('impostos-iss-aliquota')?.value || '0');
            
            const cenarioCodigo = document.getElementById('impostos-cenario-fiscal')?.value || 'venda_normal';
            
            // Calcular localmente para atualizaçéo imediata
            let baseICMS = valorProdutos - valorDesconto;
            if (icmsReducao > 0) {
                baseICMS = baseICMS * (1 - icmsReducao / 100);
            }
            
            const baseIPI = valorProdutos;
            const valorIPI = ipiAliquota > 0 ? baseIPI * (ipiAliquota / 100) : 0;
            const valorICMS = icmsAliquota > 0 ? baseICMS * (icmsAliquota / 100) : 0;
            
            let baseICMSST = 0;
            let valorICMSST = 0;
            if (icmsStAliquota > 0 && icmsStMva > 0) {
                baseICMSST = (valorProdutos + valorIPI) * (1 + icmsStMva / 100);
                valorICMSST = (baseICMSST * (icmsStAliquota / 100)) - valorICMS;
                if (valorICMSST < 0) valorICMSST = 0;
            }
            
            const basePISCOFINS = valorProdutos - valorDesconto + valorFrete + valorSeguro + outrasDespesas;
            const valorPIS = pisAliquota > 0 ? basePISCOFINS * (pisAliquota / 100) : 0;
            const valorCOFINS = cofinsAliquota > 0 ? basePISCOFINS * (cofinsAliquota / 100) : 0;
            
            const baseISS = valorProdutos - valorDesconto;
            const valorISS = issAliquota > 0 ? baseISS * (issAliquota / 100) : 0;
            
            const totalImpostos = valorICMS + valorICMSST + valorIPI + valorPIS + valorCOFINS + valorISS;
            const totalNF = valorProdutos + valorIPI + valorICMSST + valorFrete + valorSeguro + outrasDespesas - valorDesconto;
            
            // Armazenar resultados
            impostosCalculados = {
                cenario_codigo: cenarioCodigo,
                bases: {
                    icms: baseICMS,
                    icms_st: baseICMSST,
                    ipi: baseIPI,
                    pis: basePISCOFINS,
                    cofins: basePISCOFINS,
                    iss: baseISS
                },
                valores: {
                    icms: valorICMS,
                    icms_st: valorICMSST,
                    ipi: valorIPI,
                    pis: valorPIS,
                    cofins: valorCOFINS,
                    iss: valorISS
                },
                totais: {
                    produtos: valorProdutos,
                    desconto: valorDesconto,
                    frete: valorFrete,
                    seguro: valorSeguro,
                    outras_despesas: outrasDespesas,
                    impostos: totalImpostos,
                    nota_fiscal: totalNF
                }
            };
            
            // Atualizar campos na interface
            atualizarCamposImpostos();
            
            showToast('Impostos calculados com sucesso!', 'success');
        }
        
        // Atualizar quando alíquotas mudam
        function atualizarImpostos() {
            // Recalcular sem mostrar toast
            calcularImpostosSilencioso();
        }
        
        function calcularImpostosSilencioso() {
            // Mesma lógica do calcularImpostos, mas sem toast
            const valorProdutos = parsearNumero(document.getElementById('novo-total-mercadorias')?.value || '0');
            const valorDesconto = parsearNumero(document.getElementById('novo-desconto')?.value || '0');
            const valorFrete = parsearNumero(document.getElementById('novo-frete')?.value || '0');
            const valorSeguro = parsearNumero(document.getElementById('novo-seguro')?.value || '0');
            const outrasDespesas = parsearNumero(document.getElementById('novo-outras-despesas')?.value || '0');
            
            const icmsAliquota = parsearNumero(document.getElementById('impostos-icms-aliquota')?.value || '0');
            const icmsReducao = parsearNumero(document.getElementById('impostos-icms-reducao')?.value || '0');
            const icmsStAliquota = parsearNumero(document.getElementById('impostos-icms-st-aliquota')?.value || '0');
            const icmsStMva = parsearNumero(document.getElementById('impostos-icms-st-mva')?.value || '0');
            const ipiAliquota = parsearNumero(document.getElementById('impostos-ipi-aliquota')?.value || '0');
            const pisAliquota = parsearNumero(document.getElementById('impostos-pis-aliquota')?.value || '0');
            const cofinsAliquota = parsearNumero(document.getElementById('impostos-cofins-aliquota')?.value || '0');
            const issAliquota = parsearNumero(document.getElementById('impostos-iss-aliquota')?.value || '0');
            
            let baseICMS = valorProdutos - valorDesconto;
            if (icmsReducao > 0) {
                baseICMS = baseICMS * (1 - icmsReducao / 100);
            }
            
            const baseIPI = valorProdutos;
            const valorIPI = ipiAliquota > 0 ? baseIPI * (ipiAliquota / 100) : 0;
            const valorICMS = icmsAliquota > 0 ? baseICMS * (icmsAliquota / 100) : 0;
            
            let baseICMSST = 0;
            let valorICMSST = 0;
            if (icmsStAliquota > 0 && icmsStMva > 0) {
                baseICMSST = (valorProdutos + valorIPI) * (1 + icmsStMva / 100);
                valorICMSST = (baseICMSST * (icmsStAliquota / 100)) - valorICMS;
                if (valorICMSST < 0) valorICMSST = 0;
            }
            
            const basePISCOFINS = valorProdutos - valorDesconto + valorFrete + valorSeguro + outrasDespesas;
            const valorPIS = pisAliquota > 0 ? basePISCOFINS * (pisAliquota / 100) : 0;
            const valorCOFINS = cofinsAliquota > 0 ? basePISCOFINS * (cofinsAliquota / 100) : 0;
            
            const baseISS = valorProdutos - valorDesconto;
            const valorISS = issAliquota > 0 ? baseISS * (issAliquota / 100) : 0;
            
            const totalImpostos = valorICMS + valorICMSST + valorIPI + valorPIS + valorCOFINS + valorISS;
            const totalNF = valorProdutos + valorIPI + valorICMSST + valorFrete + valorSeguro + outrasDespesas - valorDesconto;
            
            impostosCalculados = {
                cenario_codigo: document.getElementById('impostos-cenario-fiscal')?.value || 'venda_normal',
                bases: { icms: baseICMS, icms_st: baseICMSST, ipi: baseIPI, pis: basePISCOFINS, cofins: basePISCOFINS, iss: baseISS },
                valores: { icms: valorICMS, icms_st: valorICMSST, ipi: valorIPI, pis: valorPIS, cofins: valorCOFINS, iss: valorISS },
                totais: { produtos: valorProdutos, desconto: valorDesconto, frete: valorFrete, seguro: valorSeguro, outras_despesas: outrasDespesas, impostos: totalImpostos, nota_fiscal: totalNF }
            };
            
            atualizarCamposImpostos();
        }
        
        // Atualizar campos visuais dos impostos
        function atualizarCamposImpostos() {
            if (!impostosCalculados) return;
            
            // ICMS
            const icmsBase = document.getElementById('impostos-icms-base');
            const icmsValor = document.getElementById('impostos-icms-valor');
            if (icmsBase) icmsBase.value = formatarNumero(impostosCalculados.bases.icms);
            if (icmsValor) icmsValor.value = formatarNumero(impostosCalculados.valores.icms);
            
            // ICMS ST
            const icmsStBase = document.getElementById('impostos-icms-st-base');
            const icmsStValor = document.getElementById('impostos-icms-st-valor');
            if (icmsStBase) icmsStBase.value = formatarNumero(impostosCalculados.bases.icms_st);
            if (icmsStValor) icmsStValor.value = formatarNumero(impostosCalculados.valores.icms_st);
            
            // IPI
            const ipiBase = document.getElementById('impostos-ipi-base');
            const ipiValor = document.getElementById('impostos-ipi-valor');
            if (ipiBase) ipiBase.value = formatarNumero(impostosCalculados.bases.ipi);
            if (ipiValor) ipiValor.value = formatarNumero(impostosCalculados.valores.ipi);
            
            // PIS
            const pisBase = document.getElementById('impostos-pis-base');
            const pisValor = document.getElementById('impostos-pis-valor');
            if (pisBase) pisBase.value = formatarNumero(impostosCalculados.bases.pis);
            if (pisValor) pisValor.value = formatarNumero(impostosCalculados.valores.pis);
            
            // COFINS
            const cofinsBase = document.getElementById('impostos-cofins-base');
            const cofinsValor = document.getElementById('impostos-cofins-valor');
            if (cofinsBase) cofinsBase.value = formatarNumero(impostosCalculados.bases.cofins);
            if (cofinsValor) cofinsValor.value = formatarNumero(impostosCalculados.valores.cofins);
            
            // ISS
            const issBase = document.getElementById('impostos-iss-base');
            const issValor = document.getElementById('impostos-iss-valor');
            if (issBase) issBase.value = formatarNumero(impostosCalculados.bases.iss);
            if (issValor) issValor.value = formatarNumero(impostosCalculados.valores.iss);
            
            // Resumo
            const totalProdutos = document.getElementById('impostos-total-produtos');
            const totalImpostos = document.getElementById('impostos-total-impostos');
            const totalFrete = document.getElementById('impostos-total-frete');
            const totalNf = document.getElementById('impostos-total-nf');
            
            if (totalProdutos) totalProdutos.textContent = `R$ ${formatarNumero(impostosCalculados.totais.produtos)}`;
            if (totalImpostos) totalImpostos.textContent = `R$ ${formatarNumero(impostosCalculados.totais.impostos)}`;
            if (totalFrete) totalFrete.textContent = `R$ ${formatarNumero(impostosCalculados.totais.frete + impostosCalculados.totais.outras_despesas)}`;
            if (totalNf) totalNf.textContent = `R$ ${formatarNumero(impostosCalculados.totais.nota_fiscal)}`;
            
            // Atualizar campos de totais no cabeçalho do modal
            const totalIpiHeader = document.getElementById('novo-total-ipi');
            const totalIcmsHeader = document.getElementById('novo-total-icms');
            
            if (totalIpiHeader) totalIpiHeader.value = formatarNumero(impostosCalculados.valores.ipi);
            if (totalIcmsHeader) totalIcmsHeader.value = formatarNumero(impostosCalculados.valores.icms_st);
        }
        
        // ========================================
        // FUNÇÕES DE PARCELAS
        // ========================================
        function sincronizarParcelasAba() {
            const parcelas = document.getElementById('novo-parcelas').value;
            const selectQtd = document.getElementById('novo-qtd-parcelas');
            
            const parcelasMap = {
                'a_vista': '1',
                '30': '1',
                '30_60': '2',
                '30_60_90': '3',
                'personalizado': '1'
            };
            
            if (selectQtd && parcelasMap[parcelas]) {
                selectQtd.value = parcelasMap[parcelas];
                gerarTabelaParcelas();
            }
        }
        
        function novoOrcamento() {
            // Usar o mesmo modal de Novo Pedido
            abrirModalNovoPedido();
        }
        
        function fecharModalNovoOrcamento() {
            if (temAlteracoesNaoSalvas()) {
                mostrarConfirmacaoAlteracoes(() => {
                    document.getElementById('modal-novo-orcamento').classList.remove('active');
                });
            } else {
                document.getElementById('modal-novo-orcamento').classList.remove('active');
            }
        }
        
        // Sistema de Abas do Orçamento
        function ativarAbaOrcamento(tabId) {
            // Desativar todas as abas
            document.querySelectorAll('.orcamento-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.orcamento-tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`.orcamento-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // Inicializar eventos das abas
        document.querySelectorAll('.orcamento-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                ativarAbaOrcamento(this.dataset.tab);
            });
        });
        
        // Renderizar tabela de itens
        function renderTabelaItens() {
            const tbody = document.getElementById('tbody-itens-orcamento');
            const emptyState = document.getElementById('empty-itens');
            const paginacao = document.querySelector('.paginacao-info');
            
            if (itensOrcamento.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
                paginacao.textContent = 'Nenhum registro encontrado';
            } else {
                emptyState.style.display = 'none';
                paginacao.textContent = `1 a ${itensOrcamento.length} de ${itensOrcamento.length} registros`;
                
                tbody.innerHTML = itensOrcamento.map((item, idx) => `
                    <tr data-index="${idx}" onclick="selecionarItemOrcamento(${idx})">
                        <td class="produto-code">${item.codigo}</td>
                        <td class="produto-desc">${item.descricao}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.qtdPendente || item.quantidade}</td>
                        <td>${item.localEstoque}</td>
                        <td>R$ ${item.precoUnitario.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>R$ ${(item.quantidade * item.precoUnitario).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                `).join('');
            }
            
            calcularTotaisOrcamento();
        }
        
        function selecionarItemOrcamento(idx) {
            document.querySelectorAll('.orcamento-tabela tbody tr').forEach(tr => tr.classList.remove('selected'));
            const row = document.querySelector(`.orcamento-tabela tbody tr[data-index="${idx}"]`);
            if (row) row.classList.add('selected');
        }
        
        // Calcular totais
        function calcularTotaisOrcamento() {
            const totalMercadorias = itensOrcamento.reduce((sum, item) => sum + (item.quantidade * item.precoUnitario), 0);
            const desconto = parseFloat(document.getElementById('novo-desconto').value.replace(',', '.')) || 0;
            const totalIpi = totalMercadorias * 0.05; // Exemplo: 5% de IPI
            const totalIcms = 0; // ICMS ST zerado por padréo
            const valorTotal = totalMercadorias - desconto + totalIpi + totalIcms;
            
            document.getElementById('novo-total-mercadorias').value = totalMercadorias.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-ipi').value = totalIpi.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-total-icms').value = totalIcms.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('novo-valor-total').value = valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }
        
        // Modal Adicionar Item
        function adicionarItemOrcamento() {
            document.getElementById('item-produto').value = '';
            document.getElementById('item-quantidade').value = 1;
            document.getElementById('item-preco').value = '';
            document.getElementById('item-estoque').value = 'principal';
            document.getElementById('modal-adicionar-item').classList.add('active');
        }
        
        function fecharModalAdicionarItem() {
            document.getElementById('modal-adicionar-item').classList.remove('active');
        }
        
        function confirmarAdicionarItem() {
            const produto = document.getElementById('item-produto').value.trim();
            const quantidade = parseInt(document.getElementById('item-quantidade').value) || 1;
            const preco = parseFloat(document.getElementById('item-preco').value.replace(',', '.')) || 0;
            const estoque = document.getElementById('item-estoque').value;
            
            if (!produto) {
                showNotification('Por favor, informe o produto.', 'warning');
                return;
            }
            if (preco <= 0) {
                showNotification('Por favor, informe um preço válido.', 'warning');
                return;
            }
            
            const estoqueLabels = {
                'principal': 'Estoque Principal',
                'secundario': 'Estoque Secundário',
                'expediçéo': 'Expediçéo'
            };
            
            // Gerar código de produto
            const codigo = 'PROD' + String(Math.floor(Math.random() * 9000) + 1000);
            
            itensOrcamento.push({
                codigo: codigo,
                descricao: produto,
                quantidade: quantidade,
                qtdPendente: quantidade,
                localEstoque: estoqueLabels[estoque] || estoque,
                precoUnitario: preco
            });
            
            renderTabelaItens();
            fecharModalAdicionarItem();
            showNotification('Item adicionado ao orçamento!', 'success');
        }
        
        // Evento desconto
        document.getElementById('novo-desconto').addEventListener('input', calcularTotaisOrcamento);
        
        // ========================================
        // FUNÇÕES ADICIONAIS DO MODAL ORÇAMENTO (ESTILO OMIE)
        // ========================================
        
        // Refazer parcelas
        function refazerParcelas() {
            const valorTotal = parseFloat(document.getElementById('novo-valor-total')?.value?.replace('.', '').replace(',', '.')) || 0;
            const tbody = document.getElementById('tbody-parcelas');
            const emptyState = document.getElementById('empty-parcelas');
            
            if (valorTotal <= 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('novo-valor-total-receber').value = '0,00';
                showNotification('Adicione itens ao pedido para gerar parcelas', 'warning');
                return;
            }
            
            emptyState.style.display = 'none';
            const dataVencimento = new Date();
            dataVencimento.setDate(dataVencimento.getDate() + 30);
            
            tbody.innerHTML = `
                <tr ondblclick="editarParcela(1)">
                    <td><span class="status-badge pendente" style="font-size: 11px; padding: 2px 8px;">Pendente</span></td>
                    <td>1/1</td>
                    <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: right;">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td style="text-align: right;">100,00%</td>
                    <td>-</td>
                    <td>-</td>
                    <td><input type="checkbox" disabled></td>
                </tr>
            `;
            
            document.getElementById('novo-valor-total-receber').value = valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            showNotification('Parcelas recalculadas!', 'success');
        }
        
        // Editar parcela (duplo clique)
        function editarParcela(numeroParcela) {
            const valorAtual = prompt(`Editar valor da parcela ${numeroParcela}:`, '0.00');
            if (valorAtual !== null && !isNaN(parseFloat(valorAtual))) {
                const linhas = document.querySelectorAll('#parcelas-tabela tbody tr');
                if (linhas[numeroParcela - 1]) {
                    const tdValor = linhas[numeroParcela - 1].querySelector('td:nth-child(4)');
                    if (tdValor) {
                        tdValor.textContent = 'R$ ' + parseFloat(valorAtual).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        showNotification(`Parcela ${numeroParcela} atualizada!`, 'success');
                    }
                }
            }
        }
        
        // Navegar para próximo orçamento
        function navegarProximoOrcamento() {
            // Encontrar próximo pedido na lista
            if (todosPedidos && todosPedidos.length > 0 && pedidoAtual) {
                const idxAtual = todosPedidos.findIndex(p => p.id === pedidoAtual.id);
                if (idxAtual >= 0 && idxAtual < todosPedidos.length - 1) {
                    const proximo = todosPedidos[idxAtual + 1];
                    abrirPedido(proximo.id);
                    showNotification(`Navegando para pedido #${proximo.numero || proximo.id}`, 'info');
                } else {
                    showNotification('Último registro da lista', 'info');
                }
            }
        }
        
        // Modais auxiliares do orçamento
        
        // === NFs RELACIONADAS ===
        let nfsRelacionadas = [];
        
        function abrirModalNFsRelacionadas() {
            document.getElementById('modal-nfs-relacionadas').classList.add('active');
        }
        
        function fecharModalNFsRelacionadas() {
            document.getElementById('modal-nfs-relacionadas').classList.remove('active');
        }
        
        function adicionarNFRelacionada() {
            const numero = document.getElementById('nf-relacionada-numero').value.trim();
            const serie = document.getElementById('nf-relacionada-serie').value.trim();
            const chave = document.getElementById('nf-relacionada-chave').value.trim();
            
            if (!numero || !chave) {
                showNotification('Preencha o número e a chave de acesso', 'error');
                return;
            }
            
            if (chave.length !== 44) {
                showNotification('A chave de acesso deve ter 44 dígitos', 'error');
                return;
            }
            
            nfsRelacionadas.push({ numero, serie, chave });
            renderizarNFsRelacionadas();
            
            document.getElementById('nf-relacionada-numero').value = '';
            document.getElementById('nf-relacionada-serie').value = '';
            document.getElementById('nf-relacionada-chave').value = '';
        }
        
        function renderizarNFsRelacionadas() {
            const lista = document.getElementById('nfs-relacionadas-lista');
            if (nfsRelacionadas.length === 0) {
                lista.innerHTML = `<tr><td colspan="4" style="padding: 30px; text-align: center; color: #999;"><i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i><p style="margin: 0;">Nenhuma NF relacionada</p></td></tr>`;
                return;
            }
            lista.innerHTML = nfsRelacionadas.map((nf, i) => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px;">${nf.numero}</td>
                    <td style="padding: 12px;">${nf.serie || '-'}</td>
                    <td style="padding: 12px; font-family: monospace; font-size: 11px;">${nf.chave}</td>
                    <td style="padding: 12px; text-align: center;"><button onclick="removerNFRelacionada(${i})" style="background: #fee2e2; color: #ef4444; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }
        
        function removerNFRelacionada(index) {
            nfsRelacionadas.splice(index, 1);
            renderizarNFsRelacionadas();
        }
        
        function salvarNFsRelacionadas() {
            showNotification(`${nfsRelacionadas.length} NF(s) relacionada(s) salva(s)`, 'success');
            fecharModalNFsRelacionadas();
        }
        
        // === INFO FISCO ===
        let infoFisco = '';
        
        function abrirModalInfoFisco() {
            document.getElementById('modal-info-fisco').classList.add('active');
            document.getElementById('info-fisco-texto').value = infoFisco;
        }
        
        function fecharModalInfoFisco() {
            document.getElementById('modal-info-fisco').classList.remove('active');
        }
        
        function salvarInfoFisco() {
            infoFisco = document.getElementById('info-fisco-texto').value;
            showNotification('Informações do fisco salvas', 'success');
            fecharModalInfoFisco();
        }
        
        // === CAMPOS OBS NF-e ===
        let camposObsNFe = [];
        
        function abrirModalCamposObsNFe() {
            document.getElementById('modal-campos-obs-nfe').classList.add('active');
            renderizarCamposObs();
        }
        
        function fecharModalCamposObsNFe() {
            document.getElementById('modal-campos-obs-nfe').classList.remove('active');
        }
        
        function adicionarCampoObs() {
            const campo = document.getElementById('obs-campo').value.trim();
            const valor = document.getElementById('obs-valor').value.trim();
            
            if (!campo || !valor) {
                showNotification('Preencha o nome do campo e o valor', 'error');
                return;
            }
            
            camposObsNFe.push({ campo, valor });
            renderizarCamposObs();
            
            document.getElementById('obs-campo').value = '';
            document.getElementById('obs-valor').value = '';
        }
        
        function renderizarCamposObs() {
            const lista = document.getElementById('campos-obs-lista');
            if (camposObsNFe.length === 0) {
                lista.innerHTML = `<div style="padding: 20px; text-align: center; color: #999; background: #f8fafc; border-radius: 8px;"><i class="fas fa-list" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i><p style="margin: 0; font-size: 13px;">Nenhum campo adicional</p></div>`;
                return;
            }
            lista.innerHTML = camposObsNFe.map((obs, i) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 8px;">
                    <strong style="min-width: 120px; color: #475569;">${obs.campo}:</strong>
                    <span style="flex: 1; color: #666;">${obs.valor}</span>
                    <button onclick="removerCampoObs(${i})" style="background: #fee2e2; color: #ef4444; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }
        
        function removerCampoObs(index) {
            camposObsNFe.splice(index, 1);
            renderizarCamposObs();
        }
        
        function salvarCamposObsNFe() {
            showNotification(`${camposObsNFe.length} campo(s) adicional(is) salvo(s)`, 'success');
            fecharModalCamposObsNFe();
        }
        
        // === ENDEREÇO DE ENTREGA ===
        let enderecoEntrega = {};
        
        function abrirModalEnderecoEntrega() {
            document.getElementById('modal-endereco-entrega').classList.add('active');
        }
        
        function fecharModalEnderecoEntrega() {
            document.getElementById('modal-endereco-entrega').classList.remove('active');
        }
        
        function toggleEnderecoEntrega() {
            const usarMesmo = document.getElementById('usar-endereco-cliente').checked;
            document.getElementById('form-endereco-entrega').style.display = usarMesmo ? 'none' : 'block';
        }
        
        async function buscarCepEntrega() {
            const cep = document.getElementById('entrega-cep').value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('entrega-logradouro').value = data.logradouro || '';
                    document.getElementById('entrega-bairro').value = data.bairro || '';
                    document.getElementById('entrega-cidade').value = data.localidade || '';
                    document.getElementById('entrega-uf').value = data.uf || '';
                }
            } catch (e) {
                console.error('Erro ao buscar CEP:', e);
            }
        }
        
        function salvarEnderecoEntrega() {
            const usarMesmo = document.getElementById('usar-endereco-cliente').checked;
            if (!usarMesmo) {
                enderecoEntrega = {
                    cep: document.getElementById('entrega-cep').value,
                    logradouro: document.getElementById('entrega-logradouro').value,
                    numero: document.getElementById('entrega-numero').value,
                    complemento: document.getElementById('entrega-complemento').value,
                    bairro: document.getElementById('entrega-bairro').value,
                    cidade: document.getElementById('entrega-cidade').value,
                    uf: document.getElementById('entrega-uf').value
                };
            }
            showNotification('Endereço de entrega salvo', 'success');
            fecharModalEnderecoEntrega();
        }
        
        // === ICMS TRANSPORTE ===
        let icmsTransporte = {};
        
        function abrirModalICMSTransporte() {
            document.getElementById('modal-icms-transporte').classList.add('active');
        }
        
        function fecharModalICMSTransporte() {
            document.getElementById('modal-icms-transporte').classList.remove('active');
        }
        
        function salvarICMSTransporte() {
            icmsTransporte = {
                valorServico: document.getElementById('icms-valor-servico').value,
                baseCalculo: document.getElementById('icms-base-calculo').value,
                aliquota: document.getElementById('icms-aliquota').value,
                valorRetido: document.getElementById('icms-valor-retido').value,
                cfop: document.getElementById('icms-cfop').value,
                codMunicipio: document.getElementById('icms-cod-municipio').value
            };
            showNotification('ICMS Transporte salvo', 'success');
            fecharModalICMSTransporte();
        }
        
        // === AGROPECUÁRIA (placeholder) ===
        function abrirModalAgropecuaria() {
            showNotification('Modal de dados agropecuários disponível em breve', 'info');
        }
        
        // Verificar conta corrente para aba email
        function verificarContaCorrenteEmail() {
            const contaCorrente = document.getElementById('novo-conta-corrente')?.value;
            const aviso = document.getElementById('aviso-conta-corrente');
            
            if (aviso) {
                aviso.style.display = contaCorrente ? 'none' : 'block';
            }
        }
        
        // Event listener para conta corrente
        document.getElementById('novo-conta-corrente')?.addEventListener('change', verificarContaCorrenteEmail);
        
        // Abrir WhatsApp com dados do orçamento
        function abrirWhatsAppOrcamento() {
            const cliente = document.getElementById('novo-cliente')?.value || '';
            const valorTotal = document.getElementById('novo-valor-total')?.value || '0,00';
            
            const mensagem = encodeURIComponent(`OlÉ! Segue informações do orçamento:Cliente: ${cliente}Valor Total: R$ ${valorTotal}Agradecemos a preferência!`);
            window.open(`https://wa.me/?text=${mensagem}`, '_blank');
        }
        
        // Mostrar barra de informaçéo do orçamento
        function mostrarInfoBarOrcamento(texto) {
            const bar = document.getElementById('orcamento-info-bar');
            const text = document.getElementById('orcamento-info-text');
            if (bar && text) {
                text.textContent = texto;
                bar.style.display = 'block';
            }
        }
        
        // Ocultar barra de informaçéo
        function ocultarInfoBarOrcamento() {
            const bar = document.getElementById('orcamento-info-bar');
            if (bar) {
                bar.style.display = 'none';
            }
        }
        
        // Salvar Orçamento
        async function salvarNovoOrcamento() {
            const cliente = document.getElementById('novo-cliente').value.trim();
            const clienteId = document.getElementById('novo-cliente-id').value;
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            const parcelas = document.getElementById('novo-parcelas').value;
            const vendedorId = document.getElementById('novo-vendedor-id').value;
            const vendedorNome = document.getElementById('novo-vendedor').value.trim();
            const transportadora = document.getElementById('novo-transportadora')?.value?.trim() || '';
            const observacoes = document.getElementById('novo-observacoes').value.trim();
            const cenarioFiscal = document.getElementById('novo-cenario-fiscal').value || document.getElementById('impostos-cenario-fiscal')?.value;
            const previsaoFaturamento = document.getElementById('novo-previsao-faturamento').value;
            const frete = parseFloat(document.getElementById('novo-frete')?.value?.replace(',', '.')) || 0;
            const departamento = document.getElementById('novo-departamento')?.value || '';
            
            // Validaçéo
            if (!cliente) {
                showNotification('Por favor, informe o nome do cliente.', 'warning');
                document.getElementById('novo-cliente').focus();
                return;
            }
            if (!vendedorId) {
                showNotification('Por favor, selecione um vendedor.', 'warning');
                return;
            }
            if (itensOrcamento.length === 0) {
                showNotification('Adicione pelo menos um item ao orçamento.', 'warning');
                ativarAbaOrcamento('itens');
                return;
            }
            
            // Mapear parcelas
            const parcelasMap = {
                'a_vista': 'À Vista',
                '30': '30 dias',
                '30_60': '30/60 dias',
                '30_60_90': '30/60/90 dias',
                'personalizado': 'Personalizado'
            };
            
            // Calcular impostos se néo foram calculados ainda
            if (!impostosCalculados) {
                calcularImpostosSilencioso();
            }
            
            try {
                // Salvar no backend via API
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vendas/pedidos', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        empresa_id: clienteId || null,
                        cliente_nome: cliente.toUpperCase(),
                        vendedor_id: vendedorId,
                        valor: valorTotal,
                        status: 'orcamento',
                        condicao_pagamento: parcelasMap[parcelas] || parcelas,
                        cenario_fiscal: cenarioFiscal,
                        previsao_faturamento: previsaoFaturamento,
                        frete: frete,
                        departamento: departamento,
                        observacoes: observacoes,
                        total_impostos: impostosCalculados?.totais?.impostos || 0,
                        itens: itensOrcamento.map(item => ({
                            codigo: item.codigo,
                            descricao: item.descricao,
                            quantidade: item.quantidade,
                            preco_unitario: item.precoUnitario,
                            unidade: item.unidade || 'UN',
                            local_estoque: item.localEstoque || 'PADRéO'
                        }))
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao salvar orçamento');
                }
                
                const novoOrc = await response.json();
                
                // Salvar impostos do pedido se houver dados calculados
                if (impostosCalculados && novoOrc.id) {
                    try {
                        await fetch(`/api/vendas/pedidos/${novoOrc.id}/impostos`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify({
                                impostos: impostosCalculados,
                                cenario_codigo: cenarioFiscal
                            })
                        });
                    } catch (impError) {
                        console.log('Impostos salvos localmente, tabela néo disponível:', impError.message);
                    }
                }
                
                // Adicionar na coluna de orçamento para visualizaçéo imediata
                const pedidoLocal = {
                    id: novoOrc.id || novoOrc.insertId,
                    cliente: cliente.toUpperCase(),
                    status: 'Aguardando aprovaçéo',
                    valor: valorTotal,
                    parcelas: parcelasMap[parcelas] || parcelas,
                    origem: 'Sistema',
                    vendedor: vendedorNome,
                    vendedor_id: vendedorId,
                    transportadora: transportadora || null,
                    mensagem: observacoes || null,
                    itens: [...itensOrcamento],
                    impostos: impostosCalculados
                };
                
                dadosVendas.orcamento.unshift(pedidoLocal);
                
                // Re-renderizar kanban
                renderKanban();
                
                // Fechar modal e notificar
                document.getElementById('modal-novo-orcamento').classList.remove('active');
                
                // Limpar dados de impostos calculados
                impostosCalculados = null;
                
                showNotification(`Orçamento Nº ${pedidoLocal.id} criado com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao salvar orçamento:', error);
                showNotification(error.message || 'Erro ao salvar orçamento. Tente novamente.', 'error');
            }
        }
        
        // Eventos do modal novo orçamento
        document.getElementById('modal-novo-orcamento').addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoOrcamento();
        });
        
        // Eventos do modal adicionar item
        document.getElementById('modal-adicionar-item').addEventListener('click', function(e) {
            if (e.target === this) fecharModalAdicionarItem();
        });

        // ========================================
        // FUNÇÕES DA ABA PARCELAS
        // ========================================
        function atualizarParcelas() {
            const forma = document.getElementById('novo-forma-pagamento').value;
            const selectParcelas = document.getElementById('novo-qtd-parcelas');
            
            // Se for à vista (dinheiro, PIX, débito), limitar a 1 parcela
            if (['dinheiro', 'pix', 'cartao_debito'].includes(forma)) {
                selectParcelas.value = '1';
                selectParcelas.disabled = true;
            } else {
                selectParcelas.disabled = false;
            }
            
            gerarTabelaParcelas();
        }
        
        function gerarTabelaParcelas() {
            const qtdParcelas = parseInt(document.getElementById('novo-qtd-parcelas').value) || 1;
            const forma = document.getElementById('novo-forma-pagamento').value;
            const intervalo = parseInt(document.getElementById('novo-intervalo-parcelas').value) || 30;
            const primeiroVencimento = document.getElementById('novo-primeiro-vencimento').value;
            const valorTotal = parseFloat(document.getElementById('novo-valor-total').value.replace('.', '').replace(',', '.')) || 0;
            
            const tbody = document.getElementById('tbody-parcelas');
            const valorParcela = valorTotal / qtdParcelas;
            
            const formaLabels = {
                'dinheiro': 'Dinheiro',
                'pix': 'PIX',
                'cartao_credito': 'Cartéo Crédito',
                'cartao_debito': 'Cartéo débito',
                'boleto': 'Boleto',
                'transferencia': 'Transferência',
                'cheque': 'Cheque',
                'crediario': 'Crediário'
            };
            
            let html = '';
            let dataBase = primeiroVencimento ? new Date(primeiroVencimento + 'T00:00:00') : new Date();
            
            for (let i = 1; i <= qtdParcelas; i++) {
                const dataVencimento = new Date(dataBase);
                dataVencimento.setDate(dataBase.getDate() + (intervalo * (i - 1)));
                
                const dataFormatada = dataVencimento.toLocaleDateString('pt-BR');
                
                html += `
                    <tr>
                        <td>${i}/${qtdParcelas}</td>
                        <td>${dataFormatada}</td>
                        <td>R$ ${valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                        <td>${formaLabels[forma] || '-'}</td>
                        <td><span class="status-badge pendente">Pendente</span></td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: #999;">Nenhuma parcela</td></tr>';
        }
        
        // Inicializar data do primeiro vencimento
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30); // 30 dias a partir de hoje
            const primeiroVenc = document.getElementById('novo-primeiro-vencimento');
            if (primeiroVenc) {
                primeiroVenc.value = hoje.toISOString().split('T')[0];
            }
        });
        
        // Eventos para atualizar parcelas
        document.getElementById('novo-primeiro-vencimento')?.addEventListener('change', gerarTabelaParcelas);
        document.getElementById('novo-intervalo-parcelas')?.addEventListener('change', gerarTabelaParcelas);
        
        // ========================================
        // FUNÇÕES DA ABA E-MAIL
        // ========================================
        function enviarEmailOrcamento() {
            const email = document.getElementById('novo-email-cliente').value.trim();
            const assunto = document.getElementById('novo-email-assunto').value.trim();
            const mensagem = document.getElementById('novo-email-mensagem').value.trim();
            
            if (!email) {
                showNotification('Por favor, informe o e-mail do destinatário.', 'warning');
                return;
            }
            
            if (!assunto) {
                showNotification('Por favor, informe o assunto do e-mail.', 'warning');
                return;
            }
            
            // Simular envio
            showNotification('E-mail enviado com sucesso para ' + email, 'success');
            
            // TODO: Integrar com API de envio de e-mail
        }
        
        function visualizarEmailOrcamento() {
            const assunto = document.getElementById('novo-email-assunto').value.trim() || 'Orçamento';
            const mensagem = document.getElementById('novo-email-mensagem').value.trim() || 'Sem mensagem personalizada.';
            
            // Abrir preview simples
            const previewContent = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h3 style="color: #333; border-bottom: 2px solid #f97316; padding-bottom: 10px;">${assunto}</h3>
                    <div style="white-space: pre-wrap; color: #555; line-height: 1.6;">${mensagem}</div>
                    <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #888;">
                            <i class="fas fa-paperclip"></i> Anexo: Orçamento.pdf
                        </p>
                    </div>
                </div>
            `;
            
            showNotification('Visualizaçéo de e-mail aberta!', 'info');
        }

        // ========================================
        // AÇÕES - FATURAR TODOS
        // ========================================
        function faturarTodos() {
            const cards = document.getElementById('col-faturar').querySelectorAll('.kanban-card');
            const count = cards.length;
            
            if (count === 0) {
                showNotification('Néo há pedidos para faturar', 'warning');
                return;
            }
            
            // Atualizar info do modal
            document.getElementById('faturar-info').textContent = 
                `Você está prestes a faturar ${count} pedido${count > 1 ? 's' : ''}.`;
            
            // Calcular total
            let total = 0;
            dadosVendas.faturar.forEach(p => total += p.valor);
            document.getElementById('faturar-total').textContent = `Total: R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Listar pedidos com design premium
            let listaHTML = '';
            dadosVendas.faturar.forEach((p, index) => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: ${index % 2 === 0 ? '#ffffff' : '#f9fafb'}; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-file-alt" style="font-size: 14px; color: #2563eb;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 14px;">Nº ${p.id}</div>
                                <div style="font-size: 12px; color: #6b7280;">${p.cliente.substring(0, 28)}${p.cliente.length > 28 ? '...' : ''}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #059669; font-size: 14px;">R$ ${p.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('faturar-lista').innerHTML = listaHTML || '<p style="text-align: center; color: #999; padding: 20px;">Nenhum pedido</p>';
            
            // Abrir modal
            document.getElementById('modal-faturar-todos').classList.add('active');
        }
        
        function fecharModalFaturar() {
            document.getElementById('modal-faturar-todos').classList.remove('active');
        }
        
        function confirmarFaturarTodos() {
            const pedidosParaFaturar = [...dadosVendas.faturar];
            const count = pedidosParaFaturar.length;
            
            if (count === 0) {
                fecharModalFaturar();
                return;
            }
            
            // Mover pedidos para coluna "faturado"
            pedidosParaFaturar.forEach(pedido => {
                // Gerar número de NF fictício
                const nfNumero = String(Math.floor(Math.random() * 900000) + 100000).padStart(8, '0');
                pedido.status = 'Faturado';
                pedido.nf = nfNumero;
                
                // Adicionar na coluna faturado
                dadosVendas.faturado.unshift(pedido);
            });
            
            // Limpar coluna faturar
            dadosVendas.faturar = [];
            
            // Re-renderizar kanban
            renderKanban();
            
            // Fechar modal e notificar
            fecharModalFaturar();
            showNotification(`${count} pedido${count > 1 ? 's' : ''} faturado${count > 1 ? 's' : ''} com sucesso!`, 'success');
            
            // TODO: Salvar no backend via API
            // faturarPedidosAPI(pedidosParaFaturar);
        }
        
        // Eventos do modal faturar
        document.getElementById('modal-faturar-todos').addEventListener('click', function(e) {
            if (e.target === this) fecharModalFaturar();
        });

        // ========================================
        // AÇÕES - PEDIDO PARCIAL
        // ========================================
        let pedidoParcialAtual = null;
        let itensPedidoParcial = [];

        function abrirModalPedidoParcial(pedidoId) {
            // Encontrar o pedido
            const pedido = [...dadosVendas.negociacao, ...dadosVendas.analise, ...dadosVendas.aprovado, ...dadosVendas.faturar, ...dadosVendas.faturado, ...dadosVendas.recibo].find(p => p.id === pedidoId);
            
            if (!pedido) {
                showNotification('Pedido néo encontrado', 'error');
                return;
            }
            
            pedidoParcialAtual = pedido;
            
            // Gerar itens fictícios baseado no pedido (em produçéo viria da API)
            itensPedidoParcial = pedido.itens || [
                { codigo: 'ITEM001', descricao: `${pedido.cliente} - Produto 1`, qtdOriginal: 5, qtdDisponivel: 5 },
                { codigo: 'ITEM002', descricao: `${pedido.cliente} - Produto 2`, qtdOriginal: 3, qtdDisponivel: 3 }
            ];
            
            // Renderizar lista de itens
            const lista = document.getElementById('pedido-parcial-lista');
            lista.innerHTML = itensPedidoParcial.map((item, idx) => `
                <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="item-parcial-${idx}" checked 
                            style="width: 20px; height: 20px; accent-color: #f97316; cursor: pointer;"
                            onchange="toggleItemParcial(${idx})">
                    </label>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${item.codigo} - ${item.descricao}</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Qtd Original: ${item.qtdOriginal} | Disponível: ${item.qtdDisponivel}</div>
                    </div>
                    <input type="number" id="qtd-parcial-${idx}" value="${item.qtdDisponivel}" min="1" max="${item.qtdDisponivel}"
                        style="width: 70px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; text-align: center; font-weight: 600;">
                </div>
            `).join('');
            
            // Abrir modal
            document.getElementById('modal-pedido-parcial').classList.add('active');
        }

        function toggleItemParcial(idx) {
            const checkbox = document.getElementById(`item-parcial-${idx}`);
            const qtdInput = document.getElementById(`qtd-parcial-${idx}`);
            qtdInput.disabled = !checkbox.checked;
            qtdInput.style.opacity = checkbox.checked ? '1' : '0.5';
        }

        function fecharModalPedidoParcial() {
            document.getElementById('modal-pedido-parcial').classList.remove('active');
            pedidoParcialAtual = null;
            itensPedidoParcial = [];
        }

        async function confirmarPedidoParcial() {
            if (!pedidoParcialAtual) {
                showNotification('Nenhum pedido selecionado', 'error');
                return;
            }
            
            // Coletar itens selecionados
            const itensSelecionados = [];
            itensPedidoParcial.forEach((item, idx) => {
                const checkbox = document.getElementById(`item-parcial-${idx}`);
                const qtdInput = document.getElementById(`qtd-parcial-${idx}`);
                
                if (checkbox && checkbox.checked) {
                    itensSelecionados.push({
                        ...item,
                        qtdFaturar: parseInt(qtdInput.value) || 0
                    });
                }
            });
            
            if (itensSelecionados.length === 0) {
                showNotification('Selecione pelo menos um item', 'warning');
                return;
            }
            
            try {
                // Simular criaçéo do pedido parcial (em produçéo usar API)
                const novoPedido = {
                    id: Math.floor(Math.random() * 9000) + 1000,
                    cliente: pedidoParcialAtual.cliente,
                    status: 'Orçamento',
                    valor: itensSelecionados.reduce((sum, item) => sum + (item.qtdFaturar * 100), 0),
                    itens: itensSelecionados,
                    pedidoOriginal: pedidoParcialAtual.id
                };
                
                // Adicionar à coluna de orçamento
                dadosVendas.negociacao.unshift(novoPedido);
                
                // Re-renderizar kanban
                renderKanban();
                
                fecharModalPedidoParcial();
                showNotification(`Pedido parcial #${novoPedido.id} criado com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao criar pedido parcial:', error);
                showNotification('Erro ao criar pedido parcial', 'error');
            }
        }

        // Eventos do modal pedido parcial
        document.getElementById('modal-pedido-parcial').addEventListener('click', function(e) {
            if (e.target === this) fecharModalPedidoParcial();
        });

        // ========================================
        // AÇÕES - COMUNICAR SEFAZ
        // ========================================
        function comunicarSefaz() {
            const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
            const count = notasFaturadas.length;
            
            if (count === 0) {
                showNotification('Néo há notas fiscais para transmitir', 'warning');
                return;
            }
            
            // Reset do modal
            document.getElementById('sefaz-loading').style.display = 'none';
            document.getElementById('sefaz-inicial').style.display = 'block';
            document.getElementById('sefaz-resultado').style.display = 'none';
            document.getElementById('btn-transmitir-sefaz').style.display = 'inline-flex';
            
            // Atualizar info
            document.getElementById('sefaz-info').textContent = 
                `${count} nota${count > 1 ? 's' : ''} fiscal${count > 1 ? 'is' : ''} pronta${count > 1 ? 's' : ''} para transmisséo.`;
            
            // Listar notas
            let listaHTML = '';
            notasFaturadas.forEach(p => {
                listaHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0; transition: all 0.2s;">
                        <span style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #334155;">
                            <i class="fas fa-file-invoice" style="color: #0ea5e9; font-size: 16px;"></i> NF ${p.nf}
                        </span>
                        <span style="color: #64748b; font-size: 13px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.cliente}</span>
                    </div>
                `;
            });
            document.getElementById('sefaz-lista').innerHTML = listaHTML;
            
            // Abrir modal
            document.getElementById('modal-sefaz').classList.add('active');
        }
        
        function fecharModalSefaz() {
            document.getElementById('modal-sefaz').classList.remove('active');
        }
        
        async function transmitirSefaz() {
            // Esconder tela inicial, mostrar loading
            document.getElementById('sefaz-inicial').style.display = 'none';
            document.getElementById('sefaz-loading').style.display = 'block';
            document.getElementById('btn-transmitir-sefaz').style.display = 'none';
            
            const notasFaturadas = dadosVendas.faturado.filter(p => p.nf);
            const count = notasFaturadas.length;
            
            if (count === 0) {
                document.getElementById('sefaz-loading').style.display = 'none';
                document.getElementById('sefaz-inicial').style.display = 'block';
                document.getElementById('btn-transmitir-sefaz').style.display = 'inline-flex';
                showNotification('Néo há notas fiscais para transmitir', 'warning');
                return;
            }
            
            let transmitidas = 0;
            let erros = [];
            
            // Tentar transmitir cada NFe para SEFAZ
            for (const pedido of notasFaturadas) {
                try {
                    // Verificar se tem nfe_id (ID da NFe no banco)
                    if (pedido.nfe_id) {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/api/nfe/${pedido.nfe_id}/transmitir`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.sucesso || result.cStat === '100') {
                                pedido.protocolo = result.nProt || result.protocolo || 'SEFAZ-' + Date.now();
                                pedido.mensagem = result.xMotivo || 'NF-e autorizada pela SEFAZ';
                                transmitidas++;
                            } else {
                                erros.push(`NF ${pedido.nf}: ${result.xMotivo || result.mensagem || 'Erro desconhecido'}`);
                            }
                        } else {
                            const errorData = await response.json().catch(() => ({}));
                            erros.push(`NF ${pedido.nf}: ${errorData.mensagem || 'Erro na comunicaçéo'}`);
                        }
                    } else {
                        // Se néo tem nfe_id, simular (modo demo)
                        pedido.protocolo = 'DEMO-' + Date.now() + '-' + pedido.id;
                        pedido.mensagem = 'NF-e autorizada (modo demonstraçéo)';
                        transmitidas++;
                    }
                } catch (error) {
                    console.error(`Erro ao transmitir NF ${pedido.nf}:`, error);
                    erros.push(`NF ${pedido.nf}: ${error.message}`);
                }
            }
            
            // Esconder loading, mostrar resultado
            document.getElementById('sefaz-loading').style.display = 'none';
            document.getElementById('sefaz-resultado').style.display = 'block';
            
            if (erros.length === 0) {
                document.getElementById('sefaz-resultado').querySelector('i').className = 'fas fa-check';
                document.getElementById('sefaz-resultado').querySelector('i').style.color = '#22c55e';
                document.getElementById('sefaz-resultado').querySelector('div').style.background = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
                document.getElementById('sefaz-resultado-info').textContent = 
                    `${transmitidas} nota${transmitidas > 1 ? 's' : ''} fiscal${transmitidas > 1 ? 'is' : ''} transmitida${transmitidas > 1 ? 's' : ''} com sucesso para a SEFAZ!`;
                showNotification(`Transmisséo SEFAZ concluída! ${transmitidas} NF-e${transmitidas > 1 ? 's' : ''} autorizadas.`, 'success');
            } else {
                document.getElementById('sefaz-resultado').querySelector('i').className = 'fas fa-exclamation-triangle';
                document.getElementById('sefaz-resultado').querySelector('i').style.color = '#f59e0b';
                document.getElementById('sefaz-resultado').querySelector('div').style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                document.getElementById('sefaz-resultado-info').innerHTML = 
                    `${transmitidas} transmitida${transmitidas > 1 ? 's' : ''}, ${erros.length} com erro:<br><small style="color: #dc2626;">${erros.join('<br>')}</small>`;
                showNotification(`Transmisséo parcial: ${transmitidas} OK, ${erros.length} erro(s)`, 'warning');
            }
            
            // Re-renderizar para atualizar visual
            renderKanban();
        }
        
        // Eventos do modal SEFAZ
        document.getElementById('modal-sefaz').addEventListener('click', function(e) {
            if (e.target === this) fecharModalSefaz();
        });

        function toggleChat() {
            showNotification('Assistente Bob será aberto em breve!', 'info');
        }

        // ========================================
        // PESQUISA
        // ========================================
        document.getElementById('search-input').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase().trim();
            const cards = document.querySelectorAll('.kanban-card');
            
            cards.forEach(card => {
                const titulo = card.querySelector('.card-title')?.textContent?.toLowerCase() || '';
                const numero = card.querySelector('.card-number')?.textContent?.toLowerCase() || '';
                // Buscar dados adicionais do card (data attributes)
                const cardId = card.dataset.id;
                const pedidoData = encontrarPedidoPorId(cardId);
                
                let match = titulo.includes(termo) || numero.includes(termo);
                
                // Se tem dados do pedido, buscar também por razéo social, nome fantasia e CNPJ
                if (pedidoData) {
                    const razaoSocial = (pedidoData.razao_social || '').toLowerCase();
                    const nomeFantasia = (pedidoData.nome_fantasia || '').toLowerCase();
                    const cnpj = (pedidoData.cnpj || pedidoData.cpf_cnpj || '').toLowerCase().replace(/[^0-9]/g, '');
                    const termoLimpo = termo.replace(/[^0-9]/g, '');
                    
                    if (razaoSocial.includes(termo) || nomeFantasia.includes(termo)) {
                        match = true;
                    }
                    // Buscar por CNPJ (apenas dígitos)
                    if (termoLimpo.length >= 3 && cnpj.includes(termoLimpo)) {
                        match = true;
                    }
                }
                
                card.style.display = match ? 'block' : 'none';
            });
        });
        
        // Funçéo auxiliar para encontrar pedido por ID
        function encontrarPedidoPorId(id) {
            if (!id) return null;
            const idNum = parseInt(id);
            for (const coluna of Object.values(dadosVendas)) {
                if (Array.isArray(coluna)) {
                    const found = coluna.find(p => p.id === idNum || p.id === id);
                    if (found) return found;
                }
            }
            return null;
        }

        // ========================================
        // NOTIFICAÇÕES
        // ========================================
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#3b82f6',
                success: '#22c55e',
                warning: '#f59e0b',
                error: '#ef4444'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Adicionar keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ========================================
        // CARREGAR DADOS DO USUÁRIO LOGADO
        // ========================================
        // Mapeamento de avatares por nome de usuário
        const avatarNameMap = {
            'clemerson': '/avatars/Clemerson.webp',
            'isabela': '/avatars/Isabela.webp',
            'thaina': '/avatars/Thaina.webp',
            'thiago': '/avatars/Thiago.webp',
            'nicolas': '/avatars/NicolasDaniel.webp',
            'nicolasdaniel': '/avatars/NicolasDaniel.webp',
            'rh': '/avatars/Rh.webp',
            'admin': '/avatars/admin.webp',
            'ti': '/avatars/TI.webp',
            'tialuforce': '/avatars/TI.webp',
            'antonio': '/avatars/Antonio.webp',
            'andreia': '/avatars/Andreia.webp',
            'guilherme': '/avatars/Guilherme.webp'
        };

        function getAvatarFromEmail(email, nome) {
            if (!email) return null;
            const username = email.split('@')[0].split('.')[0].toLowerCase();
            if (avatarNameMap[username]) return avatarNameMap[username];
            // Tentar pelo primeiro nome
            if (nome) {
                const firstName = nome.split(' ')[0].toLowerCase();
                if (avatarNameMap[firstName]) return avatarNameMap[firstName];
            }
            return null;
        }

        // Variável global do usuário logado
        let usuarioLogado = {
            id: null,
            nome: '',
            email: '',
            role: '',
            departamento: '',
            isAdmin: false,
            isSupervisor: false,
            canMoveAllKanban: false, // Permisséo para mover pedidos além de "Análise"
            canFaturar: false // Permisséo para botões Faturar Todos e Comunicar SEFAZ
        };
        
        // Lista de admins por email/nome
        const ADMINS_EMAILS = ['ti@aluforce.ind.br', 'andreia@aluforce.ind.br', 'douglas@aluforce.ind.br'];
        const ADMINS_NOMES = ['antonio egidio', 'andreia', 'douglas'];
        
        // Usuários com permisséo para Faturar Todos e Comunicar SEFAZ
        const USUARIOS_FATURAMENTO = ['andreia', 'douglas', 't.i', 'ti', 'fernando', 'antonio egidio'];
        const EMAILS_FATURAMENTO = ['andreia@aluforce.ind.br', 'douglas@aluforce.ind.br', 'ti@aluforce.ind.br', 'fernando@aluforce.ind.br'];
        
        // Funçéo para verificar se usuário pode faturar
        function verificarPermissaoFaturamento(user) {
            if (!user) return false;
            // Verificar pelo email
            if (user.email && EMAILS_FATURAMENTO.includes(user.email.toLowerCase())) return true;
            // Verificar pelo nome
            if (user.nome) {
                const nomeMin = user.nome.toLowerCase();
                for (const nome of USUARIOS_FATURAMENTO) {
                    if (nomeMin.includes(nome)) return true;
                }
            }
            // Verificar pelo apelido
            if (user.apelido) {
                const apelidoMin = user.apelido.toLowerCase();
                for (const nome of USUARIOS_FATURAMENTO) {
                    if (apelidoMin.includes(nome)) return true;
                }
            }
            return false;
        }
        
        // Funçéo para mostrar/ocultar botões de faturamento
        function atualizarBotoesFaturamento() {
            const btnFaturarTodos = document.getElementById('btn-faturar-todos');
            const btnComunicarSefaz = document.getElementById('btn-comunicar-sefaz');
            
            if (usuarioLogado.canFaturar) {
                if (btnFaturarTodos) btnFaturarTodos.style.display = 'flex';
                if (btnComunicarSefaz) btnComunicarSefaz.style.display = 'flex';
            } else {
                if (btnFaturarTodos) btnFaturarTodos.style.display = 'none';
                if (btnComunicarSefaz) btnComunicarSefaz.style.display = 'none';
            }
        }
        
        // Departamentos com permisséo de supervisores/diretores
        const SUPERVISORES_DEPARTAMENTOS = ['diretoria', 'gerencia', 'supervisao', 'coordenacao', 'ti'];
        
        function verificarSeAdmin(user) {
            if (!user) return false;
            // Verificar pelo role
            if (user.role === 'admin' || user.is_admin === 1 || user.is_admin === true) return true;
            // Verificar pelo email
            if (user.email && ADMINS_EMAILS.includes(user.email.toLowerCase())) return true;
            // Verificar pelo nome
            if (user.nome) {
                const nomeMin = user.nome.toLowerCase();
                for (const adminNome of ADMINS_NOMES) {
                    if (nomeMin.includes(adminNome)) return true;
                }
            }
            return false;
        }
        
        // Verificar se usuário É supervisor/diretor (pode mover pedidos no Kanban)
        function verificarSeSupervisor(user) {
            if (!user) return false;
            // Admin já tem todas as permissões
            if (verificarSeAdmin(user)) return true;
            // Verificar pelo departamento
            if (user.departamento) {
                const deptMin = user.departamento.toLowerCase();
                for (const deptSupervisor of SUPERVISORES_DEPARTAMENTOS) {
                    if (deptMin.includes(deptSupervisor)) return true;
                }
            }
            // Verificar se nome contêm "supervisor" ou "diretor" ou "gerente"
            if (user.nome) {
                const nomeMin = user.nome.toLowerCase();
                if (nomeMin.includes('supervisor') || nomeMin.includes('diretor') || 
                    nomeMin.includes('gerente') || nomeMin.includes('coordenador')) {
                    return true;
                }
            }
            return false;
        }

        async function carregarUsuarioLogado() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    
                    // Armazenar dados do usuário
                    usuarioLogado.id = user.id;
                    usuarioLogado.nome = user.nome || '';
                    usuarioLogado.email = user.email || '';
                    usuarioLogado.role = user.role || '';
                    usuarioLogado.departamento = user.departamento || '';
                    // Usar isAdmin da API ou calcular localmente como fallback
                    usuarioLogado.isAdmin = user.isAdmin === true || verificarSeAdmin(user);
                    // Verificar se É supervisor/diretor (pode mover pedidos no Kanban)
                    usuarioLogado.isSupervisor = verificarSeSupervisor(user);
                    // Permisséo unificada para mover pedidos além de "Análise"
                    usuarioLogado.canMoveAllKanban = usuarioLogado.isAdmin || usuarioLogado.isSupervisor;
                    // Verificar permisséo para Faturar Todos e Comunicar SEFAZ
                    usuarioLogado.canFaturar = verificarPermissaoFaturamento(user);
                    
                    console.log('[Vendas] Usuário logado:', usuarioLogado.nome, '| Admin:', usuarioLogado.isAdmin, '| Supervisor:', usuarioLogado.isSupervisor, '| CanFaturar:', usuarioLogado.canFaturar, '| ID:', usuarioLogado.id);
                    
                    // Atualizar visibilidade dos botões de faturamento
                    atualizarBotoesFaturamento();
                    
                    // Usar apelido se disponível, senéo primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');
                    
                    // Prioridade: avatar > foto > foto_perfil_url > mapeamento por email/nome
                    let userAvatar = user.avatar || user.foto || user.foto_perfil_url;
                    if (!userAvatar || userAvatar === '/avatars/default.webp') {
                        userAvatar = getAvatarFromEmail(user.email, userName);
                    }
                    
                    // Atualizar saudaçéo dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    
                    // Atualizar nome na saudaçéo
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) {
                        userNameEl.textContent = primeiroNome;
                    }
                    
                    // Atualizar avatar/foto
                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialEl = document.getElementById('user-initial');
                    
                    if (userAvatar && userPhotoEl) {
                        userPhotoEl.src = userAvatar;
                        userPhotoEl.onload = () => {
                            userPhotoEl.classList.add('visible');
                            userPhotoEl.style.display = 'block';
                            if (userInitialEl) userInitialEl.style.display = 'none';
                        };
                        userPhotoEl.onerror = () => {
                            userPhotoEl.style.display = 'none';
                            if (userInitialEl) {
                                userInitialEl.textContent = userName.charAt(0).toUpperCase();
                                userInitialEl.style.display = 'flex';
                            }
                        };
                    } else if (userInitialEl) {
                        userInitialEl.textContent = userName.charAt(0).toUpperCase();
                        userInitialEl.style.display = 'flex';
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                    
                    console.log('[Vendas] Usuário carregado:', primeiroNome, '| Foto:', userAvatar ? 'Sim' : 'Néo');
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
            }
        }

        // ========================================
        // FUNÇÕES DO MODAL NOVO CLIENTE
        // ========================================
        
        // Estado inicial do formulário para detectar alterações
        let clienteEstadoInicial = {};
        let clienteHaAlteracoes = false;
        
        function abrirModalNovoCliente() {
            document.getElementById('modal-novo-cliente').classList.add('active');
            limparFormularioCliente();
            // Salva estado inicial após limpar
            setTimeout(() => {
                clienteEstadoInicial = capturarEstadoCliente();
                clienteHaAlteracoes = false;
            }, 100);
        }

        function fecharModalNovoCliente() {
            document.getElementById('modal-novo-cliente').classList.remove('active');
            clienteHaAlteracoes = false;
        }
        
        // Verificar alterações antes de fechar
        function verificarAlteracoesCliente() {
            const estadoAtual = capturarEstadoCliente();
            const alteracoes = detectarAlteracoesCliente(clienteEstadoInicial, estadoAtual);
            
            if (alteracoes.length > 0) {
                mostrarPopupAlteracoes(alteracoes, () => fecharModalNovoCliente());
            } else {
                fecharModalNovoCliente();
            }
        }
        
        function capturarEstadoCliente() {
            return {
                cnpj: document.getElementById('cliente-cnpj')?.value || document.getElementById('manual-cnpj')?.value || '',
                razaoSocial: document.getElementById('cliente-razao-social')?.value || document.getElementById('manual-razao-social')?.value || '',
                fantasia: document.getElementById('cliente-fantasia')?.value || document.getElementById('manual-fantasia')?.value || '',
                ie: document.getElementById('cliente-ie')?.value || document.getElementById('manual-ie')?.value || '',
                cep: document.getElementById('cliente-cep')?.value || document.getElementById('manual-cep')?.value || '',
                logradouro: document.getElementById('cliente-logradouro')?.value || document.getElementById('manual-logradouro')?.value || '',
                numero: document.getElementById('cliente-numero')?.value || document.getElementById('manual-numero')?.value || '',
                bairro: document.getElementById('cliente-bairro')?.value || document.getElementById('manual-bairro')?.value || '',
                cidade: document.getElementById('cliente-cidade')?.value || document.getElementById('manual-cidade')?.value || '',
                uf: document.getElementById('cliente-uf')?.value || document.getElementById('manual-uf')?.value || '',
                telefone: document.getElementById('cliente-telefone')?.value || document.getElementById('manual-telefone')?.value || '',
                email: document.getElementById('cliente-email')?.value || document.getElementById('manual-email')?.value || ''
            };
        }
        
        function detectarAlteracoesCliente(inicial, atual) {
            const alteracoes = [];
            const labels = {
                cnpj: 'CNPJ/CPF',
                razaoSocial: 'Razéo Social',
                fantasia: 'Nome Fantasia',
                ie: 'Inscriçéo Estadual',
                cep: 'CEP',
                logradouro: 'Logradouro',
                numero: 'Número',
                bairro: 'Bairro',
                cidade: 'Cidade',
                uf: 'UF',
                telefone: 'Telefone',
                email: 'E-mail'
            };
            
            for (const key in labels) {
                if (inicial[key] !== atual[key]) {
                    alteracoes.push(`${labels[key]}: "${inicial[key] || '(vazio)'}" ? "${atual[key] || '(vazio)'}"`);
                }
            }
            
            return alteracoes;
        }

        function limparFormularioCliente() {
            const campos = ['cliente-cnpj', 'cliente-tipo-pessoa', 'cliente-situacao', 'cliente-razao-social', 
                           'cliente-fantasia', 'cliente-ie', 'cliente-im', 'cliente-cep', 'cliente-logradouro',
                           'cliente-numero', 'cliente-complemento', 'cliente-bairro', 'cliente-cidade', 'cliente-uf',
                           'cliente-telefone', 'cliente-celular', 'cliente-email', 'cliente-contato-nome',
                           'cliente-contato-cargo', 'cliente-observacoes'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                }
            });
            document.getElementById('cnpj-resultado').style.display = 'none';
            document.getElementById('cnpj-loading').style.display = 'none';
        }

        // Consulta CNPJ na API ReceitaWS (gratuita)
        async function consultarCNPJ() {
            const cnpjInput = document.getElementById('cliente-cnpj');
            const cnpj = cnpjInput.value.replace(/\D/g, '');
            
            if (cnpj.length !== 14) {
                showNotification('CNPJ deve ter 14 dígitos', 'error');
                return;
            }
            
            const loadingEl = document.getElementById('cnpj-loading');
            const resultadoEl = document.getElementById('cnpj-resultado');
            
            loadingEl.style.display = 'block';
            resultadoEl.style.display = 'none';
            
            try {
                // API gratuita ReceitaWS
                const response = await fetch(`https://receitaws.com.br/v1/cnpj/${cnpj}`, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error('CNPJ néo encontrado');
                
                const dados = await response.json();
                
                if (dados.status === 'ERROR') {
                    throw new Error(dados.message || 'CNPJ néo encontrado');
                }
                
                // Preencher formulário
                document.getElementById('cliente-razao-social').value = dados.nome || '';
                document.getElementById('cliente-fantasia').value = dados.fantasia || '';
                document.getElementById('cliente-logradouro').value = dados.logradouro || '';
                document.getElementById('cliente-numero').value = dados.numero || '';
                document.getElementById('cliente-complemento').value = dados.complemento || '';
                document.getElementById('cliente-bairro').value = dados.bairro || '';
                document.getElementById('cliente-cidade').value = dados.municipio || '';
                document.getElementById('cliente-uf').value = dados.uf || '';
                document.getElementById('cliente-cep').value = dados.cep ? dados.cep.replace(/\D/g, '') : '';
                document.getElementById('cliente-telefone').value = dados.telefone ? dados.telefone.split('/')[0].trim() : '';
                document.getElementById('cliente-email').value = dados.email || '';
                
                // Mostrar resultado
                document.getElementById('cnpj-info').textContent = 
                    `${dados.nome} - ${dados.situacao || 'Situaçéo néo informada'}`;
                resultadoEl.style.display = 'block';
                
                showNotification('Dados preenchidos automaticamente!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CNPJ', 'error');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Consulta CEP via ViaCEP
        async function consultarCEP() {
            const cepInput = document.getElementById('cliente-cep');
            const cep = cepInput.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                showNotification('CEP deve ter 8 dígitos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dados = await response.json();
                
                if (dados.erro) {
                    throw new Error('CEP néo encontrado');
                }
                
                document.getElementById('cliente-logradouro').value = dados.logradouro || '';
                document.getElementById('cliente-bairro').value = dados.bairro || '';
                document.getElementById('cliente-cidade').value = dados.localidade || '';
                document.getElementById('cliente-uf').value = dados.uf || '';
                
                showNotification('Endereço preenchido!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CEP', 'error');
            }
        }
        
        // Funções para expandir/contrair seções do modal de cliente
        function expandirPesquisaCNPJ() {
            const elemento = document.getElementById('pesquisa-cnpj-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-google-expandido').style.display = 'none';
                document.getElementById('insercao-manual-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        function expandirPesquisaGoogle() {
            const elemento = document.getElementById('pesquisa-google-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-cnpj-expandido').style.display = 'none';
                document.getElementById('insercao-manual-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        function expandirInsercaoManual() {
            const elemento = document.getElementById('insercao-manual-expandido');
            if (elemento.style.display === 'none') {
                // Esconde outros expandidos
                document.getElementById('pesquisa-cnpj-expandido').style.display = 'none';
                document.getElementById('pesquisa-google-expandido').style.display = 'none';
                elemento.style.display = 'block';
            } else {
                elemento.style.display = 'none';
            }
        }
        
        // Pesquisa Atômica - Busca no banco de dados
        async function pesquisarAtomico() {
            const termo = document.getElementById('pesquisa-atomica').value.trim();
            if (!termo) {
                showNotification('Digite algo para pesquisar', 'error');
                return;
            }
            
            showNotification('Pesquisando... Aguarde', 'info');
            
            try {
                // Buscar clientes no banco de dados
                const response = await fetch(`/api/vendas/clientes?search=${encodeURIComponent(termo)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Erro na pesquisa');
                
                const result = await response.json();
                const clientes = result.clientes || result.data || result || [];
                
                if (clientes.length === 0) {
                    showNotification('Nenhum cliente encontrado. Tente buscar por CNPJ/CPF para consultar na Receita.', 'warning');
                    return;
                }
                
                // Mostrar resultados para seleçéo
                exibirResultadosPesquisa(clientes);
                showNotification(`${clientes.length} cliente(s) encontrado(s)!`, 'success');
                
            } catch (error) {
                console.error('Erro na pesquisa:', error);
                showNotification('Erro ao pesquisar. Tente novamente.', 'error');
            }
        }
        
        // Exibir resultados da pesquisa de clientes
        function exibirResultadosPesquisa(clientes) {
            // Verificar se já existe o container de resultados
            let resultadosDiv = document.getElementById('resultados-pesquisa-cliente');
            
            if (!resultadosDiv) {
                // Criar container de resultados
                resultadosDiv = document.createElement('div');
                resultadosDiv.id = 'resultados-pesquisa-cliente';
                resultadosDiv.style.cssText = 'margin-top: 16px; background: #fff; border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(59,130,246,0.15);';
                
                // Inserir após a pesquisa inteligente
                const pesquisaDiv = document.querySelector('.cliente-opcao-pesquisa');
                pesquisaDiv.parentNode.insertBefore(resultadosDiv, pesquisaDiv.nextSibling);
            }
            
            resultadosDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                        <span style="font-weight: 600;">${clientes.length} resultado(s) encontrado(s)</span>
                    </div>
                    <button onclick="document.getElementById('resultados-pesquisa-cliente').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${clientes.map(c => `
                        <div class="resultado-cliente-item" onclick="selecionarClientePesquisa(${c.id})" 
                             style="padding: 14px 20px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;"
                             onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                            <div>
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${c.razao_social || c.nome || 'Sem nome'}</div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${c.cnpj || c.cpf || '-'} É ${c.cidade || ''}${c.uf ? '/' + c.uf : ''}
                                </div>
                            </div>
                            <button style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer;">
                                <i class="fas fa-check"></i> Selecionar
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultadosDiv.style.display = 'block';
        }
        
        // Selecionar cliente da pesquisa
        async function selecionarClientePesquisa(clienteId) {
            try {
                const response = await fetch(`/api/vendas/clientes/${clienteId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Erro ao carregar cliente');
                
                const cliente = await response.json();
                
                // Preencher formulário ou usar diretamente
                if (cliente) {
                    // Fechar modal e selecionar cliente
                    fecharModalNovoCliente();
                    
                    // Se existir funçéo para definir cliente no pedido
                    if (typeof setClienteNoPedido === 'function') {
                        setClienteNoPedido(cliente);
                    } else {
                        // Disparar evento ou salvar no localStorage
                        localStorage.setItem('clienteSelecionado', JSON.stringify(cliente));
                        showNotification(`Cliente "${cliente.razao_social || cliente.nome}" selecionado!`, 'success');
                        
                        // Atualizar campo de cliente se existir
                        const clienteInput = document.getElementById('cliente-nome') || document.querySelector('[data-cliente-nome]');
                        if (clienteInput) {
                            clienteInput.value = cliente.razao_social || cliente.nome || '';
                            clienteInput.dataset.clienteId = cliente.id;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao selecionar cliente:', error);
                showNotification('Erro ao selecionar cliente', 'error');
            }
        }
        
        // Pesquisa no Google
        function pesquisarGoogle() {
            const termo = document.getElementById('pesquisa-google').value.trim();
            if (!termo) {
                showNotification('Digite algo para pesquisar', 'error');
                return;
            }
            
            // Abrir pesquisa do Google em nova aba
            const url = `https://www.google.com/search?q=${encodeURIComponent(termo)}`;
            window.open(url, '_blank');
        }
        
        // Consultar CEP no formulário manual
        async function consultarCEPManual() {
            const cepInput = document.getElementById('manual-cep');
            const cep = cepInput.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                showNotification('CEP deve ter 8 dígitos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dados = await response.json();
                
                if (dados.erro) {
                    throw new Error('CEP néo encontrado');
                }
                
                document.getElementById('manual-logradouro').value = dados.logradouro || '';
                document.getElementById('manual-bairro').value = dados.bairro || '';
                document.getElementById('manual-cidade').value = dados.localidade || '';
                document.getElementById('manual-uf').value = dados.uf || '';
                
                showNotification('Endereço preenchido!', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Erro ao consultar CEP', 'error');
            }
        }
        
        // Salvar cliente do formulário manual
        async function salvarClienteManual() {
            const cliente = {
                cnpj_cpf: document.getElementById('manual-cnpj')?.value || '',
                razao_social: document.getElementById('manual-razao-social')?.value || '',
                nome_fantasia: document.getElementById('manual-fantasia')?.value || '',
                ie: document.getElementById('manual-ie')?.value || '',
                cep: document.getElementById('manual-cep')?.value || '',
                logradouro: document.getElementById('manual-logradouro')?.value || '',
                numero: document.getElementById('manual-numero')?.value || '',
                complemento: document.getElementById('manual-complemento')?.value || '',
                bairro: document.getElementById('manual-bairro')?.value || '',
                cidade: document.getElementById('manual-cidade')?.value || '',
                uf: document.getElementById('manual-uf')?.value || '',
                telefone: document.getElementById('manual-telefone')?.value || '',
                celular: document.getElementById('manual-celular')?.value || '',
                email: document.getElementById('manual-email')?.value || '',
                contato_nome: document.getElementById('manual-contato-nome')?.value || '',
                contato_cargo: document.getElementById('manual-contato-cargo')?.value || '',
                observacoes: document.getElementById('manual-observacoes')?.value || ''
            };

            if (!cliente.razao_social) {
                showNotification('Razéo Social é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cliente)
                });

                if (response.ok) {
                    showNotification('Cliente cadastrado com sucesso!', 'success');
                    clienteHaAlteracoes = false;
                    fecharModalNovoCliente();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar cliente', 'error');
            }
        }

        // Formatadores
        function formatarCNPJ(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            
            if (value.length > 12) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '$1.$2');
            }
            input.value = value;
        }

        function formatarCEP(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d+)$/, '$1-$2');
            }
            input.value = value;
        }

        function formatarTelefone(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d+)$/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
            }
            input.value = value;
        }

        function formatarMoedaInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = (parseInt(value || '0') / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = value;
        }

        // Salvar novo cliente
        async function salvarNovoCliente() {
            const cliente = {
                cnpj: document.getElementById('cliente-cnpj').value.replace(/\D/g, ''),
                tipo_pessoa: document.getElementById('cliente-tipo-pessoa').value,
                situacao: document.getElementById('cliente-situacao').value,
                razao_social: document.getElementById('cliente-razao-social').value,
                nome_fantasia: document.getElementById('cliente-fantasia').value,
                inscricao_estadual: document.getElementById('cliente-ie').value,
                inscricao_municipal: document.getElementById('cliente-im').value,
                cep: document.getElementById('cliente-cep').value.replace(/\D/g, ''),
                logradouro: document.getElementById('cliente-logradouro').value,
                numero: document.getElementById('cliente-numero').value,
                complemento: document.getElementById('cliente-complemento').value,
                bairro: document.getElementById('cliente-bairro').value,
                cidade: document.getElementById('cliente-cidade').value,
                uf: document.getElementById('cliente-uf').value,
                telefone: document.getElementById('cliente-telefone').value,
                celular: document.getElementById('cliente-celular').value,
                email: document.getElementById('cliente-email').value,
                contato_nome: document.getElementById('cliente-contato-nome').value,
                contato_cargo: document.getElementById('cliente-contato-cargo').value,
                observacoes: document.getElementById('cliente-observacoes').value
            };

            // Validações básicas
            if (!cliente.razao_social) {
                showNotification('Razéo Social é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cliente)
                });

                if (response.ok) {
                    showNotification('Cliente cadastrado com sucesso!', 'success');
                    fecharModalNovoCliente();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar cliente', 'error');
            }
        }

        // ========================================
        // FUNÇÕES DO MODAL NOVO PRODUTO - ESTILO OMIE
        // ========================================
        
        // Estado inicial do formulário para detectar alterações
        let produtoEstadoInicial = {};
        let produtoHaAlteracoes = false;
        let modalOrigemProduto = null;
        
        function abrirModalNovoProduto() {
            document.getElementById('modal-novo-produto').classList.add('active');
            limparFormularioProduto();
            // Salva estado inicial após limpar
            setTimeout(() => {
                produtoEstadoInicial = capturarEstadoProduto();
                produtoHaAlteracoes = false;
            }, 100);
        }

        function fecharModalNovoProduto() {
            document.getElementById('modal-novo-produto').classList.remove('active');
            produtoHaAlteracoes = false;
        }
        
        // Verificar alterações antes de fechar
        function verificarAlteracoesProduto() {
            const estadoAtual = capturarEstadoProduto();
            const alteracoes = detectarAlteracoesProduto(produtoEstadoInicial, estadoAtual);
            
            if (alteracoes.length > 0) {
                modalOrigemProduto = 'produto';
                mostrarPopupAlteracoes(alteracoes, () => fecharModalNovoProduto());
            } else {
                fecharModalNovoProduto();
            }
        }
        
        function capturarEstadoProduto() {
            return {
                descricao: document.getElementById('produto-descricao')?.value || '',
                codigo: document.getElementById('produto-codigo')?.value || '',
                ean: document.getElementById('produto-ean')?.value || '',
                unidade: document.getElementById('produto-unidade')?.value || '',
                precoVenda: document.getElementById('produto-preco-venda')?.value || '',
                ncm: document.getElementById('produto-ncm')?.value || '',
                familia: document.getElementById('produto-familia')?.value || '',
                precoCusto: document.getElementById('produto-preco-custo')?.value || '',
                observacoes: document.getElementById('produto-observacoes')?.value || ''
            };
        }
        
        function detectarAlteracoesProduto(inicial, atual) {
            const alteracoes = [];
            const labels = {
                descricao: 'Descriçéo do Produto',
                codigo: 'Código do Produto',
                ean: 'Código EAN',
                unidade: 'Unidade',
                precoVenda: 'Preço de Venda',
                ncm: 'Código NCM',
                familia: 'Família de Produto',
                precoCusto: 'Preço de Custo',
                observacoes: 'Observações'
            };
            
            for (const key in labels) {
                if (inicial[key] !== atual[key]) {
                    alteracoes.push(`${labels[key]}: "${inicial[key] || '(vazio)'}" ? "${atual[key] || '(vazio)'}"`);
                }
            }
            
            return alteracoes;
        }
        
        // Popup de confirmaçéo de alterações
        function mostrarPopupAlteracoes(alteracoes, callbackSim) {
            const lista = document.getElementById('alteracoes-itens');
            lista.innerHTML = alteracoes.map(a => `<li>${a}</li>`).join('');
            
            window.callbackDesprezarAlteracoes = callbackSim;
            document.getElementById('modal-confirmar-alteracoes').classList.add('active');
        }
        
        function toggleListaAlteracoes() {
            const lista = document.getElementById('lista-alteracoes');
            lista.classList.toggle('show');
        }
        
        function confirmarDesprezarAlteracoes() {
            // Fechar o modal de confirmaçéo
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            document.getElementById('lista-alteracoes').classList.remove('show');
            
            // Limpar alterações pendentes
            limparAlteracoes();
            
            // Fechar o modal principal de ediçéo (Orçamento)
            const modalEditar = document.getElementById('modal-editar');
            if (modalEditar) {
                modalEditar.classList.remove('active');
                modalEditar.style.display = 'none';
            }
            
            // Fechar qualquer outro modal aberto
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                if (modal.id !== 'modal-confirmar-alteracoes') {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                }
            });
            
            // Executar callback se existir
            if (window.callbackDesprezarAlteracoes) {
                window.callbackDesprezarAlteracoes();
                window.callbackDesprezarAlteracoes = null;
            }
            
            // Restaurar scroll do body
            document.body.style.overflow = '';
        }
        
        function cancelarDesprezarAlteracoes() {
            document.getElementById('modal-confirmar-alteracoes').classList.remove('active');
            document.getElementById('lista-alteracoes').classList.remove('show');
        }

        function limparFormularioProduto() {
            // Limpar campos básicos
            const campos = ['produto-descricao', 'produto-ean', 'produto-ncm', 'produto-familia',
                           'produto-preco-custo', 'produto-observacoes'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset dos valores padréo
            const precoVenda = document.getElementById('produto-preco-venda');
            if (precoVenda) precoVenda.value = '0,000000';
            
            const codigo = document.getElementById('produto-codigo');
            if (codigo) codigo.value = 'PRD' + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
            
            const unidade = document.getElementById('produto-unidade');
            if (unidade) unidade.selectedIndex = 0;
            
            // Reset imagem
            const preview = document.getElementById('produto-imagem-preview');
            const icon = document.getElementById('produto-imagem-icon');
            if (preview) {
                preview.style.display = 'none';
                preview.src = '';
            }
            if (icon) icon.style.display = 'block';
            
            // Reset toggles
            document.querySelectorAll('.toggle-switch-produto').forEach(toggle => {
                toggle.removeAttribute('data-active');
            });
            const firstToggle = document.querySelector('.toggle-switch-produto');
            if (firstToggle) firstToggle.setAttribute('data-active', 'true');
            
            // Reset abas - voltar para Estoque
            mudarAbaProduto('estoque', document.querySelector('.produto-tab'));
        }
        
        // Preview de imagem do produto
        function previewImagemProduto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('produto-imagem-preview');
                    const icon = document.getElementById('produto-imagem-icon');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    icon.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Toggle de definiçéo do produto (Simples/Kit/Com Variações)
        function toggleDefinicaoProduto(element, tipo) {
            // Remove active de todos
            document.querySelectorAll('.toggle-switch-produto').forEach(toggle => {
                toggle.removeAttribute('data-active');
            });
            // Ativa o clicado
            element.setAttribute('data-active', 'true');
        }
        
        // Toggle controle de lote
        function toggleControleLote(element) {
            const isActive = element.getAttribute('data-active') === 'true';
            element.setAttribute('data-active', !isActive);
        }
        
        // Mudar abas do produto
        function mudarAbaProduto(tabId, btnElement) {
            // Esconde todas as abas
            document.querySelectorAll('.produto-tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Remove active de todos os botões
            document.querySelectorAll('.produto-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#666';
                btn.style.borderBottomColor = 'transparent';
            });
            
            // Mostra a aba selecionada
            const panel = document.getElementById('tab-' + tabId);
            if (panel) panel.style.display = 'block';
            
            // Ativa o botéo
            if (btnElement) {
                btnElement.classList.add('active');
                btnElement.style.color = '#f97316';
                btnElement.style.borderBottomColor = '#f97316';
            }
        }
        
        // Formatar moeda no produto
        function formatarMoedaProduto(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (parseFloat(valor) / 1000000).toFixed(6);
            input.value = valor.replace('.', ',');
        }

        async function salvarNovoProduto() {
            const produto = {
                codigo: document.getElementById('produto-codigo')?.value || '',
                descricao: document.getElementById('produto-descricao')?.value || '',
                ncm: document.getElementById('produto-ncm')?.value || '',
                ean: document.getElementById('produto-ean')?.value || '',
                unidade: document.getElementById('produto-unidade')?.value || '',
                preco_venda: parseFloat(document.getElementById('produto-preco-venda')?.value.replace(/\./g, '').replace(',', '.')) || 0,
                familia: document.getElementById('produto-familia')?.value || '',
                preco_custo: parseFloat(document.getElementById('produto-preco-custo')?.value.replace(/\./g, '').replace(',', '.')) || 0,
                observacoes: document.getElementById('produto-observacoes')?.value || ''
            };

            if (!produto.descricao) {
                showNotification('Descriçéo é obrigatória', 'error');
                return;
            }

            try {
                const response = await fetch('/api/vendas/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(produto)
                });

                if (response.ok) {
                    showNotification('Produto cadastrado com sucesso!', 'success');
                    produtoHaAlteracoes = false;
                    fecharModalNovoProduto();
                } else {
                    const err = await response.json();
                    throw new Error(err.message || 'Erro ao salvar');
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao salvar produto', 'error');
            }
        }

        // ========================================
        // SISTEMA DE NOTIFICAÇÕES (CONECTADO É API)
        // ========================================
        
        // Array de notificações (carregado do servidor)
        let notificacoes = [];
        let filtroAtual = 'todas';
        
        // Carregar notificações do servidor
        async function carregarNotificacoes() {
            try {
                const filter = filtroAtual === 'nao-lidas' ? 'unread' : 
                              filtroAtual === 'importantes' ? 'important' : 'all';
                const response = await fetch(`/api/notifications?filter=${filter}`);
                if (response.ok) {
                    const data = await response.json();
                    notificacoes = (data.notifications || []).map(n => ({
                        id: n.id,
                        tipo: n.type || 'info',
                        icone: getIconePorTipo(n.type || 'info'),
                        titulo: n.title,
                        mensagem: n.message,
                        tempo: new Date(n.createdAt),
                        lida: n.read,
                        importante: n.important,
                        data: n.data
                    }));
                    atualizarContador(data.unreadCount);
                    renderizarNotificacoes();
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        // Inicializar sistema de notificações
        function inicializarNotificacoes() {
            carregarNotificacoes();
            
            // Atualizar notificações a cada 30 segundos
            setInterval(carregarNotificacoes, 30000);
            
            // Fechar painel ao clicar fora
            document.addEventListener('click', function(e) {
                const container = document.querySelector('.notification-container');
                const panel = document.getElementById('notification-panel');
                if (container && !container.contains(e.target) && panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            });
            
            // Conectar via Socket.IO para notificações em tempo real
            if (window.io) {
                const socket = io();
                socket.on('notification', (notif) => {
                    adicionarNotificacao(notif.type, notif.title, notif.message, notif.important, notif.data);
                    // Mostrar toast
                    showNotification(notif.title + ': ' + notif.message, notif.type === 'error' ? 'error' : 'info');
                });
            }
        }
        
        // Toggle do painel de notificações
        function toggleNotificacoes() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                carregarNotificacoes();
            }
        }
        
        // Renderizar lista de notificações
        function renderizarNotificacoes() {
            const lista = document.getElementById('notification-list');
            
            if (notificacoes.length === 0) {
                lista.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>Nenhuma notificaçéo ${filtroAtual === 'nao-lidas' ? 'néo lida' : filtroAtual === 'importantes' ? 'importante' : ''}</p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = notificacoes.map(notif => `
                <div class="notification-item ${notif.lida ? '' : 'unread'} ${notif.importante ? 'important' : ''}" 
                     onclick="marcarComoLida(${notif.id})">
                    <div class="notification-icon ${notif.tipo}">
                        <i class="fas ${notif.icone}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">
                            ${notif.titulo}
                            ${!notif.lida ? '<span class="badge-new">NOVO</span>' : ''}
                        </div>
                        <div class="notification-message">${notif.mensagem}</div>
                        <div class="notification-time">
                            <i class="far fa-clock"></i>
                            ${formatarTempoRelativo(notif.tempo)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Formatar tempo relativo (ex: "há 5 minutos")
        function formatarTempoRelativo(data) {
            const agora = new Date();
            const diff = agora - data;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(diff / 3600000);
            const dias = Math.floor(diff / 86400000);
            
            if (minutos < 1) return 'Agora mesmo';
            if (minutos < 60) return `há ${minutos} minuto${minutos > 1 ? 's' : ''}`;
            if (horas < 24) return `há ${horas} hora${horas > 1 ? 's' : ''}`;
            if (dias < 7) return `há ${dias} dia${dias > 1 ? 's' : ''}`;
            return data.toLocaleDateString('pt-BR');
        }
        
        // Filtrar notificações
        function filtrarNotificacoes(filtro, btn) {
            filtroAtual = filtro;
            
            // Atualizar tabs
            document.querySelectorAll('.notif-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            carregarNotificacoes();
        }
        
        // Marcar notificaçéo como lida
        async function marcarComoLida(id) {
            try {
                await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
                const notif = notificacoes.find(n => n.id === id);
                if (notif) {
                    notif.lida = true;
                    renderizarNotificacoes();
                    const naoLidas = notificacoes.filter(n => !n.lida).length;
                    atualizarContador(naoLidas);
                }
                
                // Se tiver dados do pedido, abrir o pedido
                if (notif && notif.data && notif.data.pedido_id) {
                    abrirDetalhesPedido(notif.data.pedido_id);
                }
            } catch (error) {
                console.error('Erro ao marcar como lida:', error);
            }
        }
        
        // Marcar todas como lidas
        async function marcarTodasLidas() {
            try {
                await fetch('/api/notifications/read-all', { method: 'POST' });
                notificacoes.forEach(n => n.lida = true);
                renderizarNotificacoes();
                atualizarContador(0);
                showNotification('Todas as notificações foram marcadas como lidas', 'success');
            } catch (error) {
                showNotification('Erro ao marcar notificações', 'error');
            }
        }
        
        // Sistema de Confirmaçéo Profissional
        let confirmCallback = null;
        
        function mostrarConfirmacao(opcoes = {}) {
            const modal = document.getElementById('modal-confirmacao-custom');
            const titulo = document.getElementById('confirm-titulo');
            const mensagem = document.getElementById('confirm-mensagem');
            const iconContainer = document.getElementById('confirm-icon-container');
            const icon = document.getElementById('confirm-icon');
            const btnOk = document.getElementById('btn-confirm-ok');
            const btnCancelar = document.getElementById('btn-confirm-cancelar');
            
            // Configurar textos
            titulo.textContent = opcoes.titulo || 'Confirmar Açéo';
            mensagem.textContent = opcoes.mensagem || 'Deseja realmente realizar esta açéo?';
            btnOk.textContent = opcoes.textoBotaoOk || 'Confirmar';
            btnCancelar.textContent = opcoes.textoBotaoCancelar || 'Cancelar';
            
            // Configurar aparência baseada no tipo
            const tipo = opcoes.tipo || 'warning';
            const configs = {
                warning: {
                    bg: 'linear-gradient(135deg, #fef3c7, #fde68a)',
                    iconClass: 'fas fa-exclamation-triangle',
                    iconColor: '#f59e0b',
                    btnBg: 'linear-gradient(135deg, #f97316, #ea580c)',
                    btnShadow: 'rgba(249,115,22,0.4)'
                },
                danger: {
                    bg: 'linear-gradient(135deg, #fee2e2, #fecaca)',
                    iconClass: 'fas fa-trash-alt',
                    iconColor: '#ef4444',
                    btnBg: 'linear-gradient(135deg, #ef4444, #dc2626)',
                    btnShadow: 'rgba(239,68,68,0.4)'
                },
                info: {
                    bg: 'linear-gradient(135deg, #dbeafe, #bfdbfe)',
                    iconClass: 'fas fa-info-circle',
                    iconColor: '#3b82f6',
                    btnBg: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                    btnShadow: 'rgba(59,130,246,0.4)'
                },
                success: {
                    bg: 'linear-gradient(135deg, #dcfce7, #bbf7d0)',
                    iconClass: 'fas fa-check-circle',
                    iconColor: '#22c55e',
                    btnBg: 'linear-gradient(135deg, #22c55e, #16a34a)',
                    btnShadow: 'rgba(34,197,94,0.4)'
                }
            };
            
            const config = configs[tipo] || configs.warning;
            iconContainer.style.background = config.bg;
            icon.className = config.iconClass;
            icon.style.color = config.iconColor;
            btnOk.style.background = config.btnBg;
            btnOk.style.boxShadow = `0 4px 14px ${config.btnShadow}`;
            
            // Configurar callbacks
            confirmCallback = opcoes.onConfirm || null;
            
            btnOk.onclick = () => {
                fecharConfirmacao();
                if (confirmCallback) confirmCallback();
            };
            
            btnCancelar.onclick = () => {
                fecharConfirmacao();
                if (opcoes.onCancel) opcoes.onCancel();
            };
            
            // Mostrar modal
            modal.classList.add('active');
        }
        
        function fecharConfirmacao() {
            const modal = document.getElementById('modal-confirmacao-custom');
            modal.classList.remove('active');
            confirmCallback = null;
        }
        
        // Limpar todas as notificações
        async function limparNotificacoes() {
            mostrarConfirmacao({
                tipo: 'danger',
                titulo: 'Limpar Notificações',
                mensagem: 'Deseja realmente limpar todas as notificações? Esta açéo néo pode ser desfeita.',
                textoBotaoOk: 'Limpar Todas',
                textoBotaoCancelar: 'Cancelar',
                onConfirm: async () => {
                    try {
                        for (const notif of notificacoes) {
                            await fetch(`/api/notifications/${notif.id}`, { method: 'DELETE' });
                        }
                        notificacoes = [];
                        renderizarNotificacoes();
                        atualizarContador(0);
                        showNotification('Notificações limpas com sucesso', 'info');
                    } catch (error) {
                        showNotification('Erro ao limpar notificações', 'error');
                    }
                }
            });
        }
        
        // Atualizar contador de notificações néo lidas
        function atualizarContador(count) {
            const naoLidas = count !== undefined ? count : notificacoes.filter(n => !n.lida).length;
            const badge = document.getElementById('notification-count');
            
            if (naoLidas > 0) {
                badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Ver histórico completo
        function verTodasNotificacoes() {
            // Fechar o dropdown de notificações
            document.getElementById('notification-panel').classList.remove('active');
            
            // Criar modal de histórico completo
            const modalHtml = `
                <div id="modal-historico-notificacoes" class="modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(15, 23, 42, 0.7);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeInHistorico 0.25s ease;
                ">
                    <style>
                        @keyframes fadeInHistorico { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes slideUpHistorico { from { transform: translateY(30px) scale(0.96); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
                        .historico-notif-item { cursor: default; }
                        .historico-notif-item:hover { background: linear-gradient(90deg, #f8fafc, #ffffff) !important; }
                        .historico-notif-item:hover .notif-icon-wrapper { transform: scale(1.05); }
                        .notif-icon-wrapper { transition: transform 0.2s ease; }
                        .historico-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                        .historico-input:focus { border-color: #6366f1 !important; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); outline: none; }
                        .historico-close:hover { background: rgba(255,255,255,0.3) !important; transform: rotate(90deg); }
                    </style>
                    <div class="modal-content" style="
                        background: #ffffff;
                        border-radius: 20px;
                        width: 90%;
                        max-width: 720px;
                        max-height: 85vh;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 25px 50px -12px rgba(0,0,0,0.25), 0 0 80px rgba(99, 102, 241, 0.08);
                        animation: slideUpHistorico 0.35s cubic-bezier(0.16, 1, 0.3, 1);
                        overflow: hidden;
                    ">
                        <div class="modal-header" style="
                            padding: 0;
                            display: flex;
                            flex-direction: column;
                            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
                            border-radius: 20px 20px 0 0;
                            position: relative;
                        ">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; background: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2280%22 cy=%2220%22 r=%2240%22 fill=%22rgba(255,255,255,0.05)%22/><circle cx=%2210%22 cy=%2290%22 r=%2230%22 fill=%22rgba(255,255,255,0.03)%22/></svg>'); pointer-events: none;"></div>
                            <div style="padding: 24px 28px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                                        <i class="fas fa-bell" style="font-size: 22px; color: white;"></i>
                                    </div>
                                    <div>
                                        <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: white; letter-spacing: -0.3px;">
                                            Histórico de Notificações
                                        </h2>
                                        <span style="font-size: 13px; color: rgba(255,255,255,0.8);">Acompanhe todas as atividades do sistema</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button onclick="exportarHistoricoNotificacoes()" class="historico-btn" style="
                                        background: rgba(255,255,255,0.2);
                                        backdrop-filter: blur(10px);
                                        border: 1px solid rgba(255,255,255,0.2);
                                        color: white;
                                        padding: 10px 16px;
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-size: 13px;
                                        font-weight: 600;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        transition: all 0.2s;
                                    " title="Exportar histórico">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <button onclick="fecharModalHistorico()" class="historico-close" style="
                                        background: rgba(255,255,255,0.15);
                                        border: none;
                                        color: white;
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-size: 16px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.3s;
                                    ">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-filters" style="
                            padding: 20px 28px;
                            background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
                            border-bottom: 1px solid #e5e7eb;
                            display: flex;
                            gap: 14px;
                            flex-wrap: wrap;
                            align-items: center;
                        ">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 280px;">
                                <label style="font-size: 13px; font-weight: 600; color: #374151; white-space: nowrap;">Período:</label>
                                <input type="date" id="historico-data-inicio" class="historico-input" style="
                                    padding: 10px 14px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                    font-size: 13px;
                                    background: #f9fafb;
                                    color: #374151;
                                    transition: all 0.2s;
                                    flex: 1;
                                ">
                                <span style="color: #9ca3af; font-size: 13px;">até</span>
                                <input type="date" id="historico-data-fim" class="historico-input" style="
                                    padding: 10px 14px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 10px;
                                    font-size: 13px;
                                    background: #f9fafb;
                                    color: #374151;
                                    transition: all 0.2s;
                                    flex: 1;
                                ">
                            </div>
                            <select id="historico-tipo-filtro" onchange="filtrarHistoricoNotificacoes()" class="historico-input" style="
                                padding: 10px 36px 10px 14px;
                                border: 2px solid #e5e7eb;
                                border-radius: 10px;
                                font-size: 13px;
                                background: #f9fafb url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 viewBox=%220 0 24 24%22 stroke=%22%236b7280%22><path stroke-linecap=%22round%22 stroke-linejoin=%22round%22 stroke-width=%222%22 d=%22M19 9l-7 7-7-7%22/></svg>') no-repeat right 10px center;
                                background-size: 16px;
                                appearance: none;
                                cursor: pointer;
                                color: #374151;
                                transition: all 0.2s;
                                min-width: 180px;
                            ">
                                <option value="todas">Todas as notificações</option>
                                <option value="order">📦 Pedidos</option>
                                <option value="payment">💰 Pagamentos</option>
                                <option value="warning">⚠️ Alertas</option>
                                <option value="success">✅ Sucesso</option>
                                <option value="error">❌ Erros</option>
                            </select>
                            <button onclick="filtrarHistoricoNotificacoes()" class="historico-btn" style="
                                padding: 10px 20px;
                                background: linear-gradient(135deg, #3b82f6, #2563eb);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 600;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s;
                                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                            ">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                        
                        <div class="modal-body" id="historico-lista" style="
                            flex: 1;
                            overflow-y: auto;
                            padding: 0;
                            background: #ffffff;
                        ">
                            <!-- Lista de notificações será inserida aqui -->
                        </div>
                        
                        <div class="modal-footer" style="
                            padding: 16px 28px;
                            border-top: 1px solid #e5e7eb;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
                            border-radius: 0 0 20px 20px;
                        ">
                            <span id="historico-contador" style="font-size: 13px; color: #6b7280; font-weight: 500;">
                                <i class="fas fa-list" style="margin-right: 6px; color: #9ca3af;"></i>
                                Mostrando 0 notificações
                            </span>
                            <div id="historico-paginacao" style="display: flex; gap: 6px;">
                                <!-- Paginaçéo será inserida aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente se houver
            const modalExistente = document.getElementById('modal-historico-notificacoes');
            if (modalExistente) modalExistente.remove();
            
            // Inserir modal no body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Definir datas padréo (últimos 30 dias)
            const hoje = new Date();
            const trintaDiasAtras = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
            document.getElementById('historico-data-fim').value = hoje.toISOString().split('T')[0];
            document.getElementById('historico-data-inicio').value = trintaDiasAtras.toISOString().split('T')[0];
            
            // Carregar notificações
            carregarHistoricoNotificacoes();
        }
        
        // Fechar modal de histórico
        function fecharModalHistorico() {
            const modal = document.getElementById('modal-historico-notificacoes');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        // Variáveis de paginaçéo do histórico
        let historicoNotificacoesPagina = 1;
        let historicoNotificacoesTotal = 0;
        const historicoNotificacoesPorPagina = 20;
        
        // Carregar histórico de notificações
        async function carregarHistoricoNotificacoes(pagina = 1) {
            historicoNotificacoesPagina = pagina;
            const lista = document.getElementById('historico-lista');
            
            // Mostrar loading
            lista.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; padding: 60px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #f97316;"></i>
                </div>
            `;
            
            try {
                const dataInicio = document.getElementById('historico-data-inicio').value;
                const dataFim = document.getElementById('historico-data-fim').value;
                const tipoFiltro = document.getElementById('historico-tipo-filtro').value;
                
                // Buscar do servidor
                const response = await fetch(`/api/notifications/history?page=${pagina}&limit=${historicoNotificacoesPorPagina}&startDate=${dataInicio}&endDate=${dataFim}&type=${tipoFiltro}`);
                
                let dados = { items: [], total: 0 };
                
                if (response.ok) {
                    dados = await response.json();
                } else {
                    // Fallback: usar notificações locais
                    dados = {
                        items: notificacoes.slice((pagina - 1) * historicoNotificacoesPorPagina, pagina * historicoNotificacoesPorPagina),
                        total: notificacoes.length
                    };
                }
                
                historicoNotificacoesTotal = dados.total || dados.items?.length || 0;
                
                if (!dados.items || dados.items.length === 0) {
                    lista.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 40px; color: #9ca3af;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                                <i class="fas fa-bell-slash" style="font-size: 32px; color: #9ca3af;"></i>
                            </div>
                            <p style="margin: 0; font-size: 17px; font-weight: 600; color: #374151;">Nenhuma notificaçéo encontrada</p>
                            <p style="margin: 10px 0 0; font-size: 14px; color: #9ca3af;">Tente ajustar os filtros de busca</p>
                        </div>
                    `;
                } else {
                    // Renderizar lista de notificações
                    lista.innerHTML = dados.items.map((notif, index) => {
                        const icone = notif.icone || getIconePorTipo(notif.tipo || notif.type);
                        const corIcone = getCorPorTipo(notif.tipo || notif.type);
                        const dataFormatada = formatarDataHistorico(notif.tempo || notif.created_at || notif.data);
                        
                        return `
                            <div class="historico-notif-item" style="
                                display: flex;
                                gap: 16px;
                                padding: 18px 28px;
                                border-bottom: 1px solid #f3f4f6;
                                transition: all 0.2s ease;
                                background: white;
                                ${notif.lida ? 'opacity: 0.65;' : ''}
                            ">
                                <div class="notif-icon-wrapper" style="
                                    width: 46px;
                                    height: 46px;
                                    border-radius: 12px;
                                    background: linear-gradient(135deg, ${corIcone}15, ${corIcone}25);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-shrink: 0;
                                    box-shadow: 0 2px 8px ${corIcone}20;
                                ">
                                    <i class="fas ${icone}" style="color: ${corIcone}; font-size: 18px;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                        <span style="font-weight: 700; color: #111827; font-size: 14px; line-height: 1.3;">
                                            ${notif.titulo || notif.title || 'Notificaçéo'}
                                        </span>
                                        <span style="font-size: 12px; color: #9ca3af; white-space: nowrap; margin-left: 16px; background: #f3f4f6; padding: 4px 10px; border-radius: 6px; font-weight: 500;">
                                            ${dataFormatada}
                                        </span>
                                    </div>
                                    <p style="margin: 0; font-size: 13px; color: #6b7280; line-height: 1.5;">
                                        ${notif.mensagem || notif.message || ''}
                                    </p>
                                    ${notif.importante ? '<span style="display: inline-flex; align-items: center; gap: 4px; margin-top: 8px; padding: 4px 10px; background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #dc2626; font-size: 11px; border-radius: 6px; font-weight: 600;"><i class="fas fa-star" style="font-size: 9px;"></i> Importante</span>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Atualizar contador
                document.getElementById('historico-contador').textContent = 
                    `Mostrando ${dados.items?.length || 0} de ${historicoNotificacoesTotal} notificações`;
                
                // Renderizar paginaçéo
                renderizarPaginacaoHistorico();
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                
                // Usar dados locais como fallback
                const dadosLocais = notificacoes.slice((pagina - 1) * historicoNotificacoesPorPagina, pagina * historicoNotificacoesPorPagina);
                historicoNotificacoesTotal = notificacoes.length;
                
                if (dadosLocais.length === 0) {
                    lista.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 40px; color: #9ca3af;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                                <i class="fas fa-bell-slash" style="font-size: 32px; color: #9ca3af;"></i>
                            </div>
                            <p style="margin: 0; font-size: 17px; font-weight: 600; color: #374151;">Nenhuma notificaçéo encontrada</p>
                        </div>
                    `;
                } else {
                    lista.innerHTML = dadosLocais.map((notif) => {
                        const icone = notif.icone || getIconePorTipo(notif.tipo);
                        const corIcone = getCorPorTipo(notif.tipo);
                        const dataFormatada = formatarDataHistorico(notif.tempo);
                        
                        return `
                            <div class="historico-notif-item" style="
                                display: flex;
                                gap: 16px;
                                padding: 18px 28px;
                                border-bottom: 1px solid #f3f4f6;
                                transition: all 0.2s ease;
                                background: white;
                            ">
                                <div class="notif-icon-wrapper" style="
                                    width: 46px;
                                    height: 46px;
                                    border-radius: 12px;
                                    background: linear-gradient(135deg, ${corIcone}15, ${corIcone}25);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-shrink: 0;
                                    box-shadow: 0 2px 8px ${corIcone}20;
                                ">
                                    <i class="fas ${icone}" style="color: ${corIcone}; font-size: 18px;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                        <span style="font-weight: 700; color: #111827; font-size: 14px; line-height: 1.3;">
                                            ${notif.titulo || 'Notificaçéo'}
                                        </span>
                                        <span style="font-size: 12px; color: #9ca3af; white-space: nowrap; margin-left: 16px; background: #f3f4f6; padding: 4px 10px; border-radius: 6px; font-weight: 500;">
                                            ${dataFormatada}
                                        </span>
                                    </div>
                                    <p style="margin: 0; font-size: 13px; color: #6b7280; line-height: 1.5;">
                                        ${notif.mensagem || ''}
                                    </p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('historico-contador').textContent = 
                    `Mostrando ${dadosLocais.length} de ${historicoNotificacoesTotal} notificações (offline)`;
                    
                renderizarPaginacaoHistorico();
            }
        }
        
        // Obter cor por tipo de notificaçéo
        function getCorPorTipo(tipo) {
            const cores = {
                'success': '#10b981',
                'warning': '#f59e0b',
                'error': '#ef4444',
                'info': '#3b82f6',
                'order': '#8b5cf6',
                'payment': '#10b981',
                'stock': '#f97316'
            };
            return cores[tipo] || '#6b7280';
        }
        
        // Formatar data para histórico
        function formatarDataHistorico(data) {
            if (!data) return '';
            
            const d = new Date(data);
            if (isNaN(d.getTime())) return data;
            
            const agora = new Date();
            const diff = agora - d;
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (dias === 0) {
                return `Hoje às ${d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (dias === 1) {
                return `Ontem às ${d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (dias < 7) {
                return `${dias} dias atrás`;
            } else {
                return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
        }
        
        // Renderizar paginaçéo do histórico
        function renderizarPaginacaoHistorico() {
            const container = document.getElementById('historico-paginacao');
            const totalPaginas = Math.ceil(historicoNotificacoesTotal / historicoNotificacoesPorPagina);
            
            if (totalPaginas <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Botéo anterior
            html += `
                <button onclick="carregarHistoricoNotificacoes(${historicoNotificacoesPagina - 1})" 
                    ${historicoNotificacoesPagina === 1 ? 'disabled' : ''} 
                    style="
                        padding: 8px 12px;
                        border: 1px solid ${historicoNotificacoesPagina === 1 ? '#e2e8f0' : '#f97316'};
                        background: ${historicoNotificacoesPagina === 1 ? '#f8fafc' : 'white'};
                        color: ${historicoNotificacoesPagina === 1 ? '#94a3b8' : '#f97316'};
                        border-radius: 8px;
                        cursor: ${historicoNotificacoesPagina === 1 ? 'not-allowed' : 'pointer'};
                        font-size: 13px;
                    ">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Números das páginas
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === 1 || i === totalPaginas || (i >= historicoNotificacoesPagina - 1 && i <= historicoNotificacoesPagina + 1)) {
                    html += `
                        <button onclick="carregarHistoricoNotificacoes(${i})" style="
                            padding: 8px 14px;
                            border: 1px solid ${i === historicoNotificacoesPagina ? '#f97316' : '#e2e8f0'};
                            background: ${i === historicoNotificacoesPagina ? '#f97316' : 'white'};
                            color: ${i === historicoNotificacoesPagina ? 'white' : '#64748b'};
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: ${i === historicoNotificacoesPagina ? '600' : '400'};
                        ">
                            ${i}
                        </button>
                    `;
                } else if (i === historicoNotificacoesPagina - 2 || i === historicoNotificacoesPagina + 2) {
                    html += `<span style="color: #94a3b8; padding: 0 4px;">...</span>`;
                }
            }
            
            // Botéo próximo
            html += `
                <button onclick="carregarHistoricoNotificacoes(${historicoNotificacoesPagina + 1})" 
                    ${historicoNotificacoesPagina === totalPaginas ? 'disabled' : ''} 
                    style="
                        padding: 8px 12px;
                        border: 1px solid ${historicoNotificacoesPagina === totalPaginas ? '#e2e8f0' : '#f97316'};
                        background: ${historicoNotificacoesPagina === totalPaginas ? '#f8fafc' : 'white'};
                        color: ${historicoNotificacoesPagina === totalPaginas ? '#94a3b8' : '#f97316'};
                        border-radius: 8px;
                        cursor: ${historicoNotificacoesPagina === totalPaginas ? 'not-allowed' : 'pointer'};
                        font-size: 13px;
                    ">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            container.innerHTML = html;
        }
        
        // Filtrar histórico de notificações
        function filtrarHistoricoNotificacoes() {
            carregarHistoricoNotificacoes(1);
        }
        
        // Exportar histórico de notificações
        function exportarHistoricoNotificacoes() {
            // Criar CSV das notificações
            let csv = 'Data;Tipo;Título;Mensagem;Status\n';
            
            notificacoes.forEach(notif => {
                const data = new Date(notif.tempo).toLocaleString('pt-BR');
                const tipo = notif.tipo || 'info';
                const titulo = (notif.titulo || '').replace(/;/g, ',');
                const mensagem = (notif.mensagem || '').replace(/;/g, ',').replace(/\n/g, ' ');
                const status = notif.lida ? 'Lida' : 'Néo lida';
                
                csv += `${data};${tipo};${titulo};${mensagem};${status}\n`;
            });
            
            // Download do arquivo
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `historico-notificacoes-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('📥 Histórico exportado com sucesso!', 'success');
        }
        
        // Adicionar nova notificaçéo localmente (para real-time)
        function adicionarNotificacao(tipo, titulo, mensagem, importante = false, data = {}) {
            const novaNotif = {
                id: Date.now(),
                tipo: tipo,
                icone: getIconePorTipo(tipo),
                titulo: titulo,
                mensagem: mensagem,
                tempo: new Date(),
                lida: false,
                importante: importante,
                data: data
            };
            
            notificacoes.unshift(novaNotif);
            renderizarNotificacoes();
            const naoLidas = notificacoes.filter(n => !n.lida).length;
            atualizarContador(naoLidas);
            
            // Efeito visual no badge
            const badge = document.getElementById('notification-count');
            badge.style.animation = 'none';
            setTimeout(() => badge.style.animation = '', 10);
        }
        
        function getIconePorTipo(tipo) {
            const icones = {
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle',
                'info': 'fa-info-circle',
                'order': 'fa-shopping-cart',
                'payment': 'fa-dollar-sign',
                'stock': 'fa-boxes'
            };
            return icones[tipo] || 'fa-bell';
        }
        
        // Criar notificaçéo no servidor (chamado de outras partes do código)
        async function criarNotificacaoServidor(tipo, titulo, mensagem, data = {}) {
            try {
                await fetch('/api/notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: tipo, title: titulo, message: mensagem, data })
                });
            } catch (error) {
                console.error('Erro ao criar notificaçéo:', error);
            }
        }

        // ========================================
        // FUNÇÕES DE EXPORTAÇéO
        // ========================================
        function abrirModalExportar() {
            document.getElementById('modal-exportar').classList.add('active');
            
            // Definir datas padréo (último mês)
            const hoje = new Date();
            const mesPassado = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            document.getElementById('export-data-inicio').value = mesPassado.toISOString().split('T')[0];
            document.getElementById('export-data-fim').value = hoje.toISOString().split('T')[0];
            
            // Eventos de seleçéo visual
            document.querySelectorAll('.opcao-export input').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.opcao-export-content').forEach(c => {
                        c.style.borderColor = '#e5e5e5';
                        c.style.background = 'white';
                    });
                    this.parentElement.querySelector('.opcao-export-content').style.borderColor = '#10b981';
                    this.parentElement.querySelector('.opcao-export-content').style.background = '#f0fdf4';
                });
            });
        }

        function fecharModalExportar() {
            document.getElementById('modal-exportar').classList.remove('active');
        }

        // ========================================
        // FUNÇÕES DOS MODAIS DE CADASTRO RÁPIDO
        // ========================================
        
        // Modal Condiçéo de Pagamento
        function abrirModalNovaCondicao() {
            document.getElementById('modal-nova-condicao').classList.add('active');
            document.getElementById('nova-condicao-nome').value = '';
            document.getElementById('nova-condicao-dias').value = '';
            document.getElementById('nova-condicao-descricao').value = '';
        }
        
        function fecharModalNovaCondicao() {
            document.getElementById('modal-nova-condicao').classList.remove('active');
        }
        
        async function salvarNovaCondicao() {
            const nome = document.getElementById('nova-condicao-nome').value.trim();
            const dias = document.getElementById('nova-condicao-dias').value.trim();
            
            if (!nome) {
                showNotification('Informe o nome da condiçéo', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/vendas/condicoes-pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, dias, descricao: document.getElementById('nova-condicao-descricao').value })
                });
                
                if (response.ok) {
                    showNotification('Condiçéo cadastrada com sucesso!', 'success');
                    fecharModalNovaCondicao();
                    // Adicionar opçéo no select
                    const select = document.getElementById('edit-condicao-pagamento');
                    if (select) {
                        const option = document.createElement('option');
                        option.value = dias || nome;
                        option.textContent = nome;
                        select.appendChild(option);
                        select.value = dias || nome;
                    }
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                showNotification('Erro ao cadastrar condiçéo', 'error');
            }
        }
        
        // Modal Tipo de Frete
        function abrirModalNovoTipoFrete() {
            document.getElementById('modal-novo-tipo-frete').classList.add('active');
            document.getElementById('novo-tipo-frete-codigo').value = '';
            document.getElementById('novo-tipo-frete-descricao').value = '';
        }
        
        function fecharModalNovoTipoFrete() {
            document.getElementById('modal-novo-tipo-frete').classList.remove('active');
        }
        
        async function salvarNovoTipoFrete() {
            const codigo = document.getElementById('novo-tipo-frete-codigo').value.trim();
            const descricao = document.getElementById('novo-tipo-frete-descricao').value.trim();
            
            if (!codigo || !descricao) {
                showNotification('Preencha todos os campos', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/vendas/tipos-frete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codigo, descricao })
                });
                
                if (response.ok) {
                    showNotification('Tipo de frete cadastrado!', 'success');
                    fecharModalNovoTipoFrete();
                    // Adicionar opçéo no select
                    const select = document.getElementById('edit-tipo-frete');
                    if (select) {
                        const option = document.createElement('option');
                        option.value = codigo;
                        option.textContent = `${codigo} - ${descricao}`;
                        select.appendChild(option);
                        select.value = codigo;
                    }
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                showNotification('Erro ao cadastrar tipo de frete', 'error');
            }
        }
        
        // Modal Regiéo
        function abrirModalNovaRegiao() {
            document.getElementById('modal-nova-regiao').classList.add('active');
            document.getElementById('nova-regiao-nome').value = '';
            document.getElementById('nova-regiao-estados').value = '';
            document.getElementById('nova-regiao-descricao').value = '';
        }
        
        function fecharModalNovaRegiao() {
            document.getElementById('modal-nova-regiao').classList.remove('active');
        }
        
        async function salvarNovaRegiao() {
            const nome = document.getElementById('nova-regiao-nome').value.trim();
            
            if (!nome) {
                showNotification('Informe o nome da regiéo', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/vendas/regioes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nome, 
                        estados: document.getElementById('nova-regiao-estados').value,
                        descricao: document.getElementById('nova-regiao-descricao').value 
                    })
                });
                
                if (response.ok) {
                    showNotification('Regiéo cadastrada com sucesso!', 'success');
                    fecharModalNovaRegiao();
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                showNotification('Erro ao cadastrar regiéo', 'error');
            }
        }
        
        // Modal Cargo
        function abrirModalNovoCargo() {
            document.getElementById('modal-novo-cargo').classList.add('active');
            document.getElementById('novo-cargo-nome').value = '';
            document.getElementById('novo-cargo-departamento').value = '';
            document.getElementById('novo-cargo-descricao').value = '';
        }
        
        function fecharModalNovoCargo() {
            document.getElementById('modal-novo-cargo').classList.remove('active');
        }
        
        async function salvarNovoCargo() {
            const nome = document.getElementById('novo-cargo-nome').value.trim();
            
            if (!nome) {
                showNotification('Informe o nome do cargo', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/cargos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nome, 
                        departamento: document.getElementById('novo-cargo-departamento').value,
                        descricao: document.getElementById('novo-cargo-descricao').value 
                    })
                });
                
                if (response.ok) {
                    showNotification('Cargo cadastrado com sucesso!', 'success');
                    fecharModalNovoCargo();
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                showNotification('Erro ao cadastrar cargo', 'error');
            }
        }
        
        // Modal Vendedor
        function abrirModalNovoVendedor() {
            document.getElementById('modal-novo-vendedor').classList.add('active');
            document.getElementById('novo-vendedor-nome').value = '';
            document.getElementById('novo-vendedor-email').value = '';
            document.getElementById('novo-vendedor-telefone').value = '';
            document.getElementById('novo-vendedor-regiao').value = '';
            document.getElementById('novo-vendedor-comissao').value = '';
        }
        
        function fecharModalNovoVendedor() {
            document.getElementById('modal-novo-vendedor').classList.remove('active');
        }
        
        async function salvarNovoVendedor() {
            const nome = document.getElementById('novo-vendedor-nome').value.trim();
            
            if (!nome) {
                showNotification('Informe o nome do vendedor', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/vendas/vendedores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nome,
                        email: document.getElementById('novo-vendedor-email').value,
                        telefone: document.getElementById('novo-vendedor-telefone').value,
                        regiao: document.getElementById('novo-vendedor-regiao').value,
                        comissao: document.getElementById('novo-vendedor-comissao').value || 5
                    })
                });
                
                if (response.ok) {
                    showNotification('Vendedor cadastrado com sucesso!', 'success');
                    fecharModalNovoVendedor();
                    // Adicionar opçéo no select
                    const select = document.getElementById('edit-vendedor');
                    if (select) {
                        const option = document.createElement('option');
                        option.value = nome;
                        option.textContent = nome.split(' ')[0];
                        select.appendChild(option);
                        select.value = nome;
                    }
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                showNotification('Erro ao cadastrar vendedor', 'error');
            }
        }
        
        // Eventos de fechar modais ao clicar fora
        document.getElementById('modal-nova-condicao')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovaCondicao();
        });
        document.getElementById('modal-novo-tipo-frete')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoTipoFrete();
        });
        document.getElementById('modal-nova-regiao')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovaRegiao();
        });
        document.getElementById('modal-novo-cargo')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoCargo();
        });
        document.getElementById('modal-novo-vendedor')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoVendedor();
        });

        // Função auxiliar para atualizar preview do relatório
        function atualizarPreviewRelatorio() {
            const tipo = document.getElementById('export-tipo-relatorio').value;
            const tiposNomes = {
                'pedidos': 'Pedidos/Orçamentos',
                'clientes': 'Clientes',
                'vendas': 'Resumo de Vendas',
                'faturamento': 'Faturamento'
            };
            const previewInfo = document.getElementById('export-preview-info');
            if (previewInfo) {
                previewInfo.querySelector('p:first-child').textContent = `Relatório de ${tiposNomes[tipo]} pronto`;
            }
        }

        // Função principal para gerar relatório PDF
        async function gerarRelatorioPDF() {
            const tipo = document.getElementById('export-tipo-relatorio').value;
            const dataInicio = document.getElementById('export-data-inicio').value;
            const dataFim = document.getElementById('export-data-fim').value;
            const incluirLogo = document.getElementById('export-incluir-logo').checked;
            const incluirTotais = document.getElementById('export-incluir-totais').checked;
            const agruparStatus = document.getElementById('export-agrupar-status').checked;

            showNotification('Gerando relatório PDF...', 'info');

            try {
                // Coletar dados baseado no tipo
                let dados = [];
                let titulo = '';
                
                if (tipo === 'pedidos' && window.dadosVendas) {
                    titulo = 'Relatório de Pedidos e Orçamentos';
                    const todosPedidos = [
                        ...(window.dadosVendas.orcamento || []).map(p => ({...p, etapa: 'Orçamento'})),
                        ...(window.dadosVendas.analise || []).map(p => ({...p, etapa: 'Análise de Crédito'})),
                        ...(window.dadosVendas.aprovado || []).map(p => ({...p, etapa: 'Aprovado'})),
                        ...(window.dadosVendas.faturar || []).map(p => ({...p, etapa: 'A Faturar'})),
                        ...(window.dadosVendas.faturado || []).map(p => ({...p, etapa: 'Faturado'})),
                        ...(window.dadosVendas.recibo || []).map(p => ({...p, etapa: 'Finalizado'}))
                    ];
                    dados = todosPedidos;
                } else if (tipo === 'clientes') {
                    titulo = 'Relatório de Clientes';
                } else if (tipo === 'vendas') {
                    titulo = 'Resumo de Vendas';
                } else if (tipo === 'faturamento') {
                    titulo = 'Relatório de Faturamento';
                }

                // Gerar PDF com template profissional
                await gerarPDFProfissional(titulo, dados, { dataInicio, dataFim, incluirLogo, incluirTotais, agruparStatus, tipo });
                
                fecharModalExportar();
                showNotification('Relatório PDF gerado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao gerar relatório: ' + error.message, 'error');
            }
        }

        async function gerarPDFProfissional(titulo, dados, opcoes) {
            // Calcular totais
            const totalValor = dados.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0);
            const totalPedidos = dados.length;
            
            // Agrupar por status se solicitado
            let conteudoTabela = '';
            if (opcoes.agruparStatus && dados.length > 0) {
                const grupos = {};
                dados.forEach(p => {
                    const etapa = p.etapa || 'Outros';
                    if (!grupos[etapa]) grupos[etapa] = [];
                    grupos[etapa].push(p);
                });
                
                Object.keys(grupos).forEach(etapa => {
                    const subtotal = grupos[etapa].reduce((s, p) => s + (parseFloat(p.valor) || 0), 0);
                    conteudoTabela += `
                        <tr style="background: #1e3a5f;">
                            <td colspan="5" style="padding: 10px 15px; color: white; font-weight: 600; font-size: 13px;">
                                ${etapa} (${grupos[etapa].length} itens) - Subtotal: R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                            </td>
                        </tr>
                    `;
                    grupos[etapa].forEach(p => {
                        conteudoTabela += `
                            <tr>
                                <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.id || '-'}</td>
                                <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.cliente || '-'}</td>
                                <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px; text-align: right;">R$ ${(parseFloat(p.valor) || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.vendedor || '-'}</td>
                                <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.created_at ? new Date(p.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                            </tr>
                        `;
                    });
                });
            } else {
                dados.forEach(p => {
                    conteudoTabela += `
                        <tr>
                            <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.id || '-'}</td>
                            <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.cliente || '-'}</td>
                            <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px; text-align: right;">R$ ${(parseFloat(p.valor) || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.etapa || p.status || '-'}</td>
                            <td style="padding: 12px 15px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${p.created_at ? new Date(p.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                        </tr>
                    `;
                });
            }

            // Template profissional seguindo padrão do orçamento
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>${titulo} - ALUFORCE</title>
                    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            background: #f5f5f5;
                            color: #333;
                        }
                        .page {
                            background: white;
                            max-width: 210mm;
                            margin: 20px auto;
                            padding: 0;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }
                        @media print {
                            body { background: white; }
                            .page { margin: 0; box-shadow: none; }
                            .no-print { display: none !important; }
                        }
                        
                        /* Header - Estilo Orçamento ALUFORCE */
                        .header {
                            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
                            padding: 30px 40px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .header-left {
                            display: flex;
                            align-items: center;
                            gap: 20px;
                        }
                        .logo-container {
                            width: 70px;
                            height: 70px;
                            background: linear-gradient(135deg, #f97316, #ea580c);
                            border-radius: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 4px 15px rgba(249,115,22,0.4);
                        }
                        .logo-container i { font-size: 32px; color: white; }
                        .company-info h1 {
                            color: white;
                            font-size: 28px;
                            font-weight: 700;
                            letter-spacing: 1px;
                        }
                        .company-info p {
                            color: rgba(255,255,255,0.7);
                            font-size: 13px;
                            margin-top: 4px;
                        }
                        .header-right {
                            text-align: right;
                            color: white;
                        }
                        .doc-type {
                            background: linear-gradient(135deg, #f97316, #ea580c);
                            color: white;
                            padding: 8px 20px;
                            border-radius: 25px;
                            font-size: 12px;
                            font-weight: 600;
                            letter-spacing: 1px;
                            text-transform: uppercase;
                            margin-bottom: 10px;
                            display: inline-block;
                        }
                        .doc-date {
                            font-size: 13px;
                            color: rgba(255,255,255,0.8);
                        }
                        
                        /* Barra de informações */
                        .info-bar {
                            background: #f97316;
                            padding: 15px 40px;
                            display: flex;
                            justify-content: space-between;
                            color: white;
                        }
                        .info-item {
                            text-align: center;
                        }
                        .info-item span {
                            font-size: 11px;
                            opacity: 0.9;
                            display: block;
                        }
                        .info-item strong {
                            font-size: 18px;
                            font-weight: 700;
                        }
                        
                        /* Conteúdo */
                        .content {
                            padding: 30px 40px;
                        }
                        .section-title {
                            font-size: 16px;
                            font-weight: 600;
                            color: #1e3a5f;
                            margin-bottom: 15px;
                            padding-bottom: 8px;
                            border-bottom: 2px solid #f97316;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .section-title i { color: #f97316; }
                        
                        /* Tabela */
                        .data-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        }
                        .data-table thead tr {
                            background: linear-gradient(135deg, #1e3a5f, #0f172a);
                        }
                        .data-table th {
                            padding: 15px;
                            color: white;
                            font-weight: 600;
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            text-align: left;
                        }
                        .data-table th:nth-child(3) { text-align: right; }
                        .data-table tbody tr:nth-child(even) { background: #f8fafc; }
                        .data-table tbody tr:hover { background: #fef3c7; }
                        
                        /* Totais */
                        .totals-section {
                            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
                            border: 2px solid #86efac;
                            border-radius: 12px;
                            padding: 20px 25px;
                            margin-top: 20px;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px 0;
                            border-bottom: 1px dashed #86efac;
                        }
                        .total-row:last-child { border-bottom: none; }
                        .total-row.grand-total {
                            font-size: 18px;
                            font-weight: 700;
                            color: #166534;
                            padding-top: 15px;
                            margin-top: 10px;
                            border-top: 2px solid #22c55e;
                        }
                        
                        /* Footer */
                        .footer {
                            background: #1e3a5f;
                            padding: 20px 40px;
                            text-align: center;
                            color: rgba(255,255,255,0.7);
                            font-size: 12px;
                        }
                        
                        /* Botões de ação */
                        .actions {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            display: flex;
                            gap: 10px;
                        }
                        .btn-action {
                            padding: 12px 24px;
                            border-radius: 8px;
                            border: none;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s;
                        }
                        .btn-print {
                            background: linear-gradient(135deg, #f97316, #ea580c);
                            color: white;
                        }
                        .btn-close {
                            background: #e5e7eb;
                            color: #374151;
                        }
                    </style>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                </head>
                <body>
                    <div class="actions no-print">
                        <button class="btn-action btn-print" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir / Salvar PDF
                        </button>
                        <button class="btn-action btn-close" onclick="window.close()">
                            <i class="fas fa-times"></i> Fechar
                        </button>
                    </div>
                    
                    <div class="page">
                        <div class="header">
                            <div class="header-left">
                                ${opcoes.incluirLogo ? `
                                <div class="logo-container">
                                    <i class="fas fa-industry"></i>
                                </div>
                                ` : ''}
                                <div class="company-info">
                                    <h1>ALUFORCE</h1>
                                    <p>Sistema de Gestão Empresarial</p>
                                </div>
                            </div>
                            <div class="header-right">
                                <div class="doc-type">Relatório</div>
                                <p class="doc-date">Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                            </div>
                        </div>
                        
                        ${opcoes.incluirTotais ? `
                        <div class="info-bar">
                            <div class="info-item">
                                <span>Total de Registros</span>
                                <strong>${totalPedidos}</strong>
                            </div>
                            <div class="info-item">
                                <span>Período</span>
                                <strong>${opcoes.dataInicio || 'Início'} a ${opcoes.dataFim || 'Hoje'}</strong>
                            </div>
                            <div class="info-item">
                                <span>Valor Total</span>
                                <strong>R$ ${totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="content">
                            <div class="section-title">
                                <i class="fas fa-list-alt"></i>
                                ${titulo}
                            </div>
                            
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nº</th>
                                        <th>Cliente</th>
                                        <th>Valor</th>
                                        <th>Status/Etapa</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${conteudoTabela || '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #666;">Nenhum dado encontrado para o período selecionado</td></tr>'}
                                </tbody>
                            </table>
                            
                            ${opcoes.incluirTotais ? `
                            <div class="totals-section">
                                <div class="total-row">
                                    <span>Total de registros:</span>
                                    <strong>${totalPedidos}</strong>
                                </div>
                                <div class="total-row grand-total">
                                    <span><i class="fas fa-coins"></i> VALOR TOTAL:</span>
                                    <strong>R$ ${totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="footer">
                            <p><strong>ALUFORCE</strong> - Sistema de Gestão Empresarial</p>
                            <p>Documento gerado automaticamente • ${new Date().toLocaleDateString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function executarExportacao() {
            // Mantido para compatibilidade - redireciona para nova função
            await gerarRelatorioPDF();
        }

        // Eventos dos modais de exportaçéo
        document.getElementById('modal-exportar')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalExportar();
        });

        document.getElementById('modal-novo-cliente')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoCliente();
        });

        document.getElementById('modal-novo-produto')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalNovoProduto();
        });

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar dados do usuário logado via API
            carregarUsuarioLogado();

            // Carregar configurações de impostos do sistema
            await carregarConfigImpostosSistema();

            // Carregar dados do Kanban da API e renderizar
            carregarDadosKanban();
            
            // Inicializar sistema de notificações
            inicializarNotificacoes();
            
            // Verificar se deve abrir modal de novo orçamento (vindo de outra página)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('novo') === 'true') {
                // Limpar parâmetro da URL sem recarregar
                window.history.replaceState({}, document.title, window.location.pathname);
                // Aguardar um pouco para garantir que tudo está carregado
                setTimeout(() => {
                    novoOrcamento();
                }, 500);
            }
        });
    </script>
    
    <!-- Font Awesome para ícones do chat/suporte -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Sistema de Chat e Suporte (widgets condicionais por usuário) -->
    
    <!-- Sistema de Monitoramento de Conexéo -->
    <script src="../../_shared/connection-monitor.js?v=20251223"></script>
    
    <!-- Sistema de Confirmaçéo Profissional -->
    <script src="../../_shared/confirm-dialog.js?v=20260119"></script>
    
    <!-- Serviço de Dados da Empresa para Impressões -->
    <script src="/js/empresa-service.js?v=20260120"></script>
    
    <script src="/js/popup-confirmacao.js"></script>
    <script src="/js/unsaved-changes.js?v=20260108"></script>
    <script src="/js/modal-integration.js?v=20260108"></script>
</body>
</html>


