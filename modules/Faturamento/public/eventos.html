<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aluforce: Faturamento — Eventos NF-e</title>
    <script src="/js/auth-unified.js?v=20260204" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../css/faturamento-layout.css?v=20260220">
    <link rel="stylesheet" href="/css/global-header-sidebar.css?v=20260216">
    <link rel="stylesheet" href="/css/tooltips-professional.css?v=20260209">
    <!-- Chat Widget BOB AI -->
    <link rel="stylesheet" href="/chat/widget.css?v=20260218">
</head>
<body>
<div class="app-container">
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <aside class="sidebar" id="mobile-sidebar">
        <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel"><i class="fas fa-home"></i></a>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="sidebar-btn" title="Dashboard"><i class="fas fa-tachometer-alt"></i></a>
            <a href="index.html" class="sidebar-btn" title="NF-e"><i class="fas fa-file-invoice-dollar"></i></a>
            <a href="emitir.html" class="sidebar-btn" title="Emitir NF-e"><i class="fas fa-plus-circle"></i></a>
            <a href="consultar.html" class="sidebar-btn" title="Consultar"><i class="fas fa-search"></i></a>
            <a href="danfe.html" class="sidebar-btn" title="DANFE"><i class="fas fa-file-pdf"></i></a>
            <a href="nfse.html" class="sidebar-btn" title="NFS-e"><i class="fas fa-file-contract"></i></a>
            <a href="logistica.html" class="sidebar-btn" title="Logística"><i class="fas fa-truck"></i></a>
            <a href="eventos.html" class="sidebar-btn active" title="Eventos"><i class="fas fa-calendar-check"></i></a>
            <a href="inutilizacao.html" class="sidebar-btn" title="Inutilização"><i class="fas fa-ban"></i></a>
            <a href="regua.html" class="sidebar-btn" title="Régua Cobrança"><i class="fas fa-bell"></i></a>
            <a href="pix.html" class="sidebar-btn" title="PIX"><i class="fas fa-qrcode"></i></a>
        </nav>
        <div class="sidebar-bottom">
            <a href="relatorios.html" class="sidebar-btn" title="Relatórios"><i class="fas fa-chart-bar"></i></a>
        </div>
    </aside>

    <main class="main-area">
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu"><i class="fas fa-bars"></i></button>
                <div class="header-brand" style="display:flex;align-items:center;gap:10px;">
                    <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE" style="height:22px;object-fit:contain;">
                    <span style="color:rgba(255,255,255,0.2);font-weight:300;font-size:18px;">|</span>
                    <img src="/images/zyntra-branco.png" alt="Zyntra" style="height:22px;object-fit:contain;">
                    <span style="color:rgba(255,255,255,0.3);font-size:12px;margin-left:4px;">— Faturamento</span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" title="Atualizar" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
                <div class="user-greeting">
                    <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                    <div class="user-avatar" id="user-avatar">
                        <img src="" alt="" id="user-photo" style="display:none;width:100%;height:100%;border-radius:50%;object-fit:cover;">
                        <span id="user-initials">U</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="page-content">
            <div class="page-header">
                <div class="page-header-top">
                    <div class="page-title-wrapper">
                        <div class="page-icon yellow"><i class="fas fa-calendar-check"></i></div>
                        <div>
                            <h1 class="page-title">Eventos da NF-e</h1>
                            <p class="page-subtitle">Cancelamento, Carta de Correção (CC-e) e Histórico</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="alertContainer"></div>

            <!-- Localizar NF-e -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-search"></i> Selecionar NF-e</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ID / Número da NF-e</label>
                            <input type="text" class="form-control" id="nfeId" placeholder="Informe o ID ou número">
                        </div>
                        <div class="form-group" style="display:flex;align-items:flex-end;">
                            <button class="btn btn-primary" onclick="carregarNFe()"><i class="fas fa-search"></i> Carregar</button>
                        </div>
                    </div>
                    <div id="nfeInfo" class="hidden" style="margin-top:16px;">
                        <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
                            <div class="stat-card"><div class="stat-label">Número</div><div class="stat-value" style="font-size:18px;" id="infoNumero">-</div></div>
                            <div class="stat-card"><div class="stat-label">Série</div><div class="stat-value" style="font-size:18px;" id="infoSerie">-</div></div>
                            <div class="stat-card"><div class="stat-label">Chave</div><div class="stat-value font-mono" style="font-size:11px;word-break:break-all;" id="infoChave">-</div></div>
                            <div class="stat-card"><div class="stat-label">Status</div><div id="infoStatus">-</div></div>
                            <div class="stat-card"><div class="stat-label">Data Autorização</div><div class="stat-value" style="font-size:14px;" id="infoDataAutorizacao">-</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="config-grid">
                <!-- Card Cancelamento -->
                <div class="card" id="cardCancelamento">
                    <div class="card-header">
                        <h3 class="card-title" style="color:var(--danger);"><i class="fas fa-times-circle"></i> Cancelamento</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert warning" style="margin-bottom:16px;">
                            <i class="fas fa-exclamation-triangle"></i> O cancelamento é irreversível. Prazo máximo: 24h após autorização.
                        </div>
                        <div class="form-group">
                            <label>Justificativa (mín. 15 caracteres)</label>
                            <textarea class="form-control" id="justificativaCancelamento" rows="3" maxlength="255" placeholder="Descreva o motivo do cancelamento..." oninput="atualizarContador('justificativaCancelamento','charCounterCancelamento',255)"></textarea>
                            <div class="char-counter" id="charCounterCancelamento">0 / 255</div>
                        </div>
                        <button class="btn btn-danger w-full" onclick="cancelarNFe()"><i class="fas fa-times-circle"></i> Cancelar NF-e</button>
                    </div>
                </div>

                <!-- Card CCe -->
                <div class="card" id="cardCCe">
                    <div class="card-header">
                        <h3 class="card-title" style="color:var(--warning);"><i class="fas fa-edit"></i> Carta de Correção (CC-e)</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert info" style="margin-bottom:16px;">
                            <i class="fas fa-info-circle"></i> A CC-e não pode corrigir valores, quantidades, CFOP, datas ou dados do destinatário.
                        </div>
                        <div class="form-group">
                            <label>Texto da Correção (mín. 15 caracteres)</label>
                            <textarea class="form-control" id="correcaoCCe" rows="3" maxlength="1000" placeholder="Descreva a correção..." oninput="atualizarContador('correcaoCCe','charCounterCCe',1000)"></textarea>
                            <div class="char-counter" id="charCounterCCe">0 / 1000</div>
                        </div>
                        <button class="btn btn-primary w-full" onclick="registrarCCe()"><i class="fas fa-edit"></i> Registrar CC-e</button>
                    </div>
                </div>
            </div>

            <!-- Histórico de Eventos -->
            <div class="card mt-6" id="cardEventos">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history"></i> Histórico de Eventos</h3>
                </div>
                <div class="card-body">
                    <div class="timeline" id="listaEventos">
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <h3>Nenhum evento registrado</h3>
                            <p>Selecione uma NF-e para ver seus eventos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function toggleMobileSidebar() {
    const sidebar = document.getElementById('mobile-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
}

function showAlert(message, type) {
    const c = document.getElementById('alertContainer');
    const a = document.createElement('div');
    a.className = 'alert ' + type;
    a.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${message}`;
    c.appendChild(a);
    setTimeout(() => a.remove(), 5000);
}

function atualizarContador(textareaId, counterId, max) {
    const ta = document.getElementById(textareaId);
    const counter = document.getElementById(counterId);
    const len = ta.value.length;
    counter.textContent = `${len} / ${max}`;
    counter.className = 'char-counter' + (len > max * 0.9 ? ' danger' : len > max * 0.7 ? ' warning' : '');
}

async function carregarNFe() {
    const nfeId = document.getElementById('nfeId').value;
    if (!nfeId) { showAlert('Informe o ID da NF-e', 'warning'); return; }
    try {
        const r = await fetch(`/api/nfe/${nfeId}`, { credentials: 'include' });
        if (r.ok) {
            const nfe = await r.json();
            document.getElementById('infoNumero').textContent = nfe.numero || '-';
            document.getElementById('infoSerie').textContent = nfe.serie || '-';
            document.getElementById('infoChave').textContent = nfe.chave_acesso || '-';
            document.getElementById('infoStatus').innerHTML = `<span class="badge ${(nfe.status||'').toLowerCase()}">${nfe.status || '-'}</span>`;
            document.getElementById('infoDataAutorizacao').textContent = nfe.data_autorizacao ? new Date(nfe.data_autorizacao).toLocaleString('pt-BR') : '-';
            document.getElementById('nfeInfo').classList.remove('hidden');
            carregarEventos(nfeId);
        } else { showAlert('NF-e não encontrada', 'danger'); }
    } catch(e) { showAlert('Erro ao carregar NF-e', 'danger'); }
}

async function carregarEventos(id) {
    id = id || document.getElementById('nfeId').value;
    try {
        const r = await fetch(`/api/nfe/${id}/eventos`, { credentials: 'include' });
        if (r.ok) {
            const eventos = await r.json();
            const lista = Array.isArray(eventos) ? eventos : eventos.data || [];
            const el = document.getElementById('listaEventos');
            if (!lista.length) { el.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><p>Nenhum evento registrado</p></div>'; return; }
            el.innerHTML = lista.map(ev => `
                <div class="timeline-item">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong style="font-size:13px;">${ev.tipo || ev.evento || 'Evento'}</strong>
                        <span class="text-muted" style="font-size:11px;">${ev.data ? new Date(ev.data).toLocaleString('pt-BR') : '-'}</span>
                    </div>
                    <p style="margin:0;font-size:12px;color:var(--text-secondary);">${ev.descricao || ev.justificativa || '-'}</p>
                    ${ev.protocolo ? '<p style="margin:4px 0 0;font-size:11px;"><span class="code">' + ev.protocolo + '</span></p>' : ''}
                </div>
            `).join('');
        }
    } catch(e) { console.error('Erro:', e); }
}

async function cancelarNFe() {
    const id = document.getElementById('nfeId').value;
    const just = document.getElementById('justificativaCancelamento').value;
    if (!id) { showAlert('Selecione uma NF-e primeiro', 'warning'); return; }
    if (just.length < 15) { showAlert('Justificativa deve ter no mínimo 15 caracteres', 'warning'); return; }
    if (!confirm('ATENÇÃO: O cancelamento é IRREVERSÍVEL. Deseja continuar?')) return;
    try {
        const r = await fetch(`/api/nfe/${id}/cancelar`, { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify({ justificativa: just }) });
        if (r.ok) { showAlert('NF-e cancelada com sucesso!', 'success'); carregarNFe(); }
        else { const e = await r.json(); showAlert(e.message || 'Erro ao cancelar', 'danger'); }
    } catch(e) { showAlert('Erro de conexão', 'danger'); }
}

async function registrarCCe() {
    const id = document.getElementById('nfeId').value;
    const correcao = document.getElementById('correcaoCCe').value;
    if (!id) { showAlert('Selecione uma NF-e primeiro', 'warning'); return; }
    if (correcao.length < 15) { showAlert('Texto da correção deve ter no mínimo 15 caracteres', 'warning'); return; }
    try {
        const r = await fetch(`/api/nfe/${id}/cce`, { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify({ correcao }) });
        if (r.ok) { showAlert('CC-e registrada com sucesso!', 'success'); carregarEventos(id); document.getElementById('correcaoCCe').value = ''; }
        else { const e = await r.json(); showAlert(e.message || 'Erro ao registrar CC-e', 'danger'); }
    } catch(e) { showAlert('Erro de conexão', 'danger'); }
}

function carregarDadosUsuario() {
    const h = new Date().getHours();
    document.getElementById('greeting-text').textContent = h < 12 ? 'Bom dia' : h < 18 ? 'Boa tarde' : 'Boa noite';
    fetch('/api/me', { credentials: 'include' })
        .then(r => r.json())
        .then(u => {
            const nome = u.nome || u.name || 'Usuário';
            document.getElementById('user-name').textContent = nome.split(' ')[0];
            document.getElementById('user-initials').textContent = nome.substring(0,2).toUpperCase();
            if (u.foto || u.avatar) { document.getElementById('user-photo').src = u.foto||u.avatar; document.getElementById('user-photo').style.display='block'; document.getElementById('user-initials').style.display='none'; }
        }).catch(() => {});
}

document.addEventListener('DOMContentLoaded', () => { carregarDadosUsuario(); });
</script>
<script src="/js/tooltips-professional.js?v=20260209"></script>
<script src="/js/mobile-auto-enhance.js?v=20260202" defer></script>

<!-- ALUFORCE: Confirm Dialog Profissional v2.0 --><script src="/_shared/confirm-dialog.js?v=20260217"></script>
    <!-- Chat Widget BOB AI - DESATIVADO 23/02/2026 -->
    <!-- <script src="/chat/widget.js?v=20260218" defer></script> -->
    <script src="/_shared/accessibility-widget.js?v=20260226"></script>
</body>
</html>
