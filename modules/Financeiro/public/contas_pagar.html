<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Aluforce: Contas a Pagar</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Design System Institucional Financeiro -->
    <link rel="stylesheet" href="css/fin-layout.css?v=20260216">
    <link rel="stylesheet" href="css/fin-components.css?v=20260216">
    <link rel="stylesheet" href="css/fin-header-sidebar.css?v=20260216">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/importar-xlsx.js"></script>
    <script src="/js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">
    <script src="/js/modal-title.js?v=20260210"></script>

    <style>
        /* ===== CONTAS A PAGAR — ESTILOS ESPECÍFICOS ===== */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 18px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-100);
        }
        .summary-value {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .summary-label {
            font-size: 12px;
            color: var(--gray-500);
            font-weight: 500;
        }

        .search-bar-global {
            margin-bottom: 16px;
        }
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input-wrapper > i {
            position: absolute;
            left: 14px;
            color: var(--gray-400);
            font-size: 14px;
        }
        .search-input-global {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            background: white;
            transition: border-color 0.2s;
        }
        .search-input-global:focus {
            outline: none;
            border-color: var(--info-500);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        .btn-clear-search {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
            display: none;
        }

        .filters-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            min-width: 150px;
            background: white;
        }
        .filter-input:focus {
            outline: none;
            border-color: var(--info-500);
        }
        .btn-limpar-filtros {
            padding: 8px 14px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-limpar-filtros:hover { background: var(--gray-200); }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }
        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 10px 16px;
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }
        td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-100);
        }
        tr:hover td { background: var(--gray-50); }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-overdue { background: #fee2e2; color: #991b1b; }

        .action-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            margin-right: 2px;
        }
        .action-btn.view { background: #dbeafe; color: #1e40af; }
        .action-btn.view:hover { background: #bfdbfe; }
        .action-btn.success { background: #dcfce7; color: #166534; }
        .action-btn.success:hover { background: #bbf7d0; }
        .action-btn.edit { background: #fef3c7; color: #92400e; }
        .action-btn.edit:hover { background: #fde68a; }
        .action-btn.danger { background: #fee2e2; color: #991b1b; }
        .action-btn.danger:hover { background: #fecaca; }

        .btn-success {
            padding: 8px 16px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-success:hover { background: #047857; }

        .highlight { background: #fef9c3; padding: 0 2px; border-radius: 2px; }

        /* ===== MODAIS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Modal Institucional */
        .modal-institucional {
            max-width: 700px;
        }
        .modal-header-institucional {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 24px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border-radius: 16px 16px 0 0;
            color: white;
        }
        .modal-header-icon {
            width: 42px;
            height: 42px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .modal-header-info { flex: 1; }
        .modal-title { font-size: 17px; font-weight: 700; margin: 0; color: white; }
        .modal-subtitle { font-size: 12px; opacity: 0.85; margin: 2px 0 0; }
        .close-modal-inst {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.8;
        }
        .close-modal-inst:hover { opacity: 1; }

        .form-section {
            border: 1px solid var(--gray-100);
            border-radius: 10px;
            margin: 16px 24px;
            overflow: hidden;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-100);
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-700);
        }
        .section-header i { color: var(--info-500); }
        .section-header h4 { margin: 0; font-size: 13px; }
        .section-content { padding: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 6px;
        }
        .form-group label i { color: var(--gray-400); font-size: 12px; }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            color: var(--gray-800);
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--info-500);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        .input-hint {
            font-size: 11px;
            color: var(--gray-400);
            margin-top: 4px;
            display: block;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        .input-with-prefix {
            display: flex;
            align-items: center;
        }
        .input-prefix {
            padding: 10px 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
        }
        .form-input.with-prefix {
            border-radius: 0 8px 8px 0;
        }
        .parcelas-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .parcelas-info {
            font-size: 12px;
            color: var(--gray-500);
            font-weight: 500;
        }
        .parcelas-preview {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
        }
        .preview-header {
            padding: 10px 14px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .parcela-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 14px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 12px;
        }
        .parcela-item:last-child { border-bottom: none; }
        .parcela-numero { font-weight: 600; color: var(--gray-700); }
        .parcela-data { color: var(--gray-500); }
        .parcela-valor { font-weight: 700; color: var(--gray-800); }

        .form-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--gray-600);
        }
        .checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--info-500);
        }

        .modal-footer-institucional {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
            border-radius: 0 0 16px 16px;
        }
        .footer-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--gray-400);
        }
        .footer-actions {
            display: flex;
            gap: 10px;
        }
        .btn-cancel {
            padding: 10px 20px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-cancel:hover { background: var(--gray-50); }
        .btn-save {
            padding: 10px 20px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-save:hover { opacity: 0.9; }

        /* Modal Visualizar */
        .modal-visualizar { max-width: 600px; }
        .view-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
        }
        .view-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .view-id {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-400);
            background: var(--gray-100);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .close-view {
            background: none;
            border: none;
            font-size: 22px;
            color: var(--gray-400);
            cursor: pointer;
        }
        .view-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0 0 8px;
        }
        .view-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .view-badge.pending { background: #fef3c7; color: #92400e; }
        .view-badge.paid { background: #dcfce7; color: #166534; }
        .view-badge.overdue { background: #fee2e2; color: #991b1b; }
        .view-body { padding: 20px 24px; }
        .view-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .view-item.full { grid-column: 1 / -1; }
        .view-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .view-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
        }
        .view-value.destaque {
            font-size: 20px;
            font-weight: 800;
            color: #1e40af;
        }
        .view-pagamento-info {
            margin-top: 16px;
            padding: 16px;
            background: #dcfce7;
            border-radius: 10px;
        }
        .view-pagamento-info h4 {
            font-size: 13px;
            font-weight: 700;
            color: #166534;
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .view-pagamento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .view-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-100);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-view-action {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-view-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-view-secondary:hover { background: var(--gray-200); }
        .btn-view-primary { background: #059669; color: white; }
        .btn-view-primary:hover { background: #047857; }

        /* Modal Pagar */
        .modal-pagar { max-width: 480px; }
        .modal-pagar-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 24px;
            background: linear-gradient(135deg, #059669, #10b981);
            border-radius: 16px 16px 0 0;
            color: white;
        }
        .modal-pagar-header .icon {
            width: 42px;
            height: 42px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .modal-pagar-header .info { flex: 1; }
        .modal-pagar-header .info h3 { font-size: 17px; font-weight: 700; margin: 0; }
        .modal-pagar-header .info p { font-size: 12px; opacity: 0.85; margin: 2px 0 0; }
        .modal-pagar-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }
        .modal-pagar-body { padding: 20px 24px; }
        .modal-pagar-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-100);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Notification Dropdown */
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border: 1px solid var(--gray-200);
            z-index: 1000;
            overflow: hidden;
        }
        .notification-dropdown.active { display: block; }

        /* Responsive */
        @media (max-width: 1024px) {
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .summary-cards { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .filters-bar { flex-direction: column; }
        }
    </style>
    <!-- Chat Widget BOB AI -->
    <link rel="stylesheet" href="/chat/widget.css?v=20260218">
</head>
<body>
    <div class="app-container">
        <!-- Overlay Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="mobile-sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>
            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-btn" title="Dashboard">
                    <i class="fas fa-chart-pie"></i>
                </a>
                <a href="contas_pagar.html" class="sidebar-btn active" title="Contas a Pagar">
                    <i class="fas fa-file-invoice-dollar"></i>
                </a>
                <a href="contas_receber.html" class="sidebar-btn" title="Contas a Receber">
                    <i class="fas fa-hand-holding-usd"></i>
                </a>
                <a href="contas_bancarias.html" class="sidebar-btn" title="Contas Bancárias">
                    <i class="fas fa-university"></i>
                </a>
                <a href="fluxo_caixa.html" class="sidebar-btn" title="Fluxo de Caixa">
                    <i class="fas fa-money-bill-wave"></i>
                </a>
                <a href="relatorios.html" class="sidebar-btn" title="Relatórios">
                    <i class="fas fa-chart-bar"></i>
                </a>
            </nav>
            <div class="sidebar-bottom">
                <a href="/dashboard" class="sidebar-btn" title="Configurações">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </aside>

        <!-- Main -->
        <main class="main-area" data-page-name="Contas a Pagar">
            <header class="header" id="financeiro-header">
                <div class="header-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-brand">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE" style="height:22px;object-fit:contain;">
                        <span class="header-separator">|</span>
                        <img src="/images/zyntra-branco.png" alt="Zyntra" style="height:22px;object-fit:contain;">
                        <span class="header-dash">—</span>
                        <span class="page-title">Contas a Pagar</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn" title="Nova Despesa" onclick="abrirModal()"><i class="fas fa-plus"></i></button>
                    <button class="header-btn" title="Atualizar" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
                    <div class="notification-container">
                        <button class="header-btn notification-btn" title="Notificações" onclick="toggleNotificacoes()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count" style="display:none;">0</span>
                        </button>
                    </div>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img src="" alt="Foto do usuário" id="user-photo" style="display:none;">
                            <span id="user-initials">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Resumo -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value" style="color:#ef4444;" id="total-pagar">R$ 0,00</div>
                        <div class="summary-label">Total a Pagar</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color:#f59e0b;" id="total-vencendo">R$ 0,00</div>
                        <div class="summary-label">Vencendo (7 dias)</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color:#dc2626;" id="total-vencidas">R$ 0,00</div>
                        <div class="summary-label">Vencidas</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" style="color:#16a34a;" id="total-pagas">R$ 0,00</div>
                        <div class="summary-label">Pagas este Mês</div>
                    </div>
                </div>

                <!-- Pesquisa Global -->
                <div class="search-bar-global">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="pesquisa-global" class="search-input-global" placeholder="Pesquisar por descrição, fornecedor, valor, documento..." oninput="pesquisarGlobal()">
                        <button class="btn-clear-search" onclick="limparPesquisa()" title="Limpar pesquisa">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Período</label>
                        <select class="filter-input" id="filtro-periodo" onchange="filtrarContas()">
                            <option value="todas">Todas</option>
                            <option value="mes">Este Mês</option>
                            <option value="proximos7">Próximos 7 dias</option>
                            <option value="proximos30">Próximos 30 dias</option>
                            <option value="vencidas">Vencidas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-tag"></i> Status</label>
                        <select class="filter-input" id="filtro-status" onchange="filtrarContas()">
                            <option value="">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-truck"></i> Fornecedor</label>
                        <select class="filter-input" id="filtro-fornecedor-select" onchange="filtrarContas()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group" style="align-self:end;">
                        <button class="btn-limpar-filtros" onclick="limparFiltros()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Listagem de Contas a Pagar</h3>
                        <div>
                            <button class="btn-success" onclick="exportarExcel()">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Fornecedor</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-contas">
                            <tr>
                                <td colspan="7" style="text-align:center;padding:60px;color:var(--gray-400);">
                                    <i class="fas fa-spinner fa-spin" style="font-size:48px;margin-bottom:16px;display:block;"></i>
                                    Carregando contas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nova/Editar Conta -->
    <div id="modal-conta" class="modal">
        <div class="modal-content modal-institucional">
            <div class="modal-header-institucional">
                <div class="modal-header-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="modal-header-info">
                    <h3 class="modal-title" id="modal-titulo">Nova Despesa</h3>
                    <p class="modal-subtitle">Preencha os dados da conta a pagar</p>
                </div>
                <button class="close-modal-inst" onclick="fecharModal()">×</button>
            </div>
            <form id="form-conta" onsubmit="salvarConta(event)">
                <input type="hidden" id="conta-id">
                <div class="form-section">
                    <div class="section-header"><i class="fas fa-info-circle"></i><h4>Informações Principais</h4></div>
                    <div class="section-content">
                        <div class="form-group full">
                            <label><i class="fas fa-align-left"></i> Descrição *</label>
                            <input type="text" class="form-input" id="descrição" required placeholder="Ex: Compra de materiais, Aluguel, Energia...">
                            <span class="input-hint">Descreva brevemente o motivo da despesa</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-truck"></i> Fornecedor *</label>
                                <select class="form-input" id="fornecedor-id" required><option value="">Selecione o fornecedor...</option></select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-tags"></i> Categoria *</label>
                                <select class="form-input" id="categoria-id" required><option value="">Selecione a categoria...</option></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="section-header"><i class="fas fa-dollar-sign"></i><h4>Valores e Datas</h4></div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-money-bill-wave"></i> Valor Total *</label>
                                <div class="input-with-prefix">
                                    <span class="input-prefix">R$</span>
                                    <input type="number" step="0.01" min="0.01" class="form-input with-prefix" id="conta-valor" required placeholder="0,00" oninput="calcularParcelas()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-calendar-alt"></i> Vencimento *</label>
                                <input type="date" class="form-input" id="conta-vencimento" required onchange="calcularParcelas()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-credit-card"></i> Forma de Pagamento</label>
                                <select class="form-input" id="forma-pagamento">
                                    <option value="pix">PIX</option>
                                    <option value="transferencia">Transferência Bancária</option>
                                    <option value="boleto">Boleto</option>
                                    <option value="cartao">Cartão</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cheque">Cheque</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-layer-group"></i> Parcelas</label>
                                <div class="parcelas-wrapper">
                                    <input type="number" min="1" max="48" value="1" class="form-input" id="conta-parcelas" oninput="calcularParcelas()">
                                    <span class="parcelas-info">parcela(s)</span>
                                </div>
                            </div>
                        </div>
                        <div class="parcelas-preview" id="parcelas-preview" style="display:none;">
                            <div class="preview-header"><i class="fas fa-list-ol"></i> Prévia das Parcelas</div>
                            <div class="preview-content" id="parcelas-preview-content"></div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="section-header"><i class="fas fa-clipboard-list"></i><h4>Informações Adicionais</h4></div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-file-alt"></i> Nº Documento</label>
                                <input type="text" class="form-input" id="numero-documento" placeholder="NF, Boleto, etc...">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Centro de Custo</label>
                                <select class="form-input" id="centro-custo"><option value="">Selecione (opcional)</option></select>
                            </div>
                        </div>
                        <div class="form-group full">
                            <label><i class="fas fa-comment"></i> Observações</label>
                            <textarea class="form-input" id="observacoes" rows="3" placeholder="Informações adicionais sobre a despesa..."></textarea>
                        </div>
                        <div class="form-options">
                            <label class="checkbox-option"><input type="checkbox" id="conta-recorrente"> <span><i class="fas fa-sync"></i> Despesa Recorrente</span></label>
                            <label class="checkbox-option"><input type="checkbox" id="conta-prioritaria"> <span><i class="fas fa-exclamation-triangle"></i> Alta Prioridade</span></label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer-institucional">
                    <div class="footer-info"><i class="fas fa-info-circle"></i><span>Campos com * são obrigatórios</span></div>
                    <div class="footer-actions">
                        <button type="button" class="btn-cancel" onclick="fecharModal()"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="submit" class="btn-save"><i class="fas fa-save"></i> Salvar Despesa</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Visualizar -->
    <div id="modal-visualizar" class="modal">
        <div class="modal-content modal-visualizar">
            <div class="view-header">
                <div class="view-header-top">
                    <span class="view-id" id="view-id">#000</span>
                    <button class="close-view" onclick="fecharModalVisualizar()">×</button>
                </div>
                <h3 class="view-title" id="view-descrição">Descrição da Conta</h3>
                <div><span id="view-status-badge" class="view-badge pending"><i class="fas fa-clock"></i> Pendente</span></div>
            </div>
            <div class="view-body">
                <div class="view-grid">
                    <div class="view-item"><div class="view-label"><i class="fas fa-dollar-sign"></i> Valor</div><div class="view-value destaque" id="view-valor">R$ 0,00</div></div>
                    <div class="view-item"><div class="view-label"><i class="fas fa-calendar"></i> Vencimento</div><div class="view-value" id="view-vencimento">-</div></div>
                    <div class="view-item"><div class="view-label"><i class="fas fa-truck"></i> Fornecedor</div><div class="view-value" id="view-fornecedor">-</div></div>
                    <div class="view-item"><div class="view-label"><i class="fas fa-tags"></i> Categoria</div><div class="view-value" id="view-categoria">-</div></div>
                    <div class="view-item"><div class="view-label"><i class="fas fa-credit-card"></i> Forma de Pagamento</div><div class="view-value" id="view-forma">-</div></div>
                    <div class="view-item"><div class="view-label"><i class="fas fa-file-alt"></i> Nº Documento</div><div class="view-value" id="view-documento">-</div></div>
                    <div class="view-item full"><div class="view-label"><i class="fas fa-comment"></i> Observações</div><div class="view-value" id="view-observacoes" style="font-weight:normal;font-size:14px;">-</div></div>
                </div>
                <div class="view-pagamento-info" id="view-pagamento-info" style="display:none;">
                    <h4><i class="fas fa-check-circle"></i> Informações do Pagamento</h4>
                    <div class="view-pagamento-grid">
                        <div><div class="view-label">Data Pagamento</div><div class="view-value" id="view-data-pagamento">-</div></div>
                        <div><div class="view-label">Valor Pago</div><div class="view-value" id="view-valor-pago">-</div></div>
                    </div>
                </div>
            </div>
            <div class="view-footer">
                <button class="btn-view-action btn-view-secondary" onclick="editarContaFromView()"><i class="fas fa-edit"></i> Editar</button>
                <button class="btn-view-action btn-view-primary" id="btn-pagar-view" onclick="pagarContaFromView()"><i class="fas fa-check-circle"></i> Pagar Conta</button>
            </div>
        </div>
    </div>

    <!-- Modal Pagar -->
    <div id="modal-pagar" class="modal">
        <div class="modal-content modal-pagar">
            <div class="modal-pagar-header">
                <div class="icon"><i class="fas fa-check-double"></i></div>
                <div class="info"><h3>Confirmar Pagamento</h3><p>Registre os dados do pagamento</p></div>
                <button class="close-btn" onclick="fecharModalPagar()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;opacity:0.8;">×</button>
            </div>
            <form id="form-pagar" onsubmit="confirmarPagamento(event)">
                <input type="hidden" id="pagar-conta-id">
                <div class="modal-pagar-body">
                    <div class="form-group">
                        <label><i class="fas fa-money-bill-wave"></i> Valor Pago *</label>
                        <div class="input-with-prefix"><span class="input-prefix">R$</span><input type="number" step="0.01" class="form-input with-prefix" id="pagar-valor" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label><i class="fas fa-calendar"></i> Data do Pagamento *</label><input type="date" class="form-input" id="pagar-data" required></div>
                        <div class="form-group">
                            <label><i class="fas fa-credit-card"></i> Forma</label>
                            <select class="form-input" id="pagar-forma">
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                                <option value="cartao">Cartão</option>
                                <option value="dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label><i class="fas fa-comment"></i> Observações</label><textarea class="form-input" id="pagar-obs" rows="2" placeholder="Observações sobre o pagamento..."></textarea></div>
                </div>
                <div class="modal-pagar-footer">
                    <button type="button" class="btn-cancel" onclick="fecharModalPagar()"><i class="fas fa-times"></i> Cancelar</button>
                    <button type="submit" class="btn-save" style="background:linear-gradient(135deg,#10b981,#059669);"><i class="fas fa-check"></i> Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== TOGGLE MOBILE SIDEBAR =====
        function toggleMobileSidebar() {
            document.getElementById('mobile-sidebar')?.classList.toggle('mobile-open');
            document.getElementById('sidebar-overlay')?.classList.toggle('active');
        }

        function toggleNotificacoes() {
            if (typeof window.NotificationsManager !== 'undefined') {
                window.NotificationsManager.togglePanel();
            }
        }

        let contas = [];
        let fornecedoresList = [];

        // ===== CARREGAR USUÁRIO =====
        async function carregarUsuarioLogado() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');

                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    document.getElementById('user-name').textContent = primeiroNome;

                    const avatarNameMap = {
                        'clemerson':'/avatars/Clemerson.webp','isabela':'/avatars/Isabela.webp','thaina':'/avatars/Thaina.webp',
                        'thiago':'/avatars/Thiago.webp','nicolas':'/avatars/NicolasDaniel.webp','nicolasdaniel':'/avatars/NicolasDaniel.webp',
                        'rh':'/avatars/Rh.webp','admin':'/avatars/admin.webp','ti':'/avatars/TI.webp','tialuforce':'/avatars/TI.webp',
                        'antonio':'/avatars/Antonio.webp','antônio':'/avatars/Antonio.webp','andreia':'/avatars/Andreia.webp',
                        'guilherme':'/avatars/Guilherme.webp','marcelo':'/avatars/Marcelo.webp','financeiro':'/avatars/Financeiro.webp',
                        'douglas':'/avatars/Douglas.webp','hellen':'/avatars/Hellen.webp','helen':'/avatars/Hellen.webp'
                    };

                    let avatarUrl = null;
                    if (user.avatar && user.avatar !== '/avatars/default.webp') avatarUrl = user.avatar;
                    else if (user.foto && user.foto !== '/avatars/default.webp') avatarUrl = user.foto;
                    else if (user.email) { const username = user.email.split('@')[0].split('.')[0].toLowerCase(); avatarUrl = avatarNameMap[username]; }
                    if (!avatarUrl && user.nome) { const firstName = user.nome.split(' ')[0].toLowerCase(); avatarUrl = avatarNameMap[firstName]; }

                    const userPhotoEl = document.getElementById('user-photo');
                    const userInitialEl = document.getElementById('user-initials');
                    if (avatarUrl && userPhotoEl) {
                        userPhotoEl.src = avatarUrl; userPhotoEl.style.display = 'block';
                        userPhotoEl.onerror = function() { this.style.display = 'none'; if (userInitialEl) { userInitialEl.textContent = primeiroNome.charAt(0).toUpperCase(); userInitialEl.style.display = 'flex'; } };
                        if (userInitialEl) userInitialEl.style.display = 'none';
                    } else if (userInitialEl) {
                        userInitialEl.textContent = primeiroNome.charAt(0).toUpperCase(); userInitialEl.style.display = 'flex';
                        if (userPhotoEl) userPhotoEl.style.display = 'none';
                    }
                }
            } catch (error) { console.error('Erro ao carregar usuário:', error); }
        }

        // ===== INIT =====
        async function init() {
            await Promise.all([carregarUsuarioLogado(), carregarResumo(), carregarContas(), carregarFornecedores(), carregarCategorias(), carregarCentrosCusto()]);
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('acao') === 'nova') { abrirModal(); window.history.replaceState({}, document.title, window.location.pathname); }
        }

        async function carregarResumo() {
            try {
                const response = await fetch('/api/financeiro/contas-pagar/estatisticas', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('total-pagar').textContent = `R$ ${(data.total_pagar || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('total-vencendo').textContent = `R$ ${(data.vencendo || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('total-vencidas').textContent = `R$ ${(data.vencidas || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('total-pagas').textContent = `R$ ${(data.pagas_mes || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                }
            } catch (error) { console.error('Erro ao carregar resumo:', error); }
        }

        async function carregarContas() {
            try {
                const response = await fetch('/api/financeiro/contas-pagar', { credentials: 'include' });
                if (response.ok) { const result = await response.json(); const raw = result.data || result || []; contas = Array.isArray(raw) ? raw : []; renderizarTabela(contas); }
            } catch (error) {
                console.error('Erro ao carregar contas:', error);
                document.getElementById('tabela-contas').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#ef4444;padding:40px;"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:16px;display:block;"></i>Erro ao carregar contas</td></tr>';
            }
        }

        function formatarDataSegura(data) { if (!data) return 'Sem data'; const d = new Date(data); if (isNaN(d.getTime())) return 'Data inválida'; return d.toLocaleDateString('pt-BR'); }

        function renderizarTabela(dados, pesquisa = '') {
            const tbody = document.getElementById('tabela-contas');
            if (dados.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:60px;color:#9ca3af;"><i class="fas fa-inbox" style="font-size:48px;margin-bottom:16px;display:block;"></i>Nenhuma conta encontrada</td></tr>'; return; }
            tbody.innerHTML = dados.map(conta => {
                const status = conta.status || 'pendente';
                const badges = { 'pendente': '<span class="badge badge-pending">Pendente</span>', 'pago': '<span class="badge badge-paid">Pago</span>', 'vencido': '<span class="badge badge-overdue">Vencido</span>' };
                const hl = (text) => { if (!pesquisa || !text) return text || '-'; try { const escaped = pesquisa.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(${escaped})`, 'gi'); const safe = String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return safe.replace(regex, '<span class="highlight">$1</span>'); } catch(e) { return String(text) || '-'; } };
                return `<tr>
                    <td>#${conta.id}</td>
                    <td><strong>${hl(conta.descrição || 'Sem Descrição')}</strong></td>
                    <td>${hl(conta.fornecedor_nome || '-')}</td>
                    <td>${formatarDataSegura(conta.data_vencimento || conta.vencimento)}</td>
                    <td><strong>R$ ${(parseFloat(conta.valor_total || conta.valor) || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                    <td>${badges[status] || badges.pendente}</td>
                    <td>
                        <button class="action-btn view" onclick="visualizarConta(${conta.id})" title="Visualizar"><i class="fas fa-eye"></i></button>
                        ${status === 'pendente' ? `<button class="action-btn success" onclick="abrirModalPagar(${conta.id}, ${parseFloat(conta.valor_total || conta.valor) || 0})" title="Pagar"><i class="fas fa-check-circle"></i></button>` : ''}
                        <button class="action-btn edit" onclick="editarConta(${conta.id})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="action-btn danger" onclick="excluirConta(${conta.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function carregarFornecedores() {
            try {
                const response = await fetch('/api/clientes', { credentials: 'include' });
                if (response.ok) {
                    const rawFornecedores = await response.json();
                    fornecedoresList = Array.isArray(rawFornecedores) ? rawFornecedores : (Array.isArray(rawFornecedores?.data) ? rawFornecedores.data : []);
                    const select = document.getElementById('fornecedor-id');
                    const selectFiltro = document.getElementById('filtro-fornecedor-select');
                    const options = fornecedoresList.map(f => `<option value="${f.id}">${f.razao_social || f.nome}</option>`).join('');
                    select.innerHTML = '<option value="">Selecione o fornecedor...</option>' + options;
                    selectFiltro.innerHTML = '<option value="">Todos</option>' + options;
                }
            } catch (error) { console.error('Erro ao carregar fornecedores:', error); }
        }

        async function carregarCentrosCusto() {
            try {
                const response = await fetch('/api/financeiro/centros-custo', { credentials: 'include' });
                if (response.ok) { const rawCentros = await response.json(); const centros = Array.isArray(rawCentros) ? rawCentros : (Array.isArray(rawCentros?.data) ? rawCentros.data : []); const select = document.getElementById('centro-custo'); if (select) select.innerHTML = '<option value="">Selecione (opcional)</option>' + centros.map(c => `<option value="${c.id}">${c.nome}</option>`).join(''); }
            } catch (error) { console.error('Erro ao carregar centros de custo:', error); }
        }

        async function carregarCategorias() {
            try {
                const response = await fetch('/api/financeiro/categorias', { credentials: 'include' });
                if (response.ok) { const rawCats = await response.json(); const categorias = Array.isArray(rawCats) ? rawCats : (Array.isArray(rawCats?.data) ? rawCats.data : []); const select = document.getElementById('categoria-id'); select.innerHTML = '<option value="">Selecione...</option>' + categorias.filter(c => c.tipo === 'despesa').map(c => `<option value="${c.id}">${c.nome}</option>`).join(''); }
            } catch (error) { console.error('Erro ao carregar categorias:', error); }
        }

        function abrirModal(id = null) {
            document.getElementById('modal-conta').classList.add('active');
            document.getElementById('form-conta').reset();
            document.getElementById('conta-id').value = '';
            document.getElementById('modal-titulo').textContent = 'Nova Despesa';
            document.querySelector('.modal-header-info .modal-subtitle').textContent = 'Preencha os dados da conta a pagar';
            document.getElementById('conta-vencimento').value = new Date().toISOString().split('T')[0];
            document.getElementById('conta-parcelas').value = 1;
            document.getElementById('parcelas-preview').style.display = 'none';
            if (id) {
                const conta = contas.find(c => c.id === id);
                if (conta) {
                    document.getElementById('modal-titulo').textContent = 'Editar Despesa';
                    document.querySelector('.modal-header-info .modal-subtitle').textContent = 'Altere os dados da conta a pagar';
                    document.getElementById('conta-id').value = conta.id;
                    document.getElementById('descrição').value = conta.descrição;
                    document.getElementById('fornecedor-id').value = conta.fornecedor_id;
                    document.getElementById('categoria-id').value = conta.categoria_id;
                    document.getElementById('conta-valor').value = conta.valor;
                    document.getElementById('conta-vencimento').value = conta.data_vencimento?.split('T')[0];
                    document.getElementById('forma-pagamento').value = conta.forma_pagamento || 'pix';
                    document.getElementById('observacoes').value = conta.observacoes || '';
                    document.getElementById('numero-documento').value = conta.numero_documento || '';
                    document.getElementById('centro-custo').value = conta.centro_custo_id || '';
                }
            }
        }
        function fecharModal() { document.getElementById('modal-conta').classList.remove('active'); }

        function abrirModalPagar(id, valor) {
            document.getElementById('pagar-conta-id').value = id;
            document.getElementById('pagar-valor').value = valor || 0;
            document.getElementById('pagar-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagar-obs').value = '';
            document.getElementById('modal-pagar').classList.add('active');
        }
        function fecharModalPagar() { document.getElementById('modal-pagar').classList.remove('active'); }

        async function confirmarPagamento(event) {
            event.preventDefault();
            const id = document.getElementById('pagar-conta-id').value;
            const dados = { valor_pago: parseFloat(document.getElementById('pagar-valor').value), data_pagamento: document.getElementById('pagar-data').value, forma_pagamento: document.getElementById('pagar-forma').value, observacoes: document.getElementById('pagar-obs').value };
            try {
                const response = await fetch(`/api/financeiro/contas-pagar/${id}/pagar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(dados) });
                if (response.ok) { alert('Pagamento confirmado com sucesso!'); fecharModalPagar(); await init(); } else { alert('Erro ao confirmar pagamento'); }
            } catch (error) { console.error('Erro:', error); alert('Erro ao confirmar pagamento'); }
        }

        async function salvarConta(event) {
            event.preventDefault();
            const id = document.getElementById('conta-id').value;
            const dados = { descrição: document.getElementById('descrição').value, fornecedor_id: document.getElementById('fornecedor-id').value, categoria_id: document.getElementById('categoria-id').value, valor: parseFloat(document.getElementById('conta-valor').value), data_vencimento: document.getElementById('conta-vencimento').value, forma_pagamento: document.getElementById('forma-pagamento').value, observacoes: document.getElementById('observacoes').value, numero_documento: document.getElementById('numero-documento').value, centro_custo_id: document.getElementById('centro-custo').value || null, num_parcelas: parseInt(document.getElementById('conta-parcelas').value) || 1 };
            try {
                const url = id ? `/api/financeiro/contas-pagar/${id}` : '/api/financeiro/contas-pagar';
                const method = id ? 'PUT' : 'POST';
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(dados) });
                if (response.ok) { alert('Conta salva com sucesso!'); fecharModal(); await init(); } else { alert('Erro ao salvar conta'); }
            } catch (error) { console.error('Erro:', error); alert('Erro ao salvar conta'); }
        }

        function editarConta(id) { abrirModal(id); }

        async function excluirConta(id) {
            if (!confirm('Tem certeza que deseja excluir esta conta?')) return;
            try {
                const response = await fetch(`/api/financeiro/contas-pagar/${id}`, { method: 'DELETE', credentials: 'include' });
                if (response.ok) { alert('Conta excluída com sucesso!'); await init(); } else { alert('Erro ao excluir conta'); }
            } catch (error) { console.error('Erro:', error); alert('Erro ao excluir conta'); }
        }

        function filtrarContas() {
            const periodo = document.getElementById('filtro-periodo').value;
            const status = document.getElementById('filtro-status').value;
            const fornecedorId = document.getElementById('filtro-fornecedor-select').value;
            const pesquisa = document.getElementById('pesquisa-global').value.toLowerCase();
            let filtradas = [...contas];
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            if (periodo && periodo !== 'todas') {
                filtradas = filtradas.filter(c => {
                    const venc = new Date(c.data_vencimento); venc.setHours(0,0,0,0);
                    switch (periodo) {
                        case 'mes': return venc.getMonth() === hoje.getMonth() && venc.getFullYear() === hoje.getFullYear();
                        case 'proximos7': return venc >= hoje && venc <= new Date(hoje.getTime() + 7*86400000);
                        case 'proximos30': return venc >= hoje && venc <= new Date(hoje.getTime() + 30*86400000);
                        case 'vencidas': return venc < hoje && c.status !== 'pago';
                        default: return true;
                    }
                });
            }
            if (status) filtradas = filtradas.filter(c => c.status === status);
            if (fornecedorId) filtradas = filtradas.filter(c => c.fornecedor_id == fornecedorId);
            if (pesquisa) filtradas = filtradas.filter(c => (c.descrição || '').toLowerCase().includes(pesquisa) || (c.fornecedor_nome || '').toLowerCase().includes(pesquisa) || (c.valor?.toString() || '').includes(pesquisa) || (c.id?.toString() || '').includes(pesquisa) || (c.numero_documento || '').toLowerCase().includes(pesquisa));
            renderizarTabela(filtradas, pesquisa);
        }

        let pesquisaTimeout;
        function pesquisarGlobal() {
            clearTimeout(pesquisaTimeout);
            const input = document.getElementById('pesquisa-global');
            const btnClear = input.parentElement.querySelector('.btn-clear-search');
            btnClear.style.display = input.value ? 'flex' : 'none';
            pesquisaTimeout = setTimeout(() => filtrarContas(), 300);
        }
        function limparPesquisa() { document.getElementById('pesquisa-global').value = ''; document.querySelector('.btn-clear-search').style.display = 'none'; filtrarContas(); }
        function limparFiltros() { document.getElementById('pesquisa-global').value = ''; document.getElementById('filtro-periodo').value = 'todas'; document.getElementById('filtro-status').value = ''; document.getElementById('filtro-fornecedor-select').value = ''; document.querySelector('.btn-clear-search').style.display = 'none'; renderizarTabela(contas); }

        // ===== VISUALIZAR =====
        let contaVisualizando = null;
        function visualizarConta(id) {
            const conta = contas.find(c => c.id === id); if (!conta) return;
            contaVisualizando = conta;
            document.getElementById('view-id').textContent = '#' + conta.id;
            document.getElementById('view-descrição').textContent = conta.descrição || '-';
            document.getElementById('view-fornecedor').textContent = conta.fornecedor_nome || '-';
            document.getElementById('view-categoria').textContent = conta.categoria_nome || '-';
            document.getElementById('view-valor').textContent = `R$ ${(conta.valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('view-vencimento').textContent = new Date(conta.data_vencimento).toLocaleDateString('pt-BR');
            document.getElementById('view-forma').textContent = formatarFormaPagamento(conta.forma_pagamento);
            document.getElementById('view-documento').textContent = conta.numero_documento || '-';
            document.getElementById('view-observacoes').textContent = conta.observacoes || 'Nenhuma observação';
            const badges = { 'pendente': {class:'pending',text:'Pendente',icon:'fa-clock'}, 'pago': {class:'paid',text:'Pago',icon:'fa-check-circle'}, 'vencido': {class:'overdue',text:'Vencido',icon:'fa-exclamation-circle'} };
            const statusInfo = badges[conta.status] || badges.pendente;
            const badge = document.getElementById('view-status-badge');
            badge.className = 'view-badge ' + statusInfo.class;
            badge.innerHTML = `<i class="fas ${statusInfo.icon}"></i> ${statusInfo.text}`;
            const pagamentoInfo = document.getElementById('view-pagamento-info');
            const btnPagar = document.getElementById('btn-pagar-view');
            if (conta.status === 'pago') {
                pagamentoInfo.style.display = 'block';
                document.getElementById('view-data-pagamento').textContent = conta.data_pagamento ? new Date(conta.data_pagamento).toLocaleDateString('pt-BR') : '-';
                document.getElementById('view-valor-pago').textContent = conta.valor_pago ? `R$ ${conta.valor_pago.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : document.getElementById('view-valor').textContent;
                btnPagar.style.display = 'none';
            } else { pagamentoInfo.style.display = 'none'; btnPagar.style.display = 'inline-flex'; }
            document.getElementById('modal-visualizar').classList.add('active');
        }
        function formatarFormaPagamento(forma) { const formas = {'dinheiro':'Dinheiro','pix':'PIX','transferencia':'Transferência Bancária','cartao':'Cartão','boleto':'Boleto','cheque':'Cheque'}; return formas[forma] || forma || '-'; }
        function fecharModalVisualizar() { document.getElementById('modal-visualizar').classList.remove('active'); contaVisualizando = null; }
        function editarContaFromView() { if (contaVisualizando) { fecharModalVisualizar(); editarConta(contaVisualizando.id); } }
        function pagarContaFromView() { if (contaVisualizando) { fecharModalVisualizar(); abrirModalPagar(contaVisualizando.id, contaVisualizando.valor); } }

        // ===== EXPORTAR =====
        function exportarExcel() {
            if (contas.length === 0) { alert('Não há dados para exportar'); return; }
            const pesquisa = document.getElementById('pesquisa-global').value.toLowerCase();
            const status = document.getElementById('filtro-status').value;
            const fornecedorId = document.getElementById('filtro-fornecedor-select').value;
            let dadosExportar = [...contas];
            if (status) dadosExportar = dadosExportar.filter(c => c.status === status);
            if (fornecedorId) dadosExportar = dadosExportar.filter(c => c.fornecedor_id == fornecedorId);
            if (pesquisa) dadosExportar = dadosExportar.filter(c => (c.descrição || '').toLowerCase().includes(pesquisa) || (c.fornecedor_nome || '').toLowerCase().includes(pesquisa));
            if (dadosExportar.length === 0) { alert('Não há dados para exportar com os filtros atuais'); return; }
            const csvSafe = (str) => { if (typeof str !== 'string') return String(str ?? ''); let s = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, ''); if (/^[=+\-@\t\r]/.test(s)) s = "'" + s; return s; };
            const headers = ['ID','Descrição','Fornecedor','Vencimento','Valor','Status','Forma Pagamento','Nº Documento'];
            const linhas = dadosExportar.map(c => [c.id, `"${csvSafe(c.descrição || '').replace(/"/g, '""')}"`, `"${csvSafe(c.fornecedor_nome || '').replace(/"/g, '""')}"`, new Date(c.data_vencimento).toLocaleDateString('pt-BR'), (parseFloat(c.valor) || 0).toFixed(2).replace('.', ','), csvSafe(c.status || 'pendente'), csvSafe(formatarFormaPagamento(c.forma_pagamento)), csvSafe(c.numero_documento || '')]);
            const csv = [headers.join(';'), ...linhas.map(l => l.join(';'))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `contas_pagar_${new Date().toISOString().split('T')[0]}.csv`; link.click();
            setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        }

        // ===== PARCELAS =====
        function calcularParcelas() {
            const valor = parseFloat(document.getElementById('conta-valor')?.value) || 0;
            const numParcelas = parseInt(document.getElementById('conta-parcelas')?.value) || 1;
            const preview = document.getElementById('parcelas-preview');
            const previewContent = document.getElementById('parcelas-preview-content');
            if (!previewContent) return;
            if (numParcelas <= 1) { preview.style.display = 'none'; return; }
            preview.style.display = 'block';
            if (valor <= 0) { previewContent.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af;">Preencha o valor</div>'; return; }
            const valorParcelaBase = Math.floor((valor * 100) / numParcelas) / 100;
            const restoEmCentavos = Math.round(valor * 100) - Math.round(valorParcelaBase * 100) * numParcelas;
            const vencimentoBase = document.getElementById('conta-vencimento')?.value;
            let html = '';
            for (let i = 1; i <= numParcelas; i++) {
                const valorParcela = i === numParcelas ? valorParcelaBase + (restoEmCentavos / 100) : valorParcelaBase;
                let dataVenc = '-';
                if (vencimentoBase) { const baseDate = new Date(vencimentoBase); baseDate.setMonth(baseDate.getMonth() + (i - 1)); dataVenc = baseDate.toLocaleDateString('pt-BR'); }
                html += `<div class="parcela-item"><span class="parcela-numero">${i}ª Parcela</span><span class="parcela-data">${dataVenc}</span><span class="parcela-valor">R$ ${valorParcela.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>`;
            }
            previewContent.innerHTML = html;
        }

        // ===== NOTIFICAÇÕES =====
        let notificacoes = [];
        async function carregarNotificacoes() {
            try {
                const notifs = [];
                const vencidas = contas.filter(c => c.status === 'vencido');
                if (vencidas.length > 0) notifs.push({ id: 1, tipo: 'error', mensagem: `Você tem ${vencidas.length} conta(s) vencida(s)`, lida: false });
                const hoje = new Date();
                const vencendo = contas.filter(c => { const venc = new Date(c.data_vencimento); return c.status === 'pendente' && venc >= hoje && venc <= new Date(hoje.getTime() + 7*86400000); });
                if (vencendo.length > 0) notifs.push({ id: 2, tipo: 'warning', mensagem: `${vencendo.length} conta(s) vencem nos próximos 7 dias`, lida: false });
                notificacoes = notifs;
                const badge = document.getElementById('notification-count');
                const naoLidas = notifs.filter(n => !n.lida).length;
                if (naoLidas > 0) { badge.textContent = naoLidas > 9 ? '9+' : naoLidas; badge.style.display = 'flex'; } else { badge.style.display = 'none'; }
            } catch (error) { console.error('Erro notificações:', error); }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            init().then(() => carregarNotificacoes()).catch(err => { console.error('Erro:', err); carregarNotificacoes(); });
        });
    </script>

    <script src="/js/chat-suporte-widgets.js?v=20260103"></script>
    <script src="../../_shared/connection-monitor.js?v=20251223"></script>
    <script src="/js/popup-confirmacao.js"></script>
    <script src="/js/auth-unified.js?v=20260131"></script>
    <script src="/js/mobile-auto-enhance.js?v=20260202" defer></script>
    <script src="../js/financeiro-sidebar.js?v=20260210"></script>

<!-- ALUFORCE: Confirm Dialog Profissional v2.0 --><script src="/_shared/confirm-dialog.js?v=20260217"></script>
    <!-- Chat Widget BOB AI -->
    <script src="/chat/widget.js?v=20260218" defer></script>
    <script src="/_shared/accessibility-widget.js?v=20260226"></script>
</body>
</html>
