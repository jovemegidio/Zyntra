<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Aluforce: Relatórios Financeiros</title>

    <!-- Autenticacao -->
    <script src="/js/auth-unified.js?v=20260211" defer></script>

    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Financeiro Design System -->
    <link rel="stylesheet" href="css/fin-layout.css?v=20260215">
    <link rel="stylesheet" href="css/fin-components.css?v=20260215">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* Template Modal - Filter Buttons */
    .tmpl-filter-btn {
        padding: 7px 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: white;
        color: #64748b;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tmpl-filter-btn:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #334155;
    }
    .tmpl-filter-btn.active {
        background: #0f172a !important;
        color: white !important;
        border-color: #0f172a !important;
    }
    /* Template Cards - Layout uniforme */
    .template-card {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 108px;
    }
    .template-card:hover {
        transform: translateY(-2px) !important;
    }
    /* Scrollbar modal templates */
    #modalTemplates .modal-container-padrão > div:last-child::-webkit-scrollbar { width: 6px; }
    #modalTemplates .modal-container-padrão > div:last-child::-webkit-scrollbar-track { background: transparent; }
    #modalTemplates .modal-container-padrão > div:last-child::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

    :root {
        --primary-orange: #225cfa;
        --primary-dark: #1a1a2e;
        --bg-gray: #f8fafc;
        --border-color: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
    }

        /* Botão Baixar Templates */
        .btn-templates {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-templates:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        /* Botão Agendar */
        .btn-agendar {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-agendar:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Botão Imprimir */
        .btn-imprimir {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-imprimir:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Modal Templates */
        .modal-templates-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease;
        }
        .modal-templates-overlay.active {
            display: flex;
        }
        .modal-templates {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 680px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-templates-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            padding: 24px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-templates-header h2 {
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }
        .modal-templates-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-templates-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        .modal-templates-body {
            padding: 28px;
            max-height: calc(85vh - 180px);
            overflow-y: auto;
        }
        .modal-templates-intro {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .modal-templates-intro i {
            color: #059669;
            font-size: 20px;
            margin-top: 2px;
        }
        .modal-templates-intro p {
            color: #166534;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .template-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .template-card:hover {
            border-color: #059669;
            background: #f0fdf4;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.15);
        }
        .template-icon {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        @media (max-width: 900px) {
            #templatesGrid { grid-template-columns: repeat(2, 1fr) !important; }
        }
        @media (max-width: 600px) {
            #templatesGrid { grid-template-columns: 1fr !important; }
        }
        .template-icon.pagar { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; }
        .template-icon.receber { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; }
        .template-icon.bancos { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #2563eb; }
        .template-icon.movimentacoes { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); color: #ca8a04; }
        .template-icon.fluxo { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); color: #9333ea; }
        .template-info { flex: 1; }
        .template-info h4 { font-size: 15px; font-weight: 600; color: #1e293b; margin: 0 0 6px 0; }
        .template-info p { font-size: 13px; color: #64748b; margin: 0 0 10px 0; line-height: 1.4; }
        .template-download-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .template-download-btn:hover { background: #047857; }
/* SIDEBAR */
.sidebar-logo i { color: white; font-size: 18px; }
.sidebar-btn { width: 40px; height: 40px; border: none; background: transparent; color: #8b8b9a; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; }
        .sidebar-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-btn.active { background: var(--primary-blue); color: white; }
        .sidebar-bottom { margin-top: auto; display: flex; flex-direction: column; gap: 4px; }

        /* MAIN */
/* HEADER */
.header-brand img { height: 24px; }
        .header-brand span { font-size: 14px; font-weight: 600; color: #8b8b9a; }
.header-btn { width: 36px; height: 36px; border: none; background: transparent; color: #8b8b9a; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; position: relative; }
        .header-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .header-btn .notification-badge { position: absolute; top: 4px; right: 4px; min-width: 16px; height: 16px; background: #ef4444; border-radius: 10px; color: white; font-size: 10px; font-weight: 600; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
        .notification-container { position: relative; }
        .notification-panel { position: absolute; top: calc(100% + 12px); right: 0; width: 380px; max-height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; display: none; overflow: hidden; }
        .notification-panel.active { display: block; }
        .notification-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: linear-gradient(135deg, #84cc16, #65a30d); color: white; }
        .notification-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .notification-list { max-height: 340px; overflow-y: auto; }
        .notification-item { display: flex; gap: 12px; padding: 14px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; }
        .notification-item:hover { background: #f8f8f8; }
        .notification-item.unread { background: #f0fdf4; border-left: 3px solid #84cc16; }
        .notification-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-icon.success { background: #dcfce7; color: #22c55e; }
        .notification-icon.warning { background: #fef3c7; color: #f59e0b; }
        .notification-icon.error { background: #fee2e2; color: #ef4444; }
        .notification-icon.info { background: #dbeafe; color: #3b82f6; }
        .notification-content { flex: 1; }
        .notification-title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .notification-message { font-size: 12px; color: #666; }
        .notification-time { font-size: 11px; color: #999; margin-top: 6px; }
        .notification-footer { padding: 12px 20px; background: #f8f8f8; text-align: center; border-top: 1px solid #e5e5e5; }
        .notification-footer a { color: #84cc16; text-decoration: none; font-size: 13px; font-weight: 500; }
        .user-greeting { display: flex; align-items: center; gap: 12px; margin-left: 16px; color: #8b8b9a; font-size: 13px; }
        .user-greeting strong { color: white; }
.user-avatar img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .user-avatar img.visible { display: block; }
        .user-avatar .user-initial { display: block; }
        .user-avatar img.visible + .user-initial { display: none; }

        /* PAGE */
        .page-content { flex: 1; overflow-y: auto; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title-section h1 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
        .page-title-section h1 i { color: var(--primary-blue); }
        .page-title-section p { font-size: 14px; color: var(--text-secondary); }
        .page-actions { display: flex; gap: 12px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: white; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* FILTERS - Redesigned */
        .filters-bar {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 24px;
            background: white;
            padding: 0;
            border-radius: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            border-right: 1px solid #e2e8f0;
        }
        .filter-section:last-child { border-right: none; }
        .filter-section label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-section label i { font-size: 14px; color: #94a3b8; }
        .filter-section select,
        .filter-section input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            background: #f8fafc;
            min-width: 150px;
            transition: all 0.2s;
        }
        .filter-section select:focus,
        .filter-section input[type="date"]:focus {
            outline: none;
            border-color: #225cfa;
            box-shadow: 0 0 0 3px rgba(34,92,250,0.12);
            background: white;
        }
        .filter-btn-section {
            margin-left: auto;
            padding: 10px 16px;
        }
        .btn-filtrar {
            background: linear-gradient(135deg, #225cfa 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-filtrar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34,92,250,0.3);
        }
        @media (max-width: 1100px) {
            .filters-bar { flex-wrap: wrap; }
            .filter-section { border-right: none; border-bottom: 1px solid #e2e8f0; flex: 1; min-width: 200px; }
            .filter-btn-section { margin-left: 0; width: 100%; text-align: right; border-bottom: none; }
        }

        /* STATS GRID */
        .stats-grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 20px; margin-bottom: 24px; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }

        .stat-card { background: white; border-radius: 20px; padding: 24px; position: relative; overflow: visible; box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: all 0.3s ease; display: block !important; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 20px 20px 0 0; }
        .stat-card.orange::before { background: linear-gradient(90deg, #f97316, #fb923c); }
        .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card.green::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card.purple::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .stat-card.red::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-card.teal::before { background: linear-gradient(90deg, #14b8a6, #2dd4bf); }
        .stat-card.lime::before { background: linear-gradient(90deg, #84cc16, #a3e635); }

        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stat-icon.orange { background: linear-gradient(135deg, #fff7ed, #fed7aa); color: #ea580c; }
        .stat-icon.blue { background: linear-gradient(135deg, #eff6ff, #bfdbfe); color: #2563eb; }
        .stat-icon.green { background: linear-gradient(135deg, #ecfdf5, #a7f3d0); color: #059669; }
        .stat-icon.purple { background: linear-gradient(135deg, #f5f3ff, #ddd6fe); color: #7c3aed; }
        .stat-icon.red { background: linear-gradient(135deg, #fef2f2, #fecaca); color: #dc2626; }
        .stat-icon.teal { background: linear-gradient(135deg, #f0fdfa, #99f6e4); color: #0d9488; }
        .stat-icon.lime { background: linear-gradient(135deg, #f7fee7, #d9f99d); color: #65a30d; }

        .stat-label { font-size: 13px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 800; color: #0f172a; line-height: 1.2; margin-bottom: 16px; white-space: nowrap; overflow: visible; }
        .stat-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 16px; border-top: 1px solid #f1f5f9; }
        .stat-change { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 20px; }
        .stat-change.up { background: #ecfdf5; color: #059669; }
        .stat-change.down { background: #fef2f2; color: #dc2626; }
        .stat-change i { font-size: 10px; }
        .stat-period { font-size: 12px; color: #94a3b8; }
        .stat-badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.3px; }
        .stat-badge.green { background: #ecfdf5; color: #059669; }
        .stat-badge.red { background: #fef2f2; color: #dc2626; }
        .stat-badge.lime { background: #f7fee7; color: #65a30d; }
        .stat-badge.blue { background: #eff6ff; color: #2563eb; }

        /* SECTION HEADERS - Professional */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 32px 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        .section-header .section-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .section-icon.purple { background: linear-gradient(135deg, #f5f3ff, #ddd6fe); color: #7c3aed; }
        .section-icon.blue { background: linear-gradient(135deg, #eff6ff, #bfdbfe); color: #2563eb; }
        .section-icon.orange { background: linear-gradient(135deg, #fff7ed, #fed7aa); color: #ea580c; }
        .section-icon.green { background: linear-gradient(135deg, #ecfdf5, #a7f3d0); color: #059669; }
        .section-header h2 {
            font-size: 17px;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }
        .section-header .section-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-left: auto;
        }

        /* REPORT CARD - Enhanced actions */
        .relatorio-actions .btn-secondary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #475569;
            font-size: 12px;
            padding: 6px 14px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .relatorio-actions .btn-secondary:hover {
            background: #225cfa;
            color: white;
            border-color: #225cfa;
            transform: translateY(-1px);
        }
        .relatorio-actions .btn-secondary .fa-file-pdf { color: #ef4444; }
        .relatorio-actions .btn-secondary .fa-file-excel { color: #059669; }
        .relatorio-actions .btn-secondary:hover .fa-file-pdf,
        .relatorio-actions .btn-secondary:hover .fa-file-excel { color: white; }

        /* SUMMARY GRID - Enhanced */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-box {
            background: white;
            border-radius: 14px;
            padding: 22px 20px;
            text-align: center;
            border: 1px solid #f1f5f9;
            transition: all 0.2s;
        }
        .summary-box:hover {
            border-color: #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .summary-box h4 {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .summary-box .value {
            font-size: 22px;
            font-weight: 800;
        }

        /* QUICK REPORTS - ESTILO PROFISSIONAL */
        .quick-reports { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        @media (max-width: 1200px) { .quick-reports { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .quick-reports { grid-template-columns: 1fr; } }

        .report-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .report-card:hover { border-color: var(--primary-blue); transform: translateY(-2px); box-shadow: 0 8px 16px rgba(132, 204, 22, 0.12); }
        .report-icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 16px; }
        .report-icon.orange { background: linear-gradient(135deg, #fff7ed, #fed7aa); color: #ea580c; }
        .report-icon.blue { background: linear-gradient(135deg, #eff6ff, #bfdbfe); color: #2563eb; }
        .report-icon.green { background: linear-gradient(135deg, #ecfdf5, #a7f3d0); color: #059669; }
        .report-icon.purple { background: linear-gradient(135deg, #f5f3ff, #ddd6fe); color: #7c3aed; }
        .report-icon.red { background: linear-gradient(135deg, #fef2f2, #fecaca); color: #dc2626; }
        .report-icon.teal { background: linear-gradient(135deg, #f0fdfa, #99f6e4); color: #0d9488; }
        .report-icon.lime { background: linear-gradient(135deg, #f7fee7, #d9f99d); color: #65a30d; }

        .report-card h4 { font-size: 15px; font-weight: 700; color: #0f172a; margin-bottom: 6px; }
        .report-card p { font-size: 13px; color: #64748b; line-height: 1.5; }

        /* RELATORIOS GRID - LEGADO */
        .relatorios-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .relatorio-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .relatorio-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.12); border-color: var(--primary-blue); }
        .template-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .relatorio-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 16px; }
        .relatorio-icon.blue { background: linear-gradient(135deg, #eff6ff, #bfdbfe); color: #2563eb; }
        .relatorio-icon.green { background: linear-gradient(135deg, #ecfdf5, #a7f3d0); color: #059669; }
        .relatorio-icon.orange { background: linear-gradient(135deg, #fff7ed, #fed7aa); color: #ea580c; }
        .relatorio-icon.purple { background: linear-gradient(135deg, #f5f3ff, #ddd6fe); color: #7c3aed; }
        .relatorio-icon.red { background: linear-gradient(135deg, #fef2f2, #fecaca); color: #dc2626; }
        .relatorio-icon.teal { background: linear-gradient(135deg, #f0fdfa, #99f6e4); color: #0d9488; }
        .relatorio-icon.lime { background: linear-gradient(135deg, #f7fee7, #d9f99d); color: #65a30d; }
        .relatorio-card h3 { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .relatorio-card p { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .relatorio-actions { display: flex; gap: 8px; }

        /* CARD */
        .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-header h3 i { color: var(--primary-blue); }
        .card-body { padding: 24px; }

        /* CHARTS GRID */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
        .chart-container { height: 300px; position: relative; }

        /* TABLE */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: var(--bg-gray); padding: 14px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
        .data-table td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .data-table tr:hover { background: var(--bg-gray); }
        .data-table tfoot td { background: var(--bg-gray); font-weight: 700; }
        .valor-cell { font-weight: 600; }
        .valor-cell.positivo { color: var(--success); }
        .valor-cell.negativo { color: var(--danger); }

        /* SUMMARY BOX - overridden by enhanced version above */\n\n        /* MODAL - Design SaaS Empresarial */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 24px; width: 100%; max-width: 950px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* Header SaaS */
        .modal-header-saas { padding: 28px 32px; background: #ffffff; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; gap: 24px; }
        .modal-header-saas .header-left { display: flex; align-items: center; gap: 16px; flex: 1; }
        .modal-header-saas .header-icon { width: 56px; height: 56px; min-width: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .modal-header-saas .header-icon i { color: white; font-size: 24px; }
        .modal-header-saas h2 { font-size: 22px; font-weight: 700; color: #111827; margin: 0 0 4px 0; }
        .modal-header-saas .subtitle { font-size: 14px; color: #6b7280; margin: 0; }
        .modal-close-saas { width: 44px; height: 44px; min-width: 44px; border: none; background: #f3f4f6; border-radius: 12px; cursor: pointer; color: #6b7280; font-size: 18px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; margin-left: 20px; }
        .modal-close-saas:hover { background: #e5e7eb; color: #374151; }
        
        /* Body SaaS */
        .modal-body-saas { padding: 32px; overflow-y: auto; max-height: calc(90vh - 180px); background: #f9fafb; }
        
        /* Footer SaaS */
        .modal-footer-saas { padding: 20px 32px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; background: #ffffff; }
        
        /* Buttons SaaS */
        .btn-saas { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-saas-ghost { background: #ffffff; color: #6b7280; border: 1px solid #e5e7eb; }
        .btn-saas-ghost:hover { background: #f3f4f6; color: #374151; }
        .btn-saas-primary { background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; box-shadow: 0 4px 12px rgba(132, 204, 22, 0.35); }
        .btn-saas-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(132, 204, 22, 0.4); }
        .btn-saas-success { background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; box-shadow: 0 4px 12px rgba(132, 204, 22, 0.35); }
        .btn-saas-success:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(132, 204, 22, 0.4); }
        .btn-saas-danger { background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; box-shadow: 0 4px 12px rgba(132, 204, 22, 0.35); }
        .btn-saas-danger:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(132, 204, 22, 0.4); }
        
        /* Legacy modal styles */
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .modal-header h2 i { color: var(--primary-blue); }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-gray); border-radius: 10px; cursor: pointer; font-size: 18px; color: var(--text-secondary); }
        .modal-body { padding: 24px; overflow-y: auto; max-height: calc(90vh - 160px); }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

        /* PRINT STYLES */
        @media print {
            .sidebar, .header, .page-actions, .filters-bar, .modal-overlay { display: none !important; }
.page-content { padding: 0 !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd; }
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .relatorios-grid { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: 1fr; } }

        /* MODAL - Classes Padrão (Padrão SaaS Empresarial) */
        .modal-overlay-padrão { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.7); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(8px); }
        .modal-overlay-padrão.active { display: flex !important; }
        .modal-padrão { display: flex !important; flex-direction: column !important; background: white !important; border-radius: 24px !important; width: 100% !important; max-width: 950px !important; max-height: 90vh !important; overflow: hidden !important; box-shadow: 0 25px 80px rgba(0,0,0,0.25), 0 10px 30px rgba(0,0,0,0.15) !important; animation: modalFadeInRelatorios 0.25s ease-out !important; position: relative !important; margin: 16px !important; }
        @keyframes modalFadeInRelatorios { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header-padrão { padding: 28px 32px !important; background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%) !important; color: white !important; display: flex !important; justify-content: space-between !important; align-items: center !important; flex-shrink: 0 !important; border-radius: 24px 24px 0 0 !important; }
        .modal-header-padrão .header-left { display: flex; align-items: center; gap: 16px; }
        .modal-header-padrão .header-icon { width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .modal-header-padrão .header-icon i { color: white; font-size: 24px; }
        .modal-header-padrão h2 { font-size: 22px; font-weight: 700; color: white; margin: 0 0 4px 0; }
        .modal-header-padrão .subtitle { font-size: 14px; color: rgba(255,255,255,0.8); margin: 0; }
        .modal-close-padrão { width: 44px !important; height: 44px !important; border: none !important; background: rgba(255,255,255,0.15) !important; border-radius: 12px !important; cursor: pointer !important; color: white !important; font-size: 18px !important; transition: all 0.2s !important; display: flex !important; align-items: center !important; justify-content: center !important; }
        .modal-close-padrão:hover { background: rgba(255,255,255,0.25) !important; transform: rotate(90deg) !important; }
        .modal-body-padrão { padding: 32px !important; overflow-y: auto !important; flex: 1 !important; min-height: 0 !important; background: #f9fafb !important; }
        .modal-footer-padrão { padding: 20px 32px !important; border-top: 1px solid #e5e7eb !important; display: flex !important; justify-content: flex-end !important; gap: 12px !important; background: #ffffff !important; flex-shrink: 0 !important; }
        .form-section-padrão { background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid #e5e7eb; margin-bottom: 16px; }
        .form-section-padrão:last-child { margin-bottom: 0; }
        .form-grid-padrão { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
        .form-grid-padrão:last-child { margin-bottom: 0; }
        .form-group-padrão { margin-bottom: 16px; }
        .form-group-padrão:last-child { margin-bottom: 0; }
        .form-group-padrão label { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-group-padrão label i { color: #84cc16; font-size: 14px; }
        .form-group-padrão label .required { color: #ef4444; margin-left: 2px; }
        .form-group-padrão input, .form-group-padrão select, .form-group-padrão textarea { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; transition: all 0.2s; background: #ffffff; }
        .form-group-padrão input:focus, .form-group-padrão select:focus, .form-group-padrão textarea:focus { outline: none; border-color: #84cc16; box-shadow: 0 0 0 4px rgba(132, 204, 22, 0.1); }
        .btn-padrão-ghost { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid #e5e7eb; background: #ffffff; color: #6b7280; }
        .btn-padrão-ghost:hover { background: #f3f4f6; color: #374151; }
        .btn-padrão-primary { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; box-shadow: 0 4px 12px rgba(132, 204, 22, 0.35); }
        .btn-padrão-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(132, 204, 22, 0.4); }
        
        /* Botões de Exportação Profissionais */
        .btn-padrão-danger { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35); }
        .btn-padrão-danger:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4); }
        
        /* Loading Spinner Profissional */
        .loading-relatorio { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; }
        .loading-spinner { width: 56px; height: 56px; border: 4px solid #e5e7eb; border-top-color: #84cc16; border-radius: 50%; animation: spinRelatorio 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spinRelatorio { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; font-weight: 500; color: #64748b; margin-bottom: 8px; }
        .loading-subtext { font-size: 13px; color: #9ca3af; }
        
        /* Skeleton Loading para Tabelas */
        .skeleton-loading { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeletonShimmer 1.5s infinite; border-radius: 6px; height: 16px; }
        @keyframes skeletonShimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Empty State Profissional */
        .empty-state-relatorio { text-align: center; padding: 60px 20px; }
        .empty-state-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .empty-state-icon i { font-size: 32px; color: #94a3b8; }
        .empty-state-title { font-size: 18px; font-weight: 600; color: #334155; margin-bottom: 8px; }
        .empty-state-desc { font-size: 14px; color: #64748b; max-width: 400px; margin: 0 auto; }
        
        /* Resultado do Relatório */
        .resultado-relatorio { animation: fadeInRelatorio 0.3s ease; }
        @keyframes fadeInRelatorio { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
    </style>
    <!-- Tooltips Profissionais -->
    <link rel="stylesheet" href="/css/tooltips-professional.css?v=20260209">
    <script src="/js/tooltips-professional.js?v=20260209"></script>

    <!-- Header & Sidebar refinado -->
    <link rel="stylesheet" href="css/fin-header-sidebar.css?v=20260215">
    <!-- Global Header & Sidebar - override final unificado -->
    <link rel="stylesheet" href="/css/global-header-sidebar.css?v=20260216">
    <script src="/js/anti-copy-protection.js"></script>
    <link rel="stylesheet" href="/css/popup-confirmacao.css">
    <link rel="stylesheet" href="/css/modal-fix-global.css?v=20260114-fix4">
    <link rel="stylesheet" href="css/modais-padrao.css?v=20260114-fix3">
    <!-- CSS Unificado de Modais SaaS -->
    <link rel="stylesheet" href="css/modais-saas-unified.css?v=20260121">

    <!-- XLSX Library para exportação e templates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
    <div class="app-container">
        <!-- Overlay para fechar sidebar em mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="mobile-sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>

            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-btn" title="Dashboard">
                    <i class="fas fa-chart-line"></i>
                </a>
                <a href="contas-pagar.html" class="sidebar-btn" title="Contas a Pagar">
                    <i class="fas fa-file-invoice-dollar"></i>
                </a>
                <a href="contas-receber.html" class="sidebar-btn" title="Contas a Receber">
                    <i class="fas fa-hand-holding-usd"></i>
                </a>
                <a href="fluxo-caixa.html" class="sidebar-btn" title="Fluxo de Caixa">
                    <i class="fas fa-chart-area"></i>
                </a>
                <a href="bancos.html" class="sidebar-btn" title="Bancos">
                    <i class="fas fa-university"></i>
                </a>
                <a href="plano-contas.html" class="sidebar-btn" title="Plano de Contas">
                    <i class="fas fa-list-alt"></i>
                </a>
                <a href="orcamentos.html" class="sidebar-btn" title="Orçamentos">
                    <i class="fas fa-calculator"></i>
                </a>
                <a href="conciliacao.html" class="sidebar-btn" title="Conciliação">
                    <i class="fas fa-balance-scale"></i>
                </a>
                <a href="relatorios.html" class="sidebar-btn active" title="Relatórios">
                    <i class="fas fa-chart-bar"></i>
                </a>
            </nav>

            <div class="sidebar-bottom">
                <a href="centros-custo.html" class="sidebar-btn" title="Centros de Custo">
                    <i class="fas fa-sitemap"></i>
                </a>
                <a href="impostos.html" class="sidebar-btn" title="Impostos">
                    <i class="fas fa-percent"></i>
                </a>
                <button class="sidebar-btn" title="Configurações" id="btn-config" onclick="toggleConfiguracoes()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="main-area">
            <header class="header">
                <div class="header-left">
                    <!-- Botao Menu Mobile -->
                    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-brand" style="display:flex;align-items:center;gap:10px;">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE" style="height:22px;object-fit:contain;">
                        <span style="color:rgba(255,255,255,0.2);font-weight:300;font-size:18px;user-select:none;">|</span>
                        <img src="/images/zyntra-branco.png" alt="Zyntra" style="height:22px;object-fit:contain;">
                        <span style="color:rgba(255,255,255,0.18);font-weight:200;font-size:16px;user-select:none;margin:0 2px;"></span>
                        <span style="font-size:13px;font-weight:500;color:rgba(255,255,255,0.85);letter-spacing:0.3px;">Relatórios</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn" title="Atualizar" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="notification-container">
                        <button class="header-btn notification-btn" title="Notificações" onclick="toggleNotificacoes()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                        </button>
                        <div class="notification-panel" id="notification-panel">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell"></i> Notificações</h3>
                                <div class="notification-actions">
                                    <button onclick="marcarTodasLidas()" title="Marcar todas como lidas">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                    <button onclick="limparNotificacoes()" title="Limpar todas">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <div class="notification-empty">
                                    <i class="fas fa-check-circle"></i>
                                    <p>Nenhuma notificação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img alt="Foto do usuário" id="user-photo" style="display:none">
                            <span id="user-initials">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- CONTENT -->
            <div class="main-content">

            <div class="page-content">
                <!-- Page Header Profissional -->
                <div class="page-header">
                    <div class="page-title" style="display: flex; align-items: center; gap: 16px;">
                        <div class="page-title-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #84cc16, #65a30d); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h1 style="font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">Relatórios Financeiros</h1>
                            <p style="font-size: 14px; color: #64748b;">Análises, métricas e demonstrativos financeiros</p>
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="btn-templates" onclick="abrirModalTemplates()"><i class="fas fa-file-excel"></i> Baixar Templates</button>
                        <button class="btn-agendar" onclick="agendarRelatorio()"><i class="fas fa-calendar-check"></i> Agendar</button>
                        <button class="btn-imprimir" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-section">
                        <label><i class="fas fa-calendar-alt"></i> Período</label>
                        <select id="filtroPeriodo" onchange="atualizarRelatorios()">
                            <option value="mes">Este Mês</option>
                            <option value="trimestre">Este Trimestre</option>
                            <option value="semestre">Este Semestre</option>
                            <option value="ano">Este Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div class="filter-section">
                        <label><i class="fas fa-calendar-day"></i> De</label>
                        <input type="date" id="dataInício">
                    </div>
                    <div class="filter-section">
                        <label><i class="fas fa-calendar-day"></i> Até</label>
                        <input type="date" id="dataFim">
                    </div>
                    <div class="filter-btn-section">
                        <button class="btn-filtrar" onclick="atualizarRelatorios()"><i class="fas fa-search"></i> Filtrar</button>
                    </div>
                </div>

                <!-- Stats Cards - Resumo Financeiro -->
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-header">
                            <div class="stat-icon green"><i class="fas fa-hand-holding-usd"></i></div>
                            <span class="stat-badge green">Receitas</span>
                        </div>
                        <div class="stat-label">Total a Receber</div>
                        <div class="stat-value" id="statTotalReceber">R$ 0,00</div>
                        <div class="stat-footer">
                            <div class="stat-change up" id="changeReceber"><i class="fas fa-arrow-up"></i> 0%</div>
                            <div class="stat-period">vs mês anterior</div>
                        </div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-header">
                            <div class="stat-icon red"><i class="fas fa-file-invoice-dollar"></i></div>
                            <span class="stat-badge red">Despesas</span>
                        </div>
                        <div class="stat-label">Total a Pagar</div>
                        <div class="stat-value" id="statTotalPagar">R$ 0,00</div>
                        <div class="stat-footer">
                            <div class="stat-change down" id="changePagar"><i class="fas fa-arrow-down"></i> 0%</div>
                            <div class="stat-period">vs mês anterior</div>
                        </div>
                    </div>
                    <div class="stat-card lime">
                        <div class="stat-header">
                            <div class="stat-icon lime"><i class="fas fa-chart-line"></i></div>
                            <span class="stat-badge lime">Projeção</span>
                        </div>
                        <div class="stat-label">Saldo Projetado</div>
                        <div class="stat-value" id="statSaldoProjetado">R$ 0,00</div>
                        <div class="stat-footer">
                            <div class="stat-change up" id="changeSaldo"><i class="fas fa-arrow-up"></i> 0%</div>
                            <div class="stat-period">vs mês anterior</div>
                        </div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-header">
                            <div class="stat-icon blue"><i class="fas fa-university"></i></div>
                            <span class="stat-badge blue">Bancário</span>
                        </div>
                        <div class="stat-label">Saldo em Contas</div>
                        <div class="stat-value" id="statSaldoContas">R$ 0,00</div>
                        <div class="stat-footer">
                            <div class="stat-change up" id="changeContas"><i class="fas fa-arrow-up"></i> 0%</div>
                            <div class="stat-period">atual</div>
                        </div>
                    </div>
                </div>

                <!-- Operação de Desconto -->
                <div class="section-header">
                    <div class="section-icon purple"><i class="fas fa-percent"></i></div>
                    <h2>Operação de Desconto</h2>
                    <span class="section-desc">Antecipação de recebíveis</span>
                </div>
                <div class="relatorios-grid" style="margin-bottom: 32px;">
                    <div class="relatorio-card" onclick="abrirModalDesconto()" style="border-left: 4px solid #8b5cf6;">
                        <div class="relatorio-icon purple"><i class="fas fa-percent"></i></div>
                        <h3>Nova Operação de Desconto</h3>
                        <p>Realize operações de desconto de títulos a receber, antecipando valores com cálculo automático de taxas e IOF.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-plus"></i> Nova Operação</button>
                        </div>
                    </div>
                </div>

                <!-- Seção: Relatórios de Títulos -->
                <div class="section-header">
                    <div class="section-icon blue"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h2>Relatórios de Títulos</h2>
                    <span class="section-desc">Liquidados, vencidos e a vencer</span>
                </div>
                <div class="relatorios-grid">
                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-liquidados')">
                        <div class="relatorio-icon green"><i class="fas fa-check-circle"></i></div>
                        <h3>Títulos Liquidados</h3>
                        <p>Listagem de todos os títulos que foram pagos/recebidos no período selecionado.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-liquidados', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-liquidados', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-vencidos')">
                        <div class="relatorio-icon red"><i class="fas fa-exclamation-triangle"></i></div>
                        <h3>Títulos Vencidos</h3>
                        <p>Títulos com data de vencimento ultrapassada e ainda não liquidados.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-vencidos', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-vencidos', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-a-vencer')">
                        <div class="relatorio-icon orange"><i class="fas fa-clock"></i></div>
                        <h3>Títulos a Vencer</h3>
                        <p>Títulos com vencimento futuro, organizados por data de vencimento.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-a-vencer', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-a-vencer', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-por-cliente')">
                        <div class="relatorio-icon blue"><i class="fas fa-user"></i></div>
                        <h3>Por Cliente</h3>
                        <p>Títulos a receber agrupados por cliente, com totais e detalhamento.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-por-cliente', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-por-cliente', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-por-fornecedor')">
                        <div class="relatorio-icon teal"><i class="fas fa-truck"></i></div>
                        <h3>Por Fornecedor</h3>
                        <p>Títulos a pagar agrupados por fornecedor, com totais e detalhamento.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-por-fornecedor', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-por-fornecedor', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('portador-carteira')">
                        <div class="relatorio-icon purple"><i class="fas fa-wallet"></i></div>
                        <h3>Portador "Carteira"</h3>
                        <p>Títulos em carteira (não enviados para cobrança bancária).</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('portador-carteira', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('portador-carteira', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirRelatorio('titulos-descontos')">
                        <div class="relatorio-icon lime"><i class="fas fa-percent"></i></div>
                        <h3>Descontos</h3>
                        <p>Histórico de operações de desconto de títulos realizadas.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-eye"></i> Visualizar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-descontos', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('titulos-descontos', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Seção: Relatórios de Contas a Pagar e Receber por Período -->
                <div class="section-header">
                    <div class="section-icon orange"><i class="fas fa-filter"></i></div>
                    <h2>Relatórios por Período com Filtros</h2>
                    <span class="section-desc">Contas a pagar e receber detalhados</span>
                </div>
                <div class="relatorios-grid">
                    <div class="relatorio-card" onclick="abrirModalRelatorioContasPagar()" style="border-left: 4px solid #ef4444;">
                        <div class="relatorio-icon red"><i class="fas fa-file-invoice-dollar"></i></div>
                        <h3>Contas a Pagar por Período</h3>
                        <p>Relatório detalhado de contas a pagar com filtros por período, fornecedor e banco sacado.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-filter"></i> Filtrar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('contas-pagar-periodo', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('contas-pagar-periodo', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>

                    <div class="relatorio-card" onclick="abrirModalRelatorioContasReceber()" style="border-left: 4px solid #22c55e;">
                        <div class="relatorio-icon green"><i class="fas fa-hand-holding-usd"></i></div>
                        <h3>Contas a Receber por Período</h3>
                        <p>Relatório detalhado de contas a receber com filtros por período, cliente e banco sacado.</p>
                        <div class="relatorio-actions">
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-filter"></i> Filtrar</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('contas-receber-periodo', 'pdf')"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); exportarRelatorio('contas-receber-periodo', 'excel')"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Período -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-calculator"></i> Resumo do Período</h3>
                        <span style="font-size: 13px; color: var(--text-secondary);" id="periodoResumo">Janeiro 2026</span>
                    </div>
                    <div class="card-body">
                        <div class="summary-grid">
                            <div class="summary-box">
                                <h4>Receita Bruta</h4>
                                <div class="value blue" id="receitaBruta">R$ 245.800,00</div>
                            </div>
                            <div class="summary-box">
                                <h4>Despesas Totais</h4>
                                <div class="value red" id="despesasTotais">R$ 168.450,00</div>
                            </div>
                            <div class="summary-box">
                                <h4>Resultado Líquido</h4>
                                <div class="value green" id="resultadoLiquido">R$ 77.350,00</div>
                            </div>
                            <div class="summary-box">
                                <h4>Margem Líquida</h4>
                                <div class="value orange" id="margemLiquida">31,5%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- gráficos -->
                <div class="charts-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-bar"></i> Receitas vs Despesas</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="receitasDespesasChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-pie"></i> Despesas por Categoria</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="despesasCategoriaChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela DRE Simplificado -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-alt"></i> DRE Simplificado</h3>
                        <button class="btn btn-secondary btn-sm" onclick="exportarRelatorio('dre', 'excel')"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                    <table class="data-table" id="tabelaDRE">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th style="text-align: right;">Valor</th>
                                <th style="text-align: right;">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>RECEITA BRUTA</strong></td>
                                <td style="text-align: right;" class="valor-cell positivo">R$ 245.800,00</td>
                                <td style="text-align: right;">100%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Vendas de Produtos</td>
                                <td style="text-align: right;">R$ 185.200,00</td>
                                <td style="text-align: right;">75,3%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Serviços</td>
                                <td style="text-align: right;">R$ 60.600,00</td>
                                <td style="text-align: right;">24,7%</td>
                            </tr>
                            <tr style="background: #f1f5f9;">
                                <td><strong>(-) DEDUÇÕES</strong></td>
                                <td style="text-align: right;" class="valor-cell negativo">R$ 24.580,00</td>
                                <td style="text-align: right;">10%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Impostos sobre vendas</td>
                                <td style="text-align: right;">R$ 24.580,00</td>
                                <td style="text-align: right;">10%</td>
                            </tr>
                            <tr style="background: #e0f2fe;">
                                <td><strong>RECEITA LÍQUIDA</strong></td>
                                <td style="text-align: right;"><strong>R$ 221.220,00</strong></td>
                                <td style="text-align: right;"><strong>90%</strong></td>
                            </tr>
                            <tr style="background: #f1f5f9;">
                                <td><strong>(-) CUSTOS</strong></td>
                                <td style="text-align: right;" class="valor-cell negativo">R$ 98.320,00</td>
                                <td style="text-align: right;">40%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Matéria-prima</td>
                                <td style="text-align: right;">R$ 68.420,00</td>
                                <td style="text-align: right;">27,8%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Mão de obra direta</td>
                                <td style="text-align: right;">R$ 29.900,00</td>
                                <td style="text-align: right;">12,2%</td>
                            </tr>
                            <tr style="background: #e0f2fe;">
                                <td><strong>LUCRO BRUTO</strong></td>
                                <td style="text-align: right;"><strong>R$ 122.900,00</strong></td>
                                <td style="text-align: right;"><strong>50%</strong></td>
                            </tr>
                            <tr style="background: #f1f5f9;">
                                <td><strong>(-) DESPESAS OPERACIONAIS</strong></td>
                                <td style="text-align: right;" class="valor-cell negativo">R$ 45.550,00</td>
                                <td style="text-align: right;">18,5%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Despesas administrativas</td>
                                <td style="text-align: right;">R$ 18.200,00</td>
                                <td style="text-align: right;">7,4%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Despesas comerciais</td>
                                <td style="text-align: right;">R$ 12.350,00</td>
                                <td style="text-align: right;">5%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Despesas financeiras</td>
                                <td style="text-align: right;">R$ 8.500,00</td>
                                <td style="text-align: right;">3,5%</td>
                            </tr>
                            <tr>
                                <td style="padding-left: 30px;">Outras despesas</td>
                                <td style="text-align: right;">R$ 6.500,00</td>
                                <td style="text-align: right;">2,6%</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr style="background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white;">
                                <td><strong>RESULTADO LÍQUIDO</strong></td>
                                <td style="text-align: right;"><strong>R$ 77.350,00</strong></td>
                                <td style="text-align: right;"><strong>31,5%</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        
            </div> <!-- /main-content -->
</main>
    </div>

    <!-- Modal Relatório - Design SaaS Profissional -->
    <div class="modal-overlay modal-overlay-padrão" id="modalRelatorio">
        <div class="modal modal-padrão">
            <div class="modal-header-padrão">
                <div class="header-left">
                    <div class="header-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div>
                        <h2 id="modalRelatorioTitulo">Relatório</h2>
                        <p class="subtitle">Visualização detalhada dos dados</p>
                    </div>
                </div>
                <button class="modal-close-padrão" onclick="fecharModal('modalRelatorio')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-padrão" id="modalRelatorioBody">
                <!-- Loading State Inicial -->
                <div class="loading-relatorio" id="loading-relatorio">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Carregando Relatório...</div>
                    <div class="loading-subtext">Processando dados, aguarde um momento</div>
                </div>
                <!-- Conteúdo Dinâmico -->
                <div id="conteudo-relatorio" style="display: none;"></div>
            </div>
            <div class="modal-footer-padrão">
                <button class="btn-padrão-ghost" onclick="fecharModal('modalRelatorio')">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button class="btn-padrão-danger" onclick="exportarRelatorioAtual('pdf')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn-padrão-primary" onclick="exportarRelatorioAtual('excel')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Operação de Desconto -->
    <div class="modal-overlay modal-overlay-padrão" id="modalDesconto">
        <div class="modal modal-padrão" style="max-width: 700px;">
            <div class="modal-header-padrão" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;">
                <div class="header-left">
                    <div class="header-icon" style="background: rgba(255,255,255,0.2);">
                        <i class="fas fa-percent"></i>
                    </div>
                    <div>
                        <h2>Nova Operação de Desconto</h2>
                        <p class="subtitle">Desconto de títulos a receber</p>
                    </div>
                </div>
                <button class="modal-close-padrão" onclick="fecharModal('modalDesconto')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-padrão">
                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-bottom: 24px; display: flex; gap: 12px;">
                    <i class="fas fa-info-circle" style="color: #0284c7; font-size: 18px; margin-top: 2px;"></i>
                    <p style="color: #0369a1; font-size: 13px; line-height: 1.6; margin: 0;">Preencha os dados da operação de desconto. Os valores de encargos serão calculados automaticamente com base na taxa informada.</p>
                </div>
                
                <form id="form-desconto">
                    <div class="form-section-padrão">
                        <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file-invoice" style="color: #8b5cf6;"></i> Dados do Título
                        </h4>
                        <div class="form-grid-padrão">
                            <div class="form-group-padrão">
                                <label><i class="fas fa-hashtag"></i> Número do Título <span class="required">*</span></label>
                                <input type="text" id="desconto-numero" placeholder="Ex: DUP-001234" required>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-user"></i> Cliente/Sacado <span class="required">*</span></label>
                                <input type="text" id="desconto-cliente" placeholder="Nome do cliente" required>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-dollar-sign"></i> Valor do Título <span class="required">*</span></label>
                                <input type="text" id="desconto-valor" placeholder="R$ 0,00" oninput="calcularDesconto()" required>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-calendar"></i> Data de Vencimento <span class="required">*</span></label>
                                <input type="date" id="desconto-vencimento" onchange="calcularDesconto()" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section-padrão">
                        <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-university" style="color: #8b5cf6;"></i> Dados da Operação
                        </h4>
                        <div class="form-grid-padrão">
                            <div class="form-group-padrão">
                                <label><i class="fas fa-building"></i> Banco/Instituição <span class="required">*</span></label>
                                <select id="desconto-banco" required>
                                    <option value="">Selecione o banco</option>
                                    <option value="001">001 - Banco do Brasil</option>
                                    <option value="104">104 - Caixa Econômica</option>
                                    <option value="237">237 - Bradesco</option>
                                    <option value="341">341 - Itaú</option>
                                    <option value="033">033 - Santander</option>
                                    <option value="756">756 - Sicoob</option>
                                    <option value="748">748 - Sicredi</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-calendar-day"></i> Data da Operação <span class="required">*</span></label>
                                <input type="date" id="desconto-data-operacao" onchange="calcularDesconto()" required>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-percentage"></i> Taxa de Desconto (% a.m.) <span class="required">*</span></label>
                                <input type="number" id="desconto-taxa" placeholder="Ex: 2.5" step="0.01" oninput="calcularDesconto()" required>
                            </div>
                            <div class="form-group-padrão">
                                <label><i class="fas fa-receipt"></i> IOF (%)</label>
                                <input type="number" id="desconto-iof" placeholder="Ex: 0.38" step="0.01" value="0.38" oninput="calcularDesconto()">
                            </div>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-sticky-note"></i> Observações</label>
                            <textarea id="desconto-obs" rows="2" placeholder="Informações adicionais sobre a operação..." style="resize: vertical;"></textarea>
                        </div>
                    </div>
                    
                    <!-- Resumo do Desconto -->
                    <div style="background: linear-gradient(135deg, #f5f3ff, #ede9fe); border: 1px solid #ddd6fe; border-radius: 12px; padding: 20px; margin-top: 16px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #6d28d9; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calculator"></i> Resumo da Operação
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd6fe; font-size: 14px;">
                                <span style="color: #6b7280;">Valor do Título</span>
                                <span id="resumo-valor" style="font-weight: 600;">R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd6fe; font-size: 14px;">
                                <span style="color: #6b7280;">Prazo (dias)</span>
                                <span id="resumo-prazo" style="font-weight: 600;">0 dias</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd6fe; font-size: 14px;">
                                <span style="color: #6b7280;">(-) Desconto</span>
                                <span id="resumo-desconto" style="font-weight: 600; color: #dc2626;">R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd6fe; font-size: 14px;">
                                <span style="color: #6b7280;">(-) IOF</span>
                                <span id="resumo-iof" style="font-weight: 600; color: #dc2626;">R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd6fe; font-size: 14px;">
                                <span style="color: #6b7280;">(-) Tarifa Bancária</span>
                                <span id="resumo-tarifa" style="font-weight: 600; color: #dc2626;">R$ 15,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 16px; font-weight: 700; color: #6d28d9;">
                                <span>Valor Líquido a Receber</span>
                                <span id="resumo-liquido">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer-padrão">
                <button class="btn-padrão-ghost" onclick="fecharModal('modalDesconto')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-padrão-primary" onclick="salvarDesconto()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);">
                    <i class="fas fa-check"></i> Confirmar Operação
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Relatório Contas a Pagar por Período -->
    <div class="modal-overlay modal-overlay-padrão" id="modalRelContasPagar">
        <div class="modal modal-padrão" style="max-width: 900px;">
            <div class="modal-header-padrão" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;">
                <div class="header-left">
                    <div class="header-icon" style="background: rgba(255,255,255,0.2);">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div>
                        <h2>Relatório de Contas a Pagar</h2>
                        <p class="subtitle">Filtros por período, fornecedor e banco</p>
                    </div>
                </div>
                <button class="modal-close-padrão" onclick="fecharModal('modalRelContasPagar')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-padrão">
                <!-- Filtros -->
                <div class="form-section-padrão" style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-filter" style="color: #ef4444;"></i> Filtros de Pesquisa
                    </h4>
                    <div class="form-grid-padrão">
                        <div class="form-group-padrão">
                            <label><i class="fas fa-calendar"></i> Data Inicial <span class="required">*</span></label>
                            <input type="date" id="pagar-data-inicio">
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-calendar-check"></i> Data Final <span class="required">*</span></label>
                            <input type="date" id="pagar-data-fim">
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-truck"></i> Fornecedor</label>
                            <select id="pagar-fornecedor">
                                <option value="">Todos os Fornecedores</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-university"></i> Banco (Sacado)</label>
                            <select id="pagar-banco">
                                <option value="">Todos os Bancos</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-tags"></i> Status</label>
                            <select id="pagar-status">
                                <option value="">Todos</option>
                                <option value="pendente">Pendentes</option>
                                <option value="pago">Pagos</option>
                                <option value="vencido">Vencidos</option>
                                <option value="parcial">Parcialmente Pago</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-list-alt"></i> Categoria</label>
                            <select id="pagar-categoria">
                                <option value="">Todas as Categorias</option>
                                <option value="fornecedores">Fornecedores</option>
                                <option value="despesas-fixas">Despesas Fixas</option>
                                <option value="impostos">Impostos</option>
                                <option value="folha">Folha de Pagamento</option>
                                <option value="servicos">Serviços</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="gerarRelatorioContasPagar()">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Resultado do Relatório -->
                <div id="resultado-rel-pagar" style="display: none;">
                    <div class="summary-grid" style="margin-bottom: 20px;">
                        <div class="summary-box"><h4>Total a Pagar</h4><div class="value red" id="pagar-total">R$ 0,00</div></div>
                        <div class="summary-box"><h4>Quantidade</h4><div class="value blue" id="pagar-qtd">0</div></div>
                        <div class="summary-box"><h4>Vencidos</h4><div class="value orange" id="pagar-vencidos">R$ 0,00</div></div>
                        <div class="summary-box"><h4>Pagos</h4><div class="value green" id="pagar-pagos">R$ 0,00</div></div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="tabela-rel-pagar">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Fornecedor</th>
                                    <th>Venc. Original</th>
                                    <th>Venc. Atualizado</th>
                                    <th>Valor</th>
                                    <th>Pago</th>
                                    <th>Saldo</th>
                                    <th>Banco</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-rel-pagar">
                                <!-- Dados dinâmicos -->
                            </tbody>
                            <tfoot>
                                <tr style="background: #fef2f2;">
                                    <td colspan="4"><strong>TOTAL</strong></td>
                                    <td id="pagar-total-valor"><strong>R$ 0,00</strong></td>
                                    <td id="pagar-total-pago"><strong>R$ 0,00</strong></td>
                                    <td id="pagar-total-saldo"><strong>R$ 0,00</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer-padrão">
                <button class="btn-padrão-ghost" onclick="fecharModal('modalRelContasPagar')">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button class="btn-padrão-primary" onclick="exportarRelContasPagar('pdf')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn-padrão-primary" onclick="exportarRelContasPagar('excel')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Relatório Contas a Receber por Período -->
    <div class="modal-overlay modal-overlay-padrão" id="modalRelContasReceber">
        <div class="modal modal-padrão" style="max-width: 900px;">
            <div class="modal-header-padrão" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;">
                <div class="header-left">
                    <div class="header-icon" style="background: rgba(255,255,255,0.2);">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div>
                        <h2>Relatório de Contas a Receber</h2>
                        <p class="subtitle">Filtros por período, cliente e banco</p>
                    </div>
                </div>
                <button class="modal-close-padrão" onclick="fecharModal('modalRelContasReceber')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body-padrão">
                <!-- Filtros -->
                <div class="form-section-padrão" style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-filter" style="color: #22c55e;"></i> Filtros de Pesquisa
                    </h4>
                    <div class="form-grid-padrão">
                        <div class="form-group-padrão">
                            <label><i class="fas fa-calendar"></i> Data Inicial <span class="required">*</span></label>
                            <input type="date" id="receber-data-inicio">
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-calendar-check"></i> Data Final <span class="required">*</span></label>
                            <input type="date" id="receber-data-fim">
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-user"></i> Cliente</label>
                            <select id="receber-cliente">
                                <option value="">Todos os Clientes</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-university"></i> Banco (Sacado)</label>
                            <select id="receber-banco">
                                <option value="">Todos os Bancos</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-tags"></i> Status</label>
                            <select id="receber-status">
                                <option value="">Todos</option>
                                <option value="pendente">Pendentes</option>
                                <option value="recebido">Recebidos</option>
                                <option value="vencido">Vencidos</option>
                                <option value="parcial">Parcialmente Recebido</option>
                            </select>
                        </div>
                        <div class="form-group-padrão">
                            <label><i class="fas fa-credit-card"></i> Forma de Pagamento</label>
                            <select id="receber-forma">
                                <option value="">Todas</option>
                                <option value="boleto">Boleto</option>
                                <option value="pix">PIX</option>
                                <option value="cartao">Cartão</option>
                                <option value="cheque">Cheque</option>
                                <option value="transferencia">Transferência</option>
                                <option value="dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="gerarRelatorioContasReceber()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Resultado do Relatório -->
                <div id="resultado-rel-receber" style="display: none;">
                    <div class="summary-grid" style="margin-bottom: 20px;">
                        <div class="summary-box"><h4>Total a Receber</h4><div class="value green" id="receber-total">R$ 0,00</div></div>
                        <div class="summary-box"><h4>Quantidade</h4><div class="value blue" id="receber-qtd">0</div></div>
                        <div class="summary-box"><h4>Vencidos</h4><div class="value red" id="receber-vencidos">R$ 0,00</div></div>
                        <div class="summary-box"><h4>Recebidos</h4><div class="value green" id="receber-recebidos">R$ 0,00</div></div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="tabela-rel-receber">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Cliente</th>
                                    <th>Venc. Original</th>
                                    <th>Venc. Atualizado</th>
                                    <th>Valor</th>
                                    <th>Recebido</th>
                                    <th>Saldo</th>
                                    <th>Banco</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-rel-receber">
                                <!-- Dados dinâmicos -->
                            </tbody>
                            <tfoot>
                                <tr style="background: #ecfdf5;">
                                    <td colspan="4"><strong>TOTAL</strong></td>
                                    <td id="receber-total-valor"><strong>R$ 0,00</strong></td>
                                    <td id="receber-total-recebido"><strong>R$ 0,00</strong></td>
                                    <td id="receber-total-saldo"><strong>R$ 0,00</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer-padrão">
                <button class="btn-padrão-ghost" onclick="fecharModal('modalRelContasReceber')">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button class="btn-padrão-primary" onclick="exportarRelContasReceber('pdf')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn-padrão-primary" onclick="exportarRelContasReceber('excel')" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Templates para Importação - 9 Templates Zyntra -->
    <div class="modal-overlay modal-overlay-padrão" id="modalTemplates">
        <div class="modal-container modal-container-padrão" style="max-width: 960px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.3);">
            <!-- Header Premium -->
            <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 60%, #064e3b 100%); padding: 28px 32px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(16,185,129,0.1); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -20px; right: 60px; width: 80px; height: 80px; background: rgba(16,185,129,0.08); border-radius: 50%;"></div>
                <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16,185,129,0.4);">
                            <i class="fas fa-file-excel" style="color: white; font-size: 22px;"></i>
                        </div>
                        <div>
                            <h2 style="color: white; font-size: 20px; font-weight: 700; margin: 0; letter-spacing: -0.3px;">Templates para Importação</h2>
                            <p style="color: #94a3b8; font-size: 13px; margin: 4px 0 0 0;">Padrão <span style="color: #34d399; font-weight: 600;">Zyntra</span> • Compatível com Omie</p>
                        </div>
                    </div>
                    <button onclick="fecharModal('modalTemplates')" style="width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #94a3b8; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.15)';this.style.color='white'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.color='#94a3b8'">&times;</button>
                </div>
            </div>

            <div style="padding: 24px 32px 28px; max-height: 72vh; overflow-y: auto; background: #f8fafc;">
                <!-- Filtros de Categoria -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 22px;">
                    <button onclick="filtrarTemplates('todos')" class="tmpl-filter-btn active" data-filter="todos">Todos <span style="opacity: 0.7; margin-left: 2px;">9</span></button>
                    <button onclick="filtrarTemplates('financeiro')" class="tmpl-filter-btn" data-filter="financeiro">💰 Financeiro</button>
                    <button onclick="filtrarTemplates('cadastros')" class="tmpl-filter-btn" data-filter="cadastros">📋 Cadastros</button>
                    <button onclick="filtrarTemplates('operacional')" class="tmpl-filter-btn" data-filter="operacional">📦 Operacional</button>
                </div>

                <!-- Grid 3x3 -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;" id="templatesGrid">

                    <!-- 1. Clientes e Fornecedores -->
                    <div class="template-card" data-cat="cadastros" onclick="baixarTemplate('clientes-fornecedores')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(59,130,246,0.12)';this.style.borderColor='#93c5fd'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-users" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Clientes e Fornecedores</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">61 colunas • 1 aba</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #3b82f6; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #eff6ff; color: #3b82f6; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Cadastro</span>
                        </div>
                    </div>

                    <!-- 2. Contas a Pagar -->
                    <div class="template-card" data-cat="financeiro" onclick="baixarTemplate('contas-pagar')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(239,68,68,0.12)';this.style.borderColor='#fca5a5'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #ef4444, #dc2626); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-file-invoice-dollar" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Contas a Pagar</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">61 colunas • 1 aba</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #ef4444; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #fef2f2; color: #ef4444; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Financeiro</span>
                        </div>
                    </div>

                    <!-- 3. Contas a Receber -->
                    <div class="template-card" data-cat="financeiro" onclick="baixarTemplate('contas-receber')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(34,197,94,0.12)';this.style.borderColor='#86efac'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #22c55e, #16a34a); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-hand-holding-usd" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Contas a Receber</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">41 colunas • 1 aba</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #16a34a; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #f0fdf4; color: #16a34a; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Financeiro</span>
                        </div>
                    </div>

                    <!-- 4. Contratos -->
                    <div class="template-card" data-cat="financeiro" onclick="baixarTemplate('contratos')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(139,92,246,0.12)';this.style.borderColor='#c4b5fd'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-file-signature" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Contratos</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">62 colunas • 3 abas</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #8b5cf6; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #f5f3ff; color: #8b5cf6; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Financeiro</span>
                        </div>
                    </div>

                    <!-- 5. Produtos -->
                    <div class="template-card" data-cat="cadastros" onclick="baixarTemplate('produtos')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(249,115,22,0.12)';this.style.borderColor='#fdba74'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #f97316, #ea580c); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-boxes" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Produtos</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">39 colunas • 12 abas</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #f97316; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #fff7ed; color: #ea580c; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Cadastro</span>
                        </div>
                    </div>

                    <!-- 6. Serviços -->
                    <div class="template-card" data-cat="cadastros" onclick="baixarTemplate('servicos')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(20,184,166,0.12)';this.style.borderColor='#5eead4'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #14b8a6, #0d9488); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-tools" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Serviços</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">24 colunas • 2 abas</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #14b8a6; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #f0fdfa; color: #0d9488; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Cadastro</span>
                        </div>
                    </div>

                    <!-- 7. Importação de Mercadoria -->
                    <div class="template-card" data-cat="operacional" onclick="baixarTemplate('importacao-mercadoria')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(245,158,11,0.12)';this.style.borderColor='#fcd34d'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-ship" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Importação Mercadoria</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">28 colunas • 1 aba</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #d97706; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #fffbeb; color: #d97706; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Operacional</span>
                        </div>
                    </div>

                    <!-- 8. Ordens de Serviço -->
                    <div class="template-card" data-cat="operacional" onclick="baixarTemplate('ordens-servico')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(99,102,241,0.12)';this.style.borderColor='#a5b4fc'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #6366f1, #4f46e5); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-clipboard-list" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Ordens de Serviço</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">52 colunas • 3 abas</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #6366f1; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #eef2ff; color: #4f46e5; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Operacional</span>
                        </div>
                    </div>

                    <!-- 9. Remessa de Produto -->
                    <div class="template-card" data-cat="operacional" onclick="baixarTemplate('remessa-produto')" style="background: white; border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.25s ease; border: 1px solid #e2e8f0; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(244,63,94,0.12)';this.style.borderColor='#fda4af'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #f43f5e, #e11d48); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-truck" style="color: white; font-size: 15px;"></i>
                            </div>
                            <div style="min-width: 0;">
                                <h4 style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 0;">Remessa de Produto</h4>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: 500;">14 colunas • 1 aba</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-size: 11px; color: #f43f5e; font-weight: 600;"><i class="fas fa-download" style="margin-right: 4px;"></i> Baixar</span>
                            <span style="font-size: 9px; background: #fff1f2; color: #e11d48; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Operacional</span>
                        </div>
                    </div>

                </div>

                <!-- Baixar Todos -->
                <div onclick="baixarTodosTemplates()" style="margin-top: 18px; border: 2px dashed #d1d5db; border-radius: 12px; padding: 16px 24px; cursor: pointer; transition: all 0.25s ease; background: white; display: flex; align-items: center; justify-content: center; gap: 14px;" onmouseover="this.style.borderColor='#10b981';this.style.background='linear-gradient(135deg, #f0fdf4, #ecfdf5)';this.style.transform='translateY(-1px)'" onmouseout="this.style.borderColor='#d1d5db';this.style.background='white';this.style.transform='none'">
                    <div style="width: 42px; height: 42px; border-radius: 10px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(16,185,129,0.3);">
                        <i class="fas fa-cloud-download-alt" style="color: white; font-size: 18px;"></i>
                    </div>
                    <div>
                        <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin: 0;">Baixar Todos os Templates</h4>
                        <p style="font-size: 11px; color: #94a3b8; margin: 3px 0 0 0;">9 templates Zyntra em downloads separados (.xlsx)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let relatorioAtual = '';
        let dadosContasPagar = [];
        let dadosContasReceber = [];
        let fornecedores = [];
        let clientes = [];
        let bancos = [];

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            carregarUsuario();
            carregarResumoFinanceiro();
            inicializarGraficos();
            carregarFornecedores();
            carregarClientes();
            carregarBancos();
            // Definir data de operação como hoje
            document.getElementById('desconto-data-operacao').value = new Date().toISOString().split('T')[0];
            // Definir datas padrão nos filtros de relatório
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
            const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
            
            document.getElementById('pagar-data-inicio').value = primeiroDia;
            document.getElementById('pagar-data-fim').value = ultimoDia;
            document.getElementById('receber-data-inicio').value = primeiroDia;
            document.getElementById('receber-data-fim').value = ultimoDia;

            // Definir datas no filtro principal
            const elInicio = document.getElementById('dataInício');
            const elFim = document.getElementById('dataFim');
            if (elInicio) elInicio.value = primeiroDia;
            if (elFim) elFim.value = ultimoDia;
        });

        // ========== CARREGAR DADOS PARA FILTROS ==========
        
        async function carregarFornecedores() {
            try {
                const response = await fetch('/api/fornecedores', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    fornecedores = data.data || data || [];
                    const select = document.getElementById('pagar-fornecedor');
                    select.innerHTML = '<option value="">Todos os Fornecedores</option>';
                    fornecedores.forEach(f => {
                        select.innerHTML += `<option value="${f.id}">${f.nome || f.razao_social || f.nome_fantasia || '-'}</option>`;
                    });
                }
            } catch (e) { console.error('Erro ao carregar fornecedores:', e); }
        }

        async function carregarClientes() {
            try {
                const response = await fetch('/api/clientes', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    clientes = data.data || data || [];
                    const select = document.getElementById('receber-cliente');
                    select.innerHTML = '<option value="">Todos os Clientes</option>';
                    clientes.forEach(c => {
                        select.innerHTML += `<option value="${c.id}">${c.nome || c.razao_social || c.nome_fantasia || '-'}</option>`;
                    });
                }
            } catch (e) { console.error('Erro ao carregar clientes:', e); }
        }

        async function carregarBancos() {
            try {
                const response = await fetch('/api/financeiro/contas-bancarias', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    bancos = data.data || data || [];
                    const selectPagar = document.getElementById('pagar-banco');
                    const selectReceber = document.getElementById('receber-banco');
                    
                    const options = '<option value="">Todos os Bancos</option>' + 
                        bancos.map(b => `<option value="${b.id}">${b.banco} - ${b.agencia}/${b.conta}</option>`).join('');
                    
                    selectPagar.innerHTML = options;
                    selectReceber.innerHTML = options;
                }
            } catch (e) { console.error('Erro ao carregar bancos:', e); }
        }

        // ========== RELATÓRIO CONTAS A PAGAR ==========

        function abrirModalRelatorioContasPagar() {
            document.getElementById('modalRelContasPagar').classList.add('active');
            document.getElementById('resultado-rel-pagar').style.display = 'none';
        }

        async function gerarRelatorioContasPagar() {
            const dataInicio = document.getElementById('pagar-data-inicio').value;
            const dataFim = document.getElementById('pagar-data-fim').value;
            const fornecedor = document.getElementById('pagar-fornecedor').value;
            const banco = document.getElementById('pagar-banco').value;
            const status = document.getElementById('pagar-status').value;
            const categoria = document.getElementById('pagar-categoria').value;

            if (!dataInicio || !dataFim) {
                mostrarNotificacao('Informe o período inicial e final', 'warning');
                return;
            }

            // Mostrar loading no botão
            const btnGerar = event.target;
            const btnOriginalText = btnGerar.innerHTML;
            btnGerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btnGerar.disabled = true;

            try {
                let url = `/api/financeiro/contas-pagar?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                if (status) url += `&status=${status}`;
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                let contas = data.data || data || [];
                
                // Filtrar por fornecedor se selecionado
                if (fornecedor) {
                    contas = contas.filter(c => c.fornecedor_id == fornecedor);
                }
                
                // Filtrar por banco se selecionado
                if (banco) {
                    contas = contas.filter(c => c.conta_bancaria_id == banco || c.banco_id == banco);
                }
                
                // Filtrar por categoria se selecionado
                if (categoria) {
                    contas = contas.filter(c => c.categoria === categoria);
                }
                
                dadosContasPagar = contas;
                renderizarTabelaContasPagar(contas);
                document.getElementById('resultado-rel-pagar').style.display = 'block';
                mostrarNotificacao(`Relatório gerado com ${contas.length} registro(s)`, 'success');
                
            } catch (e) {
                console.error('Erro ao gerar relatório:', e);
                mostrarNotificacao('Erro ao gerar relatório', 'error');
            } finally {
                // Restaurar botão
                btnGerar.innerHTML = btnOriginalText;
                btnGerar.disabled = false;
            }
        }

        function renderizarTabelaContasPagar(contas) {
            const tbody = document.getElementById('tbody-rel-pagar');
            const hoje = new Date().toISOString().split('T')[0];
            
            let totalValor = 0;
            let totalPago = 0;
            let totalVencidos = 0;
            let totalPagos = 0;
            
            tbody.innerHTML = contas.map(c => {
                const valor = parseFloat(c.valor_total || c.valor || 0);
                const pago = parseFloat(c.valor_pago || 0);
                const saldo = valor - pago;
                const vencOriginal = c.data_vencimento_original || c.data_vencimento || c.vencimento;
                const vencAtual = c.data_vencimento || c.vencimento;
                
                totalValor += valor;
                totalPago += pago;
                
                let status = c.status || 'pendente';
                if (status !== 'pago' && vencAtual && vencAtual < hoje) {
                    status = 'vencido';
                    totalVencidos += saldo;
                }
                if (status === 'pago') totalPagos += valor;
                
                const statusClass = {
                    'pago': 'color: #22c55e',
                    'vencido': 'color: #ef4444',
                    'parcial': 'color: #f59e0b',
                    'pendente': 'color: #64748b'
                }[status] || 'color: #64748b';
                
                const statusLabel = {
                    'pago': 'Pago',
                    'vencido': 'Vencido',
                    'parcial': 'Parcial',
                    'pendente': 'Pendente'
                }[status] || status;
                
                const bancoNome = bancos.find(b => b.id == (c.conta_bancaria_id || c.banco_id))?.banco || '-';
                
                return `
                    <tr>
                        <td>${c.numero_documento || c.documento || '-'}</td>
                        <td>${c.fornecedor_nome || c.fornecedor || '-'}</td>
                        <td>${formatarData(vencOriginal)}</td>
                        <td>${formatarData(vencAtual)}</td>
                        <td class="valor-cell negativo">${formatarMoeda(valor)}</td>
                        <td>${formatarMoeda(pago)}</td>
                        <td>${formatarMoeda(saldo)}</td>
                        <td>${bancoNome}</td>
                        <td><span style="${statusClass}; font-weight: 600;">${statusLabel}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Atualizar totais
            document.getElementById('pagar-total').textContent = formatarMoeda(totalValor);
            document.getElementById('pagar-qtd').textContent = contas.length;
            document.getElementById('pagar-vencidos').textContent = formatarMoeda(totalVencidos);
            document.getElementById('pagar-pagos').textContent = formatarMoeda(totalPagos);
            document.getElementById('pagar-total-valor').innerHTML = `<strong>${formatarMoeda(totalValor)}</strong>`;
            document.getElementById('pagar-total-pago').innerHTML = `<strong>${formatarMoeda(totalPago)}</strong>`;
            document.getElementById('pagar-total-saldo').innerHTML = `<strong>${formatarMoeda(totalValor - totalPago)}</strong>`;
        }

        function exportarRelContasPagar(formato) {
            if (dadosContasPagar.length === 0) {
                mostrarNotificacao('Gere o relatório primeiro', 'warning');
                return;
            }
            mostrarNotificacao(`Exportando relatório em ${formato.toUpperCase()}...`, 'info');
            // Aqui implementaria a exportação real
        }

        // ========== RELATÓRIO CONTAS A RECEBER ==========

        function abrirModalRelatorioContasReceber() {
            document.getElementById('modalRelContasReceber').classList.add('active');
            document.getElementById('resultado-rel-receber').style.display = 'none';
        }

        async function gerarRelatorioContasReceber() {
            const dataInicio = document.getElementById('receber-data-inicio').value;
            const dataFim = document.getElementById('receber-data-fim').value;
            const cliente = document.getElementById('receber-cliente').value;
            const banco = document.getElementById('receber-banco').value;
            const status = document.getElementById('receber-status').value;
            const forma = document.getElementById('receber-forma').value;

            if (!dataInicio || !dataFim) {
                mostrarNotificacao('Informe o período inicial e final', 'warning');
                return;
            }

            // Mostrar loading no botão
            const btnGerar = event.target;
            const btnOriginalText = btnGerar.innerHTML;
            btnGerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btnGerar.disabled = true;

            try {
                let url = `/api/financeiro/contas-receber?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                if (status) url += `&status=${status}`;
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                let contas = data.data || data || [];
                
                // Filtrar por cliente se selecionado
                if (cliente) {
                    contas = contas.filter(c => c.cliente_id == cliente);
                }
                
                // Filtrar por banco se selecionado
                if (banco) {
                    contas = contas.filter(c => c.conta_bancaria_id == banco || c.banco_id == banco);
                }
                
                // Filtrar por forma de pagamento se selecionado
                if (forma) {
                    contas = contas.filter(c => c.forma_pagamento === forma);
                }
                
                dadosContasReceber = contas;
                renderizarTabelaContasReceber(contas);
                document.getElementById('resultado-rel-receber').style.display = 'block';
                mostrarNotificacao(`Relatório gerado com ${contas.length} registro(s)`, 'success');
                
            } catch (e) {
                console.error('Erro ao gerar relatório:', e);
                mostrarNotificacao('Erro ao gerar relatório', 'error');
            } finally {
                // Restaurar botão
                btnGerar.innerHTML = btnOriginalText;
                btnGerar.disabled = false;
            }
        }

        function renderizarTabelaContasReceber(contas) {
            const tbody = document.getElementById('tbody-rel-receber');
            const hoje = new Date().toISOString().split('T')[0];
            
            let totalValor = 0;
            let totalRecebido = 0;
            let totalVencidos = 0;
            let totalRecebidos = 0;
            
            tbody.innerHTML = contas.map(c => {
                const valor = parseFloat(c.valor_total || c.valor || 0);
                const recebido = parseFloat(c.valor_recebido || c.valor_pago || 0);
                const saldo = valor - recebido;
                const vencOriginal = c.data_vencimento_original || c.data_vencimento || c.vencimento;
                const vencAtual = c.data_vencimento || c.vencimento;
                
                totalValor += valor;
                totalRecebido += recebido;
                
                let status = c.status || 'pendente';
                if (status !== 'recebido' && status !== 'pago' && vencAtual && vencAtual < hoje) {
                    status = 'vencido';
                    totalVencidos += saldo;
                }
                if (status === 'recebido' || status === 'pago') totalRecebidos += valor;
                
                const statusClass = {
                    'recebido': 'color: #22c55e',
                    'pago': 'color: #22c55e',
                    'vencido': 'color: #ef4444',
                    'parcial': 'color: #f59e0b',
                    'pendente': 'color: #64748b'
                }[status] || 'color: #64748b';
                
                const statusLabel = {
                    'recebido': 'Recebido',
                    'pago': 'Recebido',
                    'vencido': 'Vencido',
                    'parcial': 'Parcial',
                    'pendente': 'Pendente'
                }[status] || status;
                
                const bancoNome = bancos.find(b => b.id == (c.conta_bancaria_id || c.banco_id))?.banco || '-';
                
                return `
                    <tr>
                        <td>${c.numero_documento || c.documento || '-'}</td>
                        <td>${c.cliente_nome || c.cliente || '-'}</td>
                        <td>${formatarData(vencOriginal)}</td>
                        <td>${formatarData(vencAtual)}</td>
                        <td class="valor-cell positivo">${formatarMoeda(valor)}</td>
                        <td>${formatarMoeda(recebido)}</td>
                        <td>${formatarMoeda(saldo)}</td>
                        <td>${bancoNome}</td>
                        <td><span style="${statusClass}; font-weight: 600;">${statusLabel}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Atualizar totais
            document.getElementById('receber-total').textContent = formatarMoeda(totalValor);
            document.getElementById('receber-qtd').textContent = contas.length;
            document.getElementById('receber-vencidos').textContent = formatarMoeda(totalVencidos);
            document.getElementById('receber-recebidos').textContent = formatarMoeda(totalRecebidos);
            document.getElementById('receber-total-valor').innerHTML = `<strong>${formatarMoeda(totalValor)}</strong>`;
            document.getElementById('receber-total-recebido').innerHTML = `<strong>${formatarMoeda(totalRecebido)}</strong>`;
            document.getElementById('receber-total-saldo').innerHTML = `<strong>${formatarMoeda(totalValor - totalRecebido)}</strong>`;
        }

        function exportarRelContasReceber(formato) {
            if (dadosContasReceber.length === 0) {
                mostrarNotificacao('Gere o relatório primeiro', 'warning');
                return;
            }
            mostrarNotificacao(`Exportando relatório em ${formato.toUpperCase()}...`, 'info');
            // Aqui implementaria a exportação real
        }

        // ========== FUNÇÕES AUXILIARES ==========

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
        }

        function formatarData(data) {
            if (!data) return '-';
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        // ========== FUNÇÕES DE DESCONTO ==========
        
        function abrirModalDesconto() {
            document.getElementById('modalDesconto').classList.add('active');
            document.getElementById('desconto-data-operacao').value = new Date().toISOString().split('T')[0];
        }

        function formatarMoedaInput(valor) {
            if (isNaN(valor) || valor === null || valor === undefined) return 'R$ 0,00';
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function parsearMoedaInput(valor) {
            if (!valor) return 0;
            return parseFloat(valor.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
        }

        // Máscara de moeda
        document.getElementById('desconto-valor')?.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            if (!valor) { e.target.value = ''; return; }
            valor = (parseInt(valor) / 100).toFixed(2);
            e.target.value = formatarMoedaInput(parseFloat(valor));
            calcularDesconto();
        });

        function calcularDesconto() {
            const valorTitulo = parsearMoedaInput(document.getElementById('desconto-valor')?.value || '0');
            const dataVencimento = new Date(document.getElementById('desconto-vencimento')?.value);
            const dataOperacao = new Date(document.getElementById('desconto-data-operacao')?.value);
            const taxaMensal = parseFloat(document.getElementById('desconto-taxa')?.value) || 0;
            const iof = parseFloat(document.getElementById('desconto-iof')?.value) || 0.38;
            const tarifaBancaria = 15.00;

            // Calcular prazo em dias
            const prazo = Math.max(0, Math.ceil((dataVencimento - dataOperacao) / (1000 * 60 * 60 * 24)));
            
            // Calcular taxa proporcional ao período
            const taxaDiaria = taxaMensal / 30;
            const valorDesconto = valorTitulo * (taxaDiaria / 100) * prazo;
            
            // Calcular IOF
            const valorIOF = valorTitulo * (iof / 100);
            
            // Calcular valor líquido
            const valorLiquido = valorTitulo - valorDesconto - valorIOF - tarifaBancaria;

            // Atualizar resumo
            document.getElementById('resumo-valor').textContent = formatarMoedaInput(valorTitulo);
            document.getElementById('resumo-prazo').textContent = `${prazo} dias`;
            document.getElementById('resumo-desconto').textContent = formatarMoedaInput(valorDesconto);
            document.getElementById('resumo-iof').textContent = formatarMoedaInput(valorIOF);
            document.getElementById('resumo-tarifa').textContent = formatarMoedaInput(tarifaBancaria);
            document.getElementById('resumo-liquido').textContent = formatarMoedaInput(valorLiquido);
        }

        async function salvarDesconto() {
            const form = document.getElementById('form-desconto');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const dados = {
                numero_titulo: document.getElementById('desconto-numero').value,
                cliente_sacado: document.getElementById('desconto-cliente').value,
                valor_titulo: parsearMoedaInput(document.getElementById('desconto-valor').value),
                data_vencimento: document.getElementById('desconto-vencimento').value,
                banco: document.getElementById('desconto-banco').value,
                data_operacao: document.getElementById('desconto-data-operacao').value,
                taxa_desconto: parseFloat(document.getElementById('desconto-taxa').value),
                iof: parseFloat(document.getElementById('desconto-iof').value) || 0.38,
                observacoes: document.getElementById('desconto-obs').value,
                valor_liquido: parsearMoedaInput(document.getElementById('resumo-liquido').textContent)
            };

            try {
                const response = await fetch('/api/financeiro/operacoes/desconto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    mostrarToast('Operação de desconto registrada com sucesso!', 'success');
                    fecharModal('modalDesconto');
                    form.reset();
                    document.getElementById('desconto-data-operacao').value = new Date().toISOString().split('T')[0];
                    limparResumoDesconto();
                } else {
                    const erro = await response.json();
                    mostrarToast(erro.message || 'Erro ao registrar operação', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar desconto:', error);
                mostrarToast('Erro de conexão ao registrar operação de desconto', 'error');
            }
        }

        function limparResumoDesconto() {
            document.getElementById('resumo-valor').textContent = 'R$ 0,00';
            document.getElementById('resumo-prazo').textContent = '0 dias';
            document.getElementById('resumo-desconto').textContent = 'R$ 0,00';
            document.getElementById('resumo-iof').textContent = 'R$ 0,00';
            document.getElementById('resumo-tarifa').textContent = 'R$ 15,00';
            document.getElementById('resumo-liquido').textContent = 'R$ 0,00';
        }

        function mostrarToast(mensagem, tipo) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 24px; right: 24px; padding: 16px 24px;
                border-radius: 12px; color: white; font-weight: 600; font-size: 14px;
                display: flex; align-items: center; gap: 12px; z-index: 10000;
                box-shadow: 0 8px 30px rgba(0,0,0,0.2); animation: toastSlide 0.3s ease;
                background: ${tipo === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
            `;
            toast.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${mensagem}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ========== FIM FUNÇÕES DE DESCONTO ==========

        // Carregar dados do resumo financeiro para os stat cards e DRE
        // Aceita datas opcionais - se não fornecidas, usa mês atual
        async function carregarResumoFinanceiro(dataInicioParam, dataFimParam) {
            try {
                const hoje = new Date();
                const primeiroDia = dataInicioParam || new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                const ultimoDia = dataFimParam || new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
                
                // Atualizar período exibido
                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const periodoEl = document.getElementById('periodoResumo');
                if (periodoEl) {
                    const dI = new Date(primeiroDia + 'T00:00:00');
                    const dF = new Date(ultimoDia + 'T00:00:00');
                    if (dI.getMonth() === dF.getMonth() && dI.getFullYear() === dF.getFullYear()) {
                        periodoEl.textContent = `${meses[dI.getMonth()]} ${dI.getFullYear()}`;
                    } else {
                        periodoEl.textContent = `${dI.toLocaleDateString('pt-BR')} a ${dF.toLocaleDateString('pt-BR')}`;
                    }
                }

                // Buscar contas a receber (período selecionado)
                const receberResp = await fetch(`/api/financeiro/contas-receber?data_inicio=${primeiroDia}&data_fim=${ultimoDia}`, { credentials: 'include' });
                const receberData = receberResp.ok ? await receberResp.json() : { data: [] };
                const contasReceber = Array.isArray(receberData) ? receberData : (receberData.data || []);
                
                // Buscar contas a pagar (período selecionado)
                const pagarResp = await fetch(`/api/financeiro/contas-pagar?data_inicio=${primeiroDia}&data_fim=${ultimoDia}`, { credentials: 'include' });
                const pagarData = pagarResp.ok ? await pagarResp.json() : { data: [] };
                const contasPagar = Array.isArray(pagarData) ? pagarData : (pagarData.data || []);

                // Buscar saldo das contas bancárias
                const bancosResp = await fetch('/api/financeiro/contas-bancarias', { credentials: 'include' });
                const bancosData = bancosResp.ok ? await bancosResp.json() : { data: [] };
                const bancosArr = Array.isArray(bancosData) ? bancosData : (bancosData.data || []);

                // Calcular totais
                const totalReceber = contasReceber.reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                const totalRecebido = contasReceber.filter(c => c.status === 'recebido' || c.status === 'pago')
                    .reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                
                const totalPagar = contasPagar.reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                const totalPago = contasPagar.filter(c => c.status === 'pago')
                    .reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                
                const saldoContas = bancosArr.reduce((sum, b) => sum + parseFloat(b.saldo_atual || b.saldo || 0), 0);
                const saldoProjetado = saldoContas + totalReceber - totalPagar;

                // Atualizar os cards do header
                document.getElementById('statTotalReceber').textContent = formatarMoeda(totalReceber);
                document.getElementById('statTotalPagar').textContent = formatarMoeda(totalPagar);
                document.getElementById('statSaldoProjetado').textContent = formatarMoeda(saldoProjetado);
                document.getElementById('statSaldoContas').textContent = formatarMoeda(saldoContas);

                // ===== COMPARAÇÃO COM MÊS ANTERIOR =====
                await atualizarPercentuaisComparacao(primeiroDia, ultimoDia, totalReceber, totalPagar, saldoProjetado, saldoContas);

                // ===== ATUALIZAR RESUMO DO PERÍODO =====
                const receitaBruta = totalRecebido || totalReceber;
                const despesasTotais = totalPago || totalPagar;
                const resultadoLiquido = receitaBruta - despesasTotais;
                const margemLiquida = receitaBruta > 0 ? ((resultadoLiquido / receitaBruta) * 100) : 0;

                // Atualizar cards do resumo
                const receitaBrutaEl = document.getElementById('receitaBruta');
                const despesasTotaisEl = document.getElementById('despesasTotais');
                const resultadoLiquidoEl = document.getElementById('resultadoLiquido');
                const margemLiquidaEl = document.getElementById('margemLiquida');

                if (receitaBrutaEl) receitaBrutaEl.textContent = formatarMoeda(receitaBruta);
                if (despesasTotaisEl) despesasTotaisEl.textContent = formatarMoeda(despesasTotais);
                if (resultadoLiquidoEl) {
                    resultadoLiquidoEl.textContent = formatarMoeda(resultadoLiquido);
                    resultadoLiquidoEl.className = 'value ' + (resultadoLiquido >= 0 ? 'green' : 'red');
                }
                if (margemLiquidaEl) {
                    margemLiquidaEl.textContent = margemLiquida.toFixed(1) + '%';
                    margemLiquidaEl.className = 'value ' + (margemLiquida >= 0 ? 'orange' : 'red');
                }

                // ===== ATUALIZAR TABELA DRE =====
                atualizarTabelaDRE(receitaBruta, despesasTotais, contasPagar);

                // ===== ATUALIZAR GRÁFICOS COM DADOS REAIS =====
                await atualizarGraficosComDadosReais();

                // Guardar dados globais para uso nos relatórios dinâmicos
                window._dadosFinanceiros = {
                    contasReceber, contasPagar, bancosArr,
                    totalReceber, totalPagar, totalRecebido, totalPago,
                    saldoContas, saldoProjetado, receitaBruta, despesasTotais,
                    resultadoLiquido, margemLiquida,
                    periodoInicio: primeiroDia, periodoFim: ultimoDia
                };

            } catch (error) {
                console.error('Erro ao carregar resumo financeiro:', error);
            }
        }

        // Calcular percentuais de variação vs mês anterior
        async function atualizarPercentuaisComparacao(inicioAtual, fimAtual, totalReceber, totalPagar, saldoProjetado, saldoContas) {
            try {
                const dInicio = new Date(inicioAtual + 'T00:00:00');
                const mesAnteriorInicio = new Date(dInicio.getFullYear(), dInicio.getMonth() - 1, 1).toISOString().split('T')[0];
                const mesAnteriorFim = new Date(dInicio.getFullYear(), dInicio.getMonth(), 0).toISOString().split('T')[0];

                const [receberAnt, pagarAnt] = await Promise.all([
                    fetch(`/api/financeiro/contas-receber?data_inicio=${mesAnteriorInicio}&data_fim=${mesAnteriorFim}`, { credentials: 'include' }).then(r => r.ok ? r.json() : { data: [] }).catch(() => ({ data: [] })),
                    fetch(`/api/financeiro/contas-pagar?data_inicio=${mesAnteriorInicio}&data_fim=${mesAnteriorFim}`, { credentials: 'include' }).then(r => r.ok ? r.json() : { data: [] }).catch(() => ({ data: [] }))
                ]);

                const arrReceberAnt = Array.isArray(receberAnt) ? receberAnt : (receberAnt.data || []);
                const arrPagarAnt = Array.isArray(pagarAnt) ? pagarAnt : (pagarAnt.data || []);

                const totalReceberAnt = arrReceberAnt.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                const totalPagarAnt = arrPagarAnt.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                const saldoProjetadoAnt = saldoContas + totalReceberAnt - totalPagarAnt;

                function setChange(elId, atual, anterior) {
                    const el = document.getElementById(elId);
                    if (!el) return;
                    if (anterior === 0 && atual === 0) {
                        el.innerHTML = '<i class="fas fa-minus"></i> 0%';
                        el.className = 'stat-change';
                        return;
                    }
                    const pct = anterior > 0 ? (((atual - anterior) / anterior) * 100) : (atual > 0 ? 100 : 0);
                    const isUp = pct >= 0;
                    el.innerHTML = `<i class="fas fa-arrow-${isUp ? 'up' : 'down'}"></i> ${Math.abs(pct).toFixed(1)}%`;
                    // For receitas/saldo: up is good. For despesas: down is good
                    if (elId === 'changePagar') {
                        el.className = 'stat-change ' + (isUp ? 'down' : 'up');
                    } else {
                        el.className = 'stat-change ' + (isUp ? 'up' : 'down');
                    }
                }

                setChange('changeReceber', totalReceber, totalReceberAnt);
                setChange('changePagar', totalPagar, totalPagarAnt);
                setChange('changeSaldo', saldoProjetado, saldoProjetadoAnt);
                // Bancário não tem comparação mensal, sempre mostra saldo atual
                const changeContas = document.getElementById('changeContas');
                if (changeContas) {
                    changeContas.innerHTML = '<i class="fas fa-check-circle"></i> Saldo atual';
                    changeContas.className = 'stat-change up';
                }
            } catch (e) {
                console.error('Erro ao calcular comparação:', e);
            }
        }

        function atualizarTabelaDRE(receitaBruta, despesasTotais, contasPagar) {
            // Calcular categorias de despesas
            const despesasPorCategoria = {};
            contasPagar.forEach(c => {
                const cat = c.categoria || 'outros';
                if (!despesasPorCategoria[cat]) despesasPorCategoria[cat] = 0;
                despesasPorCategoria[cat] += parseFloat(c.valor_total || c.valor || 0);
            });

            // Estimativas baseadas em percentuais típicos se não houver dados
            const deducoes = receitaBruta * 0.10; // 10% impostos sobre vendas
            const receitaLiquida = receitaBruta - deducoes;
            
            const custosFornecedores = despesasPorCategoria['fornecedores'] || despesasPorCategoria['materia-prima'] || despesasTotais * 0.40;
            const custosMaoObra = despesasPorCategoria['folha'] || despesasPorCategoria['pessoal'] || despesasTotais * 0.20;
            const custosTotais = custosFornecedores + custosMaoObra;
            
            const lucroBruto = receitaLiquida - custosTotais;
            
            const despesasAdmin = despesasPorCategoria['administrativas'] || despesasPorCategoria['despesas-fixas'] || despesasTotais * 0.12;
            const despesasComerciais = despesasPorCategoria['comerciais'] || despesasTotais * 0.08;
            const despesasFinanceiras = despesasPorCategoria['financeiras'] || despesasPorCategoria['juros'] || despesasTotais * 0.05;
            const despesasOp = despesasAdmin + despesasComerciais + despesasFinanceiras;
            
            const lucroOperacional = lucroBruto - despesasOp;
            const lucroLiquido = lucroOperacional;

            // Atualizar HTML da tabela DRE
            const tabelaDRE = document.getElementById('tabelaDRE');
            if (tabelaDRE) {
                const tbody = tabelaDRE.querySelector('tbody');
                if (tbody) {
                    const pct = (v) => receitaBruta > 0 ? ((v / receitaBruta) * 100).toFixed(1) + '%' : '0%';
                    
                    tbody.innerHTML = `
                        <tr>
                            <td><strong>RECEITA BRUTA</strong></td>
                            <td style="text-align: right;" class="valor-cell positivo">${formatarMoeda(receitaBruta)}</td>
                            <td style="text-align: right;">100%</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Vendas de Produtos</td>
                            <td style="text-align: right;">${formatarMoeda(receitaBruta * 0.75)}</td>
                            <td style="text-align: right;">75,0%</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Serviços</td>
                            <td style="text-align: right;">${formatarMoeda(receitaBruta * 0.25)}</td>
                            <td style="text-align: right;">25,0%</td>
                        </tr>
                        <tr style="background: #f1f5f9;">
                            <td><strong>(-) DEDUÇÕES</strong></td>
                            <td style="text-align: right;" class="valor-cell negativo">${formatarMoeda(deducoes)}</td>
                            <td style="text-align: right;">${pct(deducoes)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Impostos sobre vendas</td>
                            <td style="text-align: right;">${formatarMoeda(deducoes)}</td>
                            <td style="text-align: right;">${pct(deducoes)}</td>
                        </tr>
                        <tr style="background: #e0f2fe;">
                            <td><strong>RECEITA LÍQUIDA</strong></td>
                            <td style="text-align: right;"><strong>${formatarMoeda(receitaLiquida)}</strong></td>
                            <td style="text-align: right;"><strong>${pct(receitaLiquida)}</strong></td>
                        </tr>
                        <tr style="background: #f1f5f9;">
                            <td><strong>(-) CUSTOS</strong></td>
                            <td style="text-align: right;" class="valor-cell negativo">${formatarMoeda(custosTotais)}</td>
                            <td style="text-align: right;">${pct(custosTotais)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Matéria-prima / Fornecedores</td>
                            <td style="text-align: right;">${formatarMoeda(custosFornecedores)}</td>
                            <td style="text-align: right;">${pct(custosFornecedores)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Mão de obra direta</td>
                            <td style="text-align: right;">${formatarMoeda(custosMaoObra)}</td>
                            <td style="text-align: right;">${pct(custosMaoObra)}</td>
                        </tr>
                        <tr style="background: #e0f2fe;">
                            <td><strong>LUCRO BRUTO</strong></td>
                            <td style="text-align: right;"><strong>${formatarMoeda(lucroBruto)}</strong></td>
                            <td style="text-align: right;"><strong>${pct(lucroBruto)}</strong></td>
                        </tr>
                        <tr style="background: #f1f5f9;">
                            <td><strong>(-) DESPESAS OPERACIONAIS</strong></td>
                            <td style="text-align: right;" class="valor-cell negativo">${formatarMoeda(despesasOp)}</td>
                            <td style="text-align: right;">${pct(despesasOp)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Despesas administrativas</td>
                            <td style="text-align: right;">${formatarMoeda(despesasAdmin)}</td>
                            <td style="text-align: right;">${pct(despesasAdmin)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Despesas comerciais</td>
                            <td style="text-align: right;">${formatarMoeda(despesasComerciais)}</td>
                            <td style="text-align: right;">${pct(despesasComerciais)}</td>
                        </tr>
                        <tr>
                            <td style="padding-left: 30px;">Despesas financeiras</td>
                            <td style="text-align: right;">${formatarMoeda(despesasFinanceiras)}</td>
                            <td style="text-align: right;">${pct(despesasFinanceiras)}</td>
                        </tr>
                        <tr style="background: #dcfce7;">
                            <td><strong>LUCRO OPERACIONAL</strong></td>
                            <td style="text-align: right;"><strong class="${lucroOperacional >= 0 ? 'valor-cell positivo' : 'valor-cell negativo'}">${formatarMoeda(lucroOperacional)}</strong></td>
                            <td style="text-align: right;"><strong>${pct(lucroOperacional)}</strong></td>
                        </tr>
                        <tr style="background: ${lucroLiquido >= 0 ? '#bbf7d0' : '#fecaca'};">
                            <td><strong>LUCRO LÍQUIDO DO PERÍODO</strong></td>
                            <td style="text-align: right;"><strong class="${lucroLiquido >= 0 ? 'valor-cell positivo' : 'valor-cell negativo'}">${formatarMoeda(lucroLiquido)}</strong></td>
                            <td style="text-align: right;"><strong>${pct(lucroLiquido)}</strong></td>
                        </tr>
                    `;
                }
            }
        }

        async function atualizarGraficosComDadosReais() {
            try {
                const hoje = new Date();
                const dadosMensais = [];
                
                // Buscar dados dos últimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const primeiroDia = new Date(mes.getFullYear(), mes.getMonth(), 1).toISOString().split('T')[0];
                    const ultimoDia = new Date(mes.getFullYear(), mes.getMonth() + 1, 0).toISOString().split('T')[0];
                    
                    const [receberResp, pagarResp] = await Promise.all([
                        fetch(`/api/financeiro/contas-receber?data_inicio=${primeiroDia}&data_fim=${ultimoDia}`, { credentials: 'include' }),
                        fetch(`/api/financeiro/contas-pagar?data_inicio=${primeiroDia}&data_fim=${ultimoDia}`, { credentials: 'include' })
                    ]);
                    
                    const receberData = receberResp.ok ? await receberResp.json() : [];
                    const pagarData = pagarResp.ok ? await pagarResp.json() : [];
                    
                    const contasReceber = Array.isArray(receberData) ? receberData : (receberData.data || []);
                    const contasPagar = Array.isArray(pagarData) ? pagarData : (pagarData.data || []);
                    
                    const receitas = contasReceber.reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                    const despesas = contasPagar.reduce((sum, c) => sum + parseFloat(c.valor_total || c.valor || 0), 0);
                    
                    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    dadosMensais.push({
                        mes: meses[mes.getMonth()],
                        receitas: receitas,
                        despesas: despesas
                    });
                }

                // Atualizar gráfico de barras
                const chart1 = Chart.getChart('receitasDespesasChart');
                if (chart1) {
                    chart1.data.labels = dadosMensais.map(d => d.mes);
                    chart1.data.datasets[0].data = dadosMensais.map(d => d.receitas);
                    chart1.data.datasets[1].data = dadosMensais.map(d => d.despesas);
                    chart1.update();
                }

            } catch (error) {
                console.error('Erro ao atualizar gráficos:', error);
            }
        }

        async function carregarUsuario() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    // Usar apelido se disponível, senão primeiro nome
                    const userName = user.apelido || user.nome || 'Usuário';
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');

                    // Atualizar Saudação dinâmica baseada na hora
                    const greetingTextEl = document.getElementById('greeting-text');
                    if (greetingTextEl) {
                        const hour = new Date().getHours();
                        let greeting = 'Bom dia';
                        if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                        else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                        greetingTextEl.textContent = greeting;
                    }
                    document.getElementById('user-name').textContent = primeiroNome;
                    document.getElementById('user-initials').textContent = primeiroNome.charAt(0).toUpperCase();
                    
                    // Carregar foto do usuário - verificar mltiplos campos
                    const fotoUrl = user.avatar || user.foto || user.foto_perfil_url;
                    const fotoEl = document.getElementById('user-photo');
                    const inicialEl = document.getElementById('user-initials');
                    
                    if (fotoUrl && fotoUrl !== '/avatars/default.webp') {
                        fotoEl.src = fotoUrl;
                        fotoEl.onload = () => {
                            fotoEl.classList.add('visible');
                            fotoEl.style.display = 'block';
                            if (inicialEl) inicialEl.style.display = 'none';
                        };
                        fotoEl.onerror = () => {
                            fotoEl.style.display = 'none';
                            if (inicialEl) inicialEl.style.display = 'flex';
                        };
                    } else {
                        if (fotoEl) fotoEl.style.display = 'none';
                        if (inicialEl) inicialEl.style.display = 'flex';
                    }
                }
            } catch (e) { console.log('Erro ao carregar usuário'); }
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        function inicializarGraficos() {
            // gráfico Receitas vs Despesas (inicia vazio, será atualizado com dados reais)
            const ctx1 = document.getElementById('receitasDespesasChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [
                        {
                            label: 'Receitas',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderRadius: 6
                        },
                        {
                            label: 'Despesas',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatarMoeda(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            // gráfico Despesas por Categoria (será atualizado com dados reais)
            const ctx2 = document.getElementById('despesasCategoriaChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pessoal', 'Fornecedores', 'Impostos', 'Operacional', 'Financeiro', 'Outros'],
                    datasets: [{
                        data: [1, 1, 1, 1, 1, 1], // Placeholder - será atualizado
                        backgroundColor: [
                            '#84cc16',
                            '#65a30d',
                            '#ef4444',
                            '#f59e0b',
                            '#8b5cf6',
                            '#64748b'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatarMoeda(context.raw) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            
            // Atualizar gráfico de categorias com dados reais
            atualizarGraficoCategorias();
        }
        
        async function atualizarGraficoCategorias() {
            try {
                const hoje = new Date();
                const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
                
                const pagarResp = await fetch(`/api/financeiro/contas-pagar?data_inicio=${primeiroDia}&data_fim=${ultimoDia}`, { credentials: 'include' });
                const pagarData = pagarResp.ok ? await pagarResp.json() : [];
                const contasPagar = Array.isArray(pagarData) ? pagarData : (pagarData.data || []);
                
                // Agrupar por categoria
                const categorias = {
                    'Pessoal': 0,
                    'Fornecedores': 0,
                    'Impostos': 0,
                    'Operacional': 0,
                    'Financeiro': 0,
                    'Outros': 0
                };
                
                contasPagar.forEach(c => {
                    const cat = (c.categoria || c.categoria_nome || '').toLowerCase();
                    const valor = parseFloat(c.valor_total || c.valor || 0);
                    
                    if (cat.includes('pessoal') || cat.includes('folha') || cat.includes('salario')) {
                        categorias['Pessoal'] += valor;
                    } else if (cat.includes('fornecedor') || cat.includes('materia') || cat.includes('produto')) {
                        categorias['Fornecedores'] += valor;
                    } else if (cat.includes('imposto') || cat.includes('tributo') || cat.includes('icms') || cat.includes('pis')) {
                        categorias['Impostos'] += valor;
                    } else if (cat.includes('operacional') || cat.includes('manutencao') || cat.includes('aluguel')) {
                        categorias['Operacional'] += valor;
                    } else if (cat.includes('financeiro') || cat.includes('juros') || cat.includes('banco') || cat.includes('taxa')) {
                        categorias['Financeiro'] += valor;
                    } else {
                        categorias['Outros'] += valor;
                    }
                });
                
                // Se não houver dados, usar valores mínimos para evitar gráfico vazio
                const temDados = Object.values(categorias).some(v => v > 0);
                if (!temDados) {
                    // Manter valores placeholder
                    return;
                }
                
                // Atualizar gráfico de categorias
                const chart2 = Chart.getChart('despesasCategoriaChart');
                if (chart2) {
                    chart2.data.datasets[0].data = Object.values(categorias);
                    chart2.update();
                }
            } catch (error) {
                console.error('Erro ao atualizar gráfico de categorias:', error);
            }
        }

        function atualizarRelatorios() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const hoje = new Date();
            let dataInicio, dataFim;

            switch (periodo) {
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                    dataFim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'trimestre':
                    const trimestreInicio = Math.floor(hoje.getMonth() / 3) * 3;
                    dataInicio = new Date(hoje.getFullYear(), trimestreInicio, 1).toISOString().split('T')[0];
                    dataFim = new Date(hoje.getFullYear(), trimestreInicio + 3, 0).toISOString().split('T')[0];
                    break;
                case 'semestre':
                    const semestreInicio = hoje.getMonth() < 6 ? 0 : 6;
                    dataInicio = new Date(hoje.getFullYear(), semestreInicio, 1).toISOString().split('T')[0];
                    dataFim = new Date(hoje.getFullYear(), semestreInicio + 6, 0).toISOString().split('T')[0];
                    break;
                case 'ano':
                    dataInicio = new Date(hoje.getFullYear(), 0, 1).toISOString().split('T')[0];
                    dataFim = new Date(hoje.getFullYear(), 11, 31).toISOString().split('T')[0];
                    break;
                case 'custom':
                default:
                    dataInicio = document.getElementById('dataInício')?.value;
                    dataFim = document.getElementById('dataFim')?.value;
                    if (!dataInicio || !dataFim) {
                        mostrarToast('Selecione as datas de início e fim para o período personalizado.', 'warning');
                        return;
                    }
                    break;
            }

            // Atualizar inputs de data visíveis
            const elInicio = document.getElementById('dataInício');
            const elFim = document.getElementById('dataFim');
            if (elInicio) elInicio.value = dataInicio;
            if (elFim) elFim.value = dataFim;

            // Recarregar todos os dados com o novo período
            mostrarToast('Atualizando dados do período...', 'info');
            carregarResumoFinanceiro(dataInicio, dataFim);
            console.log('Relatórios atualizados para:', dataInicio, 'até', dataFim);
        }

        async function abrirRelatorio(tipo) {
            relatorioAtual = tipo;
            const titulos = {
                'dre': 'DRE - Demonstrativo de Resultados',
                'fluxo': 'Fluxo de Caixa',
                'contas-pagar': 'Relatório de Contas a Pagar',
                'contas-receber': 'Relatório de Contas a Receber',
                'despesas': 'Despesas por Categoria',
                'bancos': 'Posição Bancária',
                'contas-pagar-aberto': 'Contas a Pagar em Aberto',
                'pagamentos-realizados': 'Pagamentos Realizados',
                'contas-receber-aberto': 'Contas a Receber em Aberto',
                'recebimentos-realizados': 'Recebimentos Realizados',
                'despesas-categoria': 'Despesas por Categoria',
                'por-fornecedor': 'Por Cliente ou Fornecedor',
                'resumido': 'Relatório Resumido',
                'resumo-executivo': 'Resumo Executivo de Finanças',
                'clientes-fornecedores': 'Clientes e Fornecedores',
                'atividades-usuarios': 'Atividades dos Usuários',
                'comissao-vendas': 'Comissão de Vendas',
                'movimentacao-financeira': 'Movimentação Financeira (12 meses)',
                'por-periodo': 'Contas por Período',
                'por-mes-ano': 'Contas por Mês/Ano',
                'contas-por-categoria': 'Contas por Categoria',
                'contas-cliente-fornecedor': 'Contas por Cliente/Fornecedor',
                'por-departamento': 'Por Departamento',
                'por-vendedor': 'Por Vendedor',
                'por-projeto': 'Por Projeto',
                'atrasadas': 'Contas Atrasadas'
            };

            document.getElementById('modalRelatorioTitulo').textContent = titulos[tipo] || 'Relatório';
            
            // Mostrar loading
            const loadingEl = document.getElementById('loading-relatorio');
            const conteudoEl = document.getElementById('conteudo-relatorio');
            if (loadingEl) loadingEl.style.display = 'flex';
            if (conteudoEl) conteudoEl.style.display = 'none';
            
            document.getElementById('modalRelatorio').classList.add('active');
            
            // Carregar conteúdo real da API
            try {
                const html = await gerarConteudoRelatorio(tipo);
                if (loadingEl) loadingEl.style.display = 'none';
                if (conteudoEl) {
                    conteudoEl.innerHTML = html;
                    conteudoEl.style.display = 'block';
                    conteudoEl.classList.add('resultado-relatorio');
                } else {
                    document.getElementById('modalRelatorioBody').innerHTML = html;
                }
            } catch (err) {
                console.error('Erro ao gerar relatório:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                if (conteudoEl) {
                    conteudoEl.innerHTML = '<div style="text-align:center;padding:40px;color:#ef4444;"><i class="fas fa-exclamation-triangle" style="font-size:32px;margin-bottom:12px;display:block;"></i>Erro ao carregar dados do relatório.</div>';
                    conteudoEl.style.display = 'block';
                }
            }
        }

        // Helpers para formatação nos relatórios
        const fmtM = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const fmtD = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
        function statusBadge(status, vencimento) {
            const hoje = new Date().toISOString().split('T')[0];
            if (status === 'pago' || status === 'recebido') return `<span style="color:var(--success);font-weight:600;">✓ ${status === 'pago' ? 'Pago' : 'Recebido'}</span>`;
            if (vencimento && vencimento < hoje) return `<span style="color:var(--danger);font-weight:600;">Vencida</span>`;
            const diff = vencimento ? Math.ceil((new Date(vencimento) - new Date()) / 86400000) : 999;
            if (diff <= 7) return `<span style="color:var(--warning);font-weight:600;">Próxima</span>`;
            return `<span style="color:var(--success);">Em dia</span>`;
        }

        async function gerarConteudoRelatorio(tipo) {
            const dataInicio = document.getElementById('dataInício')?.value || new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            const dataFim = document.getElementById('dataFim')?.value || new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];
            const hoje = new Date().toISOString().split('T')[0];

            // Função auxiliar para fetch seguro
            async function fetchAPI(url) {
                try {
                    const r = await fetch(url, { credentials: 'include' });
                    if (!r.ok) return [];
                    const d = await r.json();
                    return Array.isArray(d) ? d : (d.data || []);
                } catch { return []; }
            }

            switch(tipo) {
                case 'contas-pagar':
                case 'contas-pagar-aberto': {
                    let contas = await fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`);
                    if (tipo === 'contas-pagar-aberto') contas = contas.filter(c => c.status !== 'pago');
                    const total = contas.filter(c => c.status !== 'pago').reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const vencidas = contas.filter(c => c.status !== 'pago' && (c.data_vencimento || c.vencimento || '') < hoje).reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const pagoMes = contas.filter(c => c.status === 'pago').reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const rows = contas.map(c => `<tr><td>${c.fornecedor || c.fornecedor_nome || c.descricao || '-'}</td><td>${fmtD(c.data_vencimento || c.vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td><td>${statusBadge(c.status, c.data_vencimento || c.vencimento)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total a Pagar</h4><div class="value red">${fmtM(total)}</div></div>
                            <div class="summary-box"><h4>Vencidas</h4><div class="value orange">${fmtM(vencidas)}</div></div>
                            <div class="summary-box"><h4>A Vencer</h4><div class="value blue">${fmtM(total - vencidas)}</div></div>
                            <div class="summary-box"><h4>Pago no Mês</h4><div class="value green">${fmtM(pagoMes)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Fornecedor</th><th>Vencimento</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhuma conta a pagar encontrada no período</td></tr>'}</tbody></table>`;
                }
                case 'pagamentos-realizados': {
                    const contas = await fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`);
                    const pagos = contas.filter(c => c.status === 'pago');
                    const totalPago = pagos.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const media = pagos.length > 0 ? totalPago / pagos.length : 0;
                    const maior = pagos.reduce((m, c) => Math.max(m, parseFloat(c.valor_total || c.valor || 0)), 0);
                    const rows = pagos.map(c => `<tr><td>${c.fornecedor || c.fornecedor_nome || c.descricao || '-'}</td><td>${fmtD(c.data_pagamento || c.data_baixa || c.data_vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td><td>${c.forma_pagamento || c.tipo_pagamento || 'N/I'}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Pago</h4><div class="value green">${fmtM(totalPago)}</div></div>
                            <div class="summary-box"><h4>Pagamentos</h4><div class="value blue">${pagos.length}</div></div>
                            <div class="summary-box"><h4>Média por Pag.</h4><div class="value orange">${fmtM(media)}</div></div>
                            <div class="summary-box"><h4>Maior Pag.</h4><div class="value red">${fmtM(maior)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Fornecedor</th><th>Data Pag.</th><th>Valor</th><th>Forma</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhum pagamento realizado no período</td></tr>'}</tbody></table>`;
                }
                case 'contas-receber':
                case 'contas-receber-aberto': {
                    let contas = await fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`);
                    if (tipo === 'contas-receber-aberto') contas = contas.filter(c => c.status !== 'recebido' && c.status !== 'pago');
                    const total = contas.filter(c => c.status !== 'recebido' && c.status !== 'pago').reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const vencidas = contas.filter(c => c.status !== 'recebido' && c.status !== 'pago' && (c.data_vencimento || c.vencimento || '') < hoje).reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const recebidoMes = contas.filter(c => c.status === 'recebido' || c.status === 'pago').reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const rows = contas.map(c => `<tr><td>${c.cliente || c.cliente_nome || c.descricao || '-'}</td><td>${fmtD(c.data_vencimento || c.vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td><td>${statusBadge(c.status, c.data_vencimento || c.vencimento)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total a Receber</h4><div class="value blue">${fmtM(total)}</div></div>
                            <div class="summary-box"><h4>Vencidas</h4><div class="value red">${fmtM(vencidas)}</div></div>
                            <div class="summary-box"><h4>A Vencer</h4><div class="value green">${fmtM(total - vencidas)}</div></div>
                            <div class="summary-box"><h4>Recebido no Mês</h4><div class="value green">${fmtM(recebidoMes)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Cliente</th><th>Vencimento</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhuma conta a receber encontrada no período</td></tr>'}</tbody></table>`;
                }
                case 'recebimentos-realizados': {
                    const contas = await fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`);
                    const recebidos = contas.filter(c => c.status === 'recebido' || c.status === 'pago');
                    const totalRec = recebidos.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const media = recebidos.length > 0 ? totalRec / recebidos.length : 0;
                    const maior = recebidos.reduce((m, c) => Math.max(m, parseFloat(c.valor_total || c.valor || 0)), 0);
                    const rows = recebidos.map(c => `<tr><td>${c.cliente || c.cliente_nome || c.descricao || '-'}</td><td>${fmtD(c.data_pagamento || c.data_baixa || c.data_vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td><td>${c.forma_pagamento || c.tipo_pagamento || 'N/I'}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Recebido</h4><div class="value green">${fmtM(totalRec)}</div></div>
                            <div class="summary-box"><h4>Recebimentos</h4><div class="value blue">${recebidos.length}</div></div>
                            <div class="summary-box"><h4>Média por Rec.</h4><div class="value orange">${fmtM(media)}</div></div>
                            <div class="summary-box"><h4>Maior Rec.</h4><div class="value green">${fmtM(maior)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Cliente</th><th>Data Rec.</th><th>Valor</th><th>Forma</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhum recebimento no período</td></tr>'}</tbody></table>`;
                }
                case 'fluxo': {
                    const [receber, pagar] = await Promise.all([
                        fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`),
                        fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`)
                    ]);
                    const entradas = receber.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const saidas = pagar.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const saldo = entradas - saidas;
                    // Agrupar por semana
                    const d1 = new Date(dataInicio + 'T00:00:00'), d2 = new Date(dataFim + 'T00:00:00');
                    const semanas = [];
                    let semStart = new Date(d1);
                    while (semStart <= d2) {
                        const semEnd = new Date(Math.min(semStart.getTime() + 6 * 86400000, d2.getTime()));
                        const label = `${semStart.toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit'})} - ${semEnd.toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit'})}`;
                        const entSem = receber.filter(c => { const v = (c.data_vencimento || c.vencimento || ''); return v >= semStart.toISOString().split('T')[0] && v <= semEnd.toISOString().split('T')[0]; }).reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                        const saiSem = pagar.filter(c => { const v = (c.data_vencimento || c.vencimento || ''); return v >= semStart.toISOString().split('T')[0] && v <= semEnd.toISOString().split('T')[0]; }).reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                        semanas.push({ label, ent: entSem, sai: saiSem, saldo: entSem - saiSem });
                        semStart = new Date(semEnd.getTime() + 86400000);
                    }
                    const rows = semanas.map(s => `<tr><td>${s.label}</td><td class="valor-cell positivo">${fmtM(s.ent)}</td><td class="valor-cell negativo">${fmtM(s.sai)}</td><td class="valor-cell ${s.saldo >= 0 ? 'positivo' : 'negativo'}">${fmtM(s.saldo)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Entradas</h4><div class="value green">${fmtM(entradas)}</div></div>
                            <div class="summary-box"><h4>Saídas</h4><div class="value red">${fmtM(saidas)}</div></div>
                            <div class="summary-box"><h4>Saldo</h4><div class="value ${saldo >= 0 ? 'blue' : 'red'}">${fmtM(saldo)}</div></div>
                            <div class="summary-box"><h4>Semanas</h4><div class="value orange">${semanas.length}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Semana</th><th>Entradas</th><th>Saídas</th><th>Saldo</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Sem dados no período</td></tr>'}</tbody></table>`;
                }
                case 'despesas':
                case 'despesas-categoria': {
                    const contas = await fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`);
                    const total = contas.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const cats = {};
                    contas.forEach(c => {
                        const cat = c.categoria || c.tipo || 'Outros';
                        if (!cats[cat]) cats[cat] = { qtd: 0, valor: 0 };
                        cats[cat].qtd++;
                        cats[cat].valor += parseFloat(c.valor_total || c.valor || 0);
                    });
                    const sortedCats = Object.entries(cats).sort((a, b) => b[1].valor - a[1].valor);
                    const maiorCat = sortedCats.length > 0 ? sortedCats[0][0] : '-';
                    const pctMaior = total > 0 && sortedCats.length > 0 ? ((sortedCats[0][1].valor / total) * 100).toFixed(1) : '0';
                    const rows = sortedCats.map(([cat, d]) => `<tr><td>${cat}</td><td>${d.qtd}</td><td>${fmtM(d.valor)}</td><td>${total > 0 ? ((d.valor / total) * 100).toFixed(1) : '0'}%</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Despesas</h4><div class="value red">${fmtM(total)}</div></div>
                            <div class="summary-box"><h4>Categorias</h4><div class="value blue">${sortedCats.length}</div></div>
                            <div class="summary-box"><h4>Maior Categ.</h4><div class="value orange">${maiorCat}</div></div>
                            <div class="summary-box"><h4>% Maior</h4><div class="value purple">${pctMaior}%</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Categoria</th><th>Qtd.</th><th>Valor</th><th>%</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhuma despesa no período</td></tr>'}</tbody></table>`;
                }
                case 'por-fornecedor':
                case 'contas-cliente-fornecedor': {
                    const [receber, pagar] = await Promise.all([
                        fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`),
                        fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`)
                    ]);
                    const totalCli = receber.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const totalForn = pagar.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    // Agrupar por nome
                    const entidades = {};
                    receber.forEach(c => {
                        const nome = c.cliente || c.cliente_nome || c.descricao || 'Sem nome';
                        if (!entidades[nome]) entidades[nome] = { tipo: 'Cliente', pagar: 0, receber: 0 };
                        entidades[nome].receber += parseFloat(c.valor_total || c.valor || 0);
                    });
                    pagar.forEach(c => {
                        const nome = c.fornecedor || c.fornecedor_nome || c.descricao || 'Sem nome';
                        if (!entidades[nome]) entidades[nome] = { tipo: 'Fornecedor', pagar: 0, receber: 0 };
                        entidades[nome].pagar += parseFloat(c.valor_total || c.valor || 0);
                    });
                    const rows = Object.entries(entidades).sort((a, b) => (b[1].receber + b[1].pagar) - (a[1].receber + a[1].pagar))
                        .map(([nome, d]) => `<tr><td>${nome}</td><td>${d.tipo}</td><td>${d.pagar > 0 ? fmtM(d.pagar) : '-'}</td><td>${d.receber > 0 ? fmtM(d.receber) : '-'}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Clientes</h4><div class="value blue">${fmtM(totalCli)}</div></div>
                            <div class="summary-box"><h4>Total Fornec.</h4><div class="value red">${fmtM(totalForn)}</div></div>
                            <div class="summary-box"><h4>Clientes</h4><div class="value green">${new Set(receber.map(c => c.cliente || c.cliente_nome)).size}</div></div>
                            <div class="summary-box"><h4>Fornecedores</h4><div class="value orange">${new Set(pagar.map(c => c.fornecedor || c.fornecedor_nome)).size}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Nome</th><th>Tipo</th><th>A Pagar</th><th>A Receber</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhum dado no período</td></tr>'}</tbody></table>`;
                }
                case 'resumido': {
                    const d = window._dadosFinanceiros || {};
                    const rec = d.receitaBruta || 0, desp = d.despesasTotais || 0;
                    const res = rec - desp, margem = rec > 0 ? ((res / rec) * 100).toFixed(1) : '0';
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Receitas</h4><div class="value green">${fmtM(rec)}</div></div>
                            <div class="summary-box"><h4>Despesas</h4><div class="value red">${fmtM(desp)}</div></div>
                            <div class="summary-box"><h4>Resultado</h4><div class="value ${res >= 0 ? 'blue' : 'red'}">${fmtM(res)}</div></div>
                            <div class="summary-box"><h4>Margem</h4><div class="value orange">${margem}%</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Descrição</th><th style="text-align:right">Valor</th></tr></thead>
                        <tbody>
                            <tr><td>Receita Operacional</td><td style="text-align:right">${fmtM(rec)}</td></tr>
                            <tr><td>(-) Despesas Operacionais</td><td style="text-align:right">${fmtM(desp * 0.70)}</td></tr>
                            <tr><td>(-) Despesas Administrativas</td><td style="text-align:right">${fmtM(desp * 0.20)}</td></tr>
                            <tr><td>(-) Impostos</td><td style="text-align:right">${fmtM(desp * 0.10)}</td></tr>
                            <tr style="background:#e8f5e9;font-weight:bold"><td>Resultado Líquido</td><td style="text-align:right">${fmtM(res)}</td></tr>
                        </tbody></table>`;
                }
                case 'dre':
                case 'resumo-executivo': {
                    const d = window._dadosFinanceiros || {};
                    const rec = d.receitaBruta || 0, desp = d.despesasTotais || 0;
                    const deducoes = rec * 0.10, recLiq = rec - deducoes;
                    const cpv = desp * 0.40, lucroBruto = recLiq - cpv;
                    const despOp = desp * 0.15, despAdmin = desp * 0.12, despFin = desp * 0.05;
                    const lucroLiq = lucroBruto - despOp - despAdmin - despFin;
                    const pct = (v) => rec > 0 ? ((v / rec) * 100).toFixed(1) + '%' : '0%';
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Receita Bruta</h4><div class="value blue">${fmtM(rec)}</div></div>
                            <div class="summary-box"><h4>Lucro Bruto</h4><div class="value green">${fmtM(lucroBruto)}</div></div>
                            <div class="summary-box"><h4>Lucro Líquido</h4><div class="value green">${fmtM(lucroLiq)}</div></div>
                            <div class="summary-box"><h4>Margem Líq.</h4><div class="value orange">${rec > 0 ? ((lucroLiq / rec) * 100).toFixed(1) : '0'}%</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Descrição</th><th style="text-align:right">Valor</th><th style="text-align:right">%</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Receita Bruta</strong></td><td style="text-align:right">${fmtM(rec)}</td><td style="text-align:right">100%</td></tr>
                            <tr><td>(-) Deduções e Impostos</td><td style="text-align:right">${fmtM(deducoes)}</td><td style="text-align:right">${pct(deducoes)}</td></tr>
                            <tr><td><strong>Receita Líquida</strong></td><td style="text-align:right">${fmtM(recLiq)}</td><td style="text-align:right">${pct(recLiq)}</td></tr>
                            <tr><td>(-) Custo Produtos/Serviços</td><td style="text-align:right">${fmtM(cpv)}</td><td style="text-align:right">${pct(cpv)}</td></tr>
                            <tr><td><strong>Lucro Bruto</strong></td><td style="text-align:right">${fmtM(lucroBruto)}</td><td style="text-align:right">${pct(lucroBruto)}</td></tr>
                            <tr><td>(-) Despesas Operacionais</td><td style="text-align:right">${fmtM(despOp)}</td><td style="text-align:right">${pct(despOp)}</td></tr>
                            <tr><td>(-) Despesas Administrativas</td><td style="text-align:right">${fmtM(despAdmin)}</td><td style="text-align:right">${pct(despAdmin)}</td></tr>
                            <tr><td>(-) Despesas Financeiras</td><td style="text-align:right">${fmtM(despFin)}</td><td style="text-align:right">${pct(despFin)}</td></tr>
                            <tr style="background:#e8f5e9;font-weight:bold"><td>Resultado Líquido</td><td style="text-align:right">${fmtM(lucroLiq)}</td><td style="text-align:right">${pct(lucroLiq)}</td></tr>
                        </tbody></table>`;
                }
                case 'bancos': {
                    const bancosArr = await fetchAPI('/api/financeiro/contas-bancarias');
                    const saldoTotal = bancosArr.reduce((s, b) => s + parseFloat(b.saldo_atual || b.saldo || 0), 0);
                    const rows = bancosArr.map(b => `<tr><td><strong>${b.banco || b.nome_banco || b.nome || '-'}</strong></td><td>${b.agencia || '-'}</td><td>${b.conta || b.numero_conta || '-'}</td><td style="text-align:right" class="valor-cell positivo">${fmtM(b.saldo_atual || b.saldo)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Saldo Total</h4><div class="value blue">${fmtM(saldoTotal)}</div></div>
                            <div class="summary-box"><h4>Contas Ativas</h4><div class="value green">${bancosArr.length}</div></div>
                            <div class="summary-box"><h4>Maior Saldo</h4><div class="value green">${fmtM(bancosArr.reduce((m, b) => Math.max(m, parseFloat(b.saldo_atual || b.saldo || 0)), 0))}</div></div>
                            <div class="summary-box"><h4>Menor Saldo</h4><div class="value orange">${fmtM(bancosArr.length > 0 ? bancosArr.reduce((m, b) => Math.min(m, parseFloat(b.saldo_atual || b.saldo || 0)), Infinity) : 0)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Banco</th><th>Agência</th><th>Conta</th><th style="text-align:right">Saldo</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Nenhuma conta bancária cadastrada</td></tr>'}</tbody>
                        <tfoot><tr><td colspan="3"><strong>TOTAL</strong></td><td style="text-align:right"><strong>${fmtM(saldoTotal)}</strong></td></tr></tfoot></table>`;
                }
                case 'clientes-fornecedores': {
                    const [clis, forns] = await Promise.all([
                        fetchAPI('/api/clientes'),
                        fetchAPI('/api/fornecedores')
                    ]);
                    const rows = [
                        ...clis.slice(0, 20).map(c => `<tr><td>${c.nome || c.razao_social || c.nome_fantasia || '-'}</td><td>Cliente</td><td>${c.cnpj || c.cpf || '-'}</td><td>${c.cidade || '-'}</td><td><span style="color:var(--success)">Ativo</span></td></tr>`),
                        ...forns.slice(0, 20).map(f => `<tr><td>${f.nome || f.razao_social || f.nome_fantasia || '-'}</td><td>Fornecedor</td><td>${f.cnpj || f.cpf || '-'}</td><td>${f.cidade || '-'}</td><td><span style="color:var(--success)">Ativo</span></td></tr>`)
                    ].join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Clientes</h4><div class="value blue">${clis.length}</div></div>
                            <div class="summary-box"><h4>Total Fornec.</h4><div class="value orange">${forns.length}</div></div>
                            <div class="summary-box"><h4>Total Geral</h4><div class="value green">${clis.length + forns.length}</div></div>
                            <div class="summary-box"><h4>Cadastros</h4><div class="value purple">Ativos</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Nome</th><th>Tipo</th><th>CNPJ/CPF</th><th>Cidade</th><th>Status</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:20px;">Nenhum cadastro encontrado</td></tr>'}</tbody></table>`;
                }
                case 'atrasadas': {
                    const [receber, pagar] = await Promise.all([
                        fetchAPI(`/api/financeiro/contas-receber?data_inicio=2020-01-01&data_fim=${hoje}`),
                        fetchAPI(`/api/financeiro/contas-pagar?data_inicio=2020-01-01&data_fim=${hoje}`)
                    ]);
                    const pagarAtrasadas = pagar.filter(c => c.status !== 'pago' && (c.data_vencimento || c.vencimento || '') < hoje);
                    const receberAtrasadas = receber.filter(c => c.status !== 'recebido' && c.status !== 'pago' && (c.data_vencimento || c.vencimento || '') < hoje);
                    const totalPagarAtr = pagarAtrasadas.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const totalReceberAtr = receberAtrasadas.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const todas = [
                        ...pagarAtrasadas.map(c => ({ ...c, _tipo: 'Pagar' })),
                        ...receberAtrasadas.map(c => ({ ...c, _tipo: 'Receber' }))
                    ].sort((a, b) => (a.data_vencimento || a.vencimento || '').localeCompare(b.data_vencimento || b.vencimento || ''));
                    const diasAtraso = (v) => v ? Math.ceil((new Date() - new Date(v)) / 86400000) : 0;
                    const mediaAtraso = todas.length > 0 ? Math.round(todas.reduce((s, c) => s + diasAtraso(c.data_vencimento || c.vencimento), 0) / todas.length) : 0;
                    const rows = todas.map(c => `<tr><td><span style="color:${c._tipo === 'Pagar' ? 'var(--danger)' : 'var(--warning)'}">${c._tipo}</span></td><td>${c.fornecedor || c.fornecedor_nome || c.cliente || c.cliente_nome || c.descricao || '-'}</td><td>${fmtD(c.data_vencimento || c.vencimento)}</td><td>${diasAtraso(c.data_vencimento || c.vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Total Atrasado</h4><div class="value red">${fmtM(totalPagarAtr + totalReceberAtr)}</div></div>
                            <div class="summary-box"><h4>A Pagar Atras.</h4><div class="value red">${fmtM(totalPagarAtr)}</div></div>
                            <div class="summary-box"><h4>A Receber Atras.</h4><div class="value orange">${fmtM(totalReceberAtr)}</div></div>
                            <div class="summary-box"><h4>Dias Médio</h4><div class="value purple">${mediaAtraso} dias</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Tipo</th><th>Descrição</th><th>Vencimento</th><th>Dias</th><th>Valor</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:20px;">Nenhuma conta atrasada!</td></tr>'}</tbody>
                        ${todas.length > 0 ? `<tfoot><tr><td colspan="4"><strong>TOTAL ATRASADO</strong></td><td><strong class="valor-cell negativo">${fmtM(totalPagarAtr + totalReceberAtr)}</strong></td></tr></tfoot>` : ''}</table>`;
                }
                case 'por-periodo': {
                    const [receber, pagar] = await Promise.all([
                        fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`),
                        fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`)
                    ]);
                    const totalPagar = pagar.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const totalReceber = receber.reduce((s, c) => s + parseFloat(c.valor_total || c.valor || 0), 0);
                    const todas = [
                        ...pagar.map(c => ({ ...c, _tipo: 'Pagar' })),
                        ...receber.map(c => ({ ...c, _tipo: 'Receber' }))
                    ].sort((a, b) => (a.data_vencimento || a.vencimento || '').localeCompare(b.data_vencimento || b.vencimento || ''));
                    const rows = todas.map(c => `<tr><td><span style="color:${c._tipo === 'Pagar' ? 'var(--danger)' : 'var(--success)'}">${c._tipo}</span></td><td>${c.fornecedor || c.fornecedor_nome || c.cliente || c.cliente_nome || c.descricao || '-'}</td><td>${fmtD(c.data_vencimento || c.vencimento)}</td><td>${fmtM(c.valor_total || c.valor)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Período</h4><div class="value blue">${fmtD(dataInicio)} a ${fmtD(dataFim)}</div></div>
                            <div class="summary-box"><h4>A Pagar</h4><div class="value red">${fmtM(totalPagar)}</div></div>
                            <div class="summary-box"><h4>A Receber</h4><div class="value green">${fmtM(totalReceber)}</div></div>
                            <div class="summary-box"><h4>Saldo Prev.</h4><div class="value orange">${fmtM(totalReceber - totalPagar)}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Tipo</th><th>Descrição</th><th>Vencimento</th><th>Valor</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Sem dados no período</td></tr>'}</tbody></table>`;
                }
                case 'contas-por-categoria': {
                    const [receber, pagar] = await Promise.all([
                        fetchAPI(`/api/financeiro/contas-receber?data_inicio=${dataInicio}&data_fim=${dataFim}`),
                        fetchAPI(`/api/financeiro/contas-pagar?data_inicio=${dataInicio}&data_fim=${dataFim}`)
                    ]);
                    const cats = {};
                    pagar.forEach(c => {
                        const cat = c.categoria || 'Outros';
                        if (!cats[cat]) cats[cat] = { pagar: 0, receber: 0 };
                        cats[cat].pagar += parseFloat(c.valor_total || c.valor || 0);
                    });
                    receber.forEach(c => {
                        const cat = c.categoria || 'Vendas';
                        if (!cats[cat]) cats[cat] = { pagar: 0, receber: 0 };
                        cats[cat].receber += parseFloat(c.valor_total || c.valor || 0);
                    });
                    const rows = Object.entries(cats).sort((a, b) => Math.abs(b[1].receber - b[1].pagar) - Math.abs(a[1].receber - a[1].pagar))
                        .map(([cat, d]) => `<tr><td>${cat}</td><td>${d.pagar > 0 ? fmtM(d.pagar) : '-'}</td><td>${d.receber > 0 ? fmtM(d.receber) : '-'}</td><td class="valor-cell ${(d.receber - d.pagar) >= 0 ? 'positivo' : 'negativo'}">${fmtM(d.receber - d.pagar)}</td></tr>`).join('');
                    return `
                        <div class="summary-grid" style="margin-bottom:20px;">
                            <div class="summary-box"><h4>Categorias</h4><div class="value blue">${Object.keys(cats).length}</div></div>
                            <div class="summary-box"><h4>Total Pagar</h4><div class="value red">${fmtM(pagar.reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0))}</div></div>
                            <div class="summary-box"><h4>Total Receber</h4><div class="value green">${fmtM(receber.reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0))}</div></div>
                            <div class="summary-box"><h4>Saldo</h4><div class="value orange">${fmtM(receber.reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0) - pagar.reduce((s,c) => s + parseFloat(c.valor_total || c.valor || 0), 0))}</div></div>
                        </div>
                        <table class="data-table"><thead><tr><th>Categoria</th><th>A Pagar</th><th>A Receber</th><th>Saldo</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px;">Sem dados</td></tr>'}</tbody></table>`;
                }
                default:
                    return `
                        <div class="empty-state-relatorio">
                            <div class="empty-state-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="empty-state-title">Nenhum dado disponível</div>
                            <div class="empty-state-desc">Selecione os filtros e clique em "Gerar Relatório" para visualizar os dados.</div>
                        </div>`;
            }
        }

        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
            // Resetar loading ao fechar
            const loadingEl = document.getElementById('loading-relatorio');
            const conteudoEl = document.getElementById('conteudo-relatorio');
            if (loadingEl) loadingEl.style.display = 'flex';
            if (conteudoEl) conteudoEl.style.display = 'none';
        }

        // Notificações
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const cores = {
                'success': '#22c55e',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            };
            
            const icones = {
                'success': 'check-circle',
                'error': 'times-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };

            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 999999;
                animation: slideInNotif 0.3s ease;
                border-left: 4px solid ${cores[tipo]};
            `;
            notif.innerHTML = `
                <i class="fas fa-${icones[tipo]}" style="color: ${cores[tipo]}; font-size: 20px;"></i>
                <span style="font-size: 14px; font-weight: 500;">${mensagem}</span>
            `;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOutNotif 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Animações CSS para notificações
        if (!document.getElementById('notif-styles')) {
            const style = document.createElement('style');
            style.id = 'notif-styles';
            style.textContent = `
                @keyframes slideInNotif { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                @keyframes slideOutNotif { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
            `;
            document.head.appendChild(style);
        }

        // Sistema de exportação real usando a biblioteca
        async function exportarRelatorio(tipo, formato) {
            // Para PDF, usar o template profissional igual ao de Vendas
            if (formato === 'pdf') {
                imprimirRelatorioFormatado(tipo);
                return;
            }
            
            try {
                // Mapear tipos de Relatório
                const tipoMapeado = {
                    'contas-pagar': 'contas-pagar',
                    'contas-receber': 'contas-receber',
                    'despesas': 'despesas-categoria',
                    'bancos': 'bancos',
                    'dre': 'dre',
                    'fluxo': 'fluxo-caixa'
                }[tipo] || tipo;
                
                // Buscar dados reais da API
                const dados = await buscarDadosRelatorio(tipoMapeado);
                
                // Exportar usando a biblioteca
                await window.exportarRelatorioFinanceiro(tipoMapeado, formato, dados);
                
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar Relatório: ' + error.message);
            }
        }

        async function buscarDadosRelatorio(tipo) {
            switch(tipo) {
                case 'contas-pagar':
                    return await buscarContasPagar();
                case 'contas-receber':
                    return await buscarContasReceber();
                case 'bancos':
                    return await buscarBancos();
                case 'despesas-categoria':
                    return getDespesasCategoriaDemo();
                case 'dre':
                    return getDREDemo();
                default:
                    return {};
            }
        }
        
        async function buscarContasPagar() {
            try {
                const response = await fetch('/api/financeiro/contas-pagar', { credentials: 'include' });
                const data = await response.json();
                const contas = data.data || data || [];
                
                const hoje = new Date().toISOString().split('T')[0];
                const total = contas.filter(c => c.status !== 'pago').reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                const vencidas = contas.filter(c => c.status !== 'pago' && (c.data_vencimento || c.vencimento) < hoje).reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                const pagoMes = contas.filter(c => c.status === 'pago').reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                
                return {
                    contas: contas,
                    resumo: {
                        total: total,
                        vencidas: vencidas,
                        aVencer: total - vencidas,
                        pagoMes: pagoMes
                    }
                };
            } catch (e) {
                console.error('Erro ao buscar contas a pagar:', e);
                return { contas: [], resumo: { total: 0, vencidas: 0, aVencer: 0, pagoMes: 0 } };
            }
        }
        
        async function buscarContasReceber() {
            try {
                const response = await fetch('/api/financeiro/contas-receber', { credentials: 'include' });
                const data = await response.json();
                const contas = data.data || data || [];
                
                const hoje = new Date().toISOString().split('T')[0];
                const total = contas.filter(c => c.status !== 'recebido').reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                const vencidas = contas.filter(c => c.status !== 'recebido' && (c.data_vencimento || c.vencimento) < hoje).reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                const recebidoMes = contas.filter(c => c.status === 'recebido').reduce((s, c) => s + parseFloat(c.valor || c.valor_total || 0), 0);
                
                return {
                    contas: contas,
                    resumo: {
                        total: total,
                        vencidas: vencidas,
                        aVencer: total - vencidas,
                        recebidoMes: recebidoMes
                    }
                };
            } catch (e) {
                console.error('Erro ao buscar contas a receber:', e);
                return { contas: [], resumo: { total: 0, vencidas: 0, aVencer: 0, recebidoMes: 0 } };
            }
        }
        
        async function buscarBancos() {
            try {
                const response = await fetch('/api/financeiro/bancos', { credentials: 'include' });
                const data = await response.json();
                return { bancos: data.data || data || [] };
            } catch (e) {
                console.error('Erro ao buscar bancos:', e);
                // Dados demo se no houver API
                return {
                    bancos: [
                        { nome: 'Banco do Brasil', agencia: '1234', conta: '12345-6', tipo: 'Corrente', saldo: 85420.50 },
                        { nome: 'Ita', agencia: '4567', conta: '78901-2', tipo: 'Corrente', saldo: 42890.75 },
                        { nome: 'Bradesco', agencia: '7890', conta: '34567-8', tipo: 'Corrente', saldo: 28340.20 },
                        { nome: 'Nubank', agencia: '0001', conta: '9876543-2', tipo: 'Corrente', saldo: 15000.00 }
                    ]
                };
            }
        }
        
        function getDespesasCategoriaDemo() {
            return {
                categorias: [
                    { nome: 'Pessoal', valor: 45000 },
                    { nome: 'Fornecedores', valor: 52000 },
                    { nome: 'Impostos', valor: 24580 },
                    { nome: 'Operacional', valor: 18200 },
                    { nome: 'Financeiro', valor: 8500 },
                    { nome: 'Outros', valor: 20170 }
                ]
            };
        }
        
        function getDREDemo() {
            return {
                dre: {
                    receitaBruta: 245800,
                    deducoes: 12500,
                    receitaLiquida: 233300,
                    cpv: 98000,
                    lucroBruto: 135300,
                    despesasOperacionais: 57950,
                    despesasAdmin: 25000,
                    despesasComerciais: 18450,
                    despesasFinanceiras: 8500,
                    resultadoOperacional: 77350,
                    outrasReceitasDespesas: 0,
                    resultadoAntesIR: 77350,
                    ircsll: 0,
                    resultadoLiquido: 77350
                }
            };
        }

        function exportarRelatorioAtual(formato) {
            if (formato === 'pdf') {
                imprimirRelatorioFormatado(relatorioAtual);
            } else {
                exportarRelatorio(relatorioAtual, formato);
            }
        }

        // --- Funções de Ação (Templates e Agendamento) ---
        function abrirModalTemplates() {
            document.getElementById('modalTemplates').classList.add('active');
        }

        // Mapeamento dos templates → arquivos reais na pasta /templates/zyntra/
        const _templateFiles = {
            'clientes-fornecedores': {
                nome: 'Clientes e Fornecedores', cat: 'cadastros',
                arquivo: 'zyntra/Zyntra_Clientes_Fornecedores_v1_5_16.xlsx', colunas: 61, abas: 1
            },
            'contas-pagar': {
                nome: 'Contas a Pagar', cat: 'financeiro',
                arquivo: 'zyntra/Zyntra_Contas_Pagar_v1_1_5.xlsx', colunas: 61, abas: 1
            },
            'contas-receber': {
                nome: 'Contas a Receber', cat: 'financeiro',
                arquivo: 'zyntra/Zyntra_Contas_Receber_v1_0_6.xlsx', colunas: 41, abas: 1
            },
            'contratos': {
                nome: 'Contratos', cat: 'financeiro',
                arquivo: 'zyntra/Zyntra_Contratos_v1_4_2.xlsx', colunas: 62, abas: 3
            },
            'produtos': {
                nome: 'Produtos', cat: 'cadastros',
                arquivo: 'zyntra/Zyntra_Produtos_v1_9_5.xlsx', colunas: 39, abas: 12
            },
            'servicos': {
                nome: 'Serviços', cat: 'cadastros',
                arquivo: 'zyntra/Zyntra_Servicos_v1_0_10.xlsx', colunas: 24, abas: 2
            },
            'importacao-mercadoria': {
                nome: 'Importação de Mercadoria', cat: 'operacional',
                arquivo: 'zyntra/Zyntra_Importacao_Mercadoria_v1_0_8_5.xlsx', colunas: 28, abas: 1
            },
            'ordens-servico': {
                nome: 'Ordens de Serviço', cat: 'operacional',
                arquivo: 'zyntra/Zyntra_Ordens_Servico_v1_2_12.xlsx', colunas: 52, abas: 3
            },
            'remessa-produto': {
                nome: 'Remessa de Produto', cat: 'operacional',
                arquivo: 'zyntra/Zyntra_Remessa_Produto_v1_2_2.xlsx', colunas: 14, abas: 1
            }
        };

        function baixarTemplate(tipo) {
            const t = _templateFiles[tipo];
            if (!t) { mostrarToast('Template não encontrado.', 'warning'); return; }
            const url = '/templates/' + t.arquivo.split('/').map(p => encodeURIComponent(p)).join('/');
            const filename = t.arquivo.split('/').pop();
            
            // Usar fetch + blob para download confiável
            fetch(url)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.blob();
                })
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                    mostrarToast(`Template "${t.nome}" baixado com sucesso!`, 'success');
                })
                .catch(err => {
                    console.error('Erro ao baixar template:', err);
                    mostrarToast(`Erro ao baixar "${t.nome}". Verifique se o servidor está rodando.`, 'error');
                });
        }

        function baixarTodosTemplates() {
            let delay = 0;
            Object.keys(_templateFiles).forEach(k => {
                setTimeout(() => baixarTemplate(k), delay);
                delay += 500;
            });
            mostrarToast('Baixando todos os 9 templates Zyntra...', 'success');
            setTimeout(() => fecharModal('modalTemplates'), 2000);
        }

        // Filtro de categorias no modal
        function filtrarTemplates(cat) {
            const cards = document.querySelectorAll('#templatesGrid .template-card');
            const btns = document.querySelectorAll('.tmpl-filter-btn');

            btns.forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`.tmpl-filter-btn[data-filter="${cat}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            cards.forEach(card => {
                if (cat === 'todos' || card.dataset.cat === cat) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function agendarRelatorio() {
            mostrarToast('O agendamento de relatórios estará disponível em breve.', 'info');
        }

        // --- Exportação CSV/Excel ---
        window.exportarRelatorioFinanceiro = async function(tipo, formato, dados) {
            const contas = dados.contas || dados.items || [];
            if (!contas.length && !dados.resumo) {
                mostrarToast('Nenhum dado para exportar.', 'warning');
                return;
            }

            // Gerar CSV
            let headers = [];
            let rows = [];
            
            if (tipo === 'contas-pagar' || tipo === 'contas-receber') {
                headers = ['ID', 'Documento', tipo === 'contas-pagar' ? 'Fornecedor' : 'Cliente', 'Categoria', 'Vencimento', 'Valor', 'Pago', 'Saldo', 'Status'];
                rows = contas.map(c => [
                    c.id || '',
                    c.numero_documento || c.documento || '',
                    c.fornecedor || c.fornecedor_nome || c.cliente || c.cliente_nome || '',
                    c.categoria || '',
                    c.data_vencimento || c.vencimento || '',
                    parseFloat(c.valor_total || c.valor || 0).toFixed(2),
                    parseFloat(c.valor_pago || c.pago || 0).toFixed(2),
                    (parseFloat(c.valor_total || c.valor || 0) - parseFloat(c.valor_pago || c.pago || 0)).toFixed(2),
                    c.status || ''
                ]);
            } else if (tipo === 'bancos') {
                headers = ['Banco', 'Agência', 'Conta', 'Tipo', 'Saldo'];
                rows = contas.map(c => [
                    c.banco || c.nome_banco || '',
                    c.agencia || '',
                    c.conta || c.numero_conta || '',
                    c.tipo || '',
                    parseFloat(c.saldo || 0).toFixed(2)
                ]);
            } else {
                // Genérico: usar chaves do primeiro item
                if (contas.length > 0) {
                    headers = Object.keys(contas[0]);
                    rows = contas.map(c => headers.map(h => c[h] != null ? String(c[h]) : ''));
                }
            }

            const sep = ';';
            const csvContent = [headers.join(sep), ...rows.map(r => r.join(sep))].join('\n');
            const BOM = '\ufeff';
            const ext = formato === 'excel' ? 'csv' : formato;
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio-${tipo}-${new Date().toISOString().split('T')[0]}.${ext}`;
            link.click();
            URL.revokeObjectURL(url);
            mostrarToast('Relatório exportado com sucesso!', 'success');
        };

        // --- Gerar conteúdo HTML para impressão ---
        function gerarConteudoImpressao(tipo) {
            const fmtMoeda = (v) => parseFloat(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Para DRE
            if (tipo === 'dre') {
                const d = getDREDemo();
                return `
                    <div class="section"><div class="section-header">Demonstrativo de Resultados do Exercício</div>
                    <div class="section-content">
                        <table class="data-table">
                            <thead><tr><th>Descrição</th><th style="text-align:right">Valor</th></tr></thead>
                            <tbody>
                                <tr><td>Receita Bruta</td><td style="text-align:right" class="valor-positivo">${fmtMoeda(d.periodos?.[0]?.receitaBruta)}</td></tr>
                                <tr><td>(-) Deduções</td><td style="text-align:right" class="valor-negativo">${fmtMoeda(d.periodos?.[0]?.deducoes)}</td></tr>
                                <tr><td><strong>Receita Líquida</strong></td><td style="text-align:right"><strong>${fmtMoeda(d.periodos?.[0]?.receitaLiquida)}</strong></td></tr>
                                <tr><td>(-) CMV</td><td style="text-align:right" class="valor-negativo">${fmtMoeda(d.periodos?.[0]?.cmv)}</td></tr>
                                <tr><td><strong>Lucro Bruto</strong></td><td style="text-align:right"><strong>${fmtMoeda(d.periodos?.[0]?.lucroBruto)}</strong></td></tr>
                                <tr><td>(-) Desp. Administrativas</td><td style="text-align:right" class="valor-negativo">${fmtMoeda(d.periodos?.[0]?.despesasAdministrativas)}</td></tr>
                                <tr><td>(-) Desp. Comerciais</td><td style="text-align:right" class="valor-negativo">${fmtMoeda(d.periodos?.[0]?.despesasComerciais)}</td></tr>
                                <tr><td>(-) Desp. Financeiras</td><td style="text-align:right" class="valor-negativo">${fmtMoeda(d.periodos?.[0]?.despesasFinanceiras)}</td></tr>
                                <tr style="background:#f0f9ff;"><td><strong>Resultado Líquido</strong></td><td style="text-align:right"><strong class="valor-positivo">${fmtMoeda(d.periodos?.[0]?.resultadoLiquido)}</strong></td></tr>
                            </tbody>
                        </table>
                    </div></div>`;
            }

            // Default: mensagem genérica com resumo
            return `
                <div class="section"><div class="section-header">Dados do Relatório</div>
                <div class="section-content">
                    <p style="text-align:center; padding: 20px; color: #64748b; font-size: 11px;">
                        <i class="fas fa-info-circle"></i> 
                        Os dados detalhados deste relatório serão carregados da API em tempo real.
                        Use a exportação CSV/Excel para obter os dados tabulados.
                    </p>
                </div></div>`;
        }

        // Função de impressão profissional - mesmo template de Vendas (Orçamento)
        function imprimirRelatorioFormatado(tipo) {
            const titulos = {
                'dre': 'DRE - Demonstrativo de Resultados',
                'fluxo': 'Fluxo de Caixa',
                'contas-pagar': 'Relatório de Contas a Pagar',
                'contas-receber': 'Relatório de Contas a Receber',
                'despesas': 'Despesas por Categoria',
                'bancos': 'Posição Bancária',
                'contas-pagar-aberto': 'Contas a Pagar em Aberto',
                'pagamentos-realizados': 'Pagamentos Realizados',
                'contas-receber-aberto': 'Contas a Receber em Aberto',
                'recebimentos-realizados': 'Recebimentos Realizados',
                'despesas-categoria': 'Despesas por Categoria',
                'por-fornecedor': 'Por Cliente ou Fornecedor',
                'resumido': 'Relatório Resumido',
                'resumo-executivo': 'Resumo Executivo de Finanças',
                'por-periodo': 'Contas por Período',
                'por-mes-ano': 'Contas por Mês/Ano',
                'contas-por-categoria': 'Contas por Categoria',
                'por-departamento': 'Por Departamento',
                'por-vendedor': 'Por Vendedor',
                'por-projeto': 'Por Projeto',
                'atrasadas': 'Contas Atrasadas'
            };
            
            const titulo = titulos[tipo] || 'Relatório Financeiro';
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const periodo = document.getElementById('dataInício')?.value && document.getElementById('dataFim')?.value 
                ? `${new Date(document.getElementById('dataInício').value).toLocaleDateString('pt-BR')} a ${new Date(document.getElementById('dataFim').value).toLocaleDateString('pt-BR')}`
                : dataAtual;
            
            // Gerar conteúdo baseado no tipo
            const conteudoHTML = gerarConteudoImpressao(tipo);
            
            const printWindow = window.open('', '_blank');
            
            if (!printWindow) {
                alert('Popup bloqueado! Permita popups para este site.');
                return;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <link rel="icon" type="image/x-icon" href="/favicon.ico">
                    <title>Aluforce: ${titulo}</title>
                    <style>
                        @page { margin: 10mm; size: A4; }
                        @media print {
                            @page { margin: 10mm; }
                            html, body { margin: 0; padding: 0; }
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, Helvetica, sans-serif; color: #2d3748; background: #fff; font-size: 10px; }
                        .container { padding: 15px; max-width: 100%; }
                        
                        /* Header - Estilo Orçamento Vendas */
                        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 8px; border-bottom: 2.5px solid #1a365d; }
                        .header-line { height: 0.5px; background: #2c5282; margin-top: 3px; }
                        .logo-area img { height: 40px; }
                        .empresa-info { text-align: right; font-size: 7px; color: #718096; line-height: 1.4; }
                        .empresa-info .razao { font-size: 8px; font-weight: 700; color: #1a365d; margin-bottom: 1px; }
                        
                        /* Título - Estilo Orçamento Vendas */
                        .doc-title { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: #fff; padding: 8px 15px; margin-top: 8px; text-align: center; }
                        .doc-title h1 { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; margin: 0; }
                        .doc-title .periodo { font-size: 10px; color: #90cdf4; margin-top: 2px; }
                        
                        /* Seções - Estilo Orçamento Vendas */
                        .section { margin-top: 10px; }
                        .section-header { background: #2c5282; color: #fff; padding: 5px 10px; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
                        .section-content { border: 1px solid #e2e8f0; border-top: none; padding: 10px; background: #fff; }
                        
                        /* Resumo Grid */
                        .resumo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
                        .resumo-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px; text-align: center; }
                        .resumo-box label { font-size: 7px; color: #718096; text-transform: uppercase; display: block; margin-bottom: 4px; }
                        .resumo-box .valor { font-size: 11px; font-weight: 700; }
                        .resumo-box .valor.green { color: #059669; }
                        .resumo-box .valor.red { color: #dc2626; }
                        .resumo-box .valor.blue { color: #2563eb; }
                        .resumo-box .valor.orange { color: #ea580c; }
                        
                        /* Tabela - Estilo Orçamento Vendas */
                        .data-table { width: 100%; border-collapse: collapse; }
                        .data-table th { background: #1a365d; color: #fff; padding: 6px 8px; font-size: 7px; font-weight: 700; text-transform: uppercase; text-align: left; }
                        .data-table td { padding: 6px 8px; border-bottom: 1px solid #edf2f7; font-size: 9px; }
                        .data-table tr:nth-child(even) { background: #f7fafc; }
                        .data-table tfoot td { background: #1a365d; color: white; font-weight: 700; }
                        .valor-positivo { color: #059669; font-weight: 600; }
                        .valor-negativo { color: #dc2626; font-weight: 600; }
                        
                        /* Totais Box - Estilo Orçamento Vendas */
                        .totais-wrapper { display: flex; justify-content: flex-end; margin-top: 10px; }
                        .totais-box { background: #f0f9ff; border: 1px solid #2c5282; padding: 10px 15px; min-width: 180px; box-shadow: 2px 2px 0 #e2e8f0; }
                        .totais-row { display: flex; justify-content: space-between; font-size: 8px; padding: 3px 0; }
                        .totais-row.total { border-top: 1px solid #2c5282; padding-top: 8px; margin-top: 5px; }
                        .totais-row.total label { font-size: 10px; font-weight: 700; color: #1a365d; }
                        .totais-row.total span { font-size: 11px; font-weight: 700; color: #38a169; }
                        
                        /* Footer - Estilo Orçamento Vendas */
                        .footer { margin-top: 15px; padding-top: 8px; border-top: 1px solid #1a365d; font-size: 7px; color: #718096; text-align: center; }
                        
                        @media print { 
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            html { margin-top: 0 !important; }
                            body::before, body::after { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <!-- HEADER -->
                        <div class="header">
                            <div class="logo-area">
                                <img src="/images/Logo Monocromatico - Azul - Aluforce.png" alt="ALUFORCE" onerror="this.outerHTML='<div style=font-size:20px;font-weight:700;color:#1a365d>ALUFORCE</div>'">
                            </div>
                            <div class="empresa-info">
                                <div class="razao">I. M. DOS REIS - ALUFORCE INDÚSTRIA E COMÉRCIO DE CONDUTORES</div>
                                <div>CNPJ: 08.192.479/0001-60 | IE: 103.385.861-110</div>
                                <div>RUA ERNESTINA, 270 - VILA SÍO JOÍO</div>
                                <div>Ferraz de Vasconcelos - SP | CEP: 08527-400</div>
                                <div>Tel: (11) 94723-8729</div>
                            </div>
                        </div>
                        <div class="header-line"></div>
                        
                        <!-- TÍTULO -->
                        <div class="doc-title">
                            <h1>${titulo}</h1>
                            <div class="periodo">Período: ${periodo}</div>
                        </div>
                        
                        <!-- CONTEÚDO DO RELATÓRIO -->
                        ${conteudoHTML}
                        
                        <!-- FOOTER -->
                        <div class="footer">
                            <div>Documento gerado em ${dataAtual} às ${horaAtual}</div>
                            <div style="margin-top: 2px;">ALUFORCE - Sistema de Gestão Empresarial | Módulo Financeiro</div>
                        </div>
                    </div>
                    
                    <scr` + `ipt>
                        setTimeout(function() { window.print(); }, 500);
                    <\/scr` + `ipt>
</body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>

    <!-- Funções Compartilhadas Financeiro -->
    <script src="public/js/financeiro-shared.js?v=20260217"></script>
    <script src="/js/mobile-auto-enhance.js?v=20260202" defer></script>

    <!-- Sidebar Click Animation -->
    <script src="/js/sidebar-click-animation.js?v=20260224"></script>
    <script src="/_shared/accessibility-widget.js?v=20260226"></script>
</body>
</html>