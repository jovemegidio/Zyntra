<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aluforce: Impostos</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <script src="/js/auth-unified.js?v=20260211"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="css/fin-layout.css?v=20260215">
    <link rel="stylesheet" href="css/fin-components.css?v=20260215">
    <style>
        :root {
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --bg-gray: #f1f5f9;
            --border-color: #e2e8f0;
            --primary-orange: #f97316;
            --primary-dark: #1e3a5f;
            --sidebar-width: 60px;
            --header-height: 56px;
            --purple: #8b5cf6;        }

        

        
        
        

        /* ======================================== SIDEBAR LATERAL ======================================== */
        
        
        
        
        
        
        
        
        
        

        /* ======================================== MAIN CONTENT AREA ======================================== */
        .main-area { flex: 1; display: flex; flex-direction: column; /* overflow: global-header-sidebar.css */ }

        /* ======================================== HEADER SUPERIOR ======================================== */
        
        
        
        
        
        
        
        
        

        /* ======================================== SISTEMA DE NOTIFICAÇÕES ======================================== */
        
        
        
        
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        
        
        
        
        
        .notif-tab { flex: 1; padding: 12px; background: none; border: none; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .notif-tab:hover { color: #f97316; }
        .notif-tab.active { color: #f97316; border-bottom-color: #f97316; font-weight: 600; }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        /* CONTENT */
        .page-content { flex: 1; overflow-y: auto; padding: 24px; }

        /* PAGE HEADER */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 12px; }
        .page-title h1 i { color: var(--purple); }
        .page-title p { font-size: 14px; color: var(--text-secondary); }
        .page-actions { display: flex; gap: 12px; }

        /* BUTTONS */
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--purple); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: white; color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-gray); }

        /* TABS */
        .tabs-container { display: flex; gap: 8px; background: white; padding: 6px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tab-btn { padding: 12px 24px; border: none; background: transparent; border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { background: var(--bg-gray); }
        .tab-btn.active { background: var(--purple); color: white; }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .kpi-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .kpi-icon.purple { background: rgba(139,92,246,0.1); color: var(--purple); }
        .kpi-icon.green { background: rgba(34,197,94,0.1); color: var(--success); }
        .kpi-icon.orange { background: rgba(245,158,11,0.1); color: var(--warning); }
        .kpi-icon.blue { background: rgba(59,130,246,0.1); color: var(--info); }
        .kpi-content h3 { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .kpi-value { font-size: 28px; font-weight: 700; }

        /* TABLE */
        .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .card-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-header h3 i { color: var(--purple); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-gray); padding: 14px 20px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
        td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        tr:hover td { background: var(--bg-gray); }

        /* BADGES */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-success { background: rgba(34,197,94,0.1); color: #16a34a; }
        .badge-warning { background: rgba(245,158,11,0.1); color: #b45309; }
        .badge-danger { background: rgba(239,68,68,0.1); color: #b91c1c; }
        .badge-purple { background: rgba(139,92,246,0.1); color: #7c3aed; }

        /* ACTIONS */
        .btn-action { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-action.view { background: rgba(59,130,246,0.1); color: var(--info); }
        .btn-action.edit { background: rgba(245,158,11,0.1); color: var(--warning); }
        .btn-action.delete { background: rgba(239,68,68,0.1); color: var(--danger); }
        .btn-action:hover { transform: scale(1.1); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, var(--purple), #7c3aed); color: white; }
        .modal-header h3 { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border: none; background: rgba(255,255,255,0.2); cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        .modal-
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

        /* FORM */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 0 3px rgba(139,92,246,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .page-content { padding: 16px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
    <link rel="stylesheet" href="/css/tooltips-professional.css?v=20260209">
    <script src="/js/tooltips-professional.js?v=20260209"></script>
    <link rel="stylesheet" href="css/fin-header-sidebar.css?v=20260211">
    <link rel="stylesheet" href="/css/global-header-sidebar.css?v=20260216">
        <!-- Chat Widget BOB AI -->
    <link rel="stylesheet" href="/chat/widget.css?v=20260218">
</head>
<body>
    <div class="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- SIDEBAR - PADRÃO PCP (HTML estático, RBAC via JS) -->
        <aside class="sidebar" id="mobile-sidebar">
            <a href="/dashboard" class="sidebar-logo" title="Voltar ao Painel">
                <i class="fas fa-home"></i>
            </a>

            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-btn" title="Dashboard">
                    <i class="fas fa-chart-line"></i>
                </a>
                <a href="contas-pagar.html" class="sidebar-btn" title="Contas a Pagar">
                    <i class="fas fa-file-invoice-dollar"></i>
                </a>
                <a href="contas-receber.html" class="sidebar-btn" title="Contas a Receber">
                    <i class="fas fa-hand-holding-usd"></i>
                </a>
                <a href="fluxo-caixa.html" class="sidebar-btn" title="Fluxo de Caixa">
                    <i class="fas fa-chart-area"></i>
                </a>
                <a href="bancos.html" class="sidebar-btn" title="Bancos">
                    <i class="fas fa-university"></i>
                </a>
                <a href="plano-contas.html" class="sidebar-btn" title="Plano de Contas">
                    <i class="fas fa-list-alt"></i>
                </a>
                <a href="orcamentos.html" class="sidebar-btn" title="Orçamentos">
                    <i class="fas fa-calculator"></i>
                </a>
                <a href="conciliacao.html" class="sidebar-btn" title="Conciliação">
                    <i class="fas fa-balance-scale"></i>
                </a>
                <a href="relatorios.html" class="sidebar-btn" title="Relatórios">
                    <i class="fas fa-chart-bar"></i>
                </a>
            </nav>

            <div class="sidebar-bottom">
                <a href="centros-custo.html" class="sidebar-btn" title="Centros de Custo">
                    <i class="fas fa-sitemap"></i>
                </a>
                <a href="impostos.html" class="sidebar-btn active" title="Impostos">
                    <i class="fas fa-percent"></i>
                </a>
                <button class="sidebar-btn" title="Configurações" id="btn-config" onclick="toggleConfiguracoes()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <!-- HEADER - PADRÃO PCP (HTML estático) -->
            <header class="header">
                <div class="header-left">
                    <!-- Botao Menu Mobile -->
                    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-brand" style="display:flex;align-items:center;gap:10px;">
                        <img src="/images/Logo Monocromatico - Branco - Aluforce.png" alt="ALUFORCE" style="height:22px;object-fit:contain;">
                        <span style="color:rgba(255,255,255,0.2);font-weight:300;font-size:18px;user-select:none;">|</span>
                        <img src="/images/zyntra-branco.png" alt="Zyntra" style="height:22px;object-fit:contain;">
                        <span style="color:rgba(255,255,255,0.18);font-weight:200;font-size:16px;user-select:none;margin:0 2px;"></span>
                        <span style="font-size:13px;font-weight:500;color:rgba(255,255,255,0.85);letter-spacing:0.3px;">Impostos</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn" title="Atualizar" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="notification-container">
                        <button class="header-btn notification-btn" title="Notificações" onclick="toggleNotificacoes()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notification-count" style="display: none;">0</span>
                        </button>
                        <div class="notification-panel" id="notification-panel">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell"></i> Notificações</h3>
                                <div class="notification-actions">
                                    <button onclick="marcarTodasLidas()" title="Marcar todas como lidas">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                    <button onclick="limparNotificacoes()" title="Limpar todas">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="notification-list" id="notification-list">
                                <div class="notification-empty">
                                    <i class="fas fa-check-circle"></i>
                                    <p>Nenhuma notificação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-greeting">
                        <span><span id="greeting-text">Bom dia</span>, <strong id="user-name">Usuário</strong></span>
                        <div class="user-avatar" id="user-avatar">
                            <img alt="Foto do usuário" id="user-photo" style="display:none">
                            <span id="user-initials">U</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content - Padrão PCP -->
            <div class="main-content">

            <div class="page-content">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-title">
                        <h1><i class="fas fa-percent"></i> Configuração de Impostos</h1>
                        <p>Gerencie as configurações tributárias da empresa</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="exportarImpostos()"><i class="fas fa-download"></i> Exportar</button>
                        <button class="btn btn-primary" onclick="abrirModal()"><i class="fas fa-plus"></i> Novo Imposto</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="trocarTab('todos')"><i class="fas fa-list"></i> Todos</button>
                    <button class="tab-btn" onclick="trocarTab('federais')"><i class="fas fa-flag"></i> Federais</button>
                    <button class="tab-btn" onclick="trocarTab('estaduais')"><i class="fas fa-map-marker-alt"></i> Estaduais</button>
                    <button class="tab-btn" onclick="trocarTab('municipais')"><i class="fas fa-city"></i> Municipais</button>
                </div>

                <!-- KPIs -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon purple"><i class="fas fa-file-invoice-dollar"></i></div>
                        </div>
                        <div class="kpi-content">
                            <h3>Total Impostos</h3>
                            <div class="kpi-value" id="kpi-total">0</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="kpi-content">
                            <h3>Ativos</h3>
                            <div class="kpi-value" id="kpi-ativos">0</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon orange"><i class="fas fa-calculator"></i></div>
                        </div>
                        <div class="kpi-content">
                            <h3>Alíquota Média</h3>
                            <div class="kpi-value" id="kpi-aliquota">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-icon blue"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="kpi-content">
                            <h3>Vencendo Este Mês</h3>
                            <div class="kpi-value" id="kpi-vencendo">0</div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Lista de Impostos</h3>
                        <input type="text" id="searchInput" placeholder="Buscar..." style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; width: 250px;" onkeyup="filtrarImpostos()">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Alíquota</th>
                                    <th>Base de Cálculo</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-impostos">
                                <tr>
                                    <td colspan="7" class="td-loading">
                                        <i class="fas fa-spinner fa-spin"></i> Carregando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div> <!-- /main-content -->

        </main>
    </div>

    <!-- Modal Novo/Editar - Padrão SaaS Empresarial -->
    <div class="modal-overlay-saas" id="modalImposto" onclick="if(event.target === this) fecharModal()">
        <div class="modal-saas modal-sm">
            <div class="modal-header-saas header-purple">
                <div class="modal-header-content-saas">
                    <div class="modal-header-icon-saas">
                        <i class="fas fa-percent" id="modal-icon"></i>
                    </div>
                    <div class="modal-header-text-saas">
                        <h2 id="modal-titulo">Novo Imposto</h2>
                        <p id="modal-subtitulo">Configure um novo imposto ou tributo</p>
                    </div>
                    <button class="modal-close-saas" onclick="fecharModal()"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body-saas">
                <form id="formImposto">
                    <input type="hidden" id="imposto-id">
                    
                    <!-- Seção: Identificação -->
                    <div class="form-section-saas">
                        <div class="form-section-title-saas">
                            <i class="fas fa-tag icon-purple"></i>
                            <span>Identificação</span>
                            <span class="section-badge-saas">Obrigatório</span>
                        </div>
                        <div class="form-grid-saas">
                            <div class="form-group-saas">
                                <label><i class="fas fa-hashtag"></i> Código <span class="required">*</span></label>
                                <input type="text" id="imposto-codigo" placeholder="Ex: ICMS, ISS, PIS" required>
                            </div>
                            <div class="form-group-saas">
                                <label><i class="fas fa-layer-group"></i> Tipo <span class="required">*</span></label>
                                <select id="imposto-tipo" required>
                                    <option value="federal">Federal</option>
                                    <option value="estadual">Estadual</option>
                                    <option value="municipal">Municipal</option>
                                </select>
                            </div>
                            <div class="form-group-saas full">
                                <label><i class="fas fa-file-signature"></i> Nome Completo <span class="required">*</span></label>
                                <input type="text" id="imposto-nome" placeholder="Nome completo do imposto" required>
                            </div>
                        </div>
                    </div>

                    <!-- Seção: Configuração -->
                    <div class="form-section-saas">
                        <div class="form-section-title-saas">
                            <i class="fas fa-cog icon-orange"></i>
                            <span>Configuração de Cálculo</span>
                        </div>
                        <div class="form-grid-saas">
                            <div class="form-group-saas">
                                <label><i class="fas fa-percentage"></i> Alíquota (%)</label>
                                <input type="number" id="imposto-aliquota" placeholder="0.00" step="0.01" min="0" max="100">
                                <div class="field-hint-saas">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Taxa percentual aplicada</span>
                                </div>
                            </div>
                            <div class="form-group-saas">
                                <label><i class="fas fa-calculator"></i> Base de Cálculo</label>
                                <select id="imposto-base">
                                    <option value="faturamento">Faturamento Bruto</option>
                                    <option value="lucro">Lucro</option>
                                    <option value="folha">Folha de Pagamento</option>
                                    <option value="servicos">Serviços Prestados</option>
                                    <option value="mercadorias">Valor das Mercadorias</option>
                                </select>
                            </div>
                            <div class="form-group-saas full">
                                <label><i class="fas fa-align-left"></i> Descrição</label>
                                <textarea id="imposto-descricao" rows="3" placeholder="Descrição detalhada do imposto e suas regras de aplicação..."></textarea>
                            </div>
                            <div class="form-group-saas">
                                <label><i class="fas fa-toggle-on"></i> Status</label>
                                <select id="imposto-ativo">
                                    <option value="1">Ativo</option>
                                    <option value="0">Inativo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer-saas">
                <div class="modal-footer-left-saas">
                    <div class="footer-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Campos com <span style="color:#dc2626">*</span> são obrigatórios</span>
                    </div>
                </div>
                <div class="modal-footer-right-saas">
                    <button class="btn-saas btn-saas-ghost" onclick="fecharModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn-saas btn-saas-primary" onclick="salvarImposto()" id="btnSalvar">
                        <i class="fas fa-save"></i> Salvar Imposto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSS dos Modais SaaS -->
    <link rel="stylesheet" href="css/modais-saas.css">

    <script>
        let impostos = [];
        let tabAtual = 'todos';
        let editandoId = null;

        // Dados mockados (substituir por API real)
        const impostosIniciais = [
            { id: 1, codigo: 'ICMS', nome: 'Imposto sobre Circulação de Mercadorias', tipo: 'estadual', aliquota: 18, base: 'mercadorias', ativo: true },
            { id: 2, codigo: 'ISS', nome: 'Imposto Sobre Serviços', tipo: 'municipal', aliquota: 5, base: 'servicos', ativo: true },
            { id: 3, codigo: 'PIS', nome: 'Programa de Integração Social', tipo: 'federal', aliquota: 1.65, base: 'faturamento', ativo: true },
            { id: 4, codigo: 'COFINS', nome: 'Contribuição para Financiamento da Seguridade Social', tipo: 'federal', aliquota: 7.6, base: 'faturamento', ativo: true },
            { id: 5, codigo: 'IRPJ', nome: 'Imposto de Renda Pessoa Jurídica', tipo: 'federal', aliquota: 15, base: 'lucro', ativo: true },
            { id: 6, codigo: 'CSLL', nome: 'Contribuição Social sobre o Lucro Líquido', tipo: 'federal', aliquota: 9, base: 'lucro', ativo: true },
            { id: 7, codigo: 'INSS', nome: 'Instituto Nacional do Seguro Social', tipo: 'federal', aliquota: 20, base: 'folha', ativo: true },
        ];

        // Carregar usuário
        async function carregarUsuario() {
            try {
                const response = await fetch('/api/me', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    const primeiroNome = user.apelido || (user.nome ? user.nome.split(' ')[0] : 'Usuário');

                    const hour = new Date().getHours();
                    let greeting = 'Bom dia';
                    if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
                    else if (hour >= 18 || hour < 5) greeting = 'Boa noite';
                    
                    document.getElementById('greeting-text').textContent = greeting;
                    document.getElementById('user-name').textContent = primeiroNome;
                    document.getElementById('user-initials').textContent = primeiroNome.charAt(0).toUpperCase();
                    
                    const fotoUrl = user.avatar || user.foto || user.foto_perfil_url;
                    const fotoEl = document.getElementById('user-photo');
                    const inicialEl = document.getElementById('user-initials');
                    
                    if (fotoUrl && fotoUrl !== '/avatars/default.webp') {
                        fotoEl.src = fotoUrl;
                        fotoEl.onload = () => {
                            fotoEl.style.display = 'block';
                            fotoEl.classList.add('visible');
                            if (inicialEl) inicialEl.style.display = 'none';
                        };
                        fotoEl.onerror = () => { fotoEl.style.display = 'none'; if (inicialEl) { inicialEl.textContent = primeiroNome.charAt(0).toUpperCase(); inicialEl.style.display = 'flex'; } };
                    }
                }
            } catch (e) { console.error('Erro ao carregar usuário:', e); }
        }

        // Carregar impostos
        async function carregarImpostos() {
            try {
                // Tentar API real primeiro
                const response = await fetch('/api/financeiro/impostos', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const raw = data.data || data || [];
                    impostos = Array.isArray(raw) ? raw : [];
                } else {
                    // Usar dados mockados
                    impostos = impostosIniciais;
                }
            } catch (e) {
                console.log('Usando dados mockados:', e);
                impostos = impostosIniciais;
            }
            renderizarTabela();
            atualizarKPIs();
        }

        function trocarTab(tab) {
            tabAtual = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabela-impostos');
            let dados = impostos;
            
            if (tabAtual !== 'todos') {
                const tipoMap = { 'federais': 'federal', 'estaduais': 'estadual', 'municipais': 'municipal' };
                dados = impostos.filter(i => i.tipo === tipoMap[tabAtual]);
            }

            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;"><i class="fas fa-inbox" style="font-size:32px;color:#e2e8f0;display:block;margin-bottom:12px;"></i>Nenhum imposto encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = dados.map(i => `
                <tr>
                    <td><strong>${i.codigo}</strong></td>
                    <td>${i.nome}</td>
                    <td><span class="badge badge-purple">${i.tipo.charAt(0).toUpperCase() + i.tipo.slice(1)}</span></td>
                    <td><strong>${i.aliquota}%</strong></td>
                    <td>${formatarBase(i.base)}</td>
                    <td><span class="badge ${i.ativo ? 'badge-success' : 'badge-danger'}">${i.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="btn-action view" title="Ver" onclick="verImposto(${i.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn-action edit" title="Editar" onclick="editarImposto(${i.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-action delete" title="Excluir" onclick="excluirImposto(${i.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function formatarBase(base) {
            const map = {
                'faturamento': 'Faturamento Bruto',
                'lucro': 'Lucro',
                'folha': 'Folha de Pagamento',
                'servicos': 'Serviços',
                'mercadorias': 'Mercadorias'
            };
            return map[base] || base;
        }

        function atualizarKPIs() {
            const total = impostos.length;
            const ativos = impostos.filter(i => i.ativo).length;
            const aliquotaMedia = impostos.length > 0 
                ? impostos.reduce((sum, i) => sum + parseFloat(i.aliquota || 0), 0) / impostos.length 
                : 0;

            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-ativos').textContent = ativos;
            document.getElementById('kpi-aliquota').textContent = aliquotaMedia.toFixed(1) + '%';
            document.getElementById('kpi-vencendo').textContent = '0';
        }

        function filtrarImpostos() {
            const busca = document.getElementById('searchInput').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabela-impostos tr');
            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(busca) ? '' : 'none';
            });
        }

        function abrirModal() {
            editandoId = null;
            document.getElementById('modal-titulo').textContent = 'Novo Imposto';
            document.getElementById('formImposto').reset();
            document.getElementById('imposto-id').value = '';
            document.getElementById('modalImposto').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modalImposto').classList.remove('active');
        }

        function editarImposto(id) {
            const imposto = impostos.find(i => i.id === id);
            if (!imposto) return;

            editandoId = id;
            document.getElementById('modal-titulo').textContent = 'Editar Imposto';
            document.getElementById('imposto-id').value = imposto.id;
            document.getElementById('imposto-codigo').value = imposto.codigo || '';
            document.getElementById('imposto-nome').value = imposto.nome || '';
            document.getElementById('imposto-tipo').value = imposto.tipo || 'federal';
            document.getElementById('imposto-aliquota').value = imposto.aliquota || 0;
            document.getElementById('imposto-base').value = imposto.base || 'faturamento';
            document.getElementById('imposto-descricao').value = imposto.descricao || '';
            document.getElementById('imposto-ativo').value = imposto.ativo ? '1' : '0';
            document.getElementById('modalImposto').classList.add('active');
        }

        async function salvarImposto() {
            const dados = {
                codigo: document.getElementById('imposto-codigo').value,
                tipo: document.getElementById('imposto-tipo').value,
                nome: document.getElementById('imposto-nome').value,
                aliquota: parseFloat(document.getElementById('imposto-aliquota').value) || 0,
                base: document.getElementById('imposto-base').value,
                descricao: document.getElementById('imposto-descricao').value,
                observacoes: document.getElementById('imposto-descricao').value,
                ativo: document.getElementById('imposto-ativo').value === '1'
            };

            if (!dados.tipo) {
                mostrarToastFinanceiro('Tipo do imposto é obrigatório', 'warning');
                return;
            }

            try {
                const url = editandoId 
                    ? `/api/financeiro/impostos/${editandoId}`
                    : '/api/financeiro/impostos';
                
                const response = await fetch(url, {
                    method: editandoId ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    fecharModal();
                    carregarImpostos();
                    mostrarToastFinanceiro(editandoId ? 'Imposto atualizado com sucesso!' : 'Imposto criado com sucesso!', 'success');
                } else {
                    const error = await response.json();
                    mostrarToastFinanceiro('Erro: ' + (error.message || 'Falha ao salvar'), 'error');
                }
            } catch (e) {
                console.error('Erro ao salvar:', e);
                mostrarToastFinanceiro('Erro ao salvar imposto', 'error');
            }
        }

        async function excluirImposto(id) {
            if (!confirm('Tem certeza que deseja excluir este imposto?')) return;
            
            try {
                const response = await fetch(`/api/financeiro/impostos/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    carregarImpostos();
                    mostrarToastFinanceiro('Imposto excluído com sucesso!', 'success');
                } else {
                    mostrarToastFinanceiro('Erro ao excluir imposto', 'error');
                }
            } catch (e) {
                console.error('Erro ao excluir:', e);
                mostrarToastFinanceiro('Erro ao excluir imposto', 'error');
            }
        }

        function verImposto(id) {
            const imposto = impostos.find(i => i.id === id);
            if (!imposto) return;
            // Modal profissional de detalhes
            const existing = document.querySelector('.imposto-detail-modal');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.className = 'imposto-detail-modal';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            overlay.innerHTML = `
                <div style="background:#fff;border-radius:16px;padding:28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);font-family:Inter,sans-serif;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="margin:0;font-size:18px;color:#1e293b;font-weight:700;"><i class="fas fa-receipt" style="color:#8b5cf6;margin-right:8px;"></i>Detalhes do Imposto</h3>
                        <button onclick="this.closest('.imposto-detail-modal').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#94a3b8;">&times;</button>
                    </div>
                    <div style="display:grid;gap:12px;">
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Nome</span><strong style="color:#1e293b;font-size:13px;">${imposto.nome || imposto.descricao}</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Código</span><strong style="color:#1e293b;font-size:13px;">${imposto.codigo || imposto.tipo}</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Tipo</span><strong style="color:#1e293b;font-size:13px;">${imposto.tipo}</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Alíquota</span><strong style="color:#8b5cf6;font-size:13px;">${imposto.aliquota}%</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Base</span><strong style="color:#1e293b;font-size:13px;">${formatarBase(imposto.base)}</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f8fafc;border-radius:8px;"><span style="color:#64748b;font-size:13px;">Status</span><span style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;${imposto.ativo ? 'background:#dcfce7;color:#16a34a' : 'background:#fee2e2;color:#dc2626'};">${imposto.ativo ? 'Ativo' : 'Inativo'}</span></div>
                    </div>
                    <button onclick="this.closest('.imposto-detail-modal').remove()" style="width:100%;margin-top:20px;padding:10px;background:#8b5cf6;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">Fechar</button>
                </div>`;
            document.body.appendChild(overlay);
        }

        function exportarImpostos() {
            if (impostos.length === 0) {
                mostrarToastFinanceiro('Não há dados para exportar', 'warning');
                return;
            }

            let csv = 'Código,Nome,Tipo,Alíquota,Base,Status\n';
            impostos.forEach(i => {
                csv += `"${i.codigo}","${i.nome}","${i.tipo}","${i.aliquota}","${formatarBase(i.base)}","${i.ativo ? 'Ativo' : 'Inativo'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'impostos.csv';
            link.click();
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            carregarUsuario();
            carregarImpostos();
        });
    </script>
    <script src="public/js/financeiro-shared.js?v=20260217"></script>
    <!-- Sidebar + Header RBAC Component -->
    <script src="js/financeiro-sidebar.js?v=20260211"></script>
    <script src="/js/mobile-auto-enhance.js?v=20260202" defer></script>

<!-- ALUFORCE: Confirm Dialog Profissional v2.0 --><script src="/_shared/confirm-dialog.js?v=20260217"></script>
    <!-- Chat Widget BOB AI -->
    <script src="/chat/widget.js?v=20260218" defer></script>
    <script src="/_shared/accessibility-widget.js?v=20260226"></script>
</body>
</html>


