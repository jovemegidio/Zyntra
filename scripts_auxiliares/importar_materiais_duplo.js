const mysql = require('mysql2/promise');const fs = require('fs');// CNPJ para gera√ß√£o de EAN-13: 68.192.475/0001-60const CNPJ_BASE = '6819247500';function calcularDigitoVerificadorEAN13(codigo12) {    let soma = 0;    for (let i = 0; i < 12; i++) {        const digito = parseInt(codigo12[i]);        soma += digito * (i % 2 === 0 ? 1 : 3);    }    const resto = soma % 10;    return resto === 0 ? 0 : 10 - resto;}function gerarEAN13(sequencia) {    const codigo12 = '789' + CNPJ_BASE.substring(0, 6) + sequencia.toString().padStart(3, '0');    const digitoVerificador = calcularDigitoVerificadorEAN13(codigo12);    return codigo12 + digitoVerificador;}function formatarNCM(ncm) {    if (!ncm) return null;    return ncm.replace(/\./g, '');}function formatarCEST(cest) {    if (!cest) return null;    return cest.replace(/\./g, '');}function extrairUnidade(textoUnidade) {    if (!textoUnidade) return 'UN';    const match = textoUnidade.match(/\(([^)]+)\)/);    return match ? match[1] : 'UN';}async function importarMateriaisDuplo() {    console.log('üîå Conectando aos bancos de dados...');    const local = await mysql.createConnection({        host: 'localhost',        user: 'root',        password: '@dminalu',        database: 'aluforce_vendas',        port: 3306,        charset: 'utf8mb4'    });    const railway = await mysql.createConnection({        host: 'interchange.proxy.rlwy.net',        user: 'root',        password: 'iiilOZutDOnPCwxgiTKeMuEaIzSwplcu',        database: 'railway',        port: 19396,        charset: 'utf8mb4'    });    console.log('‚úÖ Conectado aos dois bancos!');    try {        const materiaisExcel = JSON.parse(fs.readFileSync('materiais_extraidos.json', 'utf8'));        console.log(`üì¶ Total de materiais no arquivo: ${materiaisExcel.length}`);        for (const [db, nome] of [[local, 'Local'], [railway, 'Railway']]) {            const [materiaisExistentes] = await db.query('SELECT id, codigo_material, descricao FROM materiais');            const mapaDescricao = {};            materiaisExistentes.forEach(m => {                if (m.descricao) mapaDescricao[m.descricao.toLowerCase().trim()] = m.id;                if (m.codigo_material) mapaDescricao[m.codigo_material.toLowerCase().trim()] = m.id;            });            let materiaisInseridos = 0;            let materiaisAtualizados = 0;            let errosMateriais = 0;            let sequenciaEAN = 500;            console.log(`üîß IMPORTANDO MATERIAIS NO BANCO: ${nome}`);            for (const material of materiaisExcel) {                const codigo = material.codigo || null;                const descricao = material.descricao || null;                const ncm = formatarNCM(material.ncm) || null;                const cest = formatarCEST(material.cest) || null;                const preco = material.preco || 0;                const estoque = material.estoque || 0;                const unidade = extrairUnidade(material.unidade) || 'UN';                const tipo = material.tipoMaterial || null;                let gtin = material.ean && material.ean.trim() !== '' ? material.ean : null;                if (!gtin) gtin = gerarEAN13(sequenciaEAN++);                try {                    const chaveDescricao = descricao ? descricao.toLowerCase().trim() : '';                    const chaveCodigo = codigo ? codigo.toLowerCase().trim() : '';                    const idExistente = mapaDescricao[chaveDescricao] || mapaDescricao[chaveCodigo];                    if (idExistente) {                        await db.execute(`UPDATE materiais SET ncm = COALESCE(?, ncm), cest = COALESCE(?, cest), gtin = COALESCE(?, gtin), preco_venda = ?, tipo = COALESCE(?, tipo), unidade_medida = ? WHERE id = ?`, [ncm, cest, gtin, preco, tipo, unidade, idExistente]);                        materiaisAtualizados++;                    } else {                        await db.execute(`INSERT INTO materiais (codigo_material, descricao, ncm, cest, gtin, preco_venda, tipo, unidade_medida, ativo, quantidade_estoque, custo_unitario) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, ?, ?)`, [codigo, descricao, ncm, cest, gtin, preco, tipo, unidade, estoque, preco]);                        materiaisInseridos++;                        if (descricao) mapaDescricao[descricao.toLowerCase().trim()] = 'novo';                        if (codigo) mapaDescricao[codigo.toLowerCase().trim()] = 'novo';                    }                } catch (err) {                    console.log(`  ‚ùå ${descricao} (${nome}): Erro - ${err.message}`);                    errosMateriais++;                }            }            console.log(`  üìä RESUMO ${nome}:`);            console.log(`     - Inseridos: ${materiaisInseridos}`);            console.log(`     - Atualizados: ${materiaisAtualizados}`);            console.log(`     - Erros: ${errosMateriais}`);        }        console.log('‚úÖ IMPORTA√á√çO DE MATERIAIS CONCLU√çDA NOS DOIS BANCOS!');    } catch (error) {        console.error('‚ùå ERRO GERAL:', error.message);    } finally {        await local.end();        await railway.end();        console.log('üîå Conex√µes encerradas');    }}importarMateriaisDuplo();