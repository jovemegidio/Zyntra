// Verifica√ß√£o de Sa√∫de do Sistema ALUFORCE// Execute: node verificar-sistema.jsconst mysql = require('mysql2/promise');const fs = require('fs');const path = require('path');const http = require('http');console.log('üîç VERIFICA√á√çO DE SA√öDE DO SISTEMA ALUFORCE');console.log('='.repeat(60));const checks = [];let hasErrors = false;// Fun√ß√£o para adicionar resultado de verifica√ß√£ofunction addCheck(name, status, message) {    const icon = status ? '‚úÖ' : '‚ùå';    checks.push({ name, status, message });    console.log(`${icon} ${name}: ${message}`);    if (!status) hasErrors = true;}async function verificarSistema() {    // 1. Verificar arquivo .env    console.log('üìã 1. Verificando Configura√ß√µes...');    try {        const envPath = path.join(__dirname, '.env');        if (fs.existsSync(envPath)) {            const envContent = fs.readFileSync(envPath, 'utf8');                        // Verificar vari√°veis cr√≠ticas            const requiredVars = [                'DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME',                'JWT_SECRET', 'SESSION_SECRET'            ];                        const missing = requiredVars.filter(v => !envContent.includes(v));            if (missing.length === 0) {                addCheck('.env', true, 'Todas vari√°veis necess√°rias presentes');            } else {                addCheck('.env', false, `Vari√°veis faltando: ${missing.join(', ')}`);            }                        // Verificar se DB_CONN_LIMIT foi aumentado            if (envContent.includes('DB_CONN_LIMIT=20')) {                addCheck('Pool Size', true, 'DB_CONN_LIMIT = 20 (otimizado)');            } else {                addCheck('Pool Size', false, 'DB_CONN_LIMIT n√£o est√° em 20');            }                        // Verificar CORS            if (envContent.includes('CORS_ORIGIN=*')) {                addCheck('CORS', false, 'CORS permissivo (*) - risco de seguran√ßa');            } else {                addCheck('CORS', true, 'CORS configurado corretamente');            }        } else {            addCheck('.env', false, 'Arquivo .env n√£o encontrado');        }    } catch (err) {        addCheck('.env', false, err.message);    }    // 2. Verificar package.json    console.log('üì¶ 2. Verificando Depend√™ncias...');    try {        const pkgPath = path.join(__dirname, 'package.json');        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));                // Verificar vers√£o do bcrypt        if (pkg.dependencies.bcrypt === '^5.1.1') {            addCheck('bcrypt', true, 'Vers√£o correta (5.1.1)');        } else {            addCheck('bcrypt', false, `Vers√£o incorreta: ${pkg.dependencies.bcrypt}`);        }                // Verificar vers√£o do axios        if (pkg.dependencies.axios.startsWith('^1.6')) {            addCheck('axios', true, 'Vers√£o atualizada');        } else {            addCheck('axios', false, `Vers√£o desatualizada: ${pkg.dependencies.axios}`);        }    } catch (err) {        addCheck('package.json', false, err.message);    }    // 3. Verificar estrutura de m√≥dulos    console.log('üóÇÔ∏è  3. Verificando M√≥dulos...');    const modules = ['Vendas', 'RH', 'Compras', 'PCP', 'Faturamento'];    for (const mod of modules) {        const modPath = path.join(__dirname, 'modules', mod);        if (fs.existsSync(modPath)) {            // Verificar se tem server.js ou server_*.js            const files = fs.readdirSync(modPath);            const hasServer = files.some(f => f.startsWith('server') && f.endsWith('.js'));            addCheck(`M√≥dulo ${mod}`, hasServer, hasServer ? 'OK' : 'server.js n√£o encontrado');        } else {            addCheck(`M√≥dulo ${mod}`, false, 'Diret√≥rio n√£o encontrado');        }    }    // 4. Verificar conex√£o com banco de dados    console.log('üóÑÔ∏è  4. Verificando Banco de Dados...');    try {        require('dotenv').config();                const config = {            host: process.env.DB_HOST || 'localhost',            port: parseInt(process.env.DB_PORT) || 3306,            user: process.env.DB_USER || 'root',            password: process.env.DB_PASSWORD,            database: process.env.DB_NAME || 'railway',            connectTimeout: 5000        };                console.log(`   Conectando em ${config.host}:${config.port}...`);        const connection = await mysql.createConnection(config);        await connection.ping();                // Testar query simples        const [rows] = await connection.query('SELECT 1 as test');        if (rows[0].test === 1) {            addCheck('Conex√£o BD', true, `Conectado em ${config.host}:${config.port}`);                        // Verificar charset            const [charset] = await connection.query("SHOW VARIABLES LIKE 'character_set_database'");            if (charset[0].Value.includes('utf8mb4')) {                addCheck('Charset BD', true, 'UTF-8mb4 configurado');            } else {                addCheck('Charset BD', false, `Charset: ${charset[0].Value}`);            }        }                await connection.end();    } catch (err) {        addCheck('Conex√£o BD', false, err.message);    }    // 5. Verificar portas dos m√≥dulos    console.log('üîå 5. Verificando Configura√ß√£o de Portas...');    const portFiles = [        { file: 'modules/Vendas/server.js', expectedPort: '3004' },        { file: 'modules/RH/server.js', expectedPort: '3005' },        { file: 'modules/Compras/server.js', expectedPort: '3007' }    ];        for (const { file, expectedPort } of portFiles) {        try {            const filePath = path.join(__dirname, file);            if (fs.existsSync(filePath)) {                const content = fs.readFileSync(filePath, 'utf8');                if (content.includes(expectedPort)) {                    addCheck(`Porta ${path.dirname(file)}`, true, `Porta ${expectedPort} configurada`);                } else {                    addCheck(`Porta ${path.dirname(file)}`, false, `Porta ${expectedPort} n√£o encontrada`);                }            }        } catch (err) {            addCheck(`Porta ${file}`, false, err.message);        }    }    // 6. Verificar JWT_SECRET unificado    console.log('üîê 6. Verificando Seguran√ßa...');    try {        require('dotenv').config();        const jwtSecret = process.env.JWT_SECRET;                if (jwtSecret && jwtSecret.length >= 32) {            addCheck('JWT_SECRET', true, `Definido (${jwtSecret.length} caracteres)`);        } else {            addCheck('JWT_SECRET', false, 'JWT_SECRET n√£o definido ou muito curto');        }                // Verificar se server.js usa o JWT correto        const serverContent = fs.readFileSync(path.join(__dirname, 'server.js'), 'utf8');        if (serverContent.includes(jwtSecret) || serverContent.includes('process.env.JWT_SECRET')) {            addCheck('JWT Server', true, 'JWT_SECRET configurado no servidor principal');        } else {            addCheck('JWT Server', false, 'JWT_SECRET n√£o encontrado no servidor');        }    } catch (err) {        addCheck('JWT_SECRET', false, err.message);    }    // Relat√≥rio Final    console.log('' + '='.repeat(60));    console.log('üìä RESUMO DA VERIFICA√á√çO');        const passed = checks.filter(c => c.status).length;    const total = checks.length;    const percentage = Math.round((passed / total) * 100);        console.log(`Total de Verifica√ß√µes: ${total}`);    console.log(`‚úÖ Aprovadas: ${passed}`);    console.log(`‚ùå Reprovadas: ${total - passed}`);    console.log(`üìà Taxa de Sucesso: ${percentage}%`);        if (hasErrors) {        console.log('‚ö†Ô∏è  ATEN√á√çO: Alguns problemas foram encontrados!');        console.log('üìñ Consulte SISTEMA_PRONTO_DIA_A_DIA.md para solu√ß√µes');        process.exit(1);    } else {        console.log('üéâ SISTEMA 100% OPERACIONAL!');        console.log('‚úÖ Todas as verifica√ß√µes passaram');        console.log('üöÄ O sistema est√° pronto para uso di√°rio');        process.exit(0);    }}// Executar verifica√ß√£overificarSistema().catch(err => {    console.error('‚ùå Erro na verifica√ß√£o:', err.message);    process.exit(1);});