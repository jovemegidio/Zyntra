/** * Script para emitir Ordens de Produ√ß√£o dos pedidos faturar/faturado/entregue * Salva os arquivos HTML na pasta ordens-emitidas */const mysql = require('mysql2/promise');const fs = require('fs');const path = require('path');require('dotenv').config();const config = {    host: process.env.DB_HOST || 'interchange.proxy.rlwy.net',    user: process.env.DB_USER || 'root',    password: process.env.DB_PASSWORD || process.env.MYSQL_ROOT_PASSWORD,    database: process.env.DB_NAME || 'railway',    port: parseInt(process.env.DB_PORT) || 19396,    charset: 'utf8mb4'};const OUTPUT_DIR = path.join(__dirname, 'ordens-emitidas');// Template HTML da Ordem de Produ√ß√£ofunction gerarHTMLOrdemProducao(dados) {    // Produtos HTML    let produtosHTML = '';    let totalGeral = 0;        if (dados.produtos && dados.produtos.length > 0) {        dados.produtos.forEach((prod, index) => {            const valorUnit = parseFloat(prod.preco_unitario) || parseFloat(prod.valor_unitario) || 0;            const qtd = parseFloat(prod.quantidade) || 0;            const total = parseFloat(prod.total) || (qtd * valorUnit);            totalGeral += total;            produtosHTML += `                <tr>                    <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>                    <td style="padding: 8px; border: 1px solid #ddd;">${prod.codigo || '-'}</td>                    <td style="padding: 8px; border: 1px solid #ddd;">${prod.descricao || prod.produto || ''}</td>                    <td style="padding: 8px; border: 1px solid #ddd;">${prod.embalagem || '-'}</td>                    <td style="padding: 8px; border: 1px solid #ddd;">${prod.lances || '-'}</td>                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${qtd}</td>                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">R$ ${valorUnit.toFixed(2)}</td>                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">R$ ${total.toFixed(2)}</td>                </tr>            `;        });    } else {        produtosHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #666;">Nenhum produto adicionado</td></tr>';    }        const dataAtual = new Date().toLocaleDateString('pt-BR');        return `<!DOCTYPE html><html lang="pt-BR"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Ordem de Produ√ß√£o - ${dados.numero_op || dados.pedido_id}</title>    <style>        @media print {            body { margin: 0; padding: 15mm; }            .no-print { display: none !important; }        }        body {            font-family: Arial, sans-serif;            font-size: 12px;            line-height: 1.4;            color: #333;            background: white;            padding: 20px;        }        .header {            display: flex;            justify-content: space-between;            align-items: flex-start;            border-bottom: 3px solid #1a365d;            padding-bottom: 15px;            margin-bottom: 20px;        }        .logo-area {            display: flex;            align-items: center;            gap: 15px;        }        .company-info {            font-size: 11px;        }        .company-name {            font-size: 18px;            font-weight: bold;            color: #1a365d;        }        .op-number {            text-align: right;        }        .op-number h1 {            font-size: 24px;            color: #1a365d;            margin: 0;        }        .op-number p {            margin: 5px 0;            font-size: 13px;        }        .section {            margin-bottom: 20px;        }        .section-title {            background: #1a365d;            color: white;            padding: 8px 12px;            font-weight: bold;            font-size: 13px;            margin-bottom: 10px;        }        .info-grid {            display: grid;            grid-template-columns: repeat(4, 1fr);            gap: 10px;            padding: 10px;            background: #f8f9fa;            border: 1px solid #ddd;        }        .info-item {            padding: 5px;        }        .info-label {            font-weight: bold;            font-size: 10px;            color: #666;            text-transform: uppercase;        }        .info-value {            font-size: 12px;            margin-top: 3px;        }        table {            width: 100%;            border-collapse: collapse;            font-size: 11px;        }        th {            background: #1a365d;            color: white;            padding: 10px 8px;            text-align: left;            font-weight: bold;        }        .total-row {            background: #e8f4f8;            font-weight: bold;        }        .total-row td {            padding: 12px 8px !important;            border: 2px solid #1a365d !important;        }        .cobranca-section {            background: #fff3cd;            border: 2px solid #ffc107;            padding: 15px;            margin-top: 20px;        }        .cobranca-title {            font-weight: bold;            font-size: 14px;            margin-bottom: 10px;            color: #856404;        }        .footer {            margin-top: 30px;            display: grid;            grid-template-columns: 1fr 1fr 1fr;            gap: 20px;        }        .signature-box {            border-top: 1px solid #333;            padding-top: 10px;            text-align: center;            font-size: 11px;        }        .obs-section {            margin-top: 20px;            padding: 10px;            background: #f0f0f0;            border: 1px solid #ddd;        }        .status-badge {            display: inline-block;            padding: 4px 12px;            border-radius: 4px;            font-weight: bold;            font-size: 11px;            text-transform: uppercase;        }        .status-faturar { background: #fff3cd; color: #856404; }        .status-faturado { background: #d4edda; color: #155724; }        .status-entregue { background: #cce5ff; color: #004085; }        .print-btn {            position: fixed;            top: 20px;            right: 20px;            background: #1a365d;            color: white;            border: none;            padding: 12px 24px;            font-size: 14px;            cursor: pointer;            border-radius: 5px;        }        .print-btn:hover {            background: #2d4a7c;        }    </style></head><body>    <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>        <div class="header">        <div class="logo-area">            <div>                <div class="company-name">ALUFORCE</div>                <div class="company-info">                    Cabos de Alum√≠nio e Condutores El√©tricos<br>                    CNPJ: 30.691.476/0001-87<br>                    Av. Industrial, 1500 - Guarulhos/SP                </div>            </div>        </div>        <div class="op-number">            <h1>ORDEM DE PRODU√á√çO</h1>            <p><strong>OP N¬∫:</strong> ${dados.numero_op}</p>            <p><strong>Pedido:</strong> #${dados.pedido_id}</p>            <p><strong>Data Libera√ß√£o:</strong> ${dataAtual}</p>            <p><span class="status-badge status-${dados.status}">${dados.status_texto}</span></p>        </div>    </div>        <div class="section">        <div class="section-title">üìã DADOS DO CLIENTE</div>        <div class="info-grid">            <div class="info-item" style="grid-column: span 2;">                <div class="info-label">Cliente</div>                <div class="info-value">${dados.cliente || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">CNPJ/CPF</div>                <div class="info-value">${dados.cnpj || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Vendedor</div>                <div class="info-value">${dados.vendedor || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Contato</div>                <div class="info-value">${dados.contato || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Telefone</div>                <div class="info-value">${dados.telefone || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">E-mail</div>                <div class="info-value">${dados.email || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Tipo Frete</div>                <div class="info-value">${dados.tipo_frete || 'CIF'}</div>            </div>        </div>    </div>        <div class="section">        <div class="section-title">üöö TRANSPORTADORA</div>        <div class="info-grid">            <div class="info-item" style="grid-column: span 2;">                <div class="info-label">Raz√£o Social</div>                <div class="info-value">${dados.transportadora || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">CNPJ</div>                <div class="info-value">${dados.transportadora_cnpj || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Telefone</div>                <div class="info-value">${dados.transportadora_fone || '-'}</div>            </div>        </div>    </div>        <div class="section">        <div class="section-title">üì¶ PRODUTOS</div>        <table>            <thead>                <tr>                    <th style="width: 30px;">Item</th>                    <th style="width: 80px;">C√≥digo</th>                    <th>Descri√ß√£o</th>                    <th style="width: 80px;">Embalagem</th>                    <th style="width: 80px;">Lance(s)</th>                    <th style="width: 50px;">Qtd</th>                    <th style="width: 80px;">V. Unit√°rio</th>                    <th style="width: 90px;">V. Total</th>                </tr>            </thead>            <tbody>                ${produtosHTML}            </tbody>            <tfoot>                <tr class="total-row">                    <td colspan="7" style="text-align: right; padding: 8px;">TOTAL DO PEDIDO:</td>                    <td style="text-align: right; padding: 8px;">R$ ${totalGeral.toFixed(2)}</td>                </tr>            </tfoot>        </table>    </div>        <div class="cobranca-section">        <div class="cobranca-title">üí∞ Dados para Cobran√ßa:</div>        <div class="info-grid" style="background: transparent; border: none;">            <div class="info-item">                <div class="info-label">Forma de Pagamento</div>                <div class="info-value">${dados.forma_pagamento || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Condi√ß√µes</div>                <div class="info-value">${dados.condicoes_pagamento || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Prazo Entrega</div>                <div class="info-value">${dados.prazo_entrega || '-'}</div>            </div>            <div class="info-item">                <div class="info-label">Valor Total</div>                <div class="info-value" style="font-size: 16px; font-weight: bold; color: #155724;">R$ ${(dados.valor_total || totalGeral).toFixed(2)}</div>            </div>        </div>    </div>        ${dados.observacoes ? `    <div class="obs-section">        <strong>üìù Observa√ß√µes:</strong><br>        ${dados.observacoes}    </div>    ` : ''}        <div class="footer">        <div class="signature-box">            Respons√°vel Vendas<br>            <small>${dados.vendedor || ''}</small>        </div>        <div class="signature-box">            Respons√°vel PCP<br>            <small>_______________</small>        </div>        <div class="signature-box">            Respons√°vel Produ√ß√£o<br>            <small>_______________</small>        </div>    </div>        <div style="text-align: center; margin-top: 40px; color: #666; font-size: 10px;">        Documento gerado em ${dataAtual} √†s ${new Date().toLocaleTimeString('pt-BR')}<br>        ALUFORCE - Sistema de Gest√£o Industrial v2.0    </div></body></html>`;}// Formatar CNPJfunction formatarCNPJ(valor) {    if (!valor) return '';    const numeros = valor.toString().replace(/\D/g, '');    if (numeros.length === 14) {        return numeros.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');    } else if (numeros.length === 11) {        return numeros.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');    }    return valor;}// Mapear statusfunction mapearStatus(status) {    const map = {        'faturar': { texto: 'A Faturar', classe: 'faturar' },        'faturado': { texto: 'Faturado', classe: 'faturado' },        'entregue': { texto: 'Entregue', classe: 'entregue' }    };    return map[status] || { texto: status, classe: status };}async function emitirOrdens() {    let pool;        try {        console.log('üîå Conectando ao banco de dados...');        pool = await mysql.createPool(config);                // Criar pasta se n√£o existir        if (!fs.existsSync(OUTPUT_DIR)) {            fs.mkdirSync(OUTPUT_DIR, { recursive: true });        }                // Buscar pedidos com status faturar, faturado ou entregue        console.log('üìã Buscando pedidos a faturar/faturado/entregue...');                const [pedidos] = await pool.query(`            SELECT                 p.id,                p.empresa_id,                p.status,                p.vendedor_id,                p.descricao,                p.observacao,                p.valor as valor_total,                p.frete,                p.prazo_entrega,                p.created_at as data_criacao,                e.razao_social as cliente,                e.nome_fantasia,                e.cnpj,                e.telefone,                e.email,                e.contato,                v.nome as vendedor_nome            FROM pedidos p            LEFT JOIN empresas e ON p.empresa_id = e.id            LEFT JOIN vendedores v ON p.vendedor_id = v.id            WHERE p.status IN ('faturar', 'faturado', 'entregue')            ORDER BY p.id DESC        `);                console.log(`üìä Encontrados ${pedidos.length} pedidos`);                if (pedidos.length === 0) {            console.log('‚ö†Ô∏è  Nenhum pedido encontrado com status faturar/faturado/entregue');            await pool.end();            return;        }                let ordensGeradas = 0;        const ano = new Date().getFullYear();                for (const pedido of pedidos) {            try {                // Buscar itens do pedido                const [itens] = await pool.query(`                    SELECT                         pi.id,                        pi.produto_id,                        pi.codigo,                        pi.descricao as item_descricao,                        pi.quantidade,                        pi.unidade,                        pi.preco_unitario,                        pi.subtotal,                        pr.nome as produto_nome,                        pr.descricao as produto_descricao                    FROM pedido_itens pi                    LEFT JOIN produtos pr ON pi.produto_id = pr.id                    WHERE pi.pedido_id = ?                `, [pedido.id]);                                // Formatar dados para o template                const statusInfo = mapearStatus(pedido.status);                const numeroOP = `OP N¬∫ ${ano}/${String(pedido.id).padStart(5, '0')}`;                                const dados = {                    numero_op: numeroOP,                    pedido_id: pedido.id,                    status: statusInfo.classe,                    status_texto: statusInfo.texto,                    cliente: pedido.cliente || pedido.nome_fantasia || 'Cliente n√£o identificado',                    cnpj: formatarCNPJ(pedido.cnpj),                    vendedor: pedido.vendedor_nome || 'N√£o informado',                    contato: pedido.contato || '',                    telefone: pedido.telefone || '',                    email: pedido.email || '',                    tipo_frete: 'CIF',                    transportadora: '',                    transportadora_cnpj: '',                    transportadora_fone: '',                    forma_pagamento: 'A prazo',                    condicoes_pagamento: '30/60/90 dias',                    prazo_entrega: '15 dias √∫teis',                    valor_total: parseFloat(pedido.valor_total) || 0,                    observacoes: pedido.descricao || '',                    produtos: itens.map(item => ({                        codigo: item.codigo || `PROD-${item.produto_id || item.id}`,                        descricao: item.produto_nome || item.item_descricao || item.produto_descricao || 'Produto',                        embalagem: item.unidade || '-',                        lances: '-',                        quantidade: parseFloat(item.quantidade) || 1,                        preco_unitario: parseFloat(item.preco_unitario) || 0,                        total: parseFloat(item.subtotal) || (parseFloat(item.quantidade) * parseFloat(item.preco_unitario)) || 0                    }))                };                                // Gerar HTML                const html = gerarHTMLOrdemProducao(dados);                                // Salvar arquivo                const nomeArquivo = `OP_${ano}_${String(pedido.id).padStart(5, '0')}_${pedido.status}.html`;                const caminhoArquivo = path.join(OUTPUT_DIR, nomeArquivo);                                fs.writeFileSync(caminhoArquivo, html, 'utf8');                                console.log(`‚úÖ ${numeroOP} - ${pedido.cliente || 'Cliente'} (${statusInfo.texto}) - ${itens.length} itens`);                console.log(`   üìÅ Salvo em: ${nomeArquivo}`);                                ordensGeradas++;                            } catch (err) {                console.error(`‚ùå Erro ao processar pedido ${pedido.id}:`, err.message);            }        }                console.log(`${'='.repeat(60)}`);        console.log(`üéâ CONCLU√çDO!`);        console.log(`   üìä Total de pedidos: ${pedidos.length}`);        console.log(`   ‚úÖ Ordens geradas: ${ordensGeradas}`);        console.log(`   üìÅ Pasta: ${OUTPUT_DIR}`);        console.log(`${'='.repeat(60)}`);                // Listar arquivos gerados        const arquivos = fs.readdirSync(OUTPUT_DIR).filter(f => f.endsWith('.html'));        console.log(`üìÇ Arquivos na pasta ordens-emitidas (${arquivos.length}):`);        arquivos.forEach(arq => console.log(`   - ${arq}`));            } catch (error) {        console.error('‚ùå Erro:', error.message);    } finally {        if (pool) await pool.end();    }}emitirOrdens();