const mysql = require('mysql2/promise');const fs = require('fs');// CNPJ para gera√ß√£o de EAN-13: 68.192.475/0001-60const CNPJ_BASE = '6819247500';  // Primeiros 10 d√≠gitos do CNPJ// Fun√ß√£o para calcular d√≠gito verificador EAN-13function calcularDigitoVerificadorEAN13(codigo12) {    let soma = 0;    for (let i = 0; i < 12; i++) {        const digito = parseInt(codigo12[i]);        soma += digito * (i % 2 === 0 ? 1 : 3);    }    const resto = soma % 10;    return resto === 0 ? 0 : 10 - resto;}// Fun√ß√£o para gerar EAN-13 baseado no CNPJ e sequ√™nciafunction gerarEAN13(sequencia) {    // 789 (Brasil) + CNPJ base (6 d√≠gitos) + sequ√™ncia (3 d√≠gitos)    const codigo12 = '789' + CNPJ_BASE.substring(0, 6) + sequencia.toString().padStart(3, '0');    const digitoVerificador = calcularDigitoVerificadorEAN13(codigo12);    return codigo12 + digitoVerificador;}// Fun√ß√£o para extrair c√≥digo de origem do textofunction extrairOrigem(textoOrigem) {    if (!textoOrigem) return '0';    // "Nacional, exceto..." = 0    // "Estrangeira - importa√ß√£o direta..." = 1    // "Estrangeira - adquirida no mercado..." = 2    if (textoOrigem.toLowerCase().includes('nacional')) return '0';    if (textoOrigem.toLowerCase().includes('estrangeira') && textoOrigem.toLowerCase().includes('direta')) return '1';    if (textoOrigem.toLowerCase().includes('estrangeira') && textoOrigem.toLowerCase().includes('mercado')) return '2';    return '0';}// Fun√ß√£o para extrair c√≥digo do tipo de produtofunction extrairTipoProduto(textoTipo) {    if (!textoTipo) return '00';    // "00 - Mercadoria para Revenda" = 00    // "04 - Produto Acabado" = 04    // etc.    const match = textoTipo.match(/^(\d{2})/);    return match ? match[1] : '00';}// Fun√ß√£o para formatar NCM (remover pontos)function formatarNCM(ncm) {    if (!ncm) return null;    return ncm.replace(/\./g, '');}// Fun√ß√£o para formatar CEST (remover pontos)function formatarCEST(cest) {    if (!cest) return null;    return cest.replace(/\./g, '');}async function atualizarBanco() {    console.log('üîå Conectando ao banco de dados...');        const connection = await mysql.createConnection({        host: 'localhost',        user: 'root',        password: '@dminalu',        database: 'aluforce_vendas',        port: 3306,        charset: 'utf8mb4'    });    console.log('‚úÖ Conectado!');    try {        // =========================================        // PARTE 1: Atualizar produtos existentes        // =========================================        console.log('üì¶ PARTE 1: ATUALIZANDO PRODUTOS EXISTENTES');        console.log('='.repeat(60));                const produtosParaAtualizar = JSON.parse(fs.readFileSync('produtos_para_atualizar.json', 'utf8'));        let atualizados = 0;        let errosAtualizacao = 0;        let sequenciaEAN = 1;        for (const item of produtosParaAtualizar) {            const novo = item.novo;            const atual = item.atual;                        // Determinar GTIN: usar existente se v√°lido, caso contr√°rio gerar ou usar do Excel            let gtin = atual.gtin;            if (!gtin || gtin.trim() === '') {                if (novo.ean && novo.ean.trim() !== '') {                    gtin = novo.ean;                } else {                    // Gerar novo EAN-13                    gtin = gerarEAN13(sequenciaEAN++);                }            }            try {                await connection.execute(`                    UPDATE produtos                     SET ncm = ?,                        cest = ?,                        gtin = ?,                        preco = ?,                        origem = ?,                        tipo_produto = ?                    WHERE codigo = ?                `, [                    formatarNCM(novo.ncm) || atual.ncm,                    formatarCEST(novo.cest) || atual.cest,                    gtin,                    novo.preco || 0,                    extrairOrigem(novo.origem),                    extrairTipoProduto(novo.tipo),                    item.codigo                ]);                                console.log(`  ‚úÖ ${item.codigo}: Atualizado com sucesso`);                atualizados++;            } catch (err) {                console.log(`  ‚ùå ${item.codigo}: Erro - ${err.message}`);                errosAtualizacao++;            }        }        console.log(`  üìä Resumo: ${atualizados} atualizados, ${errosAtualizacao} erros`);        // =========================================        // PARTE 2: Importar materiais do Excel        // =========================================        console.log('üîß PARTE 2: IMPORTANDO MATERIAIS DO EXCEL');        console.log('='.repeat(60));                const materiaisExcel = JSON.parse(fs.readFileSync('materiais_extraidos.json', 'utf8'));                // Buscar materiais existentes para evitar duplicatas        const [materiaisExistentes] = await connection.query('SELECT codigo_material, descricao FROM materiais');        const mapaMaterialExistente = new Set(materiaisExistentes.map(m => m.codigo_material?.toLowerCase() || m.descricao?.toLowerCase()));        let materiaisInseridos = 0;        let materiaisAtualizados = 0;        let materiaisIgnorados = 0;        let errosMateriais = 0;        for (const material of materiaisExcel) {            const codigoLower = material.codigo?.toLowerCase();            const descricaoLower = material.descricao?.toLowerCase();                        try {                // Verificar se j√° existe pelo c√≥digo                const [existe] = await connection.query(                    'SELECT id FROM materiais WHERE codigo_material = ? OR descricao = ?',                    [material.codigo, material.descricao]                );                if (existe.length > 0) {                    // Atualizar material existente                    await connection.execute(`                        UPDATE materiais                         SET ncm = ?,                            cest = ?,                            gtin = ?,                            preco_venda = ?,                            tipo = ?,                            unidade_medida = ?                        WHERE id = ?                    `, [                        formatarNCM(material.ncm),                        formatarCEST(material.cest),                        material.ean || null,                        material.preco || 0,                        material.categoria,                        material.unidade || 'UN',                        existe[0].id                    ]);                    materiaisAtualizados++;                } else {                    // Gerar EAN se n√£o tiver                    let gtin = material.ean;                    if (!gtin || gtin.trim() === '') {                        gtin = gerarEAN13(sequenciaEAN++);                    }                    // Inserir novo material                    await connection.execute(`                        INSERT INTO materiais (                            codigo_material, descricao, ncm, cest, gtin,                             preco_venda, tipo, unidade_medida, ativo,                            quantidade_estoque, custo_unitario                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, ?, ?)                    `, [                        material.codigo,                        material.descricao,                        formatarNCM(material.ncm),                        formatarCEST(material.cest),                        gtin,                        material.preco || 0,                        material.categoria,                        material.unidade || 'UN',                        material.estoque || 0,                        material.preco || 0                    ]);                    materiaisInseridos++;                }                if (materiaisInseridos % 20 === 0 && materiaisInseridos > 0) {                    console.log(`  üìä Progresso: ${materiaisInseridos} inseridos...`);                }            } catch (err) {                console.log(`  ‚ùå ${material.descricao}: Erro - ${err.message}`);                errosMateriais++;            }        }        console.log(`  üìä Resumo Materiais:`);        console.log(`     - Inseridos: ${materiaisInseridos}`);        console.log(`     - Atualizados: ${materiaisAtualizados}`);        console.log(`     - Erros: ${errosMateriais}`);        // =========================================        // PARTE 3: Verificar e corrigir encoding de clientes        // =========================================        console.log('üë• PARTE 3: VERIFICANDO ENCODING DE CLIENTES');        console.log('='.repeat(60));                // Buscar clientes com problemas de encoding t√≠picos (UTF-8 dobrado)        const [todosClientes] = await connection.query(`            SELECT id, nome, razao_social, nome_fantasia, cidade, endereco, bairro            FROM clientes        `);        let clientesCorrigidos = 0;        const regexEncodingProblemas = /√£|√©|√≠|√≥|√∫|√ß|√°|√ç |√™|√¥|√¢|√µ|\?\?/gi;                // Mapa de corre√ß√µes de encoding UTF-8 dobrado        const correcoes = {            '√£': '√£', '√°': '√°', '√ç ': '√†', '√¢': '√¢', '√µ': '√µ',            '√©': '√©', '√™': '√™', '√≠': '√≠', '√≥': '√≥', '√¥': '√¥',            '√∫': '√∫', '√ß': '√ß', '√ç': '√Å', '??': '',            '√ì': '√ì', '√â': '√â', '√çÀÜ': '√à', '√ö': '√ö',            '√ç∆í√Ç¬£': '√£', '√°': '√°', '√©': '√©', '√≥': '√≥',            '√∫': '√∫', '√ç∆í√Ç¬ß': '√ß', '√ç‚Ä°': '√á'        };        function corrigirEncoding(texto) {            if (!texto) return texto;            let corrigido = texto;            for (const [errado, certo] of Object.entries(correcoes)) {                corrigido = corrigido.split(errado).join(certo);            }            return corrigido;        }        for (const cliente of todosClientes) {            const camposParaCorrigir = ['nome', 'razao_social', 'nome_fantasia', 'cidade', 'endereco', 'bairro'];            let precisaCorrigir = false;            const valoresCorrigidos = {};            for (const campo of camposParaCorrigir) {                if (cliente[campo] && regexEncodingProblemas.test(cliente[campo])) {                    valoresCorrigidos[campo] = corrigirEncoding(cliente[campo]);                    precisaCorrigir = true;                }            }            if (precisaCorrigir) {                try {                    const setClauses = Object.keys(valoresCorrigidos).map(c => `${c} = ?`).join(', ');                    const valores = [...Object.values(valoresCorrigidos), cliente.id];                                        await connection.execute(                        `UPDATE clientes SET ${setClauses} WHERE id = ?`,                        valores                    );                    clientesCorrigidos++;                } catch (err) {                    console.log(`  ‚ùå Cliente ID ${cliente.id}: Erro - ${err.message}`);                }            }        }        console.log(`  üìä Clientes com encoding corrigido: ${clientesCorrigidos}`);        // =========================================        // PARTE 4: Estat√≠sticas finais        // =========================================        console.log('üìä ESTAT√çSTICAS FINAIS');        console.log('='.repeat(60));                const [countProdutos] = await connection.query('SELECT COUNT(*) as total FROM produtos');        const [countMateriais] = await connection.query('SELECT COUNT(*) as total FROM materiais');        const [countClientes] = await connection.query('SELECT COUNT(*) as total FROM clientes');        const [produtosSemGtin] = await connection.query('SELECT COUNT(*) as total FROM produtos WHERE gtin IS NULL OR gtin = ""');        const [materiaisSemGtin] = await connection.query('SELECT COUNT(*) as total FROM materiais WHERE gtin IS NULL OR gtin = ""');        console.log(`  Total de produtos: ${countProdutos[0].total}`);        console.log(`  Total de materiais: ${countMateriais[0].total}`);        console.log(`  Total de clientes: ${countClientes[0].total}`);        console.log(`  Produtos sem GTIN: ${produtosSemGtin[0].total}`);        console.log(`  Materiais sem GTIN: ${materiaisSemGtin[0].total}`);        console.log('‚úÖ IMPORTA√á√çO CONCLU√çDA COM SUCESSO!');    } catch (error) {        console.error('‚ùå ERRO GERAL:', error.message);    } finally {        await connection.end();        console.log('üîå Conex√£o encerrada');    }}atualizarBanco();