/** * Script para importar Contas a Pagar do Excel para o banco de dados * Adaptado para a estrutura existente da tabela */const XLSX = require('xlsx');const mysql = require('mysql2/promise');// Configura√ß√£o do banco Railwayconst dbConfig = {    host: 'interchange.proxy.rlwy.net',    port: 19396,    user: 'root',    password: 'iiilOZutDOnPCwxgiTKeMuEaIzSwplcu',    database: 'railway',    charset: 'utf8mb4'};// Fun√ß√£o para converter data serial do Excel para Datefunction excelDateToJS(serial) {    if (!serial || typeof serial !== 'number') return null;    const utc_days = Math.floor(serial - 25569);    const date = new Date(utc_days * 86400 * 1000);    return date.toISOString().split('T')[0];}// Mapear statusfunction mapStatus(status) {    const statusMap = {        'A vencer': 'pendente',        'Vencida': 'vencida',        'Paga': 'paga',        'Parcialmente paga': 'pendente',        'Cancelada': 'cancelada'    };    return statusMap[status] || 'pendente';}// Mapear forma de pagamentofunction mapFormaPagamento(tipo) {    if (!tipo) return 'boleto';    const t = tipo.toLowerCase();    if (t.includes('pix')) return 'pix';    if (t.includes('boleto')) return 'boleto';    if (t.includes('cart√£o') || t.includes('cartao')) return 'cartao';    if (t.includes('transfer√™ncia') || t.includes('transferencia')) return 'transferencia';    if (t.includes('dinheiro')) return 'dinheiro';    return 'boleto';}async function importarContasPagar() {    let conn;        try {        console.log('üìÇ Lendo arquivo Excel...');        const wb = XLSX.readFile('./ordens-emitidas/Contas a Pagar/Contas a Pagar.xlsx');        const ws = wb.Sheets[wb.SheetNames[0]];        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });                // Pular linhas de cabe√ßalho (0, 1, 2)        const headers = data[2];        const rows = data.slice(3);                console.log(`üìä Encontradas ${rows.length} contas a pagar`);                // Conectar ao banco        console.log('üîå Conectando ao banco de dados Railway...');        conn = await mysql.createConnection(dbConfig);                // Criar/Verificar tabela de fornecedores        await conn.query(`            CREATE TABLE IF NOT EXISTS fornecedores_financeiro (                id INT AUTO_INCREMENT PRIMARY KEY,                nome VARCHAR(255) NOT NULL,                razao_social VARCHAR(255),                cnpj_cpf VARCHAR(20),                criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,                UNIQUE KEY uk_cnpj (cnpj_cpf)            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4        `);                // Criar/Verificar tabela de categorias        await conn.query(`            CREATE TABLE IF NOT EXISTS categorias_financeiro (                id INT AUTO_INCREMENT PRIMARY KEY,                nome VARCHAR(100) NOT NULL,                tipo ENUM('pagar', 'receber', 'ambos') DEFAULT 'pagar',                UNIQUE KEY uk_nome (nome)            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4        `);                // Preparar dados para inser√ß√£o        let inseridos = 0;        let erros = 0;        let duplicados = 0;                for (const row of rows) {            if (!row || row.length < 5) continue;                        const [                situacao,           // 0                numDocumento,       // 1                parcela,            // 2                notaFiscal,         // 3                fornecedorFantasia, // 4                previsaoPgto,       // 5                ultimoPgto,         // 6                valorConta,         // 7                valorLiquido,       // 8                impostosRetidos,    // 9                desconto,           // 10                jurosMulta,         // 11                valorPago,          // 12                valorPagar,         // 13                categoria,          // 14                operacao,           // 15                vendedor,           // 16                projeto,            // 17                contaCorrente,      // 18                tipoDocumento,      // 19                vencimento,         // 20                dataEmissao,        // 21                dataRegistro,       // 22                fornecedorRazao,    // 23                fornecedorCnpj,     // 24                tags,               // 25                observacao          // 26            ] = row;                        // Validar dados essenciais            if (!fornecedorFantasia || valorConta === undefined) continue;                        try {                // Inserir ou buscar fornecedor                let fornecedorId = null;                const cnpjLimpo = String(fornecedorCnpj || '').replace(/[^\d]/g, '');                                if (cnpjLimpo) {                    const [existeForn] = await conn.query(                        'SELECT id FROM fornecedores_financeiro WHERE cnpj_cpf = ?',                        [cnpjLimpo]                    );                                        if (existeForn.length > 0) {                        fornecedorId = existeForn[0].id;                    } else {                        const [insertForn] = await conn.query(                            'INSERT INTO fornecedores_financeiro (nome, razao_social, cnpj_cpf) VALUES (?, ?, ?)',                            [                                String(fornecedorFantasia).substring(0, 255),                                String(fornecedorRazao || fornecedorFantasia).substring(0, 255),                                cnpjLimpo                            ]                        );                        fornecedorId = insertForn.insertId;                    }                }                                // Inserir ou buscar categoria                let categoriaId = null;                if (categoria) {                    const [existeCat] = await conn.query(                        'SELECT id FROM categorias_financeiro WHERE nome = ?',                        [String(categoria).substring(0, 100)]                    );                                        if (existeCat.length > 0) {                        categoriaId = existeCat[0].id;                    } else {                        const [insertCat] = await conn.query(                            'INSERT INTO categorias_financeiro (nome, tipo) VALUES (?, ?)',                            [String(categoria).substring(0, 100), 'pagar']                        );                        categoriaId = insertCat.insertId;                    }                }                                // Extrair parcela atual e total                let parcelaNum = 1;                let totalParcelas = 1;                if (parcela) {                    const match = String(parcela).match(/(\d+)\/(\d+)/);                    if (match) {                        parcelaNum = parseInt(match[1]);                        totalParcelas = parseInt(match[2]);                    }                }                                // Inserir conta a pagar                await conn.query(`                    INSERT INTO contas_pagar                     (fornecedor_id, valor, descricao, status, vencimento, data_vencimento,                      data_criacao, minha_empresa_nome_fantasia, cnpj_cpf, categoria_id,                     forma_pagamento, observacoes, parcela_numero, total_parcelas, valor_pago, previso)                    VALUES (?, ?, ?, ?, ?, ?, NOW(), ?, ?, ?, ?, ?, ?, ?, ?, ?)                `, [                    fornecedorId,                    parseFloat(valorConta) || 0,                    operacao || `${fornecedorFantasia} - ${parcela || ''}`.substring(0, 255),                    mapStatus(situacao),                    excelDateToJS(vencimento),                    excelDateToJS(vencimento),                    String(fornecedorFantasia).substring(0, 255),                    cnpjLimpo,                    categoriaId,                    mapFormaPagamento(tipoDocumento),                    String(observacao || '').substring(0, 1000),                    parcelaNum,                    totalParcelas,                    parseFloat(valorPago) || 0,                    excelDateToJS(previsaoPgto)                ]);                                inseridos++;                console.log(`‚úÖ ${inseridos}. ${String(fornecedorFantasia).substring(0, 40)} - R$ ${parseFloat(valorConta).toFixed(2)} - ${parcela || '1/1'} - Venc: ${excelDateToJS(vencimento)}`);                            } catch (err) {                if (err.code === 'ER_DUP_ENTRY') {                    duplicados++;                } else {                    erros++;                    console.error(`‚ùå Erro: ${err.message}`);                }            }        }                // Verificar total importado        const [result] = await conn.query('SELECT COUNT(*) as total, SUM(valor) as valorTotal, SUM(valor_pago) as valorPago FROM contas_pagar');        const [pendentes] = await conn.query("SELECT COUNT(*) as total, SUM(valor - COALESCE(valor_pago, 0)) as valorPendente FROM contas_pagar WHERE status = 'pendente'");        const [vencidas] = await conn.query("SELECT COUNT(*) as total, SUM(valor - COALESCE(valor_pago, 0)) as valorVencido FROM contas_pagar WHERE status = 'vencida' OR (status = 'pendente' AND vencimento < CURDATE())");                console.log('' + '='.repeat(60));        console.log('üìä RESUMO DA IMPORTA√á√çO');        console.log('='.repeat(60));        console.log(`‚úÖ Inseridos: ${inseridos}`);        console.log(`‚ö†Ô∏è Duplicados: ${duplicados}`);        console.log(`‚ùå Erros: ${erros}`);        console.log('');        console.log(`üìà Total no banco: ${result[0].total} contas`);        console.log(`üí∞ Valor total: R$ ${parseFloat(result[0].valorTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);        console.log(`üí∏ Valor pago: R$ ${parseFloat(result[0].valorPago || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);        console.log(`‚è≥ Pendentes: ${pendentes[0].total} - R$ ${parseFloat(pendentes[0].valorPendente || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);        console.log(`üî¥ Vencidas: ${vencidas[0].total} - R$ ${parseFloat(vencidas[0].valorVencido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);        console.log('='.repeat(60));            } catch (error) {        console.error('‚ùå Erro geral:', error.message);        console.error(error.stack);    } finally {        if (conn) await conn.end();    }}// ExecutarimportarContasPagar();