const xlsx = require('xlsx');const mysql = require('mysql2/promise');const path = require('path');const fs = require('fs');// ConfiguraÃ§Ãµes dos bancosconst localConfig = {    host: 'localhost',    port: 3306,    user: 'root',    password: '@dminalu',    database: 'aluforce_vendas'};const railwayConfig = {    host: 'interchange.proxy.rlwy.net',    port: 19396,    user: 'root',    password: 'iiilOZutDOnPCwxgiTKeMuEaIzSwplcu',    database: 'railway'};// Pasta dos arquivos Excelconst pastaClientes = path.join(__dirname, 'ordens-emitidas', 'Clientes');// Arquivos Excel - Todos com empresa_id=1 (ALUFORCE)const arquivos = [    { nome: 'Clientes - Aluforce.xlsx', empresa_id: 1, origem: 'Aluforce' },    { nome: 'Clientes - Labor Energy.xlsx', empresa_id: 1, origem: 'Labor Energy' },    { nome: 'Clientes - Labor II.xlsx', empresa_id: 1, origem: 'Labor II' },    { nome: 'Clientes - Labor.xlsx', empresa_id: 1, origem: 'Labor' }];// FunÃ§Ã£o para converter data do Excel (nÃºmero serial) para Datefunction excelDateToJS(excelDate) {    if (!excelDate) return null;    if (typeof excelDate === 'string') {        // Se jÃ¡ for uma string de data        const parsed = new Date(excelDate);        if (!isNaN(parsed)) return parsed;        return null;    }    // NÃºmero serial do Excel (dias desde 01/01/1900)    const epoch = new Date(1899, 11, 30);    const days = Math.floor(excelDate);    const milliseconds = (excelDate - days) * 86400000;    return new Date(epoch.getTime() + days * 86400000 + milliseconds);}// FunÃ§Ã£o para formatar data para MySQLfunction formatDateForMySQL(date) {    if (!date || isNaN(date.getTime())) return null;    return date.toISOString().slice(0, 19).replace('T', ' ');}// FunÃ§Ã£o para limpar e normalizar valoresfunction cleanValue(value) {    if (value === undefined || value === null || value === '') return null;    if (typeof value === 'string') return value.trim();    return value;}// FunÃ§Ã£o para converter Sim/NÃ£o para booleanfunction simNaoToBoolean(value) {    if (!value) return null;    const v = String(value).toLowerCase().trim();    return v === 'sim' || v === 's' || v === '1' || v === 'true';}// FunÃ§Ã£o para converter valor monetÃ¡riofunction parseMonetario(value) {    if (!value) return 0;    if (typeof value === 'number') return value;    // Remove R$, pontos de milhar e troca vÃ­rgula por ponto    let v = String(value).replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');    const num = parseFloat(v);    return isNaN(num) ? 0 : num;}// FunÃ§Ã£o para extrair cidade e estadofunction extrairCidadeEstado(cidadeCompleta, estadoSeparado) {    let cidade = null;    let estado = estadoSeparado || null;        if (cidadeCompleta) {        // Formato: "Cidade (UF)" ou apenas "Cidade"        const match = String(cidadeCompleta).match(/^(.+?)\s*\(([A-Z]{2})\)$/);        if (match) {            cidade = match[1].trim();            estado = match[2];        } else {            cidade = String(cidadeCompleta).trim();        }    }        return { cidade, estado };}// FunÃ§Ã£o para mapear colunas do Excel para campos do bancofunction mapearLinha(row, colunas) {    const getValue = (nomes) => {        for (const nome of nomes) {            const idx = colunas.indexOf(nome);            if (idx !== -1 && row[idx] !== undefined) {                return cleanValue(row[idx]);            }        }        return null;    };    const cidadeCompleta = getValue(['Cidade']);    const estadoSeparado = getValue(['Estado']);    const { cidade, estado } = extrairCidadeEstado(cidadeCompleta, estadoSeparado);        const situacao = getValue(['SituaÃ§Ã£o']);    const ativo = situacao ? (situacao.toLowerCase() === 'ativo' ? 1 : 0) : 1;    return {        tags: getValue(['Tags']),        razao_social: getValue(['RazÃ£o Social / Nome Completo', 'RazÃ£o Social']),        nome_fantasia: getValue(['Nome Fantasia / Nome Abreviado', 'Nome Fantasia']),        cnpj_cpf: getValue(['CNPJ / CPF', 'CNPJ', 'CPF']),        telefone: getValue(['Telefone']),        contato: getValue(['Contato']),        email: getValue(['E-mail', 'Email']),        cidade,        estado,        endereco: getValue(['EndereÃ§o']),        bairro: getValue(['Bairro']),        cep: getValue(['CEP']),        banco: getValue(['Banco']),        agencia: getValue(['AgÃªncia']),        conta_corrente: getValue(['Conta Corrente']),        inscricao_estadual: getValue(['InscriÃ§Ã£o Estadual']),        contribuinte_icms: simNaoToBoolean(getValue(['Contribuinte do ICMS'])),        inscricao_municipal: getValue(['InscriÃ§Ã£o Municipal']),        tipo_atividade: getValue(['Tipo de Atividade']),        vendedor_responsavel: getValue(['Vendedor (padrÃ£o)']),        credito_total: parseMonetario(getValue(['CrÃ©dito Total'])),        total_a_receber: parseMonetario(getValue(['Total a Receber'])),        credito_disponivel: parseMonetario(getValue(['CrÃ©dito DisponÃ­vel'])),        transportadora: getValue(['Transportadora']),        data_cadastro: formatDateForMySQL(excelDateToJS(getValue(['InclusÃ£o']))),        data_ultima_alteracao: formatDateForMySQL(excelDateToJS(getValue(['Ãšltima AlteraÃ§Ã£o']))),        incluido_por: getValue(['IncluÃ­do por']),        alterado_por: getValue(['Alterado por']),        ativo    };}// FunÃ§Ã£o para ler clientes do Excelfunction lerClientesExcel(arquivo) {    const caminho = path.join(pastaClientes, arquivo.nome);        if (!fs.existsSync(caminho)) {        console.log(`âŒ Arquivo nÃ£o encontrado: ${arquivo.nome}`);        return [];    }        const workbook = xlsx.readFile(caminho);    const sheetName = workbook.SheetNames[0];    const sheet = workbook.Sheets[sheetName];    const data = xlsx.utils.sheet_to_json(sheet, { header: 1, defval: null });        // Encontrar linha do cabeÃ§alho (procurar por "CNPJ" ou "RazÃ£o Social")    let headerRow = -1;    for (let i = 0; i < Math.min(10, data.length); i++) {        const row = data[i];        if (row && row.some(cell => cell && (            String(cell).includes('CNPJ') ||             String(cell).includes('RazÃ£o Social') ||            String(cell).includes('SituaÃ§Ã£o')        ))) {            headerRow = i;            break;        }    }        if (headerRow === -1) {        console.log(`âŒ CabeÃ§alho nÃ£o encontrado em: ${arquivo.nome}`);        return [];    }        const colunas = data[headerRow].map(c => c ? String(c).trim() : '');    const clientes = [];        // Processar linhas de dados    for (let i = headerRow + 1; i < data.length; i++) {        const row = data[i];        if (!row || row.every(cell => cell === null || cell === '')) continue;                const cliente = mapearLinha(row, colunas);                // Pular se nÃ£o tiver CNPJ/CPF ou razÃ£o social        if (!cliente.cnpj_cpf && !cliente.razao_social) continue;                cliente.empresa_id = arquivo.empresa_id;        cliente.origem = arquivo.origem;                // Usar razÃ£o social como nome se nÃ£o tiver nome fantasia        cliente.nome = cliente.nome_fantasia || cliente.razao_social;                clientes.push(cliente);    }        return clientes;}// FunÃ§Ã£o para inserir cliente no bancoasync function inserirCliente(conn, cliente) {    const sql = `        INSERT INTO clientes (            tags, nome, razao_social, nome_fantasia, cnpj_cpf, contato, email, telefone,            empresa_id, endereco, bairro, cidade, estado, cep, banco, agencia, conta_corrente,            inscricao_estadual, contribuinte_icms, inscricao_municipal, tipo_atividade,            vendedor_responsavel, credito_total, total_a_receber, credito_disponivel,            transportadora, data_cadastro, data_ultima_alteracao, incluido_por, alterado_por, ativo        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)        ON DUPLICATE KEY UPDATE            tags = COALESCE(VALUES(tags), tags),            nome = COALESCE(VALUES(nome), nome),            razao_social = COALESCE(VALUES(razao_social), razao_social),            nome_fantasia = COALESCE(VALUES(nome_fantasia), nome_fantasia),            contato = COALESCE(VALUES(contato), contato),            email = COALESCE(VALUES(email), email),            telefone = COALESCE(VALUES(telefone), telefone),            endereco = COALESCE(VALUES(endereco), endereco),            bairro = COALESCE(VALUES(bairro), bairro),            cidade = COALESCE(VALUES(cidade), cidade),            estado = COALESCE(VALUES(estado), estado),            cep = COALESCE(VALUES(cep), cep),            banco = COALESCE(VALUES(banco), banco),            agencia = COALESCE(VALUES(agencia), agencia),            conta_corrente = COALESCE(VALUES(conta_corrente), conta_corrente),            inscricao_estadual = COALESCE(VALUES(inscricao_estadual), inscricao_estadual),            contribuinte_icms = COALESCE(VALUES(contribuinte_icms), contribuinte_icms),            inscricao_municipal = COALESCE(VALUES(inscricao_municipal), inscricao_municipal),            tipo_atividade = COALESCE(VALUES(tipo_atividade), tipo_atividade),            vendedor_responsavel = COALESCE(VALUES(vendedor_responsavel), vendedor_responsavel),            credito_total = VALUES(credito_total),            total_a_receber = VALUES(total_a_receber),            credito_disponivel = VALUES(credito_disponivel),            transportadora = COALESCE(VALUES(transportadora), transportadora),            data_ultima_alteracao = VALUES(data_ultima_alteracao),            alterado_por = VALUES(alterado_por),            ativo = VALUES(ativo)    `;        const values = [        cliente.tags,        cliente.nome,        cliente.razao_social,        cliente.nome_fantasia,        cliente.cnpj_cpf,        cliente.contato,        cliente.email,        cliente.telefone,        cliente.empresa_id,        cliente.endereco,        cliente.bairro,        cliente.cidade,        cliente.estado,        cliente.cep,        cliente.banco,        cliente.agencia,        cliente.conta_corrente,        cliente.inscricao_estadual,        cliente.contribuinte_icms,        cliente.inscricao_municipal,        cliente.tipo_atividade,        cliente.vendedor_responsavel,        cliente.credito_total,        cliente.total_a_receber,        cliente.credito_disponivel,        cliente.transportadora,        cliente.data_cadastro,        cliente.data_ultima_alteracao,        cliente.incluido_por,        cliente.alterado_por,        cliente.ativo    ];        return conn.query(sql, values);}// FunÃ§Ã£o principalasync function main() {    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');    console.log('â•‘     IMPORTAÃ‡ÃO DE CLIENTES - EXCEL â†’ MySQL (Local + Railway)  â•‘');    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');        let localConn, railwayConn;        try {        // Conectar aos bancos        console.log('ğŸ”Œ Conectando aos bancos de dados...');        localConn = await mysql.createConnection(localConfig);        console.log('   âœ… Banco LOCAL conectado');                railwayConn = await mysql.createConnection(railwayConfig);        console.log('   âœ… Banco RAILWAY conectado');                // Adicionar Ã­ndice Ãºnico para CNPJ/CPF + empresa_id se nÃ£o existir        try {            await localConn.query(`                ALTER TABLE clientes                 ADD UNIQUE INDEX idx_cnpj_empresa (cnpj_cpf, empresa_id)            `);            console.log('   ğŸ“‹ Ãndice Ãºnico criado no banco LOCAL');        } catch (e) {            // Ãndice jÃ¡ existe        }                try {            await railwayConn.query(`                ALTER TABLE clientes                 ADD UNIQUE INDEX idx_cnpj_empresa (cnpj_cpf, empresa_id)            `);            console.log('   ğŸ“‹ Ãndice Ãºnico criado no banco RAILWAY');        } catch (e) {            // Ãndice jÃ¡ existe        }                // EstatÃ­sticas        const stats = {            local: { inseridos: 0, atualizados: 0, erros: 0 },            railway: { inseridos: 0, atualizados: 0, erros: 0 }        };                // Processar cada arquivo        for (const arquivo of arquivos) {            console.log(`ğŸ“„ Processando: ${arquivo.nome}`);            console.log('â•'.repeat(60));                        const clientes = lerClientesExcel(arquivo);            console.log(`   ğŸ“Š ${clientes.length} clientes encontrados`);                        if (clientes.length === 0) continue;                        let localOk = 0, railwayOk = 0;                        for (const cliente of clientes) {                // Inserir no banco LOCAL                try {                    const [result] = await inserirCliente(localConn, cliente);                    if (result.affectedRows > 0) {                        if (result.insertId > 0) {                            stats.local.inseridos++;                        } else {                            stats.local.atualizados++;                        }                        localOk++;                    }                } catch (err) {                    stats.local.erros++;                    if (!err.message.includes('Duplicate')) {                        console.error(`   âŒ LOCAL - Erro: ${cliente.cnpj_cpf} - ${err.message}`);                    }                }                                // Inserir no banco RAILWAY                try {                    const [result] = await inserirCliente(railwayConn, cliente);                    if (result.affectedRows > 0) {                        if (result.insertId > 0) {                            stats.railway.inseridos++;                        } else {                            stats.railway.atualizados++;                        }                        railwayOk++;                    }                } catch (err) {                    stats.railway.erros++;                    if (!err.message.includes('Duplicate')) {                        console.error(`   âŒ RAILWAY - Erro: ${cliente.cnpj_cpf} - ${err.message}`);                    }                }            }                        console.log(`   âœ… LOCAL: ${localOk} processados`);            console.log(`   âœ… RAILWAY: ${railwayOk} processados`);        }                // Resumo final        console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');        console.log('â•‘                      RESUMO DA IMPORTAÃ‡ÃO                     â•‘');        console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');                console.log('ğŸ“Š BANCO LOCAL:');        console.log(`   â• Inseridos: ${stats.local.inseridos}`);        console.log(`   ğŸ”„ Atualizados: ${stats.local.atualizados}`);        console.log(`   âŒ Erros: ${stats.local.erros}`);                console.log('ğŸ“Š BANCO RAILWAY:');        console.log(`   â• Inseridos: ${stats.railway.inseridos}`);        console.log(`   ğŸ”„ Atualizados: ${stats.railway.atualizados}`);        console.log(`   âŒ Erros: ${stats.railway.erros}`);                // Verificar totais        const [localTotal] = await localConn.query('SELECT COUNT(*) as total FROM clientes');        const [railwayTotal] = await railwayConn.query('SELECT COUNT(*) as total FROM clientes');                console.log('ğŸ“ˆ TOTAL DE CLIENTES NOS BANCOS:');        console.log(`   ğŸ  LOCAL: ${localTotal[0].total}`);        console.log(`   â˜ï¸  RAILWAY: ${railwayTotal[0].total}`);            } catch (error) {        console.error('âŒ Erro geral:', error.message);    } finally {        if (localConn) await localConn.end();        if (railwayConn) await railwayConn.end();        console.log('âœ… ConexÃµes encerradas');    }}main();