const mysql = require('mysql2/promise');const fs = require('fs');// CNPJ para gera√ß√£o de EAN-13: 68.192.475/0001-60const CNPJ_BASE = '6819247500';  // Primeiros 10 d√≠gitos do CNPJ// Fun√ß√£o para calcular d√≠gito verificador EAN-13function calcularDigitoVerificadorEAN13(codigo12) {    let soma = 0;    for (let i = 0; i < 12; i++) {        const digito = parseInt(codigo12[i]);        soma += digito * (i % 2 === 0 ? 1 : 3);    }    const resto = soma % 10;    return resto === 0 ? 0 : 10 - resto;}// Fun√ß√£o para gerar EAN-13 baseado no CNPJ e sequ√™nciafunction gerarEAN13(sequencia) {    // 789 (Brasil) + CNPJ base (6 d√≠gitos) + sequ√™ncia (3 d√≠gitos)    const codigo12 = '789' + CNPJ_BASE.substring(0, 6) + sequencia.toString().padStart(3, '0');    const digitoVerificador = calcularDigitoVerificadorEAN13(codigo12);    return codigo12 + digitoVerificador;}// Fun√ß√£o para formatar NCM (remover pontos)function formatarNCM(ncm) {    if (!ncm) return null;    return ncm.replace(/\./g, '');}// Fun√ß√£o para formatar CEST (remover pontos)function formatarCEST(cest) {    if (!cest) return null;    return cest.replace(/\./g, '');}// Fun√ß√£o para extrair unidadefunction extrairUnidade(textoUnidade) {    if (!textoUnidade) return 'UN';    // "Metro (M)" -> "M", "Quilograma (KG)" -> "KG"    const match = textoUnidade.match(/\(([^)]+)\)/);    return match ? match[1] : 'UN';}async function importarMateriais() {    console.log('üîå Conectando ao banco de dados...');        const connection = await mysql.createConnection({        host: 'localhost',        user: 'root',        password: '@dminalu',        database: 'aluforce_vendas',        port: 3306,        charset: 'utf8mb4'    });    console.log('‚úÖ Conectado!');    try {        // Carregar materiais do JSON        const materiaisExcel = JSON.parse(fs.readFileSync('materiais_extraidos.json', 'utf8'));        console.log(`üì¶ Total de materiais no arquivo: ${materiaisExcel.length}`);                // Buscar materiais existentes        const [materiaisExistentes] = await connection.query('SELECT id, codigo_material, descricao FROM materiais');        console.log(`üìä Materiais existentes no banco: ${materiaisExistentes.length}`);        // Criar mapa de materiais existentes        const mapaDescricao = {};        materiaisExistentes.forEach(m => {            if (m.descricao) mapaDescricao[m.descricao.toLowerCase().trim()] = m.id;            if (m.codigo_material) mapaDescricao[m.codigo_material.toLowerCase().trim()] = m.id;        });        let materiaisInseridos = 0;        let materiaisAtualizados = 0;        let errosMateriais = 0;        let sequenciaEAN = 500; // Come√ßar de 500 para n√£o conflitar com produtos        console.log('üîß IMPORTANDO MATERIAIS DO EXCEL');        console.log('='.repeat(60));        for (const material of materiaisExcel) {            // Extrair valores com fallback para null            const codigo = material.codigo || null;            const descricao = material.descricao || null;            const ncm = formatarNCM(material.ncm) || null;            const cest = formatarCEST(material.cest) || null;            const preco = material.preco || 0;            const estoque = material.estoque || 0;            const unidade = extrairUnidade(material.unidade) || 'UN';            const tipo = material.tipoMaterial || null; // Categoria/tipo do material                        // Gerar EAN se n√£o tiver            let gtin = material.ean && material.ean.trim() !== '' ? material.ean : null;            if (!gtin) {                gtin = gerarEAN13(sequenciaEAN++);            }            try {                // Verificar se j√° existe pela descri√ß√£o ou c√≥digo                const chaveDescricao = descricao ? descricao.toLowerCase().trim() : '';                const chaveCodigo = codigo ? codigo.toLowerCase().trim() : '';                                const idExistente = mapaDescricao[chaveDescricao] || mapaDescricao[chaveCodigo];                if (idExistente) {                    // Atualizar material existente                    await connection.execute(`                        UPDATE materiais                         SET ncm = COALESCE(?, ncm),                            cest = COALESCE(?, cest),                            gtin = COALESCE(?, gtin),                            preco_venda = ?,                            tipo = COALESCE(?, tipo),                            unidade_medida = ?                        WHERE id = ?                    `, [ncm, cest, gtin, preco, tipo, unidade, idExistente]);                                        materiaisAtualizados++;                } else {                    // Inserir novo material                    await connection.execute(`                        INSERT INTO materiais (                            codigo_material, descricao, ncm, cest, gtin,                             preco_venda, tipo, unidade_medida, ativo,                            quantidade_estoque, custo_unitario                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, ?, ?)                    `, [                        codigo,                        descricao,                        ncm,                        cest,                        gtin,                        preco,                        tipo,                        unidade,                        estoque,                        preco                    ]);                                        materiaisInseridos++;                                        // Adicionar ao mapa para evitar duplicatas                    if (descricao) mapaDescricao[descricao.toLowerCase().trim()] = 'novo';                    if (codigo) mapaDescricao[codigo.toLowerCase().trim()] = 'novo';                }                if ((materiaisInseridos + materiaisAtualizados) % 50 === 0) {                    console.log(`  üìä Progresso: ${materiaisInseridos} inseridos, ${materiaisAtualizados} atualizados...`);                }            } catch (err) {                console.log(`  ‚ùå ${descricao}: Erro - ${err.message}`);                errosMateriais++;            }        }        console.log(`  üìä RESUMO MATERIAIS:`);        console.log(`     - Inseridos: ${materiaisInseridos}`);        console.log(`     - Atualizados: ${materiaisAtualizados}`);        console.log(`     - Erros: ${errosMateriais}`);        // Estat√≠sticas finais        console.log('üìä ESTAT√çSTICAS FINAIS');        console.log('='.repeat(60));        const [countMateriais] = await connection.query('SELECT COUNT(*) as total FROM materiais');        const [materiaisSemGtin] = await connection.query('SELECT COUNT(*) as total FROM materiais WHERE gtin IS NULL OR gtin = ""');                console.log(`  Total de materiais no banco: ${countMateriais[0].total}`);        console.log(`  Materiais sem GTIN: ${materiaisSemGtin[0].total}`);        console.log('‚úÖ IMPORTA√á√çO DE MATERIAIS CONCLU√çDA!');    } catch (error) {        console.error('‚ùå ERRO GERAL:', error.message);    } finally {        await connection.end();        console.log('üîå Conex√£o encerrada');    }}importarMateriais();