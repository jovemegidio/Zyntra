const xlsx = require('xlsx');const mysql = require('mysql2/promise');const dbConfig = {    host: 'interchange.proxy.rlwy.net',    port: 19396,    user: 'root',    password: 'iiilOZutDOnPCwxgiTKeMuEaIzSwplcu',    database: 'railway',    charset: 'utf8mb4',    connectTimeout: 60000,    waitForConnections: true};function excelDateToJS(serial) {    if (!serial || isNaN(serial)) return null;    const utc_days = Math.floor(serial - 25569);    const date = new Date(utc_days * 86400 * 1000);    return date.toISOString().split('T')[0];}async function importar() {    let conn = await mysql.createConnection(dbConfig);        console.log('üìä IMPORTA√á√çO DE CONTAS CORRENTES E MOVIMENTA√á√ïES');    console.log('='.repeat(60));    // 1. Criar tabela de bancos/contas correntes    console.log('üìÇ Criando tabela de bancos...');    await conn.query(`        CREATE TABLE IF NOT EXISTS bancos (            id INT AUTO_INCREMENT PRIMARY KEY,            nome VARCHAR(255) NOT NULL,            instituicao VARCHAR(100),            tipo_conta VARCHAR(50),            agencia VARCHAR(20),            conta_corrente VARCHAR(30),            saldo_inicial DECIMAL(15,2) DEFAULT 0,            saldo_atual DECIMAL(15,2) DEFAULT 0,            limite_credito DECIMAL(15,2) DEFAULT 0,            status ENUM('ativo','inativo') DEFAULT 'ativo',            considera_fluxo BOOLEAN DEFAULT TRUE,            emite_boleto BOOLEAN DEFAULT FALSE,            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP        )    `);    // 2. Criar tabela de movimenta√ß√µes    console.log('üìÇ Criando tabela de movimenta√ß√µes banc√°rias...');    await conn.query(`        CREATE TABLE IF NOT EXISTS movimentacoes_bancarias (            id INT AUTO_INCREMENT PRIMARY KEY,            banco_id INT,            data DATE NOT NULL,            cliente_fornecedor VARCHAR(255),            categoria VARCHAR(100),            tipo ENUM('entrada','saida','transferencia') NOT NULL,            valor DECIMAL(15,2) NOT NULL,            saldo DECIMAL(15,2),            saldo_previsto DECIMAL(15,2),            tipo_documento VARCHAR(50),            numero_documento VARCHAR(50),            nota_fiscal VARCHAR(50),            parcela VARCHAR(20),            origem VARCHAR(50),            pedido_id INT,            vendedor VARCHAR(100),            observacoes TEXT,            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,            FOREIGN KEY (banco_id) REFERENCES bancos(id)        )    `);    // 3. Importar Contas Correntes    console.log('üì• Importando Contas Correntes...');    const wbContas = xlsx.readFile('./ordens-emitidas/Contas Correntes/Contas Correntes.xlsx');    const wsContas = wbContas.Sheets[wbContas.SheetNames[0]];    const dataContas = xlsx.utils.sheet_to_json(wsContas, { header: 1 });        let contasInseridas = 0;    for (let i = 3; i < dataContas.length; i++) {        const row = dataContas[i];        if (!row || !row[1]) continue;                const status = row[0] === 'Ativo' ? 'ativo' : 'inativo';        const nome = row[1] ? row[1].toString().trim() : '';        const instituicao = row[2] ? row[2].toString().trim() : '';        const tipoConta = row[3] ? row[3].toString().trim() : '';        const agencia = row[4] ? row[4].toString() : '';        const contaCorrente = row[5] ? row[5].toString() : '';        const saldoInicial = parseFloat(row[6]) || 0;        const limiteCredito = parseFloat(row[7]) || 0;        const consideraFluxo = row[8] === 'Considerada';        const emiteBoleto = row[9] === 'Sim';                try {            await conn.query(`                INSERT INTO bancos (nome, instituicao, tipo_conta, agencia, conta_corrente, saldo_inicial, saldo_atual, limite_credito, status, considera_fluxo, emite_boleto)                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)            `, [nome, instituicao, tipoConta, agencia, contaCorrente, saldoInicial, saldoInicial, limiteCredito, status, consideraFluxo, emiteBoleto]);                        contasInseridas++;            console.log(`‚úÖ ${contasInseridas}. ${nome} - ${instituicao}`);        } catch (err) {            console.log(`‚ùå Erro: ${err.message}`);        }    }    console.log(`üìä Total de contas inseridas: ${contasInseridas}`);    // 4. Buscar banco "Caixinha" para associar movimenta√ß√µes    const [bancoCaixinha] = await conn.query(`SELECT id FROM bancos WHERE nome LIKE '%Caixinha%' LIMIT 1`);    const bancoId = bancoCaixinha.length > 0 ? bancoCaixinha[0].id : null;    // 5. Importar Movimenta√ß√µes    console.log('üì• Importando Movimenta√ß√µes...');    const wbMov = xlsx.readFile('./ordens-emitidas/Movimenta√ß√£o da Conta Corrente/Movimenta√ß√£o da Conta Corrente.xlsx');    const wsMov = wbMov.Sheets[wbMov.SheetNames[0]];    const dataMov = xlsx.utils.sheet_to_json(wsMov, { header: 1 });        let movInseridas = 0;    for (let i = 3; i < dataMov.length; i++) {        const row = dataMov[i];        if (!row || !row[2]) continue;                const data = excelDateToJS(row[1]);        const clienteFornecedor = row[2] ? row[2].toString().trim() : '';        const contaCorrenteNome = row[3] ? row[3].toString().trim() : '';        const categoria = row[4] ? row[4].toString().trim() : '';        const valor = parseFloat(row[5]) || 0;        const saldo = parseFloat(row[6]) || 0;        const saldoPrevisto = parseFloat(row[7]) || 0;        const tipoDoc = row[9] ? row[9].toString() : '';        const numDoc = row[10] ? row[10].toString() : '';        const notaFiscal = row[11] ? row[11].toString() : '';        const parcela = row[12] ? row[12].toString() : '';        const origem = row[14] ? row[14].toString() : '';        const pedidoId = row[15] ? parseInt(row[15]) : null;        const vendedor = row[16] ? row[16].toString() : '';        const observacoes = row[20] ? row[20].toString() : '';                // Determinar tipo: entrada ou sa√≠da        const tipo = valor >= 0 ? 'entrada' : 'saida';                // Buscar banco pela conta corrente        let movBancoId = bancoId;        if (contaCorrenteNome) {            const [banco] = await conn.query(`SELECT id FROM bancos WHERE nome LIKE ? LIMIT 1`, [`%${contaCorrenteNome}%`]);            if (banco.length > 0) movBancoId = banco[0].id;        }                try {            await conn.query(`                INSERT INTO movimentacoes_bancarias (banco_id, data, cliente_fornecedor, categoria, tipo, valor, saldo, saldo_previsto, tipo_documento, numero_documento, nota_fiscal, parcela, origem, pedido_id, vendedor, observacoes)                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)            `, [movBancoId, data, clienteFornecedor, categoria, tipo, Math.abs(valor), saldo, saldoPrevisto, tipoDoc, numDoc, notaFiscal, parcela, origem, pedidoId, vendedor, observacoes]);                        movInseridas++;            if (movInseridas <= 10) {                console.log(`‚úÖ ${movInseridas}. ${data} - ${clienteFornecedor} - R$ ${valor.toFixed(2)}`);            }        } catch (err) {            console.log(`‚ùå Erro: ${err.message}`);        }    }    console.log(`... e mais ${movInseridas - 10} movimenta√ß√µes`);    console.log(`üìä Total de movimenta√ß√µes inseridas: ${movInseridas}`);    // 6. Atualizar saldos dos bancos    console.log('üîÑ Atualizando saldos dos bancos...');    await conn.query(`        UPDATE bancos b        SET saldo_atual = COALESCE(saldo_inicial, 0) + COALESCE((            SELECT SUM(CASE WHEN tipo = 'entrada' THEN valor ELSE -valor END)            FROM movimentacoes_bancarias m            WHERE m.banco_id = b.id        ), 0)    `);    // Estat√≠sticas finais    const [statsBancos] = await conn.query(`SELECT COUNT(*) as total, SUM(saldo_atual) as saldo FROM bancos WHERE status = 'ativo'`);    const [statsMov] = await conn.query(`        SELECT             COUNT(*) as total,            SUM(CASE WHEN tipo = 'entrada' THEN valor ELSE 0 END) as entradas,            SUM(CASE WHEN tipo = 'saida' THEN valor ELSE 0 END) as saidas        FROM movimentacoes_bancarias    `);    console.log('' + '='.repeat(60));    console.log('üìä RESUMO FINAL');    console.log('='.repeat(60));    console.log(`üè¶ Bancos ativos: ${statsBancos[0].total}`);    console.log(`üí∞ Saldo total: R$ ${parseFloat(statsBancos[0].saldo || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);    console.log(`üìÑ Movimenta√ß√µes: ${statsMov[0].total}`);    console.log(`üìà Total entradas: R$ ${parseFloat(statsMov[0].entradas || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);    console.log(`üìâ Total sa√≠das: R$ ${parseFloat(statsMov[0].saidas || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);    await conn.end();}importar().catch(console.error);